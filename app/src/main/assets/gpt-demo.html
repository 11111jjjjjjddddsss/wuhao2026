<!-- UI_VERSION: phone-shell-20250128 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
    <title>农技千问</title>
    <style>
        /* B. 颜色与尺寸（硬值） */
        :root {
            --debug-shell: 0;
            --green: #169C5C;
            --green-accent: #1FAE6A;
            --bg: #FFFFFF;
            --border: #EDEDED;
            --text: #111111;
            --text-secondary: #8C8C8C;
            --text-disabled: #BDBDBD;
            --danger: #E14B4B;
            --stop-bg: #F4F4F4;
            --divider: #F2F2F2;
            --placeholder: #9B9B9B;
            --tool-result-text: #6B6B6B;
            --input-radius: 22px;
            --btn-circle-size: 40px;
            --input-min-height: 56px;
            --transition-fast: 180ms ease;
            --transition-sheet: 240ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 16px;
            line-height: 1.4;
            background-color: #F6F6F6;
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        .app-shell {
            width: min(100vw, 430px);
            max-width: 430px;
            height: 100vh;
            margin: 0 auto;
            background: linear-gradient(to bottom, #F2F2F2 0%, #FFFFFF 22%, #FFFFFF 78%, #F2F2F2 100%);
            display: flex;
            flex-direction: column;
            position: relative;
            outline: calc(var(--debug-shell) * 1px) solid red;
        }

        @media (orientation: landscape) {
            .app-shell {
                max-width: 520px;
                width: min(100vw, 520px);
            }
        }

        /* A. 顶部 AppBar（背景透明，沿用 app-shell 整页渐变） */
        .app-bar {
            flex-shrink: 0;
            height: 56px;
            padding: env(safe-area-inset-top) 12px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: none;
            box-shadow: none;
            background: transparent;
        }
        .app-bar-left, .app-bar-right {
            width: var(--btn-circle-size);
            height: var(--btn-circle-size);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            color: var(--text);
            border-radius: 50%;
        }
        .app-bar-left {
            background: #FFFFFF;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
        }
        .app-bar-left:hover, .app-bar-right:hover {
            background: rgba(0,0,0,0.05);
        }
        .app-bar-left:hover {
            background: #F8F8F8;
        }
        .app-bar-title-wrap {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #FFFFFF;
            border-radius: 999px;
            padding: 6px 14px 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .app-bar-title {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.3px;
            color: var(--text);
        }
        .app-bar svg {
            width: 22px;
            height: 22px;
            stroke: var(--text);
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        /* 左侧抽屉：340px 最大 360px，移动端 80% 最大 360px；左滑入 220ms；禁止竖排/旋转文字 */
        #drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: 340px;
            max-width: 360px;
            height: 100%;
            background: #F5F5F5;
            box-shadow: 2px 0 12px rgba(0,0,0,0.12);
            z-index: 301;
            transform: translateX(-100%);
            transition: transform 220ms cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex;
            flex-direction: column;
            writing-mode: horizontal-tb;
        }
        #drawer .drawer-content {
            writing-mode: horizontal-tb;
            transform: none;
            text-orientation: mixed;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #drawer .drawer-content::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        #drawer .menu-card {
            writing-mode: horizontal-tb;
            transform: none;
            text-orientation: mixed;
        }
        #drawer .menu-card:active {
            transform: scale(0.98);
        }
        @media (max-width: 600px) {
            #drawer { width: 80%; max-width: 360px; }
        }
        #drawer.open {
            transform: translateX(0);
        }
        .drawer-header {
            flex-shrink: 0;
            padding: 20px 16px;
            background: #FFFFFF;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .drawer-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #E0E0E0 0%, #BDBDBD 100%);
        }
        .drawer-user {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }
        .drawer-nickname {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }
        .drawer-member {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 260px;
            display: block;
        }
        .drawer-content {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 12px 16px;
        }
        .drawer-content .section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 16px 0 8px;
            padding: 0 4px;
        }
        .drawer-content .section-title:first-child {
            margin-top: 0;
        }
        .menu-card {
            display: flex;
            align-items: center;
            gap: 12px;
            min-height: 60px;
            padding: 16px;
            margin-bottom: 12px;
            background: #F6F6F6;
            border-radius: 12px;
            font-size: 15px;
            color: var(--text);
            cursor: pointer;
            transition: background 0.2s ease, transform 0.15s ease;
        }
        .menu-card:hover {
            background: #EEEEEE;
        }
        .menu-card:active {
            background: #E0E0E0;
        }
        .menu-card > span:first-of-type {
            flex: 1;
            min-width: 0;
        }
        .menu-card .menu-card-right {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .menu-card .menu-arrow {
            flex-shrink: 0;
            opacity: 0.5;
        }
        .menu-card .menu-arrow svg {
            width: 18px;
            height: 18px;
        }
        .drawer-footer {
            flex-shrink: 0;
            padding: 12px 16px 20px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
            background: #F5F5F5;
            border-top: 1px solid rgba(0,0,0,0.06);
        }
        .drawer-footer .menu-card {
            margin-bottom: 0;
        }
        .drawer-logout {
            color: var(--text-secondary);
        }
        .drawer-version {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 12px;
        }
        /* 遮罩：rgba(0,0,0,0.35)，点击关闭抽屉 */
        #drawer-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.35);
            cursor: pointer;
            z-index: 300;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        #drawer-mask.show {
            pointer-events: auto;
            opacity: 1;
        }

        /* ========== 会员中心：一屏可见（默认无内部滚动条） ========== */
        #membership-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.35);
            z-index: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            opacity: 0;
            visibility: hidden;
            transition: opacity .22s ease, visibility .22s ease;
            writing-mode: horizontal-tb;
        }
        #membership-modal-backdrop.open {
            opacity: 1;
            visibility: visible;
        }
        #membership-modal {
            width: min(560px, calc(100vw - 24px));
            height: min(720px, calc(100vh - 24px));
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 10px 40px rgba(0,0,0,.18);
            padding: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            writing-mode: horizontal-tb;
            transform: none;
            text-orientation: mixed;
        }
        .membership-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 4px 10px;
            border-bottom: 1px solid rgba(0,0,0,.06);
        }
        .membership-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--text);
        }
        .membership-close {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,.10);
            background: #fff;
            cursor: pointer;
        }
        .membership-close:active {
            transform: scale(.98);
        }
        .membership-sub {
            font-size: 13px;
            color: var(--text-secondary);
            padding: 8px 4px 12px;
            line-height: 1.4;
        }
        .membership-cards {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-top: 12px;
        }
        .membership-card {
            flex: 1;
            min-height: 0;
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,.08);
            background: #fff;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            writing-mode: horizontal-tb;
            transform: none;
            text-orientation: mixed;
        }
        .membership-card[data-tier="pro"] {
            border-color: rgba(0,0,0,.18);
            box-shadow: 0 6px 18px rgba(0,0,0,.06);
        }
        .membership-card.recommended-highlight {
            border-color: rgba(0,0,0,.35);
            box-shadow: 0 8px 24px rgba(0,0,0,.12);
        }
        .card-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
            padding-right: 96px;
            /* 兜底：系统字体放大也不挤 */
        }
        .card-name {
            font-size: 16px;
            font-weight: 900;
            color: var(--text);
        }
        .card-price {
            font-size: 16px;
            font-weight: 900;
            color: var(--text);
            white-space: nowrap;
        }
        .card-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid rgba(0,0,0,.14);
            background: #fff;
            color: rgba(0,0,0,.72);
            /* 防止长文案顶到价格：badge 自己收敛 */
            max-width: 88px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dot {
            font-weight: 900;
            color: rgba(0,0,0,.70);
            padding: 0 2px;
        }
        .card-desc {
            font-size: 13px;
            font-weight: 400;
            color: var(--text-secondary);
            line-height: 1.45;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            padding-left: 12px;
            padding-right: 96px;
            min-width: 0;
            width: 100%;
            box-sizing: border-box;
        }
        .card-desc .dot {
            font-weight: 900;
        }
        .card-btn {
            margin-top: auto;
            width: 100%;
            height: 44px;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,.12);
            background: #111;
            color: #fff;
            font-size: 14px;
            font-weight: 900;
            cursor: pointer;
            writing-mode: horizontal-tb;
            transform: none;
        }
        .card-btn:active {
            transform: scale(.99);
        }
        .card-btn.btn-current, .card-btn:disabled {
            opacity: .45;
            cursor: not-allowed;
        }
        .membership-footnote {
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        @media (max-height: 680px) {
            #membership-modal {
                height: calc(100vh - 24px);
                overflow: auto;
                scrollbar-width: none;
            }
            #membership-modal::-webkit-scrollbar {
                width: 0;
                height: 0;
            }
        }
        #toast {
            position: fixed;
            left: 50%;
            bottom: 80px;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0,0,0,0.75);
            color: #fff;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 500;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.25s, transform 0.25s, visibility 0.25s;
        }
        #toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        /* ===== ChatGPT-ish neutral theme（覆盖 drawer + modal 为黑白灰极简） ===== */
        :root {
            --bg: #f7f7f8;
            --surface: #ffffff;
            --text: #111111;
            --muted: rgba(17,17,17,.65);
            --border: rgba(0,0,0,.08);
            --shadow: 0 8px 30px rgba(0,0,0,.12);
            --radius: 16px;
        }
        #drawer {
            background: var(--surface);
            box-shadow: 8px 0 30px rgba(0,0,0,.10);
            border-right: 1px solid var(--border);
        }
        .drawer-header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }
        .drawer-avatar {
            background: #e9e9ee;
        }
        .drawer-nickname {
            color: var(--text);
        }
        .drawer-member {
            color: var(--muted);
        }
        .menu-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            margin-bottom: 10px;
            min-height: 56px;
            padding: 14px;
            box-shadow: 0 1px 0 rgba(0,0,0,.02);
            transition: background .15s ease, border-color .15s ease;
        }
        .menu-card:hover {
            background: #fbfbfc;
            border-color: rgba(0,0,0,.12);
        }
        .menu-card:active {
            transform: none;
            background: #f3f3f5;
        }
        .menu-card .menu-card-right {
            color: var(--muted);
        }
        .menu-card .menu-arrow {
            opacity: .35;
        }
        #drawer-mask {
            background: rgba(0,0,0,.28);
        }

        .main {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .messages-wrapper {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        .messages-container {
            display: flex;
            flex-direction: column;
            padding: 16px;
            padding-bottom: calc(88px + env(safe-area-inset-bottom, 0px));
            min-height: 100%;
        }

        /* G. 空态（P0-2：无大球，文字左对齐） */
        .empty-state {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            padding: 40px 24px 24px;
            pointer-events: none;
        }
        .empty-state.hidden {
            display: none;
        }
        .empty-state .logo {
            display: none;
        }
        .empty-state .slogan {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            text-align: left;
        }

        /* 全对话无气泡：GPT 纯净文本块 */
        .message {
            margin-bottom: 20px;
            max-width: 85%;
            background: transparent;
            border: none;
            box-shadow: none;
            border-radius: 0;
        }

        .message:last-child {
            margin-bottom: 0;
        }

        .message.user {
            align-self: flex-end;
            margin-left: auto;
        }

        .message.assistant {
            align-self: flex-start;
        }

        /* P0-1: 左侧生成中跳动绿球 */
        .message.assistant .message-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .message.assistant .avatar-slot {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 14px;
        }
        /* ChatGPT 风格：生成中仅显示小尺寸黑白三点 loading，无彩色 */
        .message.assistant .streaming-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #333;
            opacity: 0;
            pointer-events: none;
        }
        .message.assistant.streaming .streaming-dot {
            opacity: 1;
            animation: dot-breathe 1s ease-in-out infinite;
        }
        @keyframes dot-breathe {
            0%, 100% { transform: scale(0.9); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 1; }
        }

        .message-content {
            line-height: 1.5;
            font-size: 16px;
            font-weight: 400;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-width: 100%;
            color: var(--text);
            padding: 4px 12px;
            background: transparent;
            border: none;
            box-shadow: none;
            border-radius: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .message.user .message-content {
            text-align: right;
            color: var(--text);
        }

        .message.assistant .message-content {
            text-align: left;
            color: var(--text);
        }

        /* 工具结果块：ChatGPT 风格灰字小号，绑定在 assistant 消息下方 */
        .tool-result {
            font-size: 12px;
            line-height: 1.5;
            color: var(--tool-result-text);
            margin-top: 8px;
            white-space: pre-wrap;
            word-break: break-word;
            padding-left: 12px;
            border-left: 1px solid rgba(0, 0, 0, 0.08);
        }
        .message-image {
            max-width: 100%;
            margin: 12px 0;
            display: block;
            border-radius: 4px;
        }

        .image-preview-container {
            padding: 8px 12px;
            background-color: #f9f9f9;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 120px;
            overflow-y: auto;
        }

        .image-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #e0e0e0;
            flex-shrink: 0;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-status-overlay {
            position: absolute;
            top: 0;
            right: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 0 0 0 8px;
        }

        .image-status-uploading {
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .image-status-success {
            color: #4caf50;
            font-size: 16px;
            font-weight: bold;
        }

        .image-status-fail {
            color: #f44336;
            font-size: 16px;
            font-weight: bold;
        }

        .image-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 4px;
            padding: 4px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
        }

        .image-action-btn {
            flex: 1;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.9);
            color: #111;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }

        .image-action-btn:hover {
            background-color: rgba(255, 255, 255, 1);
        }

        .image-action-btn.delete {
            background-color: rgba(244, 67, 54, 0.9);
            color: white;
        }

        .image-action-btn.delete:hover {
            background-color: rgba(244, 67, 54, 1);
        }

        .image-fail-hint {
            position: absolute;
            bottom: 28px;
            left: 4px;
            right: 4px;
            font-size: 10px;
            color: #f44336;
            text-align: center;
            background: rgba(0,0,0,0.6);
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* F. 底部输入区（背景透明，沿用 app-shell 整页渐变） */
        .input-container {
            flex-shrink: 0;
            min-height: calc(var(--input-min-height) - 2px);
            background: transparent;
            border-top: none;
            padding: 8px 14px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
            display: flex;
            flex-direction: column;
            gap: 0;
            transition: min-height var(--transition-sheet);
            position: relative;
            z-index: 100;
        }
        .input-container.voice-mode {
            min-height: calc(var(--input-min-height) + 8px);
        }

        .input-wrapper {
            display: flex;
            align-items: baseline;
            gap: 10px;
            min-height: 44px;
        }

        .file-input, .camera-input {
            display: none;
        }

        .add-button, .btn-mic-or-keyboard, .btn-send, .btn-stop {
            width: var(--btn-circle-size);
            height: var(--btn-circle-size);
            min-width: var(--btn-circle-size);
            min-height: var(--btn-circle-size);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform var(--transition-fast), background-color var(--transition-fast);
        }
        .add-button:active, .btn-mic-or-keyboard:active, .btn-send:active, .btn-stop:active {
            transform: scale(0.98);
        }

        /* 加号按钮：圆球白色，底栏浅灰，白球在灰底上显眼；十字架浅灰 */
        .add-button {
            align-self: center;
            min-width: 44px;
            min-height: 44px;
            width: 44px;
            height: 44px;
            background: #FFFFFF;
            border: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            color: #666666;
            font-size: 48px;
            font-weight: 300;
            line-height: 1;
        }
        .add-button:hover {
            background: #F8F8F8;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: #666666;
        }
        .add-button:active {
            transform: scale(0.96);
            box-shadow: 0 0 0 rgba(0,0,0,0.04);
        }
        .btn-mic-or-keyboard {
            background: none;
            color: var(--text);
            position: relative;
            margin-top: -2px;
        }
        .btn-mic-or-keyboard .icon-keyboard {
            display: none;
        }
        .btn-mic-or-keyboard .icon-mic {
            display: flex;
        }
        .btn-mic-or-keyboard.voice-mode .icon-keyboard {
            display: flex;
        }
        .btn-mic-or-keyboard.voice-mode .icon-mic {
            display: none;
        }
        .btn-mic-or-keyboard svg {
            width: 28px;
            height: 28px;
        }
        .btn-mic-or-keyboard .icon-mic svg,
        .btn-mic-or-keyboard .icon-keyboard svg {
            stroke: var(--text);
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        .btn-mic-or-keyboard:hover {
            background: rgba(0,0,0,0.05);
        }

        .btn-send {
            background: var(--green);
            color: #fff;
        }
        .btn-send:hover {
            background: var(--green-accent);
        }
        .btn-send svg {
            width: 24px;
            height: 24px;
            stroke: #fff;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        /* P0-7: 黑圆+绿方 */
        .btn-stop {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            background: #111;
            color: var(--text);
            border-radius: 999px;
        }
        .btn-stop:hover {
            background: #222;
        }
        .btn-stop:active {
            transform: scale(0.92);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .btn-stop svg {
            width: 21px;
            height: 21px;
        }
        .btn-stop svg rect {
            fill: var(--green);
        }

        .input-area-with-hint .btn-mic-or-keyboard,
        .input-area-with-hint .btn-send,
        .input-area-with-hint .btn-stop {
            transition: opacity var(--transition-fast);
        }
        .input-area-with-hint .btn-hidden {
            display: none !important;
        }

        .text-input {
            flex: 1;
            width: 100%;
            min-width: 0;
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 10px 4px;
            color: var(--text);
            font-size: 16px;
            font-weight: 400;
            line-height: 1.35;
            resize: none;
            min-height: 44px;
            max-height: 110px;
            outline: none;
            -webkit-font-smoothing: antialiased;
        }
        .text-input::placeholder {
            color: var(--placeholder);
        }
        .text-input:focus {
            border-color: var(--green);
        }
        .text-input::-webkit-resizer {
            display: none;
        }
        .text-input::-webkit-scrollbar {
            width: 4px;
        }
        .text-input::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 2px;
        }

        .typing-indicator {
            display: inline-block;
            color: #666;
        }

        /* ChatGPT 风格：失败/中断仅该条底部一行灰字，不弹窗 */
        .interrupted-badge {
            color: #666;
            font-size: 13px;
            margin-left: 0;
        }
        .retry-stream-btn {
            margin-left: 8px;
            padding: 2px 10px;
            font-size: 13px;
            border: 1px solid #999;
            border-radius: 4px;
            background: transparent;
            color: #333;
            cursor: pointer;
        }
        .retry-stream-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .message-folded {
            display: none;
        }

        .load-more-placeholder {
            padding: 12px;
            text-align: center;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .messages-container::-webkit-scrollbar {
            width: 4px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
        }

        /* D. VoicePanel（贴底盖住加号/麦克风；雾蒙蒙毛玻璃 + 精致感；未打开时完全不可见） */
        .voice-panel {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.88);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-radius: 20px 20px 0 0;
            border-top: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.06);
            padding: 16px 16px 20px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
            transition: transform var(--transition-sheet), opacity var(--transition-sheet);
            z-index: 102;
            min-height: 200px;
            max-height: 320px;
        }
        .voice-panel.open {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        .voice-panel.cancel-armed {
            background: rgba(225, 75, 75, 0.1);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
        }
        .voice-drag-bar {
            width: 36px;
            height: 4px;
            background: #D9D9D9;
            border-radius: 2px;
            margin: 0 auto 16px;
        }
        .voice-hint {
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            min-height: 40px;
        }
        .input-area-with-hint {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 8px 8px 14px;
            background: #FFFFFF;
            border: 1px solid var(--border);
            border-radius: var(--input-radius);
            transition: border-color var(--transition-fast);
        }
        .input-area-with-hint:focus-within {
            border-color: var(--border);
        }
        .input-area-inner {
            flex: 1;
            min-width: 0;
            position: relative;
        }
        .voice-input-hint {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: #333333;
            letter-spacing: 0.2em;
            pointer-events: none;
            display: none;
        }
        .input-container.voice-mode .voice-input-hint {
            display: block;
        }
        /* 语音面板打开时，底部输入框不再重复显示「按住说话」，只保留面板内提示 */
        body.voice-panel-open .voice-input-hint {
            display: none !important;
        }
        /* 语音模式下，输入框内按住区域（点/按住此处才录音，麦克风键只做切换） */
        .voice-hold-overlay {
            display: none;
            position: absolute;
            inset: 0;
            z-index: 2;
            cursor: pointer;
        }
        .input-container.voice-mode .voice-hold-overlay {
            display: block;
        }
        .voice-waveform-wrap {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 56px;
            height: 56px;
            margin-bottom: 16px;
        }
        .voice-waveform {
            display: block;
            width: 100%;
            max-width: 280px;
            height: 48px;
            background: transparent;
        }
        /* 录音由按住输入框触发，面板内不再显示麦克风按钮（麦克风键仅作语音/键盘切换） */
        .voice-panel .voice-mic-btn {
            display: none;
        }
        .voice-mic-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid var(--green);
            background: var(--bg);
            color: var(--green);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            cursor: pointer;
            transition: background var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast);
            -webkit-user-select: none;
            user-select: none;
        }
        .voice-mic-btn.recording {
            background: var(--green);
            color: #fff;
            border-color: var(--green);
        }
        .voice-mic-btn.cancel-armed {
            background: var(--danger);
            color: #fff;
            border-color: var(--danger);
        }
        .voice-mic-btn svg {
            width: 36px;
            height: 36px;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        /* E. + 面板 BottomSheet（z-index 高于 input-container:100，确保弹出在输入栏上方） */
        .plus-sheet-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-sheet), visibility var(--transition-sheet);
            z-index: 101;
        }
        .plus-sheet-backdrop.open {
            opacity: 1;
            visibility: visible;
        }
        /* 未打开时完全不可见、不占视线，避免刷新后底部一直看到方框 */
        .plus-sheet {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            min-height: 280px;
            background: var(--bg);
            border-radius: 18px 18px 0 0;
            padding: 8px 20px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
            transition: transform var(--transition-sheet), opacity var(--transition-sheet);
            z-index: 102;
        }
        .plus-sheet.open {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        .plus-sheet-status {
            padding: 12px 14px 10px;
            font-size: 13px;
            color: rgba(0,0,0,.65);
            border-bottom: 1px solid rgba(0,0,0,.06);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .plus-sheet-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px 24px;
        }
        .plus-sheet-item {
            height: 56px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 0 16px;
            cursor: pointer;
            border: none;
            background: rgba(0,0,0,0.04);
            border-radius: 12px;
            font-size: 16px;
            color: var(--text);
            text-align: center;
            transition: background var(--transition-fast);
        }
        .plus-sheet-item:hover {
            background: rgba(0,0,0,0.08);
        }
        .plus-sheet-item:active {
            background: rgba(0,0,0,0.06);
        }
        .plus-sheet-item svg {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            stroke: var(--text);
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        /* + 面板：当前会员档位条（黑白干净） */
        .plus-sheet-tier {
            margin-top: 14px;
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid rgba(0,0,0,.10);
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            cursor: pointer;
            user-select: none;
        }
        .plus-sheet-tier:active {
            transform: scale(.99);
        }
        .plus-sheet-tier .tier-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }
        .plus-sheet-tier .tier-name {
            font-size: 14px;
            font-weight: 800;
            color: rgba(0,0,0,.88);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .plus-sheet-tier .tier-sub {
            font-size: 12px;
            color: rgba(0,0,0,.55);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .plus-sheet-tier .tier-right {
            font-size: 12px;
            font-weight: 800;
            color: rgba(0,0,0,.75);
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(0,0,0,.14);
            background: #fff;
            flex-shrink: 0;
        }
        /* ===== + 面板：GPT 风格定版 ===== */
        #plusSheet {
            will-change: transform, opacity;
            opacity: 0;
            transform: translateY(18px);
            transition: transform .18s ease-out, opacity .18s ease-out;
        }
        #plusSheet.open {
            opacity: 1;
            transform: translateY(0);
        }
        .plus-sheet-content {
            padding: 14px 14px 18px;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
        }
        .plus-sheet-content {
            padding-top: 12px;
        }
        .plus-sheet-status {
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(0,0,0,.03);
            color: rgba(0,0,0,.68);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 12px;
        }
        #plusSheetStatus.plus-sheet-status {
            margin-top: 10px;
            padding: 8px 12px;
            font-size: 12px;
            color: rgba(0,0,0,.55);
            background: rgba(0,0,0,.03);
            border-radius: 12px;
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0;
        }
        .plus-sheet-grid {
            margin-top: 0 !important;
            margin-bottom: 12px;
        }
        .plus-sheet-content {
            padding-top: 6px !important;
        }
        .plus-sheet-item {
            height: 52px;
            border-radius: 14px;
            font-weight: 700;
            font-size: 14px;
        }
        .plus-sheet-tier {
            margin-top: 6px;
            padding: 12px 12px;
            border-radius: 14px;
            background: rgba(0,0,0,.03);
            border: 1px solid rgba(0,0,0,.06);
        }
        .plus-sheet-tier .tier-right {
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(0,0,0,.06);
            font-size: 13px;
            font-weight: 700;
            border: none;
        }
        /* 额度用尽：灰按钮（可点击以提示一次） */
        .disabled, button:disabled {
            opacity: .38;
            cursor: not-allowed;
            pointer-events: auto;
        }

        /* ===== 会员中心：收紧空白 + 取消 flex 均分撑高（最终版覆盖） ===== */
        #membership-modal-backdrop {
            overflow: hidden !important;
        }
        #membership-modal {
            height: auto !important;
            max-height: min(720px, calc(100vh - 24px)) !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            padding: 14px !important;
        }
        #membership-modal::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        #membership-modal .membership-cards,
        #membership-modal .cards-list,
        #membership-modal .modal-body {
            flex: 0 0 auto !important;
            overflow: visible !important;
            height: auto !important;
            max-height: none !important;
        }
        #membership-modal .membership-cards {
            flex: 0 0 auto !important;
            min-height: auto !important;
            padding-top: 8px !important;
            gap: 10px !important;
        }
        #membership-modal .membership-card {
            flex: 0 0 auto !important;
            min-height: auto !important;
            padding: 12px !important;
            gap: 6px !important;
            margin-bottom: 10px !important;
        }
        #membership-modal .membership-header {
            padding: 2px 2px 8px !important;
        }
        #membership-modal .membership-sub {
            padding: 6px 2px 8px !important;
            font-size: 12.5px !important;
            line-height: 1.35 !important;
        }
        #membership-modal .card-desc {
            line-height: 1.35 !important;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        #membership-modal .card-btn {
            height: 42px !important;
            margin-top: 8px !important;
            border-radius: 12px !important;
        }

        /* P0：会员中心空白再收紧一点（只动间距/内边距，不改结构） */
        #membership-modal {
            padding: 12px !important;
        }
        #membership-modal .membership-header {
            padding: 0 2px 6px !important;
        }
        #membership-modal .membership-sub {
            margin: 4px 0 6px !important;
            padding: 0 2px !important;
        }
        #membership-modal .membership-cards {
            padding-top: 6px !important;
            gap: 8px !important;
        }
        #membership-modal .membership-card {
            padding: 10px !important;
            gap: 4px !important;
            margin-bottom: 8px !important;
        }
        #membership-modal .card-btn {
            height: 40px !important;
            margin-top: 6px !important;
        }

    </style>
</head>
<body>
    <div class="app-shell" id="app">
    <header class="app-bar">
        <button type="button" class="app-bar-left" id="appBarLeft" aria-label="菜单">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="14" y2="15"/></svg>
        </button>
        <span class="app-bar-title-wrap"><span class="app-bar-title">农技千问</span></span>
        <div class="app-bar-right"></div>
    </header>

    <!-- 标准侧边抽屉：主内容仍在，抽屉 #drawer + 遮罩 #drawer-mask -->
    <div id="drawer-mask" aria-hidden="true"></div>
    <div id="drawer" aria-hidden="true">
        <div class="drawer-header">
            <div class="drawer-avatar"></div>
            <div class="drawer-user">
                <span class="drawer-nickname">用户</span>
                <span class="drawer-member">当前：免费版</span>
            </div>
        </div>
        <div class="drawer-content">
            <div class="section-title">账号</div>
            <div class="menu-card" data-menu="membership"><span>会员中心</span><span class="menu-card-right" id="drawerTierText">当前：-</span><span class="menu-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></span></div>
            <div class="section-title">其他</div>
            <div class="menu-card" data-menu="help"><span>帮助与反馈</span><span class="menu-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></span></div>
            <div class="menu-card" data-menu="about"><span>关于</span><span class="menu-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></span></div>
        </div>
        <div class="drawer-footer">
            <div class="menu-card drawer-logout" data-menu="logout"><span>退出登录</span></div>
            <div class="drawer-version">v1.0.0</div>
        </div>
    </div>

    <!-- 会员中心：一屏可见（默认无内部滚动条） -->
    <div id="membership-modal-backdrop" aria-hidden="true">
        <div id="membership-modal" onclick="event.stopPropagation()">
            <div class="membership-header">
                <div class="membership-title">会员中心</div>
                <button class="membership-close" type="button" data-close-membership aria-label="关闭">✕</button>
            </div>
            <div class="membership-sub" id="membershipSub"></div>
            <div class="membership-cards">
                <div class="membership-card" data-tier="plus">
                    <div class="card-top">
                        <div class="card-name">Plus</div>
                        <div class="card-price">¥19.9/月</div>
                    </div>
                    <div class="card-desc">30 次对话/天 <span class="dot">•</span> 5 次图片上传/天（Flash）</div>
                    <div class="card-desc">适合：日常问答、轻量咨询、随手拍图识别</div>
                    <button type="button" class="card-btn" data-tier="plus">开通 Plus</button>
                </div>
                <div class="membership-card" data-tier="pro">
                    <div class="card-badge">推荐</div>
                    <div class="card-top">
                        <div class="card-name">Pro</div>
                        <div class="card-price">¥29.9/月</div>
                    </div>
                    <div class="card-desc">60 次对话/天 <span class="dot">•</span> 10 次图片上传/天（Flash）</div>
                    <div class="card-desc">适合：高频使用、额度更稳、更多图片诊断</div>
                    <button type="button" class="card-btn" data-tier="pro">开通 Pro</button>
                </div>
                <div class="membership-card" data-tier="expert">
                    <div class="card-badge">推理/图片更强</div>
                    <div class="card-top">
                        <div class="card-name">专家模式</div>
                        <div class="card-price">¥99/月</div>
                    </div>
                    <div class="card-desc">80 次对话/天 <span class="dot">•</span> 20 次图片上传/天（PLUS）</div>
                    <div class="card-desc">适合：复杂问题、多图综合判断、推理更强</div>
                    <button type="button" class="card-btn" data-tier="expert">开通 专家模式</button>
                </div>
            </div>
            <div class="membership-footnote">注：1 次图片上传最多 4 张图（系统默认中等压缩，不限制用户文件大小）。</div>
        </div>
    </div>
    <div id="toast">功能开发中</div>

    <main class="main">
        <div class="messages-wrapper" id="messagesWrapper">
            <div class="empty-state" id="emptyState">
                <div class="logo"></div>
                <p class="slogan">今天有什么可以帮到你？</p>
            </div>
            <div class="messages-container" id="messagesContainer"></div>
        </div>

        <div class="input-container" id="inputContainer">
            <div id="imagePreviewContainer" class="image-preview-container" style="display: none;"></div>
            <div class="input-wrapper">
                <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                <input type="file" id="cameraInput" class="camera-input" accept="image/*" capture="environment">
                <button type="button" class="add-button" id="addButton" title="图片或拍照">+</button>
                <div class="input-area-with-hint">
                    <div class="input-area-inner">
                        <div class="voice-input-hint" id="voiceInputHint">按住说话</div>
                        <textarea id="textInput" class="text-input" placeholder="" rows="1" maxlength="2000"></textarea>
                        <div class="voice-hold-overlay" id="voiceHoldOverlay" aria-label="按住说话"></div>
                    </div>
                    <button type="button" class="btn-mic-or-keyboard" id="btnMicOrKeyboard" title="语音/键盘">
                        <span class="icon-mic"><svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 1 3 3v8a3 3 0 0 1-6 0V4a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></span>
                        <span class="icon-keyboard" style="margin-top: -3px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1.5" y="4.5" width="21" height="19" rx="2"/><rect x="5.42" y="8.42" width="1.25" height="1.25" fill="currentColor"/><rect x="11.42" y="8.42" width="1.25" height="1.25" fill="currentColor"/><rect x="17.42" y="8.42" width="1.25" height="1.25" fill="currentColor"/><rect x="5.42" y="12.42" width="1.25" height="1.25" fill="currentColor"/><rect x="11.42" y="12.42" width="1.25" height="1.25" fill="currentColor"/><rect x="17.42" y="12.42" width="1.25" height="1.25" fill="currentColor"/><line x1="5" y1="18" x2="19" y2="18" stroke="currentColor" stroke-width="1.5"/></svg></span>
                    </button>
                    <button type="button" class="btn-send btn-hidden" id="btnSend" title="发送">
                        <svg viewBox="0 0 24 24"><path d="M12 19V5"/><path d="M5 12l7-7 7 7"/></svg>
                    </button>
                    <button type="button" class="btn-stop btn-hidden" id="btnStop" title="停止">停止</button>
                </div>
            </div>
        </div>
    </main>

    <div class="voice-panel" id="voicePanel">
        <div class="voice-drag-bar"></div>
        <p class="voice-hint" id="voiceHint">按住说话</p>
        <div class="voice-waveform-wrap"><canvas class="voice-waveform" id="voiceWaveform" width="280" height="48"></canvas></div>
        <button type="button" class="voice-mic-btn" id="voiceMicBtn">
            <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 1 3 3v8a3 3 0 0 1-6 0V4a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
        </button>
    </div>

    <div class="plus-sheet-backdrop" id="plusSheetBackdrop"></div>
    <div class="plus-sheet" id="plusSheet">
        <div class="plus-sheet-content">
            <div class="plus-sheet-grid">
                <button type="button" class="plus-sheet-item" id="plusSheetGallery" data-action="upload">
                    <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                    图片上传
                </button>
                <button type="button" class="plus-sheet-item" id="plusSheetCamera" data-action="camera">
                    <svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                    拍照
                </button>
            </div>
            <div class="plus-sheet-tier" id="tier-card" role="button" tabindex="0">
                <div class="tier-left">
                    <div class="tier-name" id="tier-name">会员中心</div>
                    <div class="tier-sub" id="tier-sub">查看套餐与额度</div>
                </div>
                <div class="tier-right">升级</div>
            </div>
            <div class="plus-sheet-status" id="plusSheetStatus"></div>
        </div>
    </div>
    </div>

    <script>
        const MAX_ROUNDS = 30;
        const MAX_MESSAGES = MAX_ROUNDS * 2;
        const messagesWrapper = document.getElementById('messagesWrapper');
        const messagesContainer = document.getElementById('messagesContainer');
        const emptyState = document.getElementById('emptyState');
        const textInput = document.getElementById('textInput');
        const addButton = document.getElementById('addButton');
        const fileInput = document.getElementById('fileInput');
        const cameraInput = document.getElementById('cameraInput');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const btnMicOrKeyboard = document.getElementById('btnMicOrKeyboard');
        const btnSend = document.getElementById('btnSend');
        const btnStop = document.getElementById('btnStop');
        const voicePanel = document.getElementById('voicePanel');
        const voiceHint = document.getElementById('voiceHint');
        const voiceMicBtn = document.getElementById('voiceMicBtn');
        const voiceWaveform = document.getElementById('voiceWaveform');
        const voiceHoldOverlay = document.getElementById('voiceHoldOverlay');
        const inputContainer = document.getElementById('inputContainer');
        const plusSheet = document.getElementById('plusSheet');
        const plusSheetBackdrop = document.getElementById('plusSheetBackdrop');
        const plusSheetGallery = document.getElementById('plusSheetGallery');
        const plusSheetCamera = document.getElementById('plusSheetCamera');
        const drawer = document.getElementById('drawer');
        const drawerMask = document.getElementById('drawer-mask');
        const appBarLeft = document.getElementById('appBarLeft');

        function closeDrawer() {
            drawer.classList.remove('open');
            drawerMask.classList.remove('show');
            drawer.setAttribute('aria-hidden', 'true');
            drawerMask.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }
        function openDrawer() {
            updateTierUIEverywhere();
            drawer.classList.add('open');
            drawerMask.classList.add('show');
            drawer.setAttribute('aria-hidden', 'false');
            drawerMask.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }
        function toggleDrawer() {
            const open = drawer.classList.contains('open');
            open ? closeDrawer() : openDrawer();
        }
        closeDrawer();
        appBarLeft.addEventListener('click', toggleDrawer);
        drawerMask.addEventListener('click', closeDrawer);

        var membershipBackdrop = document.getElementById('membership-modal-backdrop');
        var toastEl = document.getElementById('toast');

        // ========== 会员额度闭环：tier 配置 + 今日用量 + 超额拦截 + 模拟开通 ==========
        var tier_config = {
            free:   { label: '免费版', chatPerDay: 10, imgPerDay: 1,  model: 'flash' },
            plus:   { label: 'Plus',   chatPerDay: 30, imgPerDay: 5,  model: 'flash' },
            pro:    { label: 'Pro',    chatPerDay: 60, imgPerDay: 10, model: 'flash' },
            expert: { label: '专家模式', chatPerDay: 80, imgPerDay: 20, model: 'plus' }
        };
        var STORAGE_KEY_TIER = 'membership_tier';
        function getTodayKey() {
            var d = new Date();
            return 'usage_' + d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        }
        function getUsage() {
            var key = getTodayKey();
            try {
                var raw = localStorage.getItem(key);
                if (raw) {
                    var o = JSON.parse(raw);
                    return { chat: (o.chat || 0) | 0, img: (o.img || 0) | 0 };
                }
            } catch (e) {}
            return { chat: 0, img: 0 };
        }
        function setUsage(chat, img) {
            var key = getTodayKey();
            localStorage.setItem(key, JSON.stringify({ chat: chat, img: img }));
        }
        function resetUsageIfNewDay() {
            var key = getTodayKey();
            var stored = localStorage.getItem('usage_date');
            if (stored !== key) {
                localStorage.setItem('usage_date', key);
                setUsage(0, 0);
                if (typeof refreshQuotaUI === 'function') refreshQuotaUI();
            }
        }
        function getCurrentTier() {
            var t = (localStorage.getItem(STORAGE_KEY_TIER) || 'free').toLowerCase();
            return tier_config[t] ? t : 'free';
        }
        function getMembership() {
            var tier = localStorage.getItem(STORAGE_KEY_TIER) || 'free';
            var exp = Number(localStorage.getItem('membership_expire_at') || 0);
            if (tier !== 'free' && exp && Date.now() > exp) {
                localStorage.setItem(STORAGE_KEY_TIER, 'free');
                localStorage.setItem('membership_expire_at', '0');
                return { tier: 'free', exp: 0 };
            }
            return { tier: tier, exp: exp };
        }
        function formatDate(ts) {
            if (!ts) return '';
            var d = new Date(ts);
            var y = d.getFullYear();
            var m = String(d.getMonth() + 1).padStart(2, '0');
            var da = String(d.getDate()).padStart(2, '0');
            return y + '-' + m + '-' + da;
        }
        function daysLeft(ts) {
            if (!ts) return 0;
            return Math.max(0, Math.ceil((ts - Date.now()) / 86400000));
        }
        function setCurrentTier(tier) {
            if (!tier_config[tier]) return;
            localStorage.setItem(STORAGE_KEY_TIER, tier);
            if (tier === 'free') {
                localStorage.setItem('membership_expire_at', '0');
            } else {
                localStorage.setItem('membership_expire_at', String(Date.now() + 30 * 86400000));
            }
            if (typeof updateDrawerFromTierAndUsage === 'function') updateDrawerFromTierAndUsage();
            if (typeof updateMembershipUI === 'function') updateMembershipUI();
        }
        function getQuota() {
            var c = tier_config[getCurrentTier()];
            return c ? { chat: c.chatPerDay, img: c.imgPerDay } : { chat: 10, img: 1 };
        }
        function checkQuotaBeforeSend(chatNeed, imgNeed) {
            resetUsageIfNewDay();
            var usage = getUsage();
            var quota = getQuota();
            var chatOk = (usage.chat + chatNeed) <= quota.chat;
            var imgOk = (usage.img + imgNeed) <= quota.img;
            return { allowed: chatOk && imgOk, chatOk: chatOk, imgOk: imgOk };
        }
        function incrementUsage(chatDelta, imgDelta) {
            resetUsageIfNewDay();
            var u = getUsage();
            setUsage(u.chat + (chatDelta || 0), u.img + (imgDelta || 0));
            updateDrawerFromTierAndUsage();
        }
        function getTierLabel(tier) {
            var map = { free: '免费版', plus: 'Plus', pro: 'Pro', expert: '专家模式' };
            return map[tier] || tier;
        }
        function updateTierUIEverywhere() {
            var tier = getCurrentTier();
            var usage = getUsage();
            var quota = getQuota();
            var chatLeft = Math.max(0, quota.chat - usage.chat);
            var imgLeft = Math.max(0, quota.img - usage.img);
            var fullText = '当前：' + getTierLabel(tier) + ' · 今日剩余 ' + chatLeft + ' 次对话 / ' + imgLeft + ' 次图片上传';
            var labelOnly = '当前：' + getTierLabel(tier);
            var drawerMember = document.querySelector('.drawer-member');
            if (drawerMember) drawerMember.textContent = labelOnly;
            var drawerTierText = document.getElementById('drawerTierText');
            if (drawerTierText) drawerTierText.textContent = labelOnly;
            var plusStatus = document.getElementById('plusSheetStatus');
            if (plusStatus) plusStatus.textContent = fullText;
        }
        function updateDrawerFromTierAndUsage() {
            resetUsageIfNewDay();
            updateTierUIEverywhere();
        }
        function setDisabled(selector, disabled) {
            var el = document.querySelector(selector);
            if (!el) return;
            el.classList.toggle('disabled', disabled);
            el.setAttribute('aria-disabled', disabled ? 'true' : 'false');
        }
        function refreshQuotaUI() {
            resetUsageIfNewDay();
            var tier = getCurrentTier();
            var usage = getUsage();
            var quota = getQuota();
            var chatLeft = quota.chat - usage.chat;
            var imgLeft = quota.img - usage.img;
            var canChat = chatLeft > 0;
            var canImg = imgLeft > 0;
            setDisabled('#btnSend', !canChat);
            setDisabled('#btnMicOrKeyboard', !canChat);
            setDisabled('#plusSheetGallery', !canImg);
            setDisabled('#plusSheetCamera', !canImg);
            if (typeof updateDrawerFromTierAndUsage === 'function') updateDrawerFromTierAndUsage();
        }
        function showToastOncePerDay(key, msg) {
            var day = getTodayKey();
            var k = 'toast_once_' + day + '_' + key;
            if (localStorage.getItem(k) === '1') return;
            localStorage.setItem(k, '1');
            showToast(msg);
        }
        function updateMembershipUI() {
            var m = getMembership();
            var tier = m.tier;
            var exp = m.exp;
            var sub = document.getElementById('membershipSub');
            if (sub) {
                if (tier === 'free') {
                    sub.textContent = '当前：免费版';
                } else {
                    sub.textContent = '当前：' + getTierLabel(tier) + ' · 到期：' + formatDate(exp) + '（剩余 ' + daysLeft(exp) + ' 天）';
                }
            }
            document.querySelectorAll('#membership-modal .membership-card').forEach(function(card) {
                var t = card.getAttribute('data-tier');
                var btn = card.querySelector('.card-btn');
                if (!btn) return;
                var isCurrent = (t === tier);
                if (isCurrent && tier !== 'free') {
                    btn.textContent = '当前已开通';
                    btn.disabled = true;
                    btn.classList.add('btn-current');
                } else {
                    btn.disabled = false;
                    btn.classList.remove('btn-current');
                    if (t === 'plus') btn.textContent = '开通 Plus';
                    else if (t === 'pro') btn.textContent = '开通 Pro';
                    else if (t === 'expert') btn.textContent = '开通 专家模式';
                }
            });
        }
        function openMembershipModal(highlightRecommended) {
            var cards = document.querySelectorAll('#membership-modal .membership-card');
            cards.forEach(function(el) {
                if (el.getAttribute('data-tier') === 'pro') el.classList.toggle('recommended-highlight', !!highlightRecommended);
                else el.classList.remove('recommended-highlight');
            });
            updateMembershipUI();
            membershipBackdrop.classList.add('open');
            membershipBackdrop.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }
        function closeMembershipModal() {
            membershipBackdrop.classList.remove('open');
            membershipBackdrop.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }
        function showToast(msg) {
            toastEl.textContent = msg != null ? msg : '功能开发中';
            toastEl.classList.add('show');
            setTimeout(function() {
                toastEl.classList.remove('show');
            }, 2000);
        }
        document.addEventListener('click', function(e) {
            if (e.target.closest('[data-close-membership]')) {
                closeMembershipModal();
                return;
            }
            if (e.target.id === 'membership-modal-backdrop') {
                closeMembershipModal();
            }
        });
        document.querySelectorAll('#membership-modal .card-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var tier = this.getAttribute('data-tier');
                if (tier && tier_config[tier]) {
                    setCurrentTier(tier);
                    closeMembershipModal();
                    showToast('开通成功');
                } else {
                    showToast('功能开发中');
                }
            });
        });

        document.querySelectorAll('#drawer .menu-card').forEach(function(el) {
            el.addEventListener('click', function() {
                var key = this.getAttribute('data-menu') || 'unknown';
                if (key === 'membership') {
                    openMembershipModal(false);
                } else {
                    console.log(key);
                }
            });
        });
        resetUsageIfNewDay();
        getMembership();
        updateDrawerFromTierAndUsage();
        refreshQuotaUI();

        document.addEventListener('click', function(e) {
            var sendBtn = document.getElementById('btnSend');
            var micBtn = document.getElementById('btnMicOrKeyboard');
            if (sendBtn && (e.target === sendBtn || sendBtn.contains(e.target))) {
                if (sendBtn.classList.contains('disabled') || sendBtn.getAttribute('aria-disabled') === 'true') {
                    e.preventDefault();
                    e.stopPropagation();
                    showToastOncePerDay('chat', '今日额度已用尽');
                    return;
                }
                if (imageState.size > 0 && !textInput.value.trim()) {
                    e.preventDefault();
                    e.stopPropagation();
                    showToastOncePerDay('img_no_text', '图片需要配合文字描述');
                    return;
                }
            }
            if (micBtn && (e.target === micBtn || micBtn.contains(e.target))) {
                if (micBtn.classList.contains('disabled') || micBtn.getAttribute('aria-disabled') === 'true') {
                    e.preventDefault();
                    e.stopPropagation();
                    showToastOncePerDay('chat', '今日额度已用尽');
                    return;
                }
            }
            var up = e.target.closest && e.target.closest('[data-action="upload"], [data-action="camera"]');
            if (up && (up.classList.contains('disabled') || up.getAttribute('aria-disabled') === 'true')) {
                e.preventDefault();
                e.stopPropagation();
                showToastOncePerDay('img', '今日图片额度已用尽');
            }
        }, true);

        let isGenerating = false;
        /** C. 4 态：idle | typing | generating | voicePanel */
        let inputMode = 'idle';
        let voiceRecording = false;
        let voiceCancelArmed = false;
        let voiceTouchStartY = 0;
        const VOICE_CANCEL_THRESHOLD_PX = 60;
        let waveformAnimId = null;
        let voicePendingTimeout = null;

        // 长聊不卡顿：窗口化 + 前端假流式（打字机）
        const RENDER_WINDOW = 80;      // 仅渲染最近 N 条
        const LOAD_MORE_BATCH = 20;    // 每次「加载更多」展开条数
        const TYPEWRITER_MS = 50;     // 打字机每片间隔（ms），避免 DOM 频繁重排
        const TYPEWRITER_CHARS = 2;   // 每片追加字符数
        const TYPEWRITER_MAX_MS = 60000; // 打字机最大时长兜底（ms），超时直接补全剩余
        const MAX_WAIT_MS = 65000;       // 全局 Watchdog：该 streamId 未在 65s 内收到 onComplete/onInterrupted 则强制中断收尾
        const chunkBufferByStream = {};
        // streamId -> 该 stream 当前累计的 buffer 全文（与 chunkBufferByStream 同步），供 onComplete 时 buffer 为空降级直出；语义是「最后一次可见的全文」非「最后一个 chunk」
        const lastFullBufferByStream = {};
        const watchdogTimerByStream = {}; // streamId -> setTimeout id，onComplete/onInterrupted 时 clear
        const terminatedStreamIds = {};   // 护栏：watchdog 触发后加入，onChunk/onComplete/onInterrupted 入口若已存在则直接 return
        const pendingDeduct = {};          // streamId -> imgUploadCount(0|1)，按次扣；onComplete 时扣后 delete，interrupted 只 delete 不扣
        const pendingRequest = {};         // streamId -> { text, imageUrls }，重试从此处取数不依赖 lastSent，连发不串单
        const deducted = {};               // streamId -> true，同一 streamId 只扣一次；24h 后清理（P2a）
        const DEDUCTED_TTL_MS = 24 * 60 * 60 * 1000;
        const PENDING_MAX_AGE_MS = 15 * 60 * 1000;  // P2b：pending 悬挂超 15 分钟自动清
        // 前端假流式：收到完整 response 后打字机分片追加；停止仅停定时器
        let typewriterState = { timerId: null, streamId: null, fullText: '', index: 0 };
        // reason → 文案（ChatGPT 风格：短句、灰字、不露技术细节）
        var reasonToCopy = {
            network: '网络不可用，点击重试。',
            timeout: '请求超时（60 秒），点击重试。',
            server: '服务繁忙，稍后重试。',
            error: '响应异常，点击重试。',
            auth: 'API 密钥无效，请检查配置。',
            quota: '余额不足，请充值后重试。',
            rate_limit: '请求过于频繁，请稍后重试。',
            bad_request: '请求参数有误，请重试。',
            canceled: '已停止生成。',
            no_network: '当前无网络，未发送。',
            cache_overflow: '请求失败，点击重试。',
            unknown: '请求失败，点击重试。'
        };
        
        // 图片状态管理（Map 保持插入顺序，发送时 URL 顺序与用户选择一致）
        const imageState = new Map(); // imageId -> {file, base64, status, url, element, currentRequestId}

        // Android 接口对象（由 WebView 注入）
        const AndroidInterface = window.AndroidInterface || {
            uploadImages: function(imageDataListJson) { console.log('uploadImages', imageDataListJson); },
            retryImage: function(imageId, requestId) { console.log('retryImage', imageId, requestId); },
            sendMessage: function(text, imageUrlsJson, streamId) { console.log('sendMessage', text, streamId); },
            stopGeneration: function() { console.log('stopGeneration'); }
        };

        // 自动调整文本域高度（最多 5 行视觉）
        textInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 110) + 'px';
            updateInputMode();
        });

        /** C. 4 态状态机：更新右侧按钮 Mic / Send / Stop 显示与禁用 */
        function updateInputMode() {
            const hasText = textInput.value.trim().length > 0;
            const voiceOpen = voicePanel.classList.contains('open');
            const inVoiceMode = inputContainer.classList.contains('voice-mode');
            const hasImages = imageState.size > 0;

            if (voiceOpen || inVoiceMode) {
                inputMode = inVoiceMode ? 'voiceMode' : 'voicePanel';
                btnMicOrKeyboard.classList.remove('btn-hidden');
                btnMicOrKeyboard.classList.add('voice-mode');
                btnSend.classList.add('btn-hidden');
                btnStop.classList.add('btn-hidden');
                textInput.placeholder = '';
            } else if (isGenerating) {
                inputMode = 'generating';
                btnMicOrKeyboard.classList.add('btn-hidden');
                btnSend.classList.add('btn-hidden');
                btnStop.classList.remove('btn-hidden');
                textInput.placeholder = '';
            } else if (hasImages && !hasText) {
                inputMode = 'typing';
                btnMicOrKeyboard.classList.add('btn-hidden');
                btnSend.classList.remove('btn-hidden');
                btnSend.disabled = true;
                btnStop.classList.add('btn-hidden');
                textInput.placeholder = '请补充文字描述后再发送';
            } else if (hasText) {
                inputMode = 'typing';
                btnMicOrKeyboard.classList.add('btn-hidden');
                btnSend.classList.remove('btn-hidden');
                btnStop.classList.add('btn-hidden');
                textInput.placeholder = '';
                var sendDisabled = false;
                if (hasImages) {
                    for (var _s of imageState.values()) {
                        if (_s.status === 'uploading' || _s.status === 'fail') {
                            sendDisabled = true;
                            break;
                        }
                    }
                }
                btnSend.disabled = sendDisabled;
            } else {
                inputMode = 'idle';
                btnMicOrKeyboard.classList.remove('btn-hidden');
                btnMicOrKeyboard.classList.remove('voice-mode');
                btnSend.classList.add('btn-hidden');
                btnStop.classList.add('btn-hidden');
                textInput.placeholder = '';
            }

            addButton.disabled = imageState.size >= 4;
            addButton.style.opacity = imageState.size >= 4 ? '0.5' : '1';
        }

        // E. + 面板：点击 + 打开 BottomSheet
        addButton.addEventListener('click', () => {
            if (imageState.size >= 4) {
                // 显示最多4张图片提示
                const tip = document.createElement('div');
                tip.className = 'image-limit-tip';
                tip.textContent = '最多可上传4张图片';
                tip.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 4px; font-size: 14px; z-index: 1000;';
                document.body.appendChild(tip);
                setTimeout(() => {
                    tip.remove();
                }, 1000);
                return;
            }
            refreshQuotaUI();
            updatePlusSheetTier();
            plusSheet.classList.add('open');
            plusSheetBackdrop.classList.add('open');
        });
        function closePlusSheet() {
            plusSheet.classList.remove('open');
            plusSheetBackdrop.classList.remove('open');
        }
        function getTierLocal() {
            if (typeof getCurrentTier === 'function') return getCurrentTier();
            return localStorage.getItem('membership_tier') || 'free';
        }
        function tierLabel(tier) {
            return ({ free: '免费版', plus: 'Plus', pro: 'Pro', expert: '专家模式' })[tier] || '免费版';
        }
        function updatePlusSheetTier() {
            var nameEl = document.getElementById('tier-name');
            var subEl = document.getElementById('tier-sub');
            if (!nameEl || !subEl) return;
            nameEl.textContent = '会员中心';
            subEl.textContent = '查看套餐与额度';
        }
        plusSheetBackdrop.addEventListener('click', closePlusSheet);
        plusSheetGallery.addEventListener('click', () => {
            closePlusSheet();
            fileInput.click();
        });
        plusSheetCamera.addEventListener('click', () => {
            closePlusSheet();
            cameraInput.click();
        });
        var tierEntry = document.getElementById('tier-card');
        if (tierEntry) {
            tierEntry.addEventListener('click', function() {
                closePlusSheet();
                openMembershipModal(false);
            });
        }

        function handleFileSelect(fileList) {
            const imageFiles = Array.from(fileList || []).filter(file => file.type.startsWith('image/'));
            const currentImageCount = imageState.size;
            const remainingSlots = Math.max(0, 4 - currentImageCount);
            const toAdd = imageFiles.slice(0, remainingSlots);
            toAdd.forEach((file) => {
                const imageId = 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                addImagePreview(imageId, file);
            });
            fileInput.value = '';
            cameraInput.value = '';
            updateInputMode();
        }
        fileInput.addEventListener('change', function() { handleFileSelect(this.files); });
        cameraInput.addEventListener('change', function() { handleFileSelect(this.files); });
        
        // 添加图片预览（缩略图用 objectURL 减少内存，base64 仅用于发给 Android）
        function addImagePreview(imageId, file) {
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.dataset.imageId = imageId;
            
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            
            const statusOverlay = document.createElement('div');
            statusOverlay.className = 'image-status-overlay';
            const statusIcon = document.createElement('div');
            statusIcon.className = 'image-status-uploading';
            statusOverlay.appendChild(statusIcon);
            
            const actions = document.createElement('div');
            actions.className = 'image-actions';
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'image-action-btn delete';
            deleteBtn.textContent = '删除';
            deleteBtn.onclick = () => removeImage(imageId);
            actions.appendChild(deleteBtn);
            
            previewItem.appendChild(img);
            previewItem.appendChild(statusOverlay);
            previewItem.appendChild(actions);
            
            imagePreviewContainer.appendChild(previewItem);
            imagePreviewContainer.style.display = 'flex';
            
            const requestId = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            // 立即写入 state，便于删除时能清理；base64 稍后填入
            imageState.set(imageId, {
                file: file,
                base64: null,
                status: 'uploading',
                url: null,
                element: previewItem,
                currentRequestId: requestId
            });
            
            // base64 仅用于首次发给 Android 上传，发完即丢，不长期保存（重试走 Android 缓存）
            const reader = new FileReader();
            reader.onload = function(e) {
                const state = imageState.get(imageId);
                if (!state) return; // 用户已删除，不再上传
                const base64 = e.target.result.split(',')[1];
                if (!base64 || base64.length < 10) return;
                uploadImage(imageId, base64, requestId);
                state.base64 = null; // 发完立刻丢，不占内存
            };
            reader.readAsDataURL(file);
        }
        
        // 上传图片（带 requestId；base64 仅首次使用）
        function uploadImage(imageId, base64, requestId) {
            const imageData = {
                imageId: imageId,
                base64: base64,
                requestId: requestId
            };
            const imageDataList = [imageData];
            AndroidInterface.uploadImages(JSON.stringify(imageDataList));
        }
        
        // 更新图片状态（仅当 imageId 仍存在且 requestId 匹配时生效；errorMessage 仅 fail 时卡片展示）
        function updateImageStatus(imageId, status, url, requestId, errorMessage) {
            const state = imageState.get(imageId);
            if (!state) return; // 已删除，忽略回调
            if (requestId != null && state.currentRequestId !== requestId) return; // 非本次尝试，忽略
            
            state.status = status;
            if (url) {
                state.url = url;
            }
            
            const statusOverlay = state.element.querySelector('.image-status-overlay');
            statusOverlay.innerHTML = '';
            
            if (status === 'uploading') {
                const spinner = document.createElement('div');
                spinner.className = 'image-status-uploading';
                statusOverlay.appendChild(spinner);
            } else if (status === 'success') {
                const checkmark = document.createElement('div');
                checkmark.className = 'image-status-success';
                checkmark.textContent = '✓';
                statusOverlay.appendChild(checkmark);
                
                const retryBtn = state.element.querySelector('.retry');
                if (retryBtn) retryBtn.remove();
                const hint = state.element.querySelector('.image-fail-hint');
                if (hint) hint.remove();
            } else if (status === 'fail') {
                const failIcon = document.createElement('div');
                failIcon.className = 'image-status-fail';
                failIcon.textContent = '✗';
                statusOverlay.appendChild(failIcon);
                
                const actions = state.element.querySelector('.image-actions');
                if (!actions.querySelector('.retry')) {
                    const retryBtn = document.createElement('button');
                    retryBtn.className = 'image-action-btn retry';
                    retryBtn.textContent = '重试';
                    retryBtn.onclick = () => retryImage(imageId);
                    actions.insertBefore(retryBtn, actions.firstChild);
                }
                if (errorMessage) {
                    let hint = state.element.querySelector('.image-fail-hint');
                    if (!hint) {
                        hint = document.createElement('div');
                        hint.className = 'image-fail-hint';
                        state.element.appendChild(hint);
                    }
                    hint.textContent = errorMessage;
                }
            }
            
            updateInputMode();
        }
        
        // 重试：只发 imageId + requestId，不传 base64；Android 用缓存 bytes 重传
        function retryImage(imageId) {
            const state = imageState.get(imageId);
            if (!state) return;
            
            const requestId = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            state.currentRequestId = requestId;
            updateImageStatus(imageId, 'uploading', null, requestId, null);
            AndroidInterface.retryImage(imageId, requestId);
        }
        
        // 删除图片：UI 立即移除，已删除图不参与发送，后续该图回调忽略
        function removeImage(imageId) {
            const state = imageState.get(imageId);
            if (state && state.element) {
                if (state.element.querySelector('img') && state.element.querySelector('img').src) {
                    URL.revokeObjectURL(state.element.querySelector('img').src);
                }
                state.element.remove();
            }
            imageState.delete(imageId);
            
            if (imageState.size === 0) {
                imagePreviewContainer.style.display = 'none';
            }
            
            updateInputMode();
        }
        
        // 接收 Android 上传状态回调（requestId 去重；errorMessage 仅 fail 时在卡片上展示）
        window.onImageUploadStatus = function(imageId, status, url, requestId, errorMessage) {
            updateImageStatus(imageId, status, url || null, requestId || null, errorMessage || null);
        };

        // 消息窗口化：仅渲染最近 RENDER_WINDOW 条，更老折叠为「加载更多」
        function applyMessageWindow() {
            const messages = messagesContainer.querySelectorAll('.message');
            const total = messages.length;
            const oldScrollTop = messagesWrapper.scrollTop;
            const oldScrollHeight = messagesWrapper.scrollHeight;
            let loadMoreEl = messagesContainer.querySelector('.load-more-placeholder');
            if (total <= RENDER_WINDOW) {
                messages.forEach(el => el.classList.remove('message-folded'));
                if (loadMoreEl) loadMoreEl.remove();
                requestAnimationFrame(function() {
                    const distFromBottom = oldScrollHeight - oldScrollTop;
                    if (distFromBottom <= 120) {
                        messagesWrapper.scrollTop = Math.max(0, messagesWrapper.scrollHeight - distFromBottom);
                    } else {
                        messagesWrapper.scrollTop = Math.min(oldScrollTop, Math.max(0, messagesWrapper.scrollHeight - messagesWrapper.clientHeight));
                    }
                });
                return;
            }
            const toFold = total - RENDER_WINDOW;
            for (let i = 0; i < toFold; i++) messages[i].classList.add('message-folded');
            for (let i = toFold; i < total; i++) messages[i].classList.remove('message-folded');
            if (!loadMoreEl) {
                loadMoreEl = document.createElement('div');
                loadMoreEl.className = 'load-more-placeholder';
                loadMoreEl.textContent = '加载更多（' + toFold + ' 条）';
                loadMoreEl.onclick = function() {
                    const oldScrollHeight = messagesWrapper.scrollHeight;
                    const oldScrollTop = messagesWrapper.scrollTop;
                    const folded = messagesContainer.querySelectorAll('.message-folded');
                    const n = Math.min(LOAD_MORE_BATCH, folded.length);
                    for (let i = 0; i < n; i++) folded[i].classList.remove('message-folded');
                    requestAnimationFrame(function() {
                        requestAnimationFrame(function() {
                            messagesWrapper.scrollTop = oldScrollTop + (messagesWrapper.scrollHeight - oldScrollHeight);
                        });
                    });
                    const remaining = messagesContainer.querySelectorAll('.message-folded').length;
                    if (remaining === 0) loadMoreEl.remove();
                    else loadMoreEl.textContent = '加载更多（' + remaining + ' 条）';
                };
                messagesContainer.insertBefore(loadMoreEl, messagesContainer.firstChild);
            }
            const remaining = messagesContainer.querySelectorAll('.message-folded').length;
            if (remaining === 0) loadMoreEl.remove();
            else loadMoreEl.textContent = '加载更多（' + remaining + ' 条）';
            requestAnimationFrame(function() {
                const distFromBottom = oldScrollHeight - oldScrollTop;
                if (distFromBottom <= 120) {
                    messagesWrapper.scrollTop = Math.max(0, messagesWrapper.scrollHeight - distFromBottom);
                } else {
                    messagesWrapper.scrollTop = Math.min(oldScrollTop, Math.max(0, messagesWrapper.scrollHeight - messagesWrapper.clientHeight));
                }
            });
        }

        // 发送消息
        function sendMessage() {
            if (btnSend.disabled) return;
            if (isGenerating) return;

            const text = textInput.value.trim();
            const hasImages = imageState.size > 0;
            if (!text) return;

            // 有图必须有文字（硬拦截，不弹窗；灰按钮点击已 toast 一次）
            if (hasImages && !text) return;

            // 验证：所有图片必须成功上传
            if (hasImages) {
                let allSuccess = true;
                for (const [imageId, state] of imageState) {
                    if (state.status !== 'success') {
                        allSuccess = false;
                        break;
                    }
                }
                if (!allSuccess) {
                    return;
                }
            }

            // URL 列表严格来自 success 状态，顺序与用户选择顺序一致（Map 插入序）
            const imageUrls = [];
            for (const [imageId, state] of imageState) {
                if (state.status === 'success' && state.url) {
                    imageUrls.push(state.url);
                }
            }

            // 额度硬拦截：无剩余直接 return，不弹会员、不 toast（toast 由点击灰按钮时提示一次）
            var imgCount = imageUrls.length;
            var quotaCheck = checkQuotaBeforeSend(1, imgCount);
            if (!quotaCheck.allowed) return;

            // 添加用户消息（右对齐，立即显示）
            const userMessage = createMessage({ 
                role: "user", 
                text: text, 
                files: null, 
                imageUrls: imageUrls,
                stream: false 
            });
            messagesContainer.appendChild(userMessage);
            hardTrimMessages();
            refreshEmptyState();
            scrollToBottom();
            applyMessageWindow();

            // 创建AI回复占位并生成 streamId（取消时旧气泡按 streamId 落终态）
            const streamId = 'stream_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            isGenerating = true;
            updateInputMode();
            const assistantMessage = createMessage({ role: "assistant", text: "", stream: true });
            assistantMessage.dataset.streamId = streamId;
            messagesContainer.appendChild(assistantMessage);
            hardTrimMessages();
            scrollToBottom();
            applyMessageWindow();

            lastSent = { text: text, imageUrls: imageUrls.slice(), streamId: streamId };
            pendingRequest[streamId] = { text: text, imageUrls: imageUrls.slice(), ts: Date.now() };
            pendingDeduct[streamId] = (imageUrls.length > 0 ? 1 : 0);

            // 发送到Android（带 streamId、模型；回调按 streamId 写对应气泡）
            sendToAndroid(text, imageUrls, streamId);
            startWatchdog(streamId);

            // 清空输入和图片预览
            textInput.value = '';
            textInput.style.height = 'auto';
            imageState.clear();
            imagePreviewContainer.innerHTML = '';
            imagePreviewContainer.style.display = 'none';
            updateInputMode();
        }

        // 发送到Android后端（streamId 写对应气泡；模型路由：专家=plus，其余=flash）
        function sendToAndroid(text, imageUrls, streamId) {
            var imageUrlsJson = imageUrls && imageUrls.length > 0 ? JSON.stringify(imageUrls) : 'null';
            var tier = getCurrentTier();
            var model = tier === 'expert' ? 'plus' : 'flash';
            if (typeof AndroidInterface.sendMessage === 'function') {
                AndroidInterface.sendMessage(text || '', imageUrlsJson, streamId || '', model);
            }
        }

        // 全局 Watchdog：65s 内该 streamId 未收到 onComplete/onInterrupted 则强制中断收尾（永不无限转圈）
        function startWatchdog(streamId) {
            if (!streamId) return;
            if (watchdogTimerByStream[streamId]) {
                clearTimeout(watchdogTimerByStream[streamId]);
                delete watchdogTimerByStream[streamId];
            }
            watchdogTimerByStream[streamId] = setTimeout(function() {
                if (watchdogTimerByStream[streamId]) {
                    clearTimeout(watchdogTimerByStream[streamId]);
                    delete watchdogTimerByStream[streamId];
                }
                terminatedStreamIds[streamId] = true;
                AndroidInterface.stopGeneration && AndroidInterface.stopGeneration();
                stopTypewriter();
                isGenerating = false;
                updateInputMode();
                delete chunkBufferByStream[streamId];
                delete lastFullBufferByStream[streamId];
                delete pendingRequest[streamId];
                delete pendingDeduct[streamId];
                applyInterruptedUI(streamId, 'timeout');
                setTimeout(function() { delete terminatedStreamIds[streamId]; }, 2 * 60 * 1000);
            }, MAX_WAIT_MS);
        }

        function clearWatchdog(streamId) {
            if (!streamId) return;
            if (watchdogTimerByStream[streamId]) {
                clearTimeout(watchdogTimerByStream[streamId]);
                delete watchdogTimerByStream[streamId];
            }
        }

        function cleanupStalePending() {
            var now = Date.now();
            Object.keys(pendingRequest).forEach(function(sid) {
                var req = pendingRequest[sid];
                if (req && req.ts != null && (now - req.ts) > PENDING_MAX_AGE_MS) {
                    delete pendingRequest[sid];
                    delete pendingDeduct[sid];
                }
            });
        }
        setInterval(cleanupStalePending, 5 * 60 * 1000);

        // 统一中断 UI：该条消息底部一行灰字 +「重试」按钮（ChatGPT 风格，不弹窗）
        function applyInterruptedUI(streamId, reason) {
            var msg = Array.from(messagesContainer.querySelectorAll('.message.assistant')).find(function(m) { return m.dataset.streamId === streamId; });
            if (!msg) return;
            msg.classList.remove('streaming');
            msg.classList.add('message-interrupted');
            var contentDiv = msg.querySelector('.message-content');
            if (!contentDiv || contentDiv.querySelector('.interrupted-badge')) return;
            var text = reasonToCopy[reason] || reasonToCopy.unknown;
            var badge = document.createElement('span');
            badge.className = 'interrupted-badge';
            badge.textContent = text;
            contentDiv.appendChild(badge);
            if (pendingRequest[streamId]) {
                var retryBtn = document.createElement('button');
                retryBtn.className = 'retry-stream-btn';
                retryBtn.textContent = '重试';
                retryBtn.onclick = function() {
                    var data = pendingRequest[streamId];
                    if (!data) return;
                    AndroidInterface.stopGeneration && AndroidInterface.stopGeneration();
                    delete chunkBufferByStream[streamId];
                    delete lastFullBufferByStream[streamId];
                    delete pendingRequest[streamId];
                    delete pendingDeduct[streamId];
                    contentDiv.innerHTML = '';
                    var newStreamId = 'stream_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    msg.dataset.streamId = newStreamId;
                    msg.classList.remove('message-interrupted');
                    var urls = data.imageUrls && data.imageUrls.slice ? data.imageUrls.slice() : (data.imageUrls || []);
                    pendingRequest[newStreamId] = { text: data.text, imageUrls: urls, ts: Date.now() };
                    pendingDeduct[newStreamId] = (urls.length > 0 ? 1 : 0);
                    lastSent = { text: data.text, imageUrls: urls, streamId: newStreamId };
                    isGenerating = true;
                    updateInputMode();
                    sendToAndroid(data.text, urls, newStreamId);
                    startWatchdog(newStreamId);
                };
                contentDiv.appendChild(retryBtn);
            }
        }

        // 停止打字机（用户点「停止」时）：仅停定时器，可选一次性补全剩余文字
        function stopTypewriter() {
            if (typewriterState.timerId) {
                clearInterval(typewriterState.timerId);
                typewriterState.timerId = null;
            }
            if (typewriterState.streamId && typewriterState.fullText && typewriterState.index < typewriterState.fullText.length) {
                const msg = Array.from(messagesContainer.querySelectorAll('.message.assistant')).find(function(m) { return m.dataset.streamId === typewriterState.streamId; });
                if (msg) {
                    const contentDiv = msg.querySelector('.message-content');
                    if (contentDiv) contentDiv.textContent += typewriterState.fullText.slice(typewriterState.index); // 仅追加剩余部分，避免重复
                    msg.classList.remove('streaming');
                }
            }
            typewriterState = { timerId: null, streamId: null, fullText: '', index: 0 };
        }

        // 前端假流式：用定时器分片追加 fullText；先停旧打字机（防旧写到新消息）；超时兜底直接补全
        function runTypewriter(streamId, fullText) {
            stopTypewriter();
            if (!streamId || !fullText) return;
            const msg = Array.from(messagesContainer.querySelectorAll('.message.assistant')).find(function(m) { return m.dataset.streamId === streamId; });
            if (!msg) return;
            const contentDiv = msg.querySelector('.message-content');
            if (!contentDiv) return;
            var typewriterStartMs = Date.now();
            typewriterState = { timerId: null, streamId: streamId, fullText: fullText, index: 0 };
            typewriterState.timerId = setInterval(function() {
                if ((Date.now() - typewriterStartMs) >= TYPEWRITER_MAX_MS) {
                    clearInterval(typewriterState.timerId);
                    typewriterState.timerId = null;
                    if (typewriterState.index < fullText.length) {
                        contentDiv.textContent += fullText.slice(typewriterState.index); // 仅追加剩余部分，避免重复
                    }
                    msg.classList.remove('streaming');
                    typewriterState = { timerId: null, streamId: null, fullText: '', index: 0 };
                    isGenerating = false;
                    fileInput.value = '';
                    updateInputMode();
                    hardTrimMessages();
                    scrollToBottom();
                    return;
                }
                var n = Math.min(TYPEWRITER_CHARS, fullText.length - typewriterState.index);
                if (n <= 0) {
                    clearInterval(typewriterState.timerId);
                    typewriterState.timerId = null;
                    msg.classList.remove('streaming');
                    typewriterState = { timerId: null, streamId: null, fullText: '', index: 0 };
                    isGenerating = false;
                    fileInput.value = '';
                    updateInputMode();
                    hardTrimMessages();
                    return;
                }
                contentDiv.textContent += fullText.slice(typewriterState.index, typewriterState.index + n);
                typewriterState.index += n;
                scrollToBottom();
            }, TYPEWRITER_MS);
        }

        // 接收后端一次性返回的完整内容（仅累积到 buffer，不直接写 DOM）
        window.onChunkReceived = function(streamId, chunk) {
            if (!streamId || !chunk) return;
            if (terminatedStreamIds[streamId]) return;
            chunkBufferByStream[streamId] = (chunkBufferByStream[streamId] || '') + chunk;
            lastFullBufferByStream[streamId] = chunkBufferByStream[streamId];
        };

        // 收到完成通知后：同一 streamId 只扣一次（deducted 防重）；再取 buffer 全文、打字机/直出、清理 pending、clear Watchdog
        window.onCompleteReceived = function(streamId) {
            if (!streamId) return;
            if (terminatedStreamIds[streamId]) return;
            if (deducted[streamId]) return;
            clearWatchdog(streamId);
            var imgUploadCount = (pendingDeduct[streamId] != null ? pendingDeduct[streamId] : 0);
            delete pendingRequest[streamId];
            delete pendingDeduct[streamId];
            incrementUsage(1, imgUploadCount);
            deducted[streamId] = true;
            setTimeout(function() { delete deducted[streamId]; }, DEDUCTED_TTL_MS);
            refreshQuotaUI();
            var hadBuffer = !!(chunkBufferByStream[streamId]);
            var fullText = (chunkBufferByStream[streamId] || '');
            if (!fullText) fullText = (lastFullBufferByStream[streamId] || '');
            delete chunkBufferByStream[streamId];
            delete lastFullBufferByStream[streamId];
            if (!fullText) {
                var msg = Array.from(messagesContainer.querySelectorAll('.message.assistant')).find(function(m) { return m.dataset.streamId === streamId; });
                if (msg) msg.classList.remove('streaming');
                isGenerating = false;
                fileInput.value = '';
                updateInputMode();
                hardTrimMessages();
                delete terminatedStreamIds[streamId];
                return;
            }
            if (hadBuffer) {
                runTypewriter(streamId, fullText);
            } else {
                var msg = Array.from(messagesContainer.querySelectorAll('.message.assistant')).find(function(m) { return m.dataset.streamId === streamId; });
                if (msg) {
                    var contentDiv = msg.querySelector('.message-content');
                    if (contentDiv) contentDiv.textContent = fullText;
                    msg.classList.remove('streaming');
                }
                scrollToBottom();
                isGenerating = false;
                fileInput.value = '';
                updateInputMode();
                hardTrimMessages();
            }
            delete terminatedStreamIds[streamId];
        };

        // 统一渲染工具结果块：同 streamId + toolName 只保留一块，重复回调则覆盖更新（定位与创建消息处一致：data-stream-id）
        function renderToolResult(streamId, toolName, text) {
            if (!streamId || toolName == null) return;
            var msg = messagesContainer.querySelector('.message.assistant[data-stream-id="' + streamId + '"]');
            if (!msg) return;
            var contentDiv = msg.querySelector('.message-content');
            if (!contentDiv) return;
            var normalized = (text != null ? (text + '') : '').replace(/\\n/g, '\n');
            var existing = contentDiv.querySelector('.tool-result[data-tool="' + toolName + '"]');
            if (existing) {
                existing.textContent = normalized;
            } else {
                var block = document.createElement('div');
                block.className = 'tool-result';
                block.setAttribute('data-tool', toolName);
                block.textContent = normalized;
                contentDiv.appendChild(block);
            }
            scrollToBottom();
        }

        // 博查联网搜索结果：仅在有结果时展示灰字块；空结果完全静默（对齐 GPT）
        window.onSearchResult = function(streamId, resultText) {
            if (resultText == null || (typeof resultText === 'string' && resultText.trim() === '')) return;
            renderToolResult(streamId, 'bocha', resultText);
        };

        // 安卓本地时间：供锚点/业务按需调用
        window.getLocalDateTimeFromAndroid = function() {
            if (typeof AndroidInterface !== 'undefined' && typeof AndroidInterface.getLocalDateTime === 'function') {
                return AndroidInterface.getLocalDateTime();
            }
            return '';
        };

        // 终态仅 badge/灰字 + 重试；开头 clear Watchdog、清理 buffer，再统一 applyInterruptedUI
        window.onStreamInterrupted = function(streamId, reason) {
            if (!streamId) return;
            if (terminatedStreamIds[streamId]) return;
            clearWatchdog(streamId);
            delete pendingRequest[streamId];
            delete pendingDeduct[streamId];
            if (typewriterState.streamId === streamId) stopTypewriter();
            isGenerating = false;
            updateInputMode();
            delete chunkBufferByStream[streamId];
            delete lastFullBufferByStream[streamId];
            applyInterruptedUI(streamId, reason);
            delete terminatedStreamIds[streamId];
        };

        // 统一消息渲染函数（用户/AI共用）
        function createMessage({ role, text, files, imageUrls, stream }) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (role === 'assistant') {
                const row = document.createElement('div');
                row.className = 'message-row';
                const avatarSlot = document.createElement('div');
                avatarSlot.className = 'avatar-slot';
                const dot = document.createElement('span');
                dot.className = 'streaming-dot';
                avatarSlot.appendChild(dot);
                row.appendChild(avatarSlot);
                row.appendChild(contentDiv);
                messageDiv.appendChild(row);
                if (stream) messageDiv.classList.add('streaming');
            } else {
                messageDiv.appendChild(contentDiv);
            }

            // 添加图片（仅用户消息支持）
            if (imageUrls && imageUrls.length > 0 && role === 'user') {
                for (let url of imageUrls) {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = 'message-image';
                    contentDiv.appendChild(img);
                }
            } else if (files && files.length > 0 && role === 'user') {
                // 兼容旧逻辑（如果传入files）
                for (let file of files) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'message-image';
                            contentDiv.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }

            // 添加文本
            if (text && role === 'user') {
                // 用户消息：立即完整显示（同步）
                const textNode = document.createTextNode(text);
                contentDiv.appendChild(textNode);
            } else if (role === 'assistant') {
                // AI消息：初始为空，等待流式渲染
                contentDiv.textContent = '';
            }

            if (role !== 'assistant') {
                messageDiv.appendChild(contentDiv);
            }
            return messageDiv;
        }

        // 滚动到底部（滚动容器为 messagesWrapper）
        function scrollToBottom() {
            messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
        }

        function hardTrimMessages() {
            if (!messagesContainer) return;
            var nodes = Array.from(messagesContainer.querySelectorAll('.message'));
            if (nodes.length <= MAX_MESSAGES) return;
            var removeCount = nodes.length - MAX_MESSAGES;
            for (var i = 0; i < removeCount; i++) {
                nodes[i].remove();
            }
        }
        function refreshEmptyState() {
            const hasMessages = messagesContainer.querySelectorAll('.message').length > 0;
            emptyState.classList.toggle('hidden', hasMessages);
        }

        // 同一位置切换：语音键/键盘键（麦克风键只做切换，不打开面板；录音由按住输入框触发）
        btnMicOrKeyboard.addEventListener('click', function() {
            if (voicePanel.classList.contains('open')) {
                stopVoice();
                textInput.focus();
                return;
            }
            if (inputContainer.classList.contains('voice-mode')) {
                inputContainer.classList.remove('voice-mode');
                updateInputMode();
                textInput.focus();
            } else {
                inputContainer.classList.add('voice-mode');
                updateInputMode();
            }
        });

        // C. Stop：只停前端（stopTypewriter + 状态）；stopGeneration 保留调用但不依赖其中断后端
        btnStop.addEventListener('click', function() {
            stopTypewriter();
            isGenerating = false;
            updateInputMode();
            if (typeof AndroidInterface.stopGeneration === 'function') {
                AndroidInterface.stopGeneration();
            }
        });

        /** P0-6: 幂等复位，任一退出事件调用 */
        function stopVoice() {
            if (!voicePanel.classList.contains('open') && !voiceRecording) return;
            voiceRecording = false;
            voiceCancelArmed = false;
            if (voicePendingTimeout) { clearTimeout(voicePendingTimeout); voicePendingTimeout = null; }
            voicePanel.classList.remove('open');
            document.body.classList.remove('voice-panel-open');
            inputContainer.classList.remove('voice-mode');
            voicePanel.classList.remove('cancel-armed');
            voiceHint.textContent = '按住说话';
            stopWaveform();
            removeVoiceRecordingListeners();
            removeVoiceExitListeners();
            updateInputMode();
        }
        function addVoiceExitListeners() {
            document.addEventListener('pointerup', _onVoiceExit);
            document.addEventListener('pointercancel', _onVoiceExit);
            window.addEventListener('blur', _onVoiceExit);
            document.addEventListener('visibilitychange', _onVoiceExitHidden);
        }
        function removeVoiceExitListeners() {
            document.removeEventListener('pointerup', _onVoiceExit);
            document.removeEventListener('pointercancel', _onVoiceExit);
            window.removeEventListener('blur', _onVoiceExit);
            document.removeEventListener('visibilitychange', _onVoiceExitHidden);
        }
        function _onVoiceExit(e) {
            if (!voicePanel.classList.contains('open')) return;
            if (e && (e.target === voiceMicBtn || voiceMicBtn.contains(e.target))) return;
            if (e && voiceHoldOverlay && (e.target === voiceHoldOverlay || voiceHoldOverlay.contains(e.target))) return;
            stopVoice();
        }
        function _onVoiceExitHidden() { if (document.hidden) stopVoice(); }

        // D. VoicePanel：按住输入框才录音，弹出面板显示蓝态/红态提示（松手发送上滑取消 / 松手取消）
        function getTouchY(e) {
            if (e.touches && e.touches.length) return e.touches[0].clientY;
            return e.clientY;
        }
        function addVoiceRecordingListeners() {
            document.addEventListener('touchmove', onVoiceMove, { passive: true });
            document.addEventListener('mousemove', onVoiceMove);
            document.addEventListener('touchend', onVoiceEnd);
            document.addEventListener('mouseup', onVoiceEnd);
        }
        function removeVoiceRecordingListeners() {
            document.removeEventListener('touchmove', onVoiceMove);
            document.removeEventListener('mousemove', onVoiceMove);
            document.removeEventListener('touchend', onVoiceEnd);
            document.removeEventListener('mouseup', onVoiceEnd);
        }
        function onVoiceMove(e) {
            if (!voiceRecording) return;
            const y = getTouchY(e);
            const delta = voiceTouchStartY - y;
            if (delta > VOICE_CANCEL_THRESHOLD_PX && !voiceCancelArmed) {
                voiceCancelArmed = true;
                voicePanel.classList.add('cancel-armed');
                voiceHint.textContent = '松手取消';
                startWaveform(true, true);
            }
        }

        function onVoiceStart(e) {
            e.preventDefault();
            if (e.type === 'touchstart') voiceTouchStartY = e.touches[0].clientY;
            else voiceTouchStartY = e.clientY;
            voiceRecording = true;
            voiceCancelArmed = false;
            voicePanel.classList.remove('cancel-armed');
            voiceHint.textContent = '松手发送，上滑取消';
            voicePanel.classList.add('open');
            document.body.classList.add('voice-panel-open');
            addVoiceExitListeners();
            addVoiceRecordingListeners();
            startWaveform(true, false);
        }

        function onVoiceEnd(e) {
            if (!voiceRecording) return;
            e.preventDefault();
            voiceRecording = false;
            removeVoiceRecordingListeners();
            voicePanel.classList.remove('cancel-armed');
            voiceHint.textContent = '按住说话';
            stopWaveform();
            if (voiceCancelArmed) {
                voicePanel.classList.remove('open');
                document.body.classList.remove('voice-panel-open');
                removeVoiceExitListeners();
                updateInputMode();
                return;
            }
            if (voicePendingTimeout) clearTimeout(voicePendingTimeout);
            voicePendingTimeout = setTimeout(function() {
                voicePendingTimeout = null;
                finishVoiceSend('语音输入的消息');
            }, 600);
            if (typeof window.onVoiceRecognized === 'function') {
                var t = window.onVoiceRecognized();
                if (t != null && t !== undefined) {
                    if (voicePendingTimeout) { clearTimeout(voicePendingTimeout); voicePendingTimeout = null; }
                    finishVoiceSend(t);
                    return;
                }
            }
        }
        if (voiceHoldOverlay) {
            voiceHoldOverlay.addEventListener('mousedown', onVoiceStart);
            voiceHoldOverlay.addEventListener('touchstart', onVoiceStart, { passive: true });
        }
        window.onVoiceResult = function(text) {
            if (voicePendingTimeout) { clearTimeout(voicePendingTimeout); voicePendingTimeout = null; }
            finishVoiceSend(text);
        };

        function finishVoiceSend(text) {
            removeVoiceExitListeners();
            voicePanel.classList.remove('open');
            document.body.classList.remove('voice-panel-open');
            inputContainer.classList.remove('voice-mode');
            updateInputMode();
            if (!text || !String(text).trim()) {
                showToastOncePerDay('voice_empty', '未识别到内容');
                voiceHint.textContent = '按住说话';
                return;
            }
            var t = String(text).trim();
            textInput.value = t;
            updateInputMode();
            sendMessage();
        }

        // D4. 波形 Canvas（细条、轻微浮动，不抢注意力）
        const WAVE_BARS = 32;
        let waveBarsHeights = Array(WAVE_BARS).fill(0.35);
        let wavePhase = 0;

        function startWaveform(recording, cancelArmed) {
            stopWaveform();
            const ctx = voiceWaveform.getContext('2d');
            const w = voiceWaveform.width;
            const h = voiceWaveform.height;
            const barW = Math.max(2, (w / WAVE_BARS) * 0.32);
            const gap = w / WAVE_BARS - barW;
            const color = cancelArmed ? '#E14B4B' : (recording ? '#000000' : '#D9D9D9');
            const amp = cancelArmed ? 0.2 : (recording ? 0.28 : 0.15);

            function draw() {
                wavePhase += recording ? 0.08 : 0.03;
                ctx.clearRect(0, 0, w, h);
                for (let i = 0; i < WAVE_BARS; i++) {
                    const t = Math.sin(wavePhase + i * 0.35) * 0.5 + 0.5;
                    waveBarsHeights[i] = waveBarsHeights[i] * 0.88 + t * amp * 0.12;
                    const barH = Math.max(2, h * waveBarsHeights[i] * 0.5);
                    const x = i * (barW + gap) + gap * 0.5;
                    ctx.fillStyle = color;
                    ctx.fillRect(x, (h - barH) / 2, barW, barH);
                }
                waveformAnimId = requestAnimationFrame(draw);
            }
            draw();
        }

        function stopWaveform() {
            if (waveformAnimId) {
                cancelAnimationFrame(waveformAnimId);
                waveformAnimId = null;
            }
        }


        updateInputMode();
        refreshEmptyState();

        btnSend.addEventListener('click', sendMessage);

        textInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
