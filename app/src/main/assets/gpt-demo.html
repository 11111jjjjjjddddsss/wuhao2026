<!-- UI_VERSION: phone-shell-20250128 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
    <title>农技千问</title>
    <style>
        /* B. 颜色与尺寸（硬值） */
        :root {
            --debug-shell: 0;
            --green: #169C5C;
            --green-accent: #1FAE6A;
            --bg: #FFFFFF;
            --border: #EDEDED;
            --text: #111111;
            --text-secondary: #8C8C8C;
            --text-disabled: #BDBDBD;
            --danger: #E14B4B;
            --stop-bg: #F4F4F4;
            --divider: #F2F2F2;
            --placeholder: #9B9B9B;
            --input-radius: 22px;
            --btn-circle-size: 40px;
            --input-min-height: 56px;
            --transition-fast: 180ms ease;
            --transition-sheet: 240ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 16px;
            line-height: 1.4;
            background-color: #F6F6F6;
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        .app-shell {
            width: min(100vw, 430px);
            max-width: 430px;
            height: 100vh;
            margin: 0 auto;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            position: relative;
            outline: calc(var(--debug-shell) * 1px) solid red;
        }

        @media (orientation: landscape) {
            .app-shell {
                max-width: 520px;
                width: min(100vw, 520px);
            }
        }

        /* A. 顶部 AppBar + H. 标题 */
        .app-bar {
            flex-shrink: 0;
            height: 56px;
            padding: env(safe-area-inset-top) 12px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--divider);
            background: var(--bg);
        }
        .app-bar-left, .app-bar-right {
            width: var(--btn-circle-size);
            height: var(--btn-circle-size);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--text);
            border-radius: 50%;
        }
        .app-bar-left:hover, .app-bar-right:hover {
            background: rgba(0,0,0,0.05);
        }
        .app-bar-title {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.3px;
            color: var(--text);
        }
        .app-bar svg {
            width: 22px;
            height: 22px;
            stroke: var(--text);
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        .main {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .messages-wrapper {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        .messages-container {
            display: flex;
            flex-direction: column;
            padding: 16px;
            padding-bottom: calc(88px + env(safe-area-inset-bottom, 0px));
            min-height: 100%;
        }

        /* G. 空态（P0-2：无大球，文字左对齐） */
        .empty-state {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            padding: 40px 24px 24px;
            pointer-events: none;
        }
        .empty-state.hidden {
            display: none;
        }
        .empty-state .logo {
            display: none;
        }
        .empty-state .slogan {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            text-align: left;
        }

        /* 气泡 ChatGPT 风格：留白大、角圆、阴影轻 */
        .message {
            margin-bottom: 20px;
            max-width: 85%;
        }

        .message:last-child {
            margin-bottom: 0;
        }

        .message.user {
            align-self: flex-end;
            margin-left: auto;
        }

        .message.assistant {
            align-self: flex-start;
        }

        /* P0-1: 左侧生成中跳动绿球 */
        .message.assistant .message-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .message.assistant .avatar-slot {
            flex-shrink: 0;
            width: 12px;
            height: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 14px;
        }
        .message.assistant .streaming-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--green);
            opacity: 0;
            pointer-events: none;
        }
        .message.assistant.streaming .streaming-dot {
            opacity: 1;
            animation: dot-breathe 1s ease-in-out infinite;
        }
        @keyframes dot-breathe {
            0%, 100% { transform: scale(0.9); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        .message-content {
            line-height: 1.5;
            font-size: 16px;
            font-weight: 400;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-width: 100%;
            color: var(--text);
            padding: 14px 18px;
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .message.user .message-content {
            text-align: right;
            background: var(--green);
            color: #fff;
        }

        .message.assistant .message-content {
            text-align: left;
            background: #f4f4f4;
            color: var(--text);
        }

        .message-image {
            max-width: 100%;
            margin: 12px 0;
            display: block;
            border-radius: 4px;
        }

        .image-preview-container {
            padding: 8px 12px;
            background-color: #f9f9f9;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 120px;
            overflow-y: auto;
        }

        .image-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #e0e0e0;
            flex-shrink: 0;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-status-overlay {
            position: absolute;
            top: 0;
            right: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 0 0 0 8px;
        }

        .image-status-uploading {
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .image-status-success {
            color: #4caf50;
            font-size: 16px;
            font-weight: bold;
        }

        .image-status-fail {
            color: #f44336;
            font-size: 16px;
            font-weight: bold;
        }

        .image-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 4px;
            padding: 4px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
        }

        .image-action-btn {
            flex: 1;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.9);
            color: #111;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }

        .image-action-btn:hover {
            background-color: rgba(255, 255, 255, 1);
        }

        .image-action-btn.delete {
            background-color: rgba(244, 67, 54, 0.9);
            color: white;
        }

        .image-action-btn.delete:hover {
            background-color: rgba(244, 67, 54, 1);
        }

        .image-fail-hint {
            position: absolute;
            bottom: 28px;
            left: 4px;
            right: 4px;
            font-size: 10px;
            color: #f44336;
            text-align: center;
            background: rgba(0,0,0,0.6);
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* F. 底部输入区 */
        .input-container {
            flex-shrink: 0;
            min-height: var(--input-min-height);
            background: var(--bg);
            border-top: 1px solid var(--border);
            padding: 10px 14px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            min-height: 44px;
        }

        .file-input, .camera-input {
            display: none;
        }

        .add-button, .btn-mic, .btn-send, .btn-stop {
            width: var(--btn-circle-size);
            height: var(--btn-circle-size);
            min-width: var(--btn-circle-size);
            min-height: var(--btn-circle-size);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform var(--transition-fast), background-color var(--transition-fast);
        }
        .add-button:active, .btn-mic:active, .btn-send:active, .btn-stop:active {
            transform: scale(0.98);
        }

        .add-button {
            min-width: 44px;
            min-height: 44px;
            width: 44px;
            height: 44px;
            background: rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            color: var(--text);
            font-size: 24px;
            font-weight: 300;
        }
        .add-button:hover {
            background: rgba(0,0,0,0.08);
        }
        .add-button:active {
            transform: scale(0.96);
            box-shadow: 0 0 0 rgba(0,0,0,0.04);
        }
        .btn-mic {
            background: none;
            color: var(--text);
            font-size: 24px;
            font-weight: 300;
        }
        .btn-mic svg {
            width: 22px;
            height: 22px;
            stroke: var(--text);
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        .btn-mic:hover {
            background: rgba(0,0,0,0.05);
        }

        .btn-send {
            background: var(--green);
            color: #fff;
        }
        .btn-send:hover {
            background: var(--green-accent);
        }
        .btn-send svg {
            width: 20px;
            height: 20px;
            stroke: #fff;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        /* P0-7: 黑圆+绿方 */
        .btn-stop {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            background: #111;
            color: var(--text);
            border-radius: 999px;
        }
        .btn-stop:hover {
            background: #222;
        }
        .btn-stop svg {
            width: 14px;
            height: 14px;
            fill: var(--green);
        }

        .input-area-buttons .btn-mic,
        .input-area-buttons .btn-send,
        .input-area-buttons .btn-stop {
            transition: opacity var(--transition-fast);
        }
        .input-area-buttons .btn-hidden {
            display: none !important;
        }

        .text-input {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--input-radius);
            padding: 12px 16px;
            color: var(--text);
            font-size: 16px;
            font-weight: 400;
            line-height: 1.35;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            outline: none;
            -webkit-font-smoothing: antialiased;
        }
        .text-input::placeholder {
            color: var(--placeholder);
        }
        .text-input:focus {
            border-color: var(--green);
        }
        .text-input::-webkit-resizer {
            display: none;
        }
        .text-input::-webkit-scrollbar {
            width: 4px;
        }
        .text-input::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 2px;
        }

        .typing-indicator {
            display: inline-block;
            color: #666;
        }

        .interrupted-badge {
            color: #999;
            font-size: 13px;
            margin-left: 4px;
        }
        .retry-stream-btn {
            margin-left: 8px;
            padding: 2px 10px;
            font-size: 13px;
            border: 1px solid var(--green);
            border-radius: 4px;
            background: transparent;
            color: var(--green);
            cursor: pointer;
        }
        .retry-stream-btn:hover {
            background: rgba(22, 156, 92, 0.08);
        }

        .message-folded {
            display: none;
        }

        .load-more-placeholder {
            padding: 12px;
            text-align: center;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .messages-container::-webkit-scrollbar {
            width: 4px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
        }

        /* D. VoicePanel */
        .voice-panel {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            padding: 12px 16px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
            transform: translateY(100%);
            transition: transform var(--transition-sheet);
            z-index: 100;
            max-height: 260px;
        }
        .voice-panel.open {
            transform: translateY(0);
        }
        .voice-panel.cancel-armed {
            background: rgba(225, 75, 75, 0.06);
        }
        .voice-drag-bar {
            width: 36px;
            height: 4px;
            background: #D9D9D9;
            border-radius: 2px;
            margin: 0 auto 16px;
        }
        .voice-hint {
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            min-height: 40px;
        }
        .voice-waveform-wrap {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 48px;
            margin-bottom: 16px;
        }
        .voice-waveform {
            display: block;
            width: 100%;
            max-width: 280px;
            height: 48px;
        }
        .voice-mic-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid var(--green);
            background: var(--bg);
            color: var(--green);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            cursor: pointer;
            transition: background var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast);
            -webkit-user-select: none;
            user-select: none;
        }
        .voice-mic-btn.recording {
            background: var(--green);
            color: #fff;
            border-color: var(--green);
        }
        .voice-mic-btn.cancel-armed {
            background: var(--danger);
            color: #fff;
            border-color: var(--danger);
        }
        .voice-mic-btn svg {
            width: 36px;
            height: 36px;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        .voice-panel-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 8px;
        }
        .btn-keyboard {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            border-radius: 50%;
            background: var(--bg);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .btn-keyboard svg {
            width: 20px;
            height: 20px;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        /* E. + 面板 BottomSheet */
        .plus-sheet-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-sheet), visibility var(--transition-sheet);
            z-index: 98;
        }
        .plus-sheet-backdrop.open {
            opacity: 1;
            visibility: visible;
        }
        .plus-sheet {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg);
            border-radius: 18px 18px 0 0;
            padding: 24px 20px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
            transform: translateY(100%);
            transition: transform var(--transition-sheet);
            z-index: 99;
        }
        .plus-sheet.open {
            transform: translateY(0);
        }
        .plus-sheet-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px 24px;
        }
        .plus-sheet-item {
            height: 56px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 0 16px;
            cursor: pointer;
            border: none;
            background: rgba(0,0,0,0.04);
            border-radius: 12px;
            font-size: 16px;
            color: var(--text);
            text-align: center;
            transition: background var(--transition-fast);
        }
        .plus-sheet-item:hover {
            background: rgba(0,0,0,0.08);
        }
        .plus-sheet-item:active {
            background: rgba(0,0,0,0.06);
        }
        .plus-sheet-item svg {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            stroke: var(--text);
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
    </style>
</head>
<body>
    <div class="app-shell" id="app">
    <header class="app-bar">
        <button type="button" class="app-bar-left" id="appBarLeft" aria-label="菜单">
            <svg viewBox="0 0 24 24"><path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/></svg>
        </button>
        <span class="app-bar-title">农技千问</span>
        <div class="app-bar-right"></div>
    </header>

    <main class="main">
        <div class="messages-wrapper" id="messagesWrapper">
            <div class="empty-state" id="emptyState">
                <div class="logo"></div>
                <p class="slogan">今天有什么可以帮到你？</p>
            </div>
            <div class="messages-container" id="messagesContainer"></div>
        </div>

        <div class="input-container">
            <div id="imagePreviewContainer" class="image-preview-container" style="display: none;"></div>
            <div class="input-wrapper">
                <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                <input type="file" id="cameraInput" class="camera-input" accept="image/*" capture="environment">
                <button type="button" class="add-button" id="addButton" title="图片或拍照">+</button>
                <textarea id="textInput" class="text-input" placeholder="给农技千问发消息" rows="1" maxlength="2000"></textarea>
                <div class="input-area-buttons">
                    <button type="button" class="btn-mic" id="btnMic" title="语音">
                        <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 1 3 3v8a3 3 0 0 1-6 0V4a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                    </button>
                    <button type="button" class="btn-send btn-hidden" id="btnSend" title="发送">
                        <svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
                    </button>
                    <button type="button" class="btn-stop btn-hidden" id="btnStop" title="停止">
                        <svg viewBox="0 0 24 24"><rect x="5" y="5" width="14" height="14" rx="2.5" fill="currentColor"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div class="voice-panel" id="voicePanel">
        <div class="voice-panel-header">
            <button type="button" class="btn-keyboard" id="btnKeyboard" title="键盘">
                <svg viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2"/><line x1="6" y1="10" x2="6.01" y2="10"/><line x1="10" y1="10" x2="10.01" y2="10"/><line x1="14" y1="10" x2="14.01" y2="10"/><line x1="18" y1="10" x2="18.01" y2="10"/><line x1="8" y1="14" x2="16" y2="14"/></svg>
            </button>
        </div>
        <div class="voice-drag-bar"></div>
        <p class="voice-hint" id="voiceHint">按住说话</p>
        <div class="voice-waveform-wrap"><canvas class="voice-waveform" id="voiceWaveform" width="280" height="48"></canvas></div>
        <button type="button" class="voice-mic-btn" id="voiceMicBtn">
            <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 1 3 3v8a3 3 0 0 1-6 0V4a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
        </button>
    </div>

    <div class="plus-sheet-backdrop" id="plusSheetBackdrop"></div>
    <div class="plus-sheet" id="plusSheet">
        <div class="plus-sheet-grid">
            <button type="button" class="plus-sheet-item" id="plusSheetGallery">
                <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                图片
            </button>
            <button type="button" class="plus-sheet-item" id="plusSheetCamera">
                <svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                拍照
            </button>
        </div>
    </div>
    </div>

    <script>
        const messagesWrapper = document.getElementById('messagesWrapper');
        const messagesContainer = document.getElementById('messagesContainer');
        const emptyState = document.getElementById('emptyState');
        const textInput = document.getElementById('textInput');
        const addButton = document.getElementById('addButton');
        const fileInput = document.getElementById('fileInput');
        const cameraInput = document.getElementById('cameraInput');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const btnMic = document.getElementById('btnMic');
        const btnSend = document.getElementById('btnSend');
        const btnStop = document.getElementById('btnStop');
        const voicePanel = document.getElementById('voicePanel');
        const voiceHint = document.getElementById('voiceHint');
        const voiceMicBtn = document.getElementById('voiceMicBtn');
        const voiceWaveform = document.getElementById('voiceWaveform');
        const btnKeyboard = document.getElementById('btnKeyboard');
        const plusSheet = document.getElementById('plusSheet');
        const plusSheetBackdrop = document.getElementById('plusSheetBackdrop');
        const plusSheetGallery = document.getElementById('plusSheetGallery');
        const plusSheetCamera = document.getElementById('plusSheetCamera');

        let isGenerating = false;
        /** C. 4 态：idle | typing | generating | voicePanel */
        let inputMode = 'idle';
        let voiceRecording = false;
        let voiceCancelArmed = false;
        let voiceTouchStartY = 0;
        const VOICE_CANCEL_THRESHOLD_PX = 60;
        let waveformAnimId = null;
        let voicePendingTimeout = null;

        // 长聊不卡顿：窗口化 + SSE 节流（常量，便于验证）
        const RENDER_WINDOW = 80;      // 仅渲染最近 N 条
        const LOAD_MORE_BATCH = 20;    // 每次「加载更多」展开条数
        const CHUNK_FLUSH_MS = 60;    // SSE chunk 合并间隔（ms），避免每 token 重排
        const chunkBufferByStream = {};
        const chunkFlushScheduledByStream = {};
        
        // 图片状态管理（Map 保持插入顺序，发送时 URL 顺序与用户选择一致）
        const imageState = new Map(); // imageId -> {file, base64, status, url, element, currentRequestId}

        // Android 接口对象（由 WebView 注入）
        const AndroidInterface = window.AndroidInterface || {
            uploadImages: function(imageDataListJson) { console.log('uploadImages', imageDataListJson); },
            retryImage: function(imageId, requestId) { console.log('retryImage', imageId, requestId); },
            sendMessage: function(text, imageUrlsJson, streamId) { console.log('sendMessage', text, streamId); },
            stopGeneration: function() { console.log('stopGeneration'); }
        };

        // 自动调整文本域高度（最多 5 行视觉）
        textInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            updateInputMode();
        });

        /** C. 4 态状态机：更新右侧按钮 Mic / Send / Stop 显示与禁用 */
        function updateInputMode() {
            const hasText = textInput.value.trim().length > 0;
            const voiceOpen = voicePanel.classList.contains('open');

            if (voiceOpen) {
                inputMode = 'voicePanel';
                btnMic.classList.add('btn-hidden');
                btnSend.classList.add('btn-hidden');
                btnStop.classList.add('btn-hidden');
            } else if (isGenerating) {
                inputMode = 'generating';
                btnMic.classList.add('btn-hidden');
                btnSend.classList.add('btn-hidden');
                btnStop.classList.remove('btn-hidden');
            } else if (hasText) {
                inputMode = 'typing';
                btnMic.classList.add('btn-hidden');
                btnSend.classList.remove('btn-hidden');
                btnStop.classList.add('btn-hidden');
                let sendDisabled = false;
                if (imageState.size > 0) {
                    for (const [, state] of imageState) {
                        if (state.status === 'uploading' || state.status === 'fail') {
                            sendDisabled = true;
                            break;
                        }
                    }
                }
                btnSend.disabled = sendDisabled;
            } else {
                inputMode = 'idle';
                btnMic.classList.remove('btn-hidden');
                btnSend.classList.add('btn-hidden');
                btnStop.classList.add('btn-hidden');
            }

            addButton.disabled = imageState.size >= 4;
            addButton.style.opacity = imageState.size >= 4 ? '0.5' : '1';
        }

        // E. + 面板：点击 + 打开 BottomSheet
        addButton.addEventListener('click', () => {
            if (imageState.size >= 4) return;
            plusSheet.classList.add('open');
            plusSheetBackdrop.classList.add('open');
        });
        function closePlusSheet() {
            plusSheet.classList.remove('open');
            plusSheetBackdrop.classList.remove('open');
        }
        plusSheetBackdrop.addEventListener('click', closePlusSheet);
        plusSheetGallery.addEventListener('click', () => {
            closePlusSheet();
            fileInput.click();
        });
        plusSheetCamera.addEventListener('click', () => {
            closePlusSheet();
            cameraInput.click();
        });

        function handleFileSelect(fileList) {
            const imageFiles = Array.from(fileList || []).filter(file => file.type.startsWith('image/'));
            const currentImageCount = imageState.size;
            const remainingSlots = Math.max(0, 4 - currentImageCount);
            const toAdd = imageFiles.slice(0, remainingSlots);
            toAdd.forEach((file) => {
                const imageId = 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                addImagePreview(imageId, file);
            });
            fileInput.value = '';
            cameraInput.value = '';
            updateInputMode();
        }
        fileInput.addEventListener('change', function() { handleFileSelect(this.files); });
        cameraInput.addEventListener('change', function() { handleFileSelect(this.files); });
        
        // 添加图片预览（缩略图用 objectURL 减少内存，base64 仅用于发给 Android）
        function addImagePreview(imageId, file) {
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.dataset.imageId = imageId;
            
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            
            const statusOverlay = document.createElement('div');
            statusOverlay.className = 'image-status-overlay';
            const statusIcon = document.createElement('div');
            statusIcon.className = 'image-status-uploading';
            statusOverlay.appendChild(statusIcon);
            
            const actions = document.createElement('div');
            actions.className = 'image-actions';
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'image-action-btn delete';
            deleteBtn.textContent = '删除';
            deleteBtn.onclick = () => removeImage(imageId);
            actions.appendChild(deleteBtn);
            
            previewItem.appendChild(img);
            previewItem.appendChild(statusOverlay);
            previewItem.appendChild(actions);
            
            imagePreviewContainer.appendChild(previewItem);
            imagePreviewContainer.style.display = 'flex';
            
            const requestId = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            // 立即写入 state，便于删除时能清理；base64 稍后填入
            imageState.set(imageId, {
                file: file,
                base64: null,
                status: 'uploading',
                url: null,
                element: previewItem,
                currentRequestId: requestId
            });
            
            // base64 仅用于首次发给 Android 上传，发完即丢，不长期保存（重试走 Android 缓存）
            const reader = new FileReader();
            reader.onload = function(e) {
                const state = imageState.get(imageId);
                if (!state) return; // 用户已删除，不再上传
                const base64 = e.target.result.split(',')[1];
                if (!base64 || base64.length < 10) return;
                uploadImage(imageId, base64, requestId);
                state.base64 = null; // 发完立刻丢，不占内存
            };
            reader.readAsDataURL(file);
        }
        
        // 上传图片（带 requestId；base64 仅首次使用）
        function uploadImage(imageId, base64, requestId) {
            const imageData = {
                imageId: imageId,
                base64: base64,
                requestId: requestId
            };
            const imageDataList = [imageData];
            AndroidInterface.uploadImages(JSON.stringify(imageDataList));
        }
        
        // 更新图片状态（仅当 imageId 仍存在且 requestId 匹配时生效；errorMessage 仅 fail 时卡片展示）
        function updateImageStatus(imageId, status, url, requestId, errorMessage) {
            const state = imageState.get(imageId);
            if (!state) return; // 已删除，忽略回调
            if (requestId != null && state.currentRequestId !== requestId) return; // 非本次尝试，忽略
            
            state.status = status;
            if (url) {
                state.url = url;
            }
            
            const statusOverlay = state.element.querySelector('.image-status-overlay');
            statusOverlay.innerHTML = '';
            
            if (status === 'uploading') {
                const spinner = document.createElement('div');
                spinner.className = 'image-status-uploading';
                statusOverlay.appendChild(spinner);
            } else if (status === 'success') {
                const checkmark = document.createElement('div');
                checkmark.className = 'image-status-success';
                checkmark.textContent = '✓';
                statusOverlay.appendChild(checkmark);
                
                const retryBtn = state.element.querySelector('.retry');
                if (retryBtn) retryBtn.remove();
                const hint = state.element.querySelector('.image-fail-hint');
                if (hint) hint.remove();
            } else if (status === 'fail') {
                const failIcon = document.createElement('div');
                failIcon.className = 'image-status-fail';
                failIcon.textContent = '✗';
                statusOverlay.appendChild(failIcon);
                
                const actions = state.element.querySelector('.image-actions');
                if (!actions.querySelector('.retry')) {
                    const retryBtn = document.createElement('button');
                    retryBtn.className = 'image-action-btn retry';
                    retryBtn.textContent = '重试';
                    retryBtn.onclick = () => retryImage(imageId);
                    actions.insertBefore(retryBtn, actions.firstChild);
                }
                if (errorMessage) {
                    let hint = state.element.querySelector('.image-fail-hint');
                    if (!hint) {
                        hint = document.createElement('div');
                        hint.className = 'image-fail-hint';
                        state.element.appendChild(hint);
                    }
                    hint.textContent = errorMessage;
                }
            }
            
            updateInputMode();
        }
        
        // 重试：只发 imageId + requestId，不传 base64；Android 用缓存 bytes 重传
        function retryImage(imageId) {
            const state = imageState.get(imageId);
            if (!state) return;
            
            const requestId = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            state.currentRequestId = requestId;
            updateImageStatus(imageId, 'uploading', null, requestId, null);
            AndroidInterface.retryImage(imageId, requestId);
        }
        
        // 删除图片：UI 立即移除，已删除图不参与发送，后续该图回调忽略
        function removeImage(imageId) {
            const state = imageState.get(imageId);
            if (state && state.element) {
                if (state.element.querySelector('img') && state.element.querySelector('img').src) {
                    URL.revokeObjectURL(state.element.querySelector('img').src);
                }
                state.element.remove();
            }
            imageState.delete(imageId);
            
            if (imageState.size === 0) {
                imagePreviewContainer.style.display = 'none';
            }
            
            updateInputMode();
        }
        
        // 接收 Android 上传状态回调（requestId 去重；errorMessage 仅 fail 时在卡片上展示）
        window.onImageUploadStatus = function(imageId, status, url, requestId, errorMessage) {
            updateImageStatus(imageId, status, url || null, requestId || null, errorMessage || null);
        };

        // 消息窗口化：仅渲染最近 RENDER_WINDOW 条，更老折叠为「加载更多」
        function applyMessageWindow() {
            const messages = messagesContainer.querySelectorAll('.message');
            const total = messages.length;
            const oldScrollTop = messagesWrapper.scrollTop;
            const oldScrollHeight = messagesWrapper.scrollHeight;
            let loadMoreEl = messagesContainer.querySelector('.load-more-placeholder');
            if (total <= RENDER_WINDOW) {
                messages.forEach(el => el.classList.remove('message-folded'));
                if (loadMoreEl) loadMoreEl.remove();
                requestAnimationFrame(function() {
                    const distFromBottom = oldScrollHeight - oldScrollTop;
                    if (distFromBottom <= 120) {
                        messagesWrapper.scrollTop = Math.max(0, messagesWrapper.scrollHeight - distFromBottom);
                    } else {
                        messagesWrapper.scrollTop = Math.min(oldScrollTop, Math.max(0, messagesWrapper.scrollHeight - messagesWrapper.clientHeight));
                    }
                });
                return;
            }
            const toFold = total - RENDER_WINDOW;
            for (let i = 0; i < toFold; i++) messages[i].classList.add('message-folded');
            for (let i = toFold; i < total; i++) messages[i].classList.remove('message-folded');
            if (!loadMoreEl) {
                loadMoreEl = document.createElement('div');
                loadMoreEl.className = 'load-more-placeholder';
                loadMoreEl.textContent = '加载更多（' + toFold + ' 条）';
                loadMoreEl.onclick = function() {
                    const oldScrollHeight = messagesWrapper.scrollHeight;
                    const oldScrollTop = messagesWrapper.scrollTop;
                    const folded = messagesContainer.querySelectorAll('.message-folded');
                    const n = Math.min(LOAD_MORE_BATCH, folded.length);
                    for (let i = 0; i < n; i++) folded[i].classList.remove('message-folded');
                    requestAnimationFrame(function() {
                        messagesWrapper.scrollTop = oldScrollTop + (messagesWrapper.scrollHeight - oldScrollHeight);
                    });
                    const remaining = messagesContainer.querySelectorAll('.message-folded').length;
                    if (remaining === 0) loadMoreEl.remove();
                    else loadMoreEl.textContent = '加载更多（' + remaining + ' 条）';
                };
                messagesContainer.insertBefore(loadMoreEl, messagesContainer.firstChild);
            }
            const remaining = messagesContainer.querySelectorAll('.message-folded').length;
            if (remaining === 0) loadMoreEl.remove();
            else loadMoreEl.textContent = '加载更多（' + remaining + ' 条）';
            requestAnimationFrame(function() {
                const distFromBottom = oldScrollHeight - oldScrollTop;
                if (distFromBottom <= 120) {
                    messagesWrapper.scrollTop = Math.max(0, messagesWrapper.scrollHeight - distFromBottom);
                } else {
                    messagesWrapper.scrollTop = Math.min(oldScrollTop, Math.max(0, messagesWrapper.scrollHeight - messagesWrapper.clientHeight));
                }
            });
        }

        // 发送消息
        function sendMessage() {
            if (btnSend.disabled) return;
            if (isGenerating) return;

            const text = textInput.value.trim();
            const hasImages = imageState.size > 0;
            if (!text && !hasImages) return;

            // 验证规则：有图必须有文字
            if (hasImages && !text) {
                alert('请补充文字说明');
                return;
            }

            // 验证：所有图片必须成功上传
            if (hasImages) {
                let allSuccess = true;
                for (const [imageId, state] of imageState) {
                    if (state.status !== 'success') {
                        allSuccess = false;
                        break;
                    }
                }
                if (!allSuccess) {
                    // 不应该到达这里（按钮已禁用），但作为双重检查
                    return;
                }
            }

            // URL 列表严格来自 success 状态，顺序与用户选择顺序一致（Map 插入序）
            const imageUrls = [];
            for (const [imageId, state] of imageState) {
                if (state.status === 'success' && state.url) {
                    imageUrls.push(state.url);
                }
            }

            // 添加用户消息（右对齐，立即显示）
            const userMessage = createMessage({ 
                role: "user", 
                text: text, 
                files: null, 
                imageUrls: imageUrls,
                stream: false 
            });
            messagesContainer.appendChild(userMessage);
            refreshEmptyState();
            scrollToBottom();
            applyMessageWindow();

            // 创建AI回复占位并生成 streamId（取消时旧气泡按 streamId 落终态）
            const streamId = 'stream_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            isGenerating = true;
            updateInputMode();
            const assistantMessage = createMessage({ role: "assistant", text: "", stream: true });
            assistantMessage.dataset.streamId = streamId;
            messagesContainer.appendChild(assistantMessage);
            scrollToBottom();
            applyMessageWindow();

            // 保存用于重试
            lastSent = { text: text, imageUrls: imageUrls.slice(), streamId: streamId };

            // 发送到Android（带 streamId，回调按 streamId 写对应气泡）
            sendToAndroid(text, imageUrls, streamId);

            // 清空输入和图片预览
            textInput.value = '';
            textInput.style.height = 'auto';
            imageState.clear();
            imagePreviewContainer.innerHTML = '';
            imagePreviewContainer.style.display = 'none';
            updateInputMode();
        }

        // 发送到Android后端（streamId 用于 onChunk/onComplete/onStreamInterrupted 写对应气泡）
        function sendToAndroid(text, imageUrls, streamId) {
            const imageUrlsJson = imageUrls.length > 0 ? JSON.stringify(imageUrls) : 'null';
            AndroidInterface.sendMessage(text || '', imageUrlsJson, streamId || '');
        }

        // SSE 节流：Map<streamId, buffer> 隔离，每 CHUNK_FLUSH_MS 刷新；只写对应 streamId 的气泡
        function flushChunkBuffer(streamId) {
            if (!streamId) return;
            chunkFlushScheduledByStream[streamId] = false;
            const buf = chunkBufferByStream[streamId];
            if (!buf) return;
            const msg = Array.from(messagesContainer.querySelectorAll('.message.assistant')).find(function(m) { return m.dataset.streamId === streamId; });
            if (msg) {
                const contentDiv = msg.querySelector('.message-content');
                if (contentDiv) {
                    contentDiv.textContent += buf;
                    scrollToBottom();
                }
            }
            chunkBufferByStream[streamId] = '';
        }

        // 接收Android返回的流式chunk（streamId 指定写入哪条 assistant 消息）
        window.onChunkReceived = function(streamId, chunk) {
            if (!streamId || !chunk || chunk.trim() === '') return;
            chunkBufferByStream[streamId] = (chunkBufferByStream[streamId] || '') + chunk;
            if (!chunkFlushScheduledByStream[streamId]) {
                chunkFlushScheduledByStream[streamId] = true;
                setTimeout(function() { flushChunkBuffer(streamId); }, CHUNK_FLUSH_MS);
            }
        };

        // 接收Android完成通知（保证一次；onComplete 必 flush 该 streamId buffer，最后几个字不丢）
        window.onCompleteReceived = function(streamId) {
            if (streamId) {
                flushChunkBuffer(streamId);
                const msg = Array.from(messagesContainer.querySelectorAll('.message.assistant')).find(function(m) { return m.dataset.streamId === streamId; });
                if (msg) msg.classList.remove('streaming');
            }
            isGenerating = false;
            fileInput.value = '';
            updateInputMode();
        };

        // 终态仅 badge/灰化，不写正文；提供重试按钮。reason: canceled/timeout/network/server/cache_overflow/error
        window.onStreamInterrupted = function(streamId, reason) {
            if (!streamId) return;
            isGenerating = false;
            updateInputMode();
            const msg = Array.from(messagesContainer.querySelectorAll('.message.assistant')).find(function(m) { return m.dataset.streamId === streamId; });
            if (msg) {
                msg.classList.remove('streaming');
                msg.classList.add('message-interrupted');
                const contentDiv = msg.querySelector('.message-content');
                if (contentDiv && !contentDiv.querySelector('.interrupted-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'interrupted-badge';
                    const reasonText = reason === 'canceled' ? '（已停止）' : (reason === 'timeout' ? '（超时）' : (reason === 'network' ? '（网络异常）' : (reason === 'server' ? '（服务异常）' : (reason === 'cache_overflow' ? '（缓存超限）' : '（请求失败）'))));
                    badge.textContent = reasonText;
                    contentDiv.appendChild(badge);
                    if (lastSent && lastSent.streamId === streamId) {
                        const retryBtn = document.createElement('button');
                        retryBtn.className = 'retry-stream-btn';
                        retryBtn.textContent = '重试';
                        retryBtn.onclick = function() {
                            if (!lastSent) return;
                            AndroidInterface.stopGeneration && AndroidInterface.stopGeneration();
                            delete chunkBufferByStream[streamId];
                            contentDiv.innerHTML = '';
                            const newStreamId = 'stream_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            msg.dataset.streamId = newStreamId;
                            msg.classList.remove('message-interrupted');
                            lastSent.streamId = newStreamId;
                            isGenerating = true;
                            updateInputMode();
                            sendToAndroid(lastSent.text, lastSent.imageUrls, newStreamId);
                        };
                        contentDiv.appendChild(retryBtn);
                    }
                }
            }
        };

        // 统一消息渲染函数（用户/AI共用）
        function createMessage({ role, text, files, imageUrls, stream }) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (role === 'assistant') {
                const row = document.createElement('div');
                row.className = 'message-row';
                const avatarSlot = document.createElement('div');
                avatarSlot.className = 'avatar-slot';
                const dot = document.createElement('span');
                dot.className = 'streaming-dot';
                avatarSlot.appendChild(dot);
                row.appendChild(avatarSlot);
                row.appendChild(contentDiv);
                messageDiv.appendChild(row);
                if (stream) messageDiv.classList.add('streaming');
            } else {
                messageDiv.appendChild(contentDiv);
            }

            // 添加图片（仅用户消息支持）
            if (imageUrls && imageUrls.length > 0 && role === 'user') {
                for (let url of imageUrls) {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = 'message-image';
                    contentDiv.appendChild(img);
                }
            } else if (files && files.length > 0 && role === 'user') {
                // 兼容旧逻辑（如果传入files）
                for (let file of files) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'message-image';
                            contentDiv.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }

            // 添加文本
            if (text && role === 'user') {
                // 用户消息：立即完整显示（同步）
                const textNode = document.createTextNode(text);
                contentDiv.appendChild(textNode);
            } else if (role === 'assistant') {
                // AI消息：初始为空，等待流式渲染
                contentDiv.textContent = '';
            }

            if (role !== 'assistant') {
                messageDiv.appendChild(contentDiv);
            }
            return messageDiv;
        }

        // 滚动到底部（滚动容器为 messagesWrapper）
        function scrollToBottom() {
            messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
        }

        function refreshEmptyState() {
            const hasMessages = messagesContainer.querySelectorAll('.message').length > 0;
            emptyState.classList.toggle('hidden', hasMessages);
        }

        // C. Idle 右侧 Mic：点击打开 VoicePanel
        btnMic.addEventListener('click', function() {
            voicePanel.classList.add('open');
            addVoiceExitListeners();
            updateInputMode();
            startWaveform(false, false);
        });

        // C. Generating 右侧 Stop：取消当前流式
        btnStop.addEventListener('click', function() {
            if (typeof AndroidInterface.stopGeneration === 'function') {
                AndroidInterface.stopGeneration();
            }
        });

        /** P0-6: 幂等复位，任一退出事件调用 */
        function stopVoice() {
            if (!voicePanel.classList.contains('open') && !voiceRecording) return;
            voiceRecording = false;
            voiceCancelArmed = false;
            if (voicePendingTimeout) { clearTimeout(voicePendingTimeout); voicePendingTimeout = null; }
            voicePanel.classList.remove('open');
            voiceMicBtn.classList.remove('recording', 'cancel-armed');
            voicePanel.classList.remove('cancel-armed');
            voiceHint.textContent = '按住说话';
            stopWaveform();
            removeVoiceExitListeners();
            updateInputMode();
        }
        function addVoiceExitListeners() {
            document.addEventListener('pointerup', _onVoiceExit);
            document.addEventListener('pointercancel', _onVoiceExit);
            window.addEventListener('blur', _onVoiceExit);
            document.addEventListener('visibilitychange', _onVoiceExitHidden);
        }
        function removeVoiceExitListeners() {
            document.removeEventListener('pointerup', _onVoiceExit);
            document.removeEventListener('pointercancel', _onVoiceExit);
            window.removeEventListener('blur', _onVoiceExit);
            document.removeEventListener('visibilitychange', _onVoiceExitHidden);
        }
        function _onVoiceExit(e) {
            if (!voicePanel.classList.contains('open')) return;
            if (e && (e.target === voiceMicBtn || voiceMicBtn.contains(e.target))) return;
            stopVoice();
        }
        function _onVoiceExitHidden() { if (document.hidden) stopVoice(); }

        // D. VoicePanel：Keyboard 关闭面板并聚焦输入框
        btnKeyboard.addEventListener('click', function() {
            stopVoice();
            textInput.focus();
        });

        // D. VoicePanel：按住说话（Press-and-hold）
        function getTouchY(e) {
            if (e.touches && e.touches.length) return e.touches[0].clientY;
            return e.clientY;
        }
        voiceMicBtn.addEventListener('mousedown', onVoiceStart);
        voiceMicBtn.addEventListener('touchstart', onVoiceStart, { passive: true });
        voiceMicBtn.addEventListener('mouseup', onVoiceEnd);
        voiceMicBtn.addEventListener('touchend', onVoiceEnd);
        voiceMicBtn.addEventListener('mouseleave', onVoiceEnd);
        voiceMicBtn.addEventListener('touchmove', function(e) {
            if (!voiceRecording) return;
            const y = getTouchY(e);
            const delta = voiceTouchStartY - y;
            if (delta > VOICE_CANCEL_THRESHOLD_PX && !voiceCancelArmed) {
                voiceCancelArmed = true;
                voiceMicBtn.classList.add('cancel-armed');
                voicePanel.classList.add('cancel-armed');
                voiceHint.textContent = '';
                startWaveform(true, true);
            }
        }, { passive: true });

        function onVoiceStart(e) {
            e.preventDefault();
            if (e.type === 'touchstart') voiceTouchStartY = e.touches[0].clientY;
            else voiceTouchStartY = e.clientY;
            voiceRecording = true;
            voiceCancelArmed = false;
            voiceMicBtn.classList.add('recording');
            voiceMicBtn.classList.remove('cancel-armed');
            voicePanel.classList.remove('cancel-armed');
            voiceHint.textContent = '';
            startWaveform(true, false);
        }

        function onVoiceEnd(e) {
            if (!voiceRecording) return;
            e.preventDefault();
            voiceRecording = false;
            voiceMicBtn.classList.remove('recording', 'cancel-armed');
            voicePanel.classList.remove('cancel-armed');
            voiceHint.textContent = '按住说话';
            stopWaveform();
            if (voiceCancelArmed) return;
            if (voicePendingTimeout) clearTimeout(voicePendingTimeout);
            voicePendingTimeout = setTimeout(function() {
                voicePendingTimeout = null;
                finishVoiceSend('语音输入的消息');
            }, 600);
            if (typeof window.onVoiceRecognized === 'function') {
                var t = window.onVoiceRecognized();
                if (t != null && t !== undefined) {
                    if (voicePendingTimeout) { clearTimeout(voicePendingTimeout); voicePendingTimeout = null; }
                    finishVoiceSend(t);
                    return;
                }
            }
        }
        window.onVoiceResult = function(text) {
            if (voicePendingTimeout) { clearTimeout(voicePendingTimeout); voicePendingTimeout = null; }
            finishVoiceSend(text);
        };

        function finishVoiceSend(text) {
            removeVoiceExitListeners();
            voicePanel.classList.remove('open');
            updateInputMode();
            if (!text || !String(text).trim()) {
                voiceHint.textContent = '未识别到内容';
                setTimeout(function() { voiceHint.textContent = '按住说话'; }, 1500);
                return;
            }
            const t = String(text).trim();
            const streamId = 'stream_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const userMessage = createMessage({ role: 'user', text: t, files: null, imageUrls: [], stream: false });
            messagesContainer.appendChild(userMessage);
            refreshEmptyState();
            scrollToBottom();
            applyMessageWindow();
            isGenerating = true;
            const assistantMessage = createMessage({ role: 'assistant', text: '', stream: true });
            assistantMessage.dataset.streamId = streamId;
            messagesContainer.appendChild(assistantMessage);
            scrollToBottom();
            applyMessageWindow();
            sendToAndroid(t, [], streamId);
            updateInputMode();
        }

        // D4. 波形 Canvas（24 根竖条）
        const WAVE_BARS = 24;
        let waveBarsHeights = Array(WAVE_BARS).fill(0.3);
        let wavePhase = 0;

        function startWaveform(recording, cancelArmed) {
            stopWaveform();
            const ctx = voiceWaveform.getContext('2d');
            const w = voiceWaveform.width;
            const h = voiceWaveform.height;
            const barW = (w / WAVE_BARS) * 0.6;
            const gap = w / WAVE_BARS - barW;
            const color = cancelArmed ? '#E14B4B' : (recording ? '#169C5C' : '#D9D9D9');
            const amp = cancelArmed ? 0.4 : (recording ? 0.8 : 0.25);

            function draw() {
                wavePhase += recording ? 0.15 : 0.04;
                ctx.clearRect(0, 0, w, h);
                for (let i = 0; i < WAVE_BARS; i++) {
                    const t = Math.sin(wavePhase + i * 0.4) * 0.5 + 0.5;
                    waveBarsHeights[i] = waveBarsHeights[i] * 0.7 + t * amp * 0.3;
                    const barH = Math.max(4, h * waveBarsHeights[i]);
                    const x = i * (barW + gap) + gap * 0.5;
                    ctx.fillStyle = color;
                    ctx.fillRect(x, (h - barH) / 2, barW, barH);
                }
                waveformAnimId = requestAnimationFrame(draw);
            }
            draw();
        }

        function stopWaveform() {
            if (waveformAnimId) {
                cancelAnimationFrame(waveformAnimId);
                waveformAnimId = null;
            }
        }


        updateInputMode();
        refreshEmptyState();

        btnSend.addEventListener('click', sendMessage);

        textInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
