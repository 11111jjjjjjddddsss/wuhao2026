<!-- UI_VERSION: phone-shell-20250128 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
    <title>农技千问</title>
    <style>
        /* B. 颜色与尺寸（硬值） */
        :root {
            --debug-shell: 0;
            --green: #169C5C;
            --green-accent: #1FAE6A;
            --bg: #FFFFFF;
            --border: #EDEDED;
            --text: #111111;
            --text-secondary: #8C8C8C;
            --text-disabled: #BDBDBD;
            --danger: #E14B4B;
            --stop-bg: #F4F4F4;
            --divider: #F2F2F2;
            --placeholder: #9B9B9B;
            --tool-result-text: #6B6B6B;
            --input-radius: 22px;
            --btn-circle-size: 40px;
            --input-min-height: 56px;
            --transition-fast: 180ms ease;
            --transition-sheet: 240ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        html::-webkit-scrollbar,
        body::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 16px;
            line-height: 1.4;
            background-color: #F6F6F6;
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        .app-shell {
            --shell-width: min(100vw, 430px);
            width: min(100vw, 430px);
            max-width: 430px;
            height: 100vh;
            margin: 0 auto;
            background: #F6F6F6;
            display: flex;
            flex-direction: column;
            position: relative;
            outline: calc(var(--debug-shell) * 1px) solid red;
        }
        .app-shell::before {
            display: none;
        }
        .app-shell::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 96px;
            background: linear-gradient(to top, rgba(0,0,0,0.03), transparent);
            pointer-events: none;
            z-index: 0;
        }

        @media (orientation: landscape) {
            .app-shell {
                --shell-width: min(100vw, 520px);
                max-width: 520px;
                width: min(100vw, 520px);
            }
        }

        /* A. 顶部 AppBar（背景透明，沿用 app-shell 底色） */
        .app-bar {
            position: fixed;
            top: 0;
            left: calc((100vw - var(--shell-width)) / 2);
            right: auto;
            margin: 0;
            width: var(--shell-width);
            max-width: none;
            z-index: 120;
            flex-shrink: 0;
            height: 56px;
            padding: env(safe-area-inset-top) 14px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: none;
            box-shadow: none;
            background: rgba(246,246,246,0.06);
            -webkit-backdrop-filter: saturate(170%) blur(22px);
            backdrop-filter: saturate(170%) blur(22px);
            transform: translateZ(0);
            will-change: transform;
        }
        .app-bar::after { display: none; }
        .app-bar-left {
            width: var(--btn-circle-size);
            height: var(--btn-circle-size);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            color: var(--text);
            border-radius: 50%;
            background: #FFFFFF;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.06);
        }
        .app-bar-left:hover {
            background: #F8F8F8;
        }
        .app-bar-title-wrap {
            position: relative;
            margin-left: auto;
            margin-right: 0;
            pointer-events: none;
            max-width: calc(100% - var(--btn-circle-size) - 32px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #FFFFFF;
            border-radius: 999px;
            padding: 6px 14px 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.06);
        }
        .app-bar-title {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.3px;
            color: var(--text);
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .app-bar svg {
            width: 22px;
            height: 22px;
            stroke: var(--text);
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        /* 左侧抽屉：340px 最大 360px，移动端 80% 最大 360px；左滑入 220ms；禁止竖排/旋转文字 */
        #drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: 340px;
            max-width: 360px;
            height: 100%;
            background: #F7F7F8;
            box-shadow: 2px 0 12px rgba(0,0,0,0.12);
            z-index: 301;
            transform: translateX(-100%);
            transition: transform 220ms cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex;
            flex-direction: column;
            writing-mode: horizontal-tb;
        }
        #drawer .drawer-content {
            writing-mode: horizontal-tb;
            transform: none;
            text-orientation: mixed;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #drawer .drawer-content::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        #drawer .menu-card {
            writing-mode: horizontal-tb;
            transform: none;
            text-orientation: mixed;
        }
        #drawer .menu-card:active {
            transform: scale(0.98);
        }
        @media (max-width: 600px) {
            #drawer { width: 80%; max-width: 360px; }
        }
        #drawer.open {
            transform: translateX(0);
        }
        .drawer-content {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .drawer-menu-group {
            background: #fff;
            border: 1px solid rgba(0,0,0,.06);
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0,0,0,.04);
            overflow: hidden;
        }
        .menu-icon {
            width: 28px;
            min-width: 28px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: currentColor;
        }
        .menu-icon svg {
            width: 20px;
            height: 20px;
            display: block;
            stroke: currentColor;
        }
        .menu-label {
            flex: 1;
            min-width: 0;
        }
        .menu-card {
            display: flex;
            align-items: center;
            gap: 12px;
            min-height: 58px;
            padding: 16px;
            margin-bottom: 0;
            background: transparent;
            border: 0;
            border-radius: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            position: relative;
            transition: background 120ms ease, transform 120ms ease;
        }
        .drawer-menu-group .menu-card + .menu-card { position: relative; }
        .drawer-menu-group .menu-card + .menu-card::before {
            content: "";
            position: absolute;
            left: 44px;
            right: 16px;
            top: 0;
            height: 1px;
            background: rgba(0,0,0,.06);
        }
        .menu-card:hover { background: transparent; }
        .menu-card:active {
            background: rgba(0,0,0,.04);
            transform: scale(0.996);
        }
        .menu-card .menu-card-right {
            font-size: 13px;
            color: #8E8E93;
            font-weight: 400;
            text-align: right;
            max-width: 45%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .menu-card .menu-arrow {
            display: none !important;
        }
        .menu-card .menu-arrow svg {
            width: 18px;
            height: 18px;
        }
        .drawer-logout {
            color: #C2362B;
            font-size: 14px;
            font-weight: 600;
        }
        .menu-card.menu-card-danger {
            color: #D64A3A;
            background: #ECECEE;
            border: 0;
        }
        .menu-card.is-hidden {
            display: none;
        }
        .drawer-version { display: none; }
        .drawer-logout-strip { display: none; }
        #logoutConfirmMask {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.35);
            z-index: 920;
            opacity: 0;
            visibility: hidden;
            transition: opacity 160ms ease, visibility 160ms ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        #logoutConfirmMask.open {
            opacity: 1;
            visibility: visible;
        }
        #logoutConfirmDialog {
            width: min(320px, 86vw);
            background: #fff;
            border-radius: 16px;
            padding: 16px;
            transform: translateY(4px);
            opacity: 0;
            transition: transform 160ms ease, opacity 160ms ease;
        }
        #logoutConfirmMask.open #logoutConfirmDialog {
            transform: translateY(0);
            opacity: 1;
        }
        .logout-confirm-title {
            font-size: 17px;
            font-weight: 700;
            color: #111;
            line-height: 24px;
        }
        .logout-confirm-text {
            margin-top: 6px;
            font-size: 14px;
            color: #8E8E93;
            line-height: 20px;
        }
        .logout-confirm-actions {
            margin-top: 14px;
            display: flex;
            gap: 10px;
        }
        .logout-confirm-btn {
            flex: 1;
            height: 40px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
        }
        .logout-confirm-cancel {
            border: 1px solid rgba(0,0,0,.1);
            background: #fff;
            color: #111;
        }
        .logout-confirm-ok {
            border: 1px solid #111;
            background: #111;
            color: #fff;
        }
        /* 遮罩：rgba(0,0,0,0.35)，点击关闭抽屉 */
        #drawer-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.35);
            cursor: pointer;
            z-index: 300;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        #drawer-mask.show {
            pointer-events: auto;
            opacity: 1;
        }

        /* ========== 会员中心：一屏可见（默认无内部滚动条） ========== */
        #membership-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.35);
            z-index: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            opacity: 0;
            visibility: hidden;
            transition: opacity .22s ease, visibility .22s ease;
            writing-mode: horizontal-tb;
        }
        #membership-modal-backdrop.open {
            opacity: 1;
            visibility: visible;
        }
        #membership-modal {
            width: min(560px, calc(100vw - 24px));
            height: min(720px, calc(100vh - 24px));
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 10px 40px rgba(0,0,0,.18);
            padding: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1000;
            writing-mode: horizontal-tb;
            transform: none;
            text-orientation: mixed;
        }
        .membership-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 4px 10px;
            border-bottom: 1px solid rgba(0,0,0,.06);
        }
        .membership-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--text);
        }
        .membership-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,.10);
            background: #fff;
            cursor: pointer;
            pointer-events: auto;
            z-index: 1100;
        }
        .membership-close:active {
            transform: scale(.98);
        }
        .membership-sub {
            font-size: 13px;
            color: var(--text-secondary);
            padding: 8px 4px 12px;
            line-height: 1.4;
        }
        .membership-cards {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-top: 12px;
        }
        .membership-card {
            flex: 1;
            min-height: 0;
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,.08);
            background: #fff;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            writing-mode: horizontal-tb;
            transform: none;
            text-orientation: mixed;
        }
        .membership-card[data-tier="pro"] {
            border-color: rgba(0,0,0,.18);
            box-shadow: 0 6px 18px rgba(0,0,0,.06);
        }
        .membership-card.recommended-highlight {
            border-color: rgba(0,0,0,.35);
            box-shadow: 0 8px 24px rgba(0,0,0,.12);
        }
        .card-top {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-right: 96px;
            /* 兜底：系统字体放大也不挤 */
        }
        .card-name {
            flex: 1;
            min-width: 0;
            font-size: 16px;
            font-weight: 900;
            color: var(--text);
        }
        .card-price {
            flex: 0 0 96px;
            text-align: right;
            font-size: 16px;
            font-weight: 900;
            color: var(--text);
            white-space: nowrap;
            font-variant-numeric: tabular-nums;
        }
        .card-badge {
            position: absolute;
            top: 10px;
            right: 12px;
            font-size: 11px;
            line-height: 1.2;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid rgba(0,0,0,.14);
            background: #fff;
            color: rgba(0,0,0,.72);
            /* 防止长文案顶到价格：badge 自己收敛 */
            max-width: 88px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dot {
            font-weight: 900;
            color: rgba(0,0,0,.70);
            padding: 0 2px;
        }
        .card-desc {
            font-size: 13px;
            font-weight: 400;
            color: var(--text-secondary);
            line-height: 1.45;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            padding-left: 12px;
            padding-right: 96px;
            min-width: 0;
            width: 100%;
            box-sizing: border-box;
        }
        .card-desc .dot {
            font-weight: 900;
        }
        .card-btn {
            margin-top: auto;
            width: 100%;
            height: 44px;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,.12);
            background: #111;
            color: #fff;
            font-size: 14px;
            font-weight: 900;
            cursor: pointer;
            writing-mode: horizontal-tb;
            transform: none;
        }
        .card-btn:active {
            transform: scale(.99);
        }
        .card-btn.btn-current, .card-btn:disabled {
            opacity: .45;
        }
        .card-btn.btn-higher-disabled {
            cursor: not-allowed;
            opacity: .5;
        }
        .card-higher-hint {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
            cursor: not-allowed;
        }
        .membership-footnote {
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        @media (max-height: 680px) {
            #membership-modal {
                height: calc(100vh - 24px);
                overflow: auto;
                scrollbar-width: none;
            }
            #membership-modal::-webkit-scrollbar {
                width: 0;
                height: 0;
            }
        }
        #toast {
            position: fixed;
            left: 50%;
            bottom: 80px;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0,0,0,0.75);
            color: #fff;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 500;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.25s, transform 0.25s, visibility 0.25s;
        }
        #toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        /* ===== ChatGPT-ish neutral theme（覆盖 drawer + modal 为黑白灰极简） ===== */
        :root {
            --bg: #f7f7f8;
            --surface: #ffffff;
            --text: #111111;
            --muted: rgba(17,17,17,.65);
            --border: rgba(0,0,0,.08);
            --shadow: 0 8px 30px rgba(0,0,0,.12);
            --radius: 16px;
            --drawer-bg: #F6F6F6;
            --drawer-card: #FFFFFF;
            --drawer-text: #111111;
            --drawer-muted: #8E8E93;
            --drawer-divider: rgba(0,0,0,.06);
        }
        .drawer-content {
            padding: 16px 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        #drawer {
            background: var(--drawer-bg);
            box-shadow: 0 2px 10px rgba(0,0,0,.05);
            border-right: 0;
            border-radius: 0;
        }
        .drawer-menu-group {
            background: transparent;
            border: 0;
            border-radius: 0;
            box-shadow: none;
            overflow: visible;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .menu-card {
            background: #ECECEE;
            border: 0;
            border-radius: 16px;
            margin-bottom: 0;
            min-height: 58px;
            padding: 16px;
            box-shadow: none;
            transition: background 120ms ease, transform 120ms ease;
            font-size: 16px;
            font-weight: 400;
            color: var(--drawer-text);
        }
        .menu-card:hover { background: #ECECEE; }
        .menu-card:active {
            transform: scale(0.997);
            background: #E5E5E7;
        }
        .menu-card .menu-card-right {
            font-size: 13px;
            color: var(--drawer-muted);
            font-weight: 400;
            text-align: right;
            max-width: 45%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .drawer-menu-group .menu-card + .menu-card::before { display: none; }
        .menu-card .menu-arrow {
            display: none !important;
        }
        .menu-card.menu-card-danger {
            color: #D14B3A;
        }
        #drawer-mask {
            background: rgba(0,0,0,.28);
        }

        .main {
            position: relative;
            z-index: 1;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .messages-wrapper {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            position: relative;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding-top: 56px;
        }

        .messages-wrapper::before { display: none; }

        .messages-wrapper::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .messages-container {
            display: flex;
            flex-direction: column;
            padding: 16px;
            padding-bottom: calc(88px + env(safe-area-inset-bottom, 0px));
            min-height: 100%;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        /* G. 空态（P0-2：无大球，文字左对齐） */
        .empty-state {
            position: absolute;
            left: 0;
            right: 0;
            top: 56px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            padding: 28px 24px 24px;
            pointer-events: none;
        }
        .empty-state.hidden {
            display: none;
        }
        .empty-state .logo {
            display: block;
        }
        .empty-state .empty-state-hint {
            font-size: 16px;
            color: var(--text);
            font-weight: 500;
            margin-top: 12px;
            line-height: 1.55;
            max-width: 340px;
            letter-spacing: 0.2px;
        }
        /* 全对话无气泡：GPT 纯净文本块 */
        .message {
            margin-bottom: 20px;
            max-width: 85%;
            background: transparent;
            border: none;
            box-shadow: none;
            border-radius: 0;
        }

        .message:last-child {
            margin-bottom: 0;
        }

        .message.user {
            align-self: flex-end;
            margin-left: auto;
        }

        .message.assistant {
            align-self: flex-start;
        }

        /* P0-1: 左侧生成中跳动绿球 */
        .message.assistant .message-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .message.assistant .avatar-slot {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 14px;
        }
        /* ChatGPT 风格：生成中仅显示小尺寸黑白三点 loading，无彩色 */
        .message.assistant .streaming-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #202123;
            opacity: 0;
            pointer-events: none;
        }
        .message.assistant.streaming .streaming-dot {
            opacity: 1;
            animation: dot-breathe 1.25s ease-in-out infinite;
        }
        @keyframes dot-breathe {
            0%, 100% { transform: scale(1); opacity: 0.78; }
            50% { transform: scale(1.12); opacity: 0.95; }
        }

        .message-content {
            line-height: 1.62;
            font-size: 16px;
            font-weight: 400;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
            /* 断行别太碎（anywhere 会把中文/URL 断得很怪） */
            overflow-wrap: break-word;
            letter-spacing: 0.1px;
            max-width: 100%;
            color: var(--text);
            padding: 4px 12px;
            background: transparent;
            border: none;
            box-shadow: none;
            border-radius: 12px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .message-content p { margin: 0 0 10px; }
        .message-content p:last-child { margin-bottom: 0; }
        .message-content ul, .message-content ol { margin: 6px 0 10px 22px; padding: 0; }
        .message-content li { margin: 4px 0; }
        .message-content li > p { margin: 0; }
        .message-content blockquote {
            margin: 8px 0 10px;
            padding: 6px 10px;
            border-left: 3px solid rgba(0,0,0,0.12);
            color: var(--text-secondary);
        }
        .message-content code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            font-size: 0.95em;
            background: rgba(0,0,0,0.05);
            border-radius: 6px;
            padding: 1px 6px;
        }
        .message-content pre {
            margin: 8px 0 10px;
            padding: 10px 12px;
            background: rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 12px;
            overflow: auto;
            /* WebView 里代码块更稳、更像 GPT */
            white-space: pre;
            tab-size: 4;
        }
        .message-content pre code {
            background: transparent;
            padding: 0;
            border-radius: 0;
            display: block;
            white-space: pre;
        }
        .message-content h1 { font-size: 18px; margin: 10px 0 8px; }
        .message-content h2 { font-size: 17px; margin: 10px 0 8px; }
        .message-content h3 { font-size: 16px; margin: 10px 0 6px; }
        .message-content h4 { font-size: 16px; margin: 8px 0 6px; font-weight: 600; }
        .message-content a { color: inherit; text-decoration: underline; text-underline-offset: 2px; }
        .message-content hr { border: 0; border-top: 1px solid rgba(0,0,0,0.08); margin: 10px 0; }
        .message-content.md-rendered { white-space: normal; }
        /* ===== 追加覆盖：收口成 GPT 观感（不删旧规则，仅后写覆盖） ===== */
        /* 1) 内容宽度与贴边：assistant 靠左、user 靠右，但都别铺满 */
        .message-content { max-width: 680px; width: 100%; box-sizing: border-box; margin-right: auto; margin-left: 0; }
        .message.user .message-content { margin-left: auto; margin-right: 0; max-width: 680px; }

        /* 2) 节奏更像 GPT：段落/列表间距略收紧 */
        .message-content p { margin: 0 0 8px; }
        .message-content p:last-child { margin-bottom: 0; }
        .message-content ul, .message-content ol { margin: 6px 0 8px 22px; }
        .message-content li { margin: 3px 0; }

        /* 3) 引用块：淡底 + 圆角，避免“硬框” */
        .message-content blockquote { padding: 8px 10px; background: rgba(0,0,0,0.02); border-left-color: rgba(0,0,0,0.12); border-radius: 10px; }

        /* 4) 代码块：更顺滑拖动、更稳的字号与行高 */
        .message-content pre { line-height: 1.55; font-size: 14px; padding: 12px 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; background: rgba(0,0,0,0.035); border-color: rgba(0,0,0,0.07); border-radius: 14px; }
        .message-content code { background: rgba(0,0,0,0.045); }

        /* 5) 链接：别太“硬”，下划线淡一点 */
        .message-content a { text-decoration-thickness: 1px; text-decoration-color: rgba(0,0,0,0.35); }

        /* 6) 用户消息：容器靠右，块级与段落左对齐可读 */
        .message.user .message-content ul,
        .message.user .message-content ol,
        .message.user .message-content blockquote,
        .message.user .message-content pre,
        .message.user .message-content h1,
        .message.user .message-content h2,
        .message.user .message-content h3,
        .message.user .message-content h4 { text-align: left; }
        .message.user .message-content p,
        .message.user .message-content li,
        .message.user .message-content blockquote,
        .message.user .message-content pre { text-align: left; }

        .message.user .message-content {
            text-align: right;
            color: var(--text);
            margin-left: auto;
            margin-right: 0;
            max-width: 680px;
        }

        .message.assistant .message-content {
            text-align: left;
            color: var(--text);
        }

        /* ===== GPT-ish message spacing (override only) ===== */
        /* 1) 每条消息的垂直间距：别挤、别太散 */
        .message { margin: 12px 0; }
        /* 2) 消息行内部：头像与正文的距离、对齐更稳 */
        .message-row { gap: 12px; align-items: flex-start; }
        /* 3) 内容块内边距：GPT 更“纸张感”，但别变成气泡 */
        .message-content { padding: 4px 10px; }
        /* 4) 用户消息块：右侧靠边但别贴死（不改你现有右对齐策略） */
        .message.user .message-content { padding: 4px 10px; }
        /* 5) 如果你有 message-wrapper/ container 的 padding，确保上下留白 */
        .messages-container { padding-top: 8px; padding-bottom: calc(98px + env(safe-area-inset-bottom, 0px)); }

        /* ===== 完成态 GPT 观感最小风险收口（仅追加覆盖） ===== */
        .message-content.md-rendered { overflow-wrap: break-word; word-break: break-word; }
        .message-content.md-rendered a { word-break: break-all; }
        .message-content { line-height: 1.72; font-size: 16px; font-weight: 400; letter-spacing: 0.01em; text-align: left; }
        .message.user .message-content { text-align: left; }
        .message-content p { margin: 0 0 12px; }
        .message-content p:last-child { margin-bottom: 0; }
        .message-content ul, .message-content ol { margin: 8px 0 12px 24px; }
        .message-content li { margin: 5px 0; }
        .message-content h1 { font-size: 24px; line-height: 1.35; font-weight: 600; margin: 14px 0 10px; }
        .message-content h2 { font-size: 21px; line-height: 1.4; font-weight: 600; margin: 13px 0 9px; }
        .message-content h3 { font-size: 18px; line-height: 1.45; font-weight: 600; margin: 12px 0 8px; }
        .message-content h4 { font-size: 16px; line-height: 1.5; font-weight: 600; margin: 10px 0 8px; }
        .message-content strong { font-weight: 600; }
        .message-content pre,
        .message-content code { text-align: left; direction: ltr; unicode-bidi: plaintext; }
        .message-content { -webkit-user-select: text; user-select: text; }
        .copy-popover {
            position: fixed;
            z-index: 9999;
            background: rgba(255,255,255,0.98);
            border: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 6px 18px rgba(0,0,0,0.10);
            border-radius: 12px;
            padding: 6px;
            display: none;
        }
        .copy-popover button {
            border: 0;
            background: transparent;
            padding: 8px 10px;
            font-size: 14px;
            color: var(--text);
            cursor: pointer;
            border-radius: 10px;
        }
        .copy-popover button:active { background: rgba(0,0,0,0.06); }

        .copy-sheet-mask {
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 9998;
            background: rgba(0,0,0,0.08);
            display: none;
        }
        .copy-sheet-mask.open { display: block; }
        .copy-sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            max-height: 55vh;
            background: #fff;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -4px 24px rgba(0,0,0,0.12);
            transform: translateY(110%);
            transition: transform 0.25s ease;
            display: block;
        }
        .copy-sheet.open { transform: translateY(0); }
        .copy-sheet-handle {
            height: 4px;
            width: 36px;
            margin: 8px auto;
            background: rgba(0,0,0,0.12);
            border-radius: 2px;
        }
        .copy-sheet-actions {
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }
        .copy-sheet-actions button {
            border: 0;
            background: transparent;
            padding: 8px 12px;
            font-size: 14px;
            color: var(--text);
            cursor: pointer;
            border-radius: 8px;
        }
        .copy-sheet-actions button:active { background: rgba(0,0,0,0.06); }
        .copy-sheet-body {
            padding: 12px;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            user-select: text;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.5;
            max-height: calc(55vh - 120px);
        }
        body.copy-ui-open { overflow: hidden; }
        .copy-sheet-body { -webkit-user-select: text; user-select: text; }
        .copy-sheet-body * { -webkit-user-select: text; user-select: text; }
        .copy-sheet-body a { pointer-events: none; }

        /* 工具结果块：ChatGPT 风格灰字小号，绑定在 assistant 消息下方 */
        .tool-result {
            font-size: 12px;
            line-height: 1.5;
            color: var(--tool-result-text);
            margin-top: 8px;
            white-space: pre-wrap;
            word-break: break-word;
            padding-left: 12px;
            border-left: 1px solid rgba(0, 0, 0, 0.08);
        }
        .message-image {
            max-width: 100%;
            margin: 12px 0;
            display: block;
            border-radius: 4px;
        }

        .image-preview-container {
            padding: 8px 12px;
            background-color: #f9f9f9;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 120px;
            overflow-y: auto;
        }

        .image-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #e0e0e0;
            flex-shrink: 0;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-status-overlay {
            position: absolute;
            top: 0;
            right: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 0 0 0 8px;
        }

        .image-status-uploading {
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .image-status-success {
            color: #4caf50;
            font-size: 16px;
            font-weight: bold;
        }

        .image-status-fail {
            color: #f44336;
            font-size: 16px;
            font-weight: bold;
        }

        .image-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 4px;
            padding: 4px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
        }

        .image-action-btn {
            flex: 1;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.9);
            color: #111;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }

        .image-action-btn:hover {
            background-color: rgba(255, 255, 255, 1);
        }

        .image-action-btn.delete {
            background-color: rgba(244, 67, 54, 0.9);
            color: white;
        }

        .image-action-btn.delete:hover {
            background-color: rgba(244, 67, 54, 1);
        }

        .image-fail-hint {
            position: absolute;
            bottom: 28px;
            left: 4px;
            right: 4px;
            font-size: 10px;
            color: #f44336;
            text-align: center;
            background: rgba(0,0,0,0.6);
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* F. 底部输入区（背景透明，沿用 app-shell 整页渐变） */
        .input-container {
            flex-shrink: 0;
            min-height: calc(var(--input-min-height) - 2px);
            background: transparent;
            border-top: none;
            padding: 8px 14px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
            display: flex;
            flex-direction: column;
            gap: 0;
            transition: min-height var(--transition-sheet);
            position: relative;
            z-index: 100;
        }
        .input-container.voice-mode {
            min-height: calc(var(--input-min-height) + 8px);
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 44px;
        }

        .file-input, .camera-input {
            display: none;
        }

        .add-button, .btn-mic-or-keyboard, .btn-send, .btn-stop {
            width: var(--btn-circle-size);
            height: var(--btn-circle-size);
            min-width: var(--btn-circle-size);
            min-height: var(--btn-circle-size);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform var(--transition-fast), background-color var(--transition-fast);
        }
        .add-button:active, .btn-mic-or-keyboard:active, .btn-send:active, .btn-stop:active {
            transform: scale(0.98);
        }

        /* 加号按钮：圆球白色，底栏浅灰，白球在灰底上显眼；十字架浅灰 */
        .add-button {
            border: 1px solid rgba(0,0,0,0.06);
            align-self: center;
            min-width: 44px;
            min-height: 44px;
            width: 44px;
            height: 44px;
            background: #FFFFFF;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            color: #666666;
            font-size: 48px;
            font-weight: 300;
            line-height: 1;
        }
        .add-button:hover {
            background: #F8F8F8;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: #666666;
        }
        .add-button:active {
            transform: scale(0.96);
            box-shadow: 0 0 0 rgba(0,0,0,0.04);
        }
        .btn-mic-or-keyboard {
            background: none;
            color: var(--text);
            position: relative;
            margin-top: -2px;
        }
        .btn-mic-or-keyboard .icon-keyboard {
            display: none;
        }
        .btn-mic-or-keyboard .icon-mic {
            display: flex;
        }
        .btn-mic-or-keyboard.voice-mode .icon-keyboard {
            display: flex;
        }
        .btn-mic-or-keyboard.voice-mode .icon-mic {
            display: none;
        }
        .btn-mic-or-keyboard svg {
            width: 28px;
            height: 28px;
        }
        .btn-mic-or-keyboard .icon-mic svg,
        .btn-mic-or-keyboard .icon-keyboard svg {
            stroke: var(--text);
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        .btn-mic-or-keyboard:hover {
            background: rgba(0,0,0,0.05);
        }

        .btn-send {
            background: rgba(0,0,0,0.92);
            color: #fff;
        }
        .btn-send:hover {
            background: rgba(0,0,0,0.84);
        }
        .btn-send:active {
            background: rgba(0,0,0,0.78);
        }
        .btn-send svg {
            width: 24px;
            height: 24px;
            stroke: #fff;
            stroke-width: 2.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        /* P0-7: 黑圆+绿方 */
        .btn-stop {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            background: #111;
            color: var(--text);
            border-radius: 999px;
        }
        .btn-stop:hover {
            background: #222;
        }
        .btn-stop:active {
            transform: scale(0.92);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .btn-stop svg {
            width: 21px;
            height: 21px;
        }
        .btn-stop svg rect {
            fill: #fff;
        }

        .input-area-with-hint .btn-mic-or-keyboard,
        .input-area-with-hint .btn-send,
        .input-area-with-hint .btn-stop {
            transition: opacity var(--transition-fast);
        }
        .input-area-with-hint .btn-hidden {
            display: none !important;
        }

        .text-input {
            flex: 1;
            width: 100%;
            min-width: 0;
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 10px 4px 6px;
            color: var(--text);
            font-size: 16px;
            font-weight: 400;
            line-height: 22px;
            resize: none;
            min-height: 40px;
            max-height: 110px;
            outline: none;
            -webkit-font-smoothing: antialiased;
            text-align: left;
        }
        .text-input::placeholder {
            color: transparent;
            text-align: left;
        }
        .text-input:focus {
            border-color: var(--green);
        }
        .text-input::-webkit-resizer {
            display: none;
        }
        .text-input::-webkit-scrollbar {
            width: 4px;
        }
        .text-input::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 2px;
        }

        .typing-indicator {
            display: inline-block;
            color: #666;
        }

        /* ChatGPT 风格：失败/中断仅该条底部一行灰字，不弹窗 */
        .interrupted-badge {
            color: #666;
            font-size: 13px;
            margin-left: 0;
        }
        .retry-stream-btn {
            margin-left: 8px;
            padding: 2px 10px;
            font-size: 13px;
            border: 1px solid #999;
            border-radius: 4px;
            background: transparent;
            color: #333;
            cursor: pointer;
        }
        .retry-stream-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .message-folded {
            display: none;
        }

        .load-more-placeholder {
            padding: 12px;
            text-align: center;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .messages-container::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: transparent;
        }

        /* GPT 风格：回到底部居中圆形箭头（生成中且用户离开底部时显示） */
        .scroll-to-bottom-btn {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 88px;
            width: 44px;
            height: 44px;
            min-width: 44px;
            min-height: 44px;
            border-radius: 999px;
            background: #fff;
            border: 1px solid #e5e5e5;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            color: #111;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 130;
            cursor: pointer;
        }
        .scroll-to-bottom-btn svg {
            width: 24px;
            height: 24px;
        }

        /* D. VoicePanel（贴底盖住加号/麦克风；雾蒙蒙毛玻璃 + 精致感；未打开时完全不可见） */
        .voice-panel {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ffffff !important;
            -webkit-backdrop-filter: none;
            backdrop-filter: none;
            border-radius: 20px 20px 0 0;
            border-top: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.06);
            padding: 16px 16px 20px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
            transition: none !important;
            z-index: 9999 !important;
            min-height: 200px;
            max-height: 320px;
        }
        .voice-panel.open {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
            touch-action: none;
        }
        .voice-panel.cancel-armed {
            background: #ffffff !important;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.06);
        }
        .voice-drag-bar {
            visibility: hidden;
            width: 36px;
            height: 4px;
            margin: 0 auto 16px;
        }
        .voice-hint {
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            min-height: 40px;
        }
        .input-area-with-hint {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 3px 8px 3px 14px;
            background: #FFFFFF;
            border: 1px solid var(--border);
            border-radius: var(--input-radius);
            transition: border-color var(--transition-fast);
        }
        .input-area-with-hint:focus-within {
            border-color: var(--border);
        }
        .input-area-inner {
            flex: 1;
            min-width: 0;
            position: relative;
        }
        .text-placeholder {
            position: absolute;
            left: 4px;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            color: var(--placeholder);
            font-size: 16px;
            font-weight: 400;
            line-height: 22px;
            text-align: left;
            pointer-events: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: none;
        }
        .voice-input-hint {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: #333333;
            letter-spacing: 0.2em;
            pointer-events: none;
            display: none;
        }
        .input-container.voice-mode .voice-input-hint {
            display: block;
        }
        /* 语音面板打开时：禁止页面滚动，保证上滑取消手势稳定 */
        body.voice-panel-open {
            overflow-y: hidden;
        }
        body.voice-panel-open .voice-input-hint {
            display: none !important;
        }
        /* 语音模式下，输入框内按住区域（点/按住此处才录音，麦克风键只做切换） */
        .voice-hold-overlay {
            display: none;
            position: absolute;
            inset: 0;
            z-index: 2;
            cursor: pointer;
            touch-action: none;
        }
        .input-container.voice-mode .voice-hold-overlay {
            display: block;
        }
        .voice-waveform-wrap {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 56px;
            height: 56px;
            margin-bottom: 16px;
        }
        .voice-waveform {
            display: block;
            width: 100%;
            max-width: 280px;
            height: 48px;
            background: transparent;
        }
        /* 录音由按住输入框触发，面板内不再显示麦克风按钮（麦克风键仅作语音/键盘切换） */
        .voice-panel .voice-mic-btn {
            display: none;
        }
        .voice-mic-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid var(--green);
            background: var(--bg);
            color: var(--green);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            cursor: pointer;
            transition: background var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast);
            -webkit-user-select: none;
            user-select: none;
        }
        .voice-mic-btn.recording {
            background: var(--green);
            color: #fff;
            border-color: var(--green);
        }
        .voice-mic-btn.cancel-armed {
            background: var(--danger);
            color: #fff;
            border-color: var(--danger);
        }
        .voice-mic-btn svg {
            width: 36px;
            height: 36px;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        /* E. + 面板 BottomSheet（z-index 高于 input-container:100，确保弹出在输入栏上方） */
        .plus-sheet-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-sheet), visibility var(--transition-sheet);
            z-index: 101;
        }
        .plus-sheet-backdrop.open {
            opacity: 1;
            visibility: visible;
        }
        /* 未打开时完全不可见、不占视线，避免刷新后底部一直看到方框 */
        .plus-sheet {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            min-height: 280px;
            background: var(--bg);
            border-radius: 18px 18px 0 0;
            padding: 8px 20px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
            transition: transform var(--transition-sheet), opacity var(--transition-sheet);
            z-index: 102;
        }
        .plus-sheet.open {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        .plus-sheet-status {
            padding: 12px 14px 10px;
            font-size: 13px;
            color: rgba(0,0,0,.65);
            border-bottom: 1px solid rgba(0,0,0,.06);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .plus-sheet-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px 88px;
        }
        .plus-sheet-item {
            height: 76px;
            min-height: 48px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 6px;
            padding: 10px 12px;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.06);
            background: rgba(255,255,255,0.86);
            border-radius: 16px;
            box-shadow: none;
            font-size: 16px;
            color: var(--text);
            text-align: center;
            transition: background var(--transition-fast);
        }
        .plus-sheet-item:hover {
            background: rgba(255,255,255,0.96);
        }
        .plus-sheet-item:active {
            background: rgba(255,255,255,0.82);
        }
        .plus-sheet-item svg {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            stroke: var(--text);
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        /* + 面板：当前会员档位条（黑白干净） */
        .plus-sheet-tier {
            margin-top: 14px;
            padding: 13px 14px;
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,0.06);
            background: rgba(255,255,255,0.86);
            box-shadow: none;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            cursor: pointer;
            user-select: none;
        }
        .plus-sheet-tier:active {
            background: rgba(255,255,255,0.82);
        }
        .plus-sheet-tier:hover {
            background: rgba(255,255,255,0.96);
        }
        .plus-sheet-tier .tier-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }
        .plus-sheet-tier .tier-name {
            font-size: 16px;
            font-weight: 600;
            color: rgba(0,0,0,0.88);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .plus-sheet-tier .tier-sub {
            font-size: 13px;
            color: rgba(0,0,0,0.58);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .plus-sheet-tier .tier-right { display: none; }
        /* ===== + 面板：GPT 风格定版 ===== */
        #plusSheet {
            will-change: transform, opacity;
            opacity: 0;
            transform: translateY(18px);
            transition: transform .18s ease-out, opacity .18s ease-out;
        }
        #plusSheet.open {
            opacity: 1;
            transform: translateY(0);
        }
        .plus-sheet-content {
            padding: 14px 14px 18px;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
        }
        .plus-sheet-content {
            padding-top: 12px;
        }
        .plus-sheet-status {
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(0,0,0,.03);
            color: rgba(0,0,0,.68);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 12px;
        }
        #plusSheetStatus.plus-sheet-status {
            margin-top: 10px;
            padding: 8px 12px;
            font-size: 12px;
            color: rgba(0,0,0,.55);
            background: rgba(0,0,0,.03);
            border-radius: 12px;
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0;
        }
        .plus-sheet-grid {
            margin-top: 0 !important;
            margin-bottom: 0;
        }
        .plus-sheet-content {
            padding-top: 6px !important;
        }
        .plus-sheet-item {
            height: 76px;
            border-radius: 16px;
            font-weight: 700;
            font-size: 14px;
        }
        .plus-sheet-tier {
            margin-top: 0;
        }
        /* + 面板：会员中心卡片（真实 DOM，两行文案） */
        #tier-card { margin-top: 42px; }
        #tier-card .tier-left {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        #tier-card .tier-title {
            font-size: 16px;
            font-weight: 600;
            color: rgba(0,0,0,0.88);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #tier-card .tier-tierline {
            font-size: 13px;
            color: rgba(0,0,0,0.58);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #tier-card .tier-tiername {
            font-weight: 700;
            color: inherit;
        }
        #tier-card .tier-row-sub {
            margin-top: 4px;
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
            font-size: 13px;
            color: rgba(0,0,0,0.58);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* 额度用尽：灰按钮（可点击以提示一次） */
        .disabled, button:disabled {
            opacity: .38;
            cursor: not-allowed;
            pointer-events: auto;
        }

        /* ===== 会员中心：收紧空白 + 取消 flex 均分撑高（最终版覆盖） ===== */
        #membership-modal-backdrop {
            overflow: hidden !important;
        }
        #membership-modal {
            height: auto !important;
            max-height: min(720px, calc(100vh - 24px)) !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            padding: 14px !important;
        }
        #membership-modal::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        #membership-modal .membership-cards,
        #membership-modal .cards-list,
        #membership-modal .modal-body {
            flex: 0 0 auto !important;
            overflow: visible !important;
            height: auto !important;
            max-height: none !important;
        }
        #membership-modal .membership-cards {
            flex: 0 0 auto !important;
            min-height: auto !important;
            padding-top: 8px !important;
            gap: 10px !important;
        }
        #membership-modal .membership-card {
            flex: 0 0 auto !important;
            min-height: auto !important;
            padding: 12px !important;
            gap: 6px !important;
            margin-bottom: 10px !important;
        }
        #membership-modal .membership-header {
            padding: 2px 2px 8px !important;
        }
        #membership-modal .membership-sub {
            padding: 6px 2px 8px !important;
            font-size: 12.5px !important;
            line-height: 1.35 !important;
        }
        #membership-modal .card-desc {
            line-height: 1.35 !important;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        #membership-modal .card-btn {
            height: 42px !important;
            margin-top: 8px !important;
            border-radius: 12px !important;
        }

        /* P0：会员中心空白再收紧一点（只动间距/内边距，不改结构） */
        #membership-modal {
            padding: 12px !important;
            height: min(680px, calc(100vh - 32px)) !important;
            max-height: calc(100vh - 24px) !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        #membership-modal .membership-header {
            padding: 0 2px 6px !important;
        }
        #membership-modal .membership-sub {
            margin: 4px 0 6px !important;
            padding: 0 2px !important;
        }
        #membership-modal .membership-cards {
            padding-top: 6px !important;
            gap: 8px !important;
        }
        #membership-modal .membership-card {
            padding: 10px !important;
            gap: 4px !important;
            margin-bottom: 8px !important;
        }
        #membership-modal .card-btn {
            height: 40px !important;
            margin-top: 6px !important;
        }

    </style>
    <script>
        (function () {
            try {
                var accountId = (localStorage.getItem('account_id') || '').trim();
                var accountType = (localStorage.getItem('account_type') || '').trim();
                var validType = (accountType === 'anon' || accountType === 'phone');
                if (!accountId || !validType) {
                    location.replace('login.html');
                }
            } catch (e) {
                location.replace('login.html');
            }
        })();
    </script>
</head>
<body>
    <div class="app-shell" id="app">
    <header class="app-bar">
        <button type="button" class="app-bar-left" id="appBarLeft" aria-label="菜单">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="14" y2="15"/></svg>
        </button>
        <span class="app-bar-title-wrap"><span class="app-bar-title">农技千问</span></span>
    </header>

    <!-- 标准侧边抽屉：主内容仍在，抽屉 #drawer + 遮罩 #drawer-mask -->
    <div id="drawer-mask" aria-hidden="true"></div>
    <div id="drawer" aria-hidden="true">
        <div class="drawer-content">
            <div class="drawer-menu-group">
                <div class="menu-card" data-menu="account-manage">
                    <span class="menu-icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span>
                    <span class="menu-label">账号管理</span>
                    <span class="menu-card-right" id="drawerAccountText">-</span>
                </div>
                <div class="menu-card" data-menu="membership">
                    <span class="menu-icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg></span>
                    <span class="menu-label">会员中心</span>
                    <span class="menu-card-right" id="drawerTierText">当前：-</span>
                </div>
                <div class="menu-card" data-menu="privacy">
                    <span class="menu-icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></span>
                    <span class="menu-label">隐私政策</span>
                </div>
                <div class="menu-card" data-menu="terms">
                    <span class="menu-icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg></span>
                    <span class="menu-label">用户协议</span>
                </div>
                <div class="menu-card" data-menu="help">
                    <span class="menu-icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><path d="M4.93 4.93l4.24 4.24"/><path d="M14.83 14.83l4.24 4.24"/><path d="M14.83 9.17l4.24-4.24"/><path d="M9.17 14.83l-4.24 4.24"/></svg></span>
                    <span class="menu-label">帮助与反馈</span>
                </div>
                <div class="menu-card" data-menu="about">
                    <span class="menu-icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg></span>
                    <span class="menu-label">关于</span>
                </div>
                <div class="menu-card menu-card-danger" data-menu="logout">
                    <span class="menu-icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="M16 17l5-5-5-5"/><path d="M21 12H9"/></svg></span>
                    <span class="menu-label">退出登录</span>
                </div>
            </div>
        </div>
    </div>
    <div id="logoutConfirmMask" aria-hidden="true">
        <div id="logoutConfirmDialog" onclick="event.stopPropagation()">
            <div class="logout-confirm-title">确认退出登录</div>
            <div class="logout-confirm-text">退出后将返回登录页</div>
            <div class="logout-confirm-actions">
                <button type="button" class="logout-confirm-btn logout-confirm-cancel" id="logoutConfirmCancel">取消</button>
                <button type="button" class="logout-confirm-btn logout-confirm-ok" id="logoutConfirmOk">退出</button>
            </div>
        </div>
    </div>

    <!-- 会员中心：一屏可见（默认无内部滚动条） -->
    <div id="membership-modal-backdrop" aria-hidden="true">
        <div id="membership-modal" onclick="event.stopPropagation()">
            <div class="membership-header">
                <div class="membership-title">会员中心</div>
                <button class="membership-close" type="button" data-close-membership aria-label="关闭">✕</button>
            </div>
            <div class="membership-sub" id="membershipSub"></div>
            <div class="membership-cards">
                <div class="membership-card" data-tier="plus">
                    <div class="card-top">
                        <div class="card-name">Plus</div>
                        <div class="card-price">¥19.9/月</div>
                    </div>
                    <div class="card-desc">30 次对话/天 <span class="dot">•</span> 5 次图片上传/天（Flash）</div>
                    <div class="card-desc">适合：日常问答、轻量咨询、随手拍图识别</div>
                    <button type="button" class="card-btn" data-tier="plus">开通 Plus</button>
                </div>
                <div class="membership-card" data-tier="pro">
                    <div class="card-badge">推荐</div>
                    <div class="card-top">
                        <div class="card-name">Pro</div>
                        <div class="card-price">¥29.9/月</div>
                    </div>
                    <div class="card-desc">60 次对话/天 <span class="dot">•</span> 10 次图片上传/天（Flash）</div>
                    <div class="card-desc">适合：高频使用、额度更稳、更多图片诊断</div>
                    <button type="button" class="card-btn" data-tier="pro">开通 Pro</button>
                </div>
                <div class="membership-card" data-tier="expert">
                    <div class="card-badge">推理/图片更强</div>
                    <div class="card-top">
                        <div class="card-name">专家模式</div>
                        <div class="card-price">¥49.9/月</div>
                    </div>
                    <div class="card-desc">80 次对话/天 <span class="dot">•</span> 20 次图片上传/天（MAX）</div>
                    <div class="card-desc">适合：复杂问题、多图综合判断、推理更强</div>
                    <button type="button" class="card-btn" data-tier="expert">开通 专家模式</button>
                </div>
            </div>
            <div class="membership-footnote">注：1 次图片上传最多 4 张图（系统默认中等压缩，不限制用户文件大小）。</div>
        </div>
    </div>
    <div id="toast">功能开发中</div>

    <main class="main">
        <div class="messages-wrapper" id="messagesWrapper">
            <div class="empty-state" id="emptyState">
                <div class="logo"></div>
                <p class="empty-state-hint">
                    欢迎咨询种植、病虫害防治、施肥等问题。<br>
                    描述作物/地区/现象，必要时可上传照片。
                </p>
            </div>
            <div class="messages-container" id="messagesContainer"></div>
        </div>

        <div class="input-container" id="inputContainer">
            <div id="imagePreviewContainer" class="image-preview-container" style="display: none;"></div>
            <div class="input-wrapper">
                <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                <input type="file" id="cameraInput" class="camera-input" accept="image/*" capture="environment">
                <button type="button" class="add-button" id="addButton" title="图片或拍照">+</button>
                <div class="input-area-with-hint">
                    <div class="input-area-inner">
                        <div class="voice-input-hint" id="voiceInputHint">按住说话</div>
                        <div class="text-placeholder" id="textPlaceholder"></div>
                        <textarea id="textInput" class="text-input" placeholder="" rows="1" maxlength="6000"></textarea>
                        <div class="voice-hold-overlay" id="voiceHoldOverlay" aria-label="按住说话"></div>
                    </div>
                    <button type="button" class="btn-mic-or-keyboard" id="btnMicOrKeyboard" title="语音/键盘">
                        <span class="icon-mic"><svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 1 3 3v8a3 3 0 0 1-6 0V4a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></span>
                        <span class="icon-keyboard" style="margin-top: -3px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.7" stroke-linecap="butt" stroke-linejoin="miter"><rect x="1.5" y="6" width="21" height="15" rx="1.2"/><rect x="5.62" y="8.62" width="0.85" height="0.85" rx="0" ry="0" fill="currentColor"/><rect x="11.62" y="8.62" width="0.85" height="0.85" rx="0" ry="0" fill="currentColor"/><rect x="17.62" y="8.62" width="0.85" height="0.85" rx="0" ry="0" fill="currentColor"/><rect x="5.62" y="12.62" width="0.85" height="0.85" rx="0" ry="0" fill="currentColor"/><rect x="11.62" y="12.62" width="0.85" height="0.85" rx="0" ry="0" fill="currentColor"/><rect x="17.62" y="12.62" width="0.85" height="0.85" rx="0" ry="0" fill="currentColor"/><rect x="5" y="16.25" width="14" height="1.5" rx="0" ry="0" fill="currentColor" stroke="none"/></svg></span>
                    </button>
                    <button type="button" class="btn-send btn-hidden" id="btnSend" title="发送">
                        <svg viewBox="0 0 24 24"><path d="M12 20V3.2 M6.0 10.8L12 3.2 18.0 10.8"/></svg>
                    </button>
                    <button type="button" class="btn-stop btn-hidden" id="btnStop" title="停止" aria-label="停止">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                            <rect x="4" y="4" width="16" height="16" rx="0"></rect>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </main>
    <button type="button" id="scrollToBottomBtn" class="scroll-to-bottom-btn" aria-label="回到底部" style="display: none;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M19 12l-7 7-7-7"/></svg></button>

    <div class="voice-panel" id="voicePanel">
        <div class="voice-drag-bar"></div>
        <p class="voice-hint" id="voiceHint">按住说话</p>
        <div class="voice-waveform-wrap"><canvas class="voice-waveform" id="voiceWaveform" width="280" height="48"></canvas></div>
        <button type="button" class="voice-mic-btn" id="voiceMicBtn">
            <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 1 3 3v8a3 3 0 0 1-6 0V4a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
        </button>
    </div>

    <div class="plus-sheet-backdrop" id="plusSheetBackdrop"></div>
    <div class="plus-sheet" id="plusSheet">
        <div class="plus-sheet-content">
            <div class="plus-sheet-grid">
                <button type="button" class="plus-sheet-item" id="plusSheetGallery" data-action="upload">
                    <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                    图片上传
                </button>
                <button type="button" class="plus-sheet-item" id="plusSheetCamera" data-action="camera">
                    <svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                    拍照
                </button>
            </div>
            <div class="plus-sheet-tier" id="tier-card" role="button" tabindex="0">
                <div class="tier-left">
                    <div class="tier-title" id="tier-name">会员中心</div>
                    <div class="tier-tierline">当前生效：<strong class="tier-tiername" id="tier-tier">-</strong> ｜ 查看套餐与额度</div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div id="copyPopover" class="copy-popover" aria-hidden="true">
        <button id="copyBtn" type="button">复制</button>
    </div>

    <div id="copySheetMask" class="copy-sheet-mask" aria-hidden="true"></div>
    <div id="copySheet" class="copy-sheet" aria-hidden="true">
        <div class="copy-sheet-handle"></div>
        <div class="copy-sheet-actions">
            <button id="copySheetCopyBtn" type="button">复制全文</button>
            <button id="copySheetCloseBtn" type="button">关闭</button>
        </div>
        <div id="copySheetBody" class="copy-sheet-body"></div>
    </div>

    <script>
        const MAX_ROUNDS = 30;
        const MAX_MESSAGES = MAX_ROUNDS * 2;
        const MAX_TEXT_LEN = 6000;
        const messagesWrapper = document.getElementById('messagesWrapper');
        const messagesContainer = document.getElementById('messagesContainer');
        const emptyState = document.getElementById('emptyState');
        const textInput = document.getElementById('textInput');
        const textPlaceholder = document.getElementById('textPlaceholder');
        const addButton = document.getElementById('addButton');
        const fileInput = document.getElementById('fileInput');
        const cameraInput = document.getElementById('cameraInput');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const btnMicOrKeyboard = document.getElementById('btnMicOrKeyboard');
        const btnSend = document.getElementById('btnSend');
        const btnStop = document.getElementById('btnStop');
        const voicePanel = document.getElementById('voicePanel');
        const voiceHint = document.getElementById('voiceHint');
        const voiceMicBtn = document.getElementById('voiceMicBtn');
        const voiceWaveform = document.getElementById('voiceWaveform');
        const voiceHoldOverlay = document.getElementById('voiceHoldOverlay');
        const inputContainer = document.getElementById('inputContainer');
        const plusSheet = document.getElementById('plusSheet');
        const plusSheetBackdrop = document.getElementById('plusSheetBackdrop');
        const plusSheetGallery = document.getElementById('plusSheetGallery');
        const plusSheetCamera = document.getElementById('plusSheetCamera');
        const drawer = document.getElementById('drawer');
        const drawerMask = document.getElementById('drawer-mask');
        const logoutConfirmMask = document.getElementById('logoutConfirmMask');
        const logoutConfirmCancel = document.getElementById('logoutConfirmCancel');
        const logoutConfirmOk = document.getElementById('logoutConfirmOk');
        const appBarLeft = document.getElementById('appBarLeft');
        const copyPopover = document.getElementById('copyPopover');
        const copyBtn = document.getElementById('copyBtn');
        const copySheetMask = document.getElementById('copySheetMask');
        const copySheet = document.getElementById('copySheet');
        const copySheetBody = document.getElementById('copySheetBody');
        const copySheetCopyBtn = document.getElementById('copySheetCopyBtn');
        const copySheetCloseBtn = document.getElementById('copySheetCloseBtn');

        function closeDrawer() {
            drawer.classList.remove('open');
            drawerMask.classList.remove('show');
            drawer.setAttribute('aria-hidden', 'true');
            drawerMask.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }
        function openDrawer() {
            updateTierUIEverywhere();
            drawer.classList.add('open');
            drawerMask.classList.add('show');
            drawer.setAttribute('aria-hidden', 'false');
            drawerMask.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
            updateDrawerLoginState();
        }
        function toggleDrawer() {
            const open = drawer.classList.contains('open');
            open ? closeDrawer() : openDrawer();
        }
        closeDrawer();
        appBarLeft.addEventListener('click', toggleDrawer);
        drawerMask.addEventListener('click', closeDrawer);
        function closeLogoutConfirm() {
            if (!logoutConfirmMask) return;
            logoutConfirmMask.classList.remove('open');
            logoutConfirmMask.setAttribute('aria-hidden', 'true');
        }
        function openLogoutConfirm() {
            if (!logoutConfirmMask) return;
            logoutConfirmMask.classList.add('open');
            logoutConfirmMask.setAttribute('aria-hidden', 'false');
        }
        if (logoutConfirmMask) {
            logoutConfirmMask.addEventListener('click', closeLogoutConfirm);
        }
        if (logoutConfirmCancel) {
            logoutConfirmCancel.addEventListener('click', closeLogoutConfirm);
        }
        if (logoutConfirmOk) {
            logoutConfirmOk.addEventListener('click', function() {
                closeLogoutConfirm();
                performLogoutToLogin();
            });
        }
        window.addEventListener('focus', function() { updateDrawerLoginState(); });
        window.addEventListener('pageshow', function() { updateDrawerLoginState(); });
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) updateDrawerLoginState();
        });

        var membershipBackdrop = document.getElementById('membership-modal-backdrop');
        var membershipModal = document.getElementById('membership-modal');
        var membershipCloseBtn = document.querySelector('[data-close-membership]');
        var toastEl = document.getElementById('toast');
        var HELP_FEEDBACK_URL = 'https://t0zamvo8k09.feishu.cn/share/base/form/shrcn9AWNObwhAUnHxVzldd9mwh';
        function openLocalPage(path) {
            if (/^https?:\/\//i.test(path)) {
                try {
                    if (window.AndroidInterface && typeof window.AndroidInterface.openUrl === 'function') {
                        window.AndroidInterface.openUrl(path);
                        return;
                    }
                } catch (e) {}
                try {
                    var popup = window.open(path, '_blank');
                    if (popup) return;
                } catch (e2) {}
                window.location.href = path;
                return;
            }
            window.location.href = path;
        }
        function getAccountId() {
            var val = localStorage.getItem('account_id');
            if (val && String(val).trim()) return String(val).trim();
            if (window.account_id && String(window.account_id).trim()) return String(window.account_id).trim();
            return '';
        }
        function getAccountType() {
            var t = localStorage.getItem('account_type');
            if (t && String(t).trim()) return String(t).trim();
            if (window.account_type && String(window.account_type).trim()) return String(window.account_type).trim();
            var accountId = getAccountId();
            if (!accountId) return '';
            return accountId.indexOf('anon_') === 0 ? 'anon' : 'phone';
        }
        function setPhoneLoginIdentity(phoneAccountId) {
            var nextId = (phoneAccountId == null ? '' : String(phoneAccountId).trim());
            if (!nextId) return false;
            var prevId = getAccountId();
            if (getAccountType() === 'anon' && prevId) {
                localStorage.setItem('merge_from_anon', prevId);
            }
            localStorage.setItem('account_id', nextId);
            localStorage.setItem('account_type', 'phone');
            localStorage.removeItem('debug_tier');
            window.account_id = nextId;
            window.account_type = 'phone';
            updateDrawerLoginState();
            return true;
        }
        function getIdentityReservedParams() {
            return {
                account_id: getAccountId() || '',
                account_type: getAccountType() || '',
                merge_from_anon: localStorage.getItem('merge_from_anon') || ''
            };
        }
        function getMaskedAccountText() {
            if (getAccountType() === 'anon') return '匿名';
            var account = getAccountId();
            var digits = account.replace(/\D/g, '');
            if (digits.length >= 7) return digits.slice(0, 3) + '****' + digits.slice(-2);
            return '已登录';
        }
        function isLoggedIn() {
            return !!getAccountId();
        }
        function performLogoutToLogin() {
            localStorage.removeItem('account_id');
            localStorage.removeItem('account_type');
            localStorage.removeItem('debug_tier');
            window.account_id = '';
            window.account_type = '';
            location.replace('login.html');
        }
        function updateDrawerLoginState() {
            var loggedIn = isLoggedIn();
            if (!loggedIn) { location.replace('login.html'); return; }
            var accountText = document.getElementById('drawerAccountText');
            if (accountText) accountText.textContent = getMaskedAccountText();
        }
        window.__refreshDrawerLoginState = updateDrawerLoginState;
        window.__setPhoneLoginIdentity = setPhoneLoginIdentity;
        window.__getIdentityReservedParams = getIdentityReservedParams;

        // ==================== 开关：仅切换 Data 层来源，UI 不改 ====================
        var USE_BACKEND_AB = false;           // 实际生效在 Android BuildConfig.USE_BACKEND_AB；此处仅文档
        var USE_BACKEND_ENTITLEMENT = false; // true 时额度/展示只读后端 GET /api/entitlement

        // ==================== Data 层：存储 + 后端 HTTP（不直接给 UI，经 Domain） ====================
        var STORAGE_KEY_TIER = 'membership_tier';
        var STORAGE_KEY_SUBSCRIPTIONS = 'membership_subscriptions';
        var SUBSCRIPTION_DAYS = 30;
        function getSubscriptions() {
            try {
                var raw = localStorage.getItem(STORAGE_KEY_SUBSCRIPTIONS);
                if (raw) {
                    var arr = JSON.parse(raw);
                    return Array.isArray(arr) ? arr : [];
                }
            } catch (e) {}
            return [];
        }
        function saveSubscriptions(arr) {
            localStorage.setItem(STORAGE_KEY_SUBSCRIPTIONS, JSON.stringify(arr));
        }
        function getEntitlementFromBackend(cb) {
            if (!USE_BACKEND_ENTITLEMENT || typeof cb !== 'function') return;
            if (!window.AndroidInterface || typeof window.AndroidInterface.getEntitlement !== 'function') { cb(null); return; }
            window._entitlementCallback = window._entitlementCallback || {};
            var id = 'ent_' + Date.now();
            window._entitlementCallback[id] = function(ent) {
                if (ent) window._cachedEntitlement = ent;
                cb(ent);
            };
            window.AndroidInterface.getEntitlement(id);
        }
        function getTodayKey() {
            var d = new Date();
            return 'usage_' + d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        }
        function getUsage() {
            var key = getTodayKey();
            try {
                var raw = localStorage.getItem(key);
                if (raw) {
                    var o = JSON.parse(raw);
                    return { chat: (o.chat || 0) | 0, img: (o.img || 0) | 0 };
                }
            } catch (e) {}
            return { chat: 0, img: 0 };
        }
        function setUsage(chat, img) {
            var key = getTodayKey();
            localStorage.setItem(key, JSON.stringify({ chat: chat, img: img }));
        }

        // ==================== Domain 层：会员裁决、扣减口径、输入规则（只调 Data，不直接改 DOM） ====================
        var TIER_ORDER = { free: 0, plus: 1, pro: 2, expert: 3 };
        var tier_config = {
            free:   { label: '免费版', chatPerDay: 10, imgPerDay: 1,  model: 'flash' },
            plus:   { label: 'Plus',   chatPerDay: 30, imgPerDay: 5,  model: 'flash' },
            pro:    { label: 'Pro',    chatPerDay: 60, imgPerDay: 10, model: 'flash' },
            expert: { label: '专家模式', chatPerDay: 80, imgPerDay: 20, model: 'expert' }
        };
        var COPY_REFRESH_FAIL = '权益状态暂未更新，请稍后重试';
        function getTierLevel(tier) { return TIER_ORDER[tier] != null ? TIER_ORDER[tier] : -1; }
        // 状态机 (a)(b)(c)；仅读 Data 层 getSubscriptions/saveSubscriptions
        function computeEntitlement() {
            var now = Date.now();
            var list = getSubscriptions();
            for (var i = 0; i < list.length; i++) {
                var s = list[i];
                if (s.status !== 'active' && s.status !== 'paused') continue;
                var endMs = s.end_at || 0;
                if (s.status === 'active' && endMs <= now) {
                    s.status = 'expired';
                    var pausedSubs = list.filter(function(x) { return x.status === 'paused' && (x.remaining_seconds > 0 || (x.end_at && x.end_at > now)); });
                    var best = null;
                    for (var j = 0; j < pausedSubs.length; j++) {
                        if (!best || getTierLevel(pausedSubs[j].tier) > getTierLevel(best.tier)) best = pausedSubs[j];
                    }
                    if (best) {
                        best.status = 'active';
                        best.resume_at = now;
                        best.end_at = now + (best.remaining_seconds || 0) * 1000;
                        best.remaining_seconds = 0;
                    }
                }
            }
            var activeList = list.filter(function(s) { return s.status === 'active' && s.end_at > now; });
            var effective = null;
            for (var i = 0; i < activeList.length; i++) {
                if (!effective || getTierLevel(activeList[i].tier) > getTierLevel(effective.tier)) effective = activeList[i];
            }
            for (var i = 0; i < list.length; i++) {
                var s = list[i];
                if (s.status !== 'active' && s.status !== 'paused') continue;
                if (effective && getTierLevel(s.tier) < getTierLevel(effective.tier)) {
                    if (s.status !== 'paused') {
                        s.status = 'paused';
                        s.pause_at = now;
                        s.remaining_seconds = Math.max(0, Math.floor((s.end_at - now) / 1000));
                    }
                }
            }
            var pausedList = list.filter(function(s) { return s.status === 'paused'; });
            var effectiveTier = effective ? effective.tier : 'free';
            var effectiveEndAt = effective ? effective.end_at : 0;
            var pausedForShow = pausedList.map(function(p) {
                var sec = p.remaining_seconds != null ? p.remaining_seconds : Math.max(0, Math.floor((p.end_at - now) / 1000));
                return { tier: p.tier, remaining_days: Math.ceil(sec / 86400) };
            });
            saveSubscriptions(list);
            var out = { effective_tier: effectiveTier, effective_end_at: effectiveEndAt, paused_list: pausedForShow };
            if (typeof console !== 'undefined' && console.log) console.log('[ENT] entitlement:', JSON.stringify(out));
            return out;
        }
        function resetUsageIfNewDay() {
            var key = getTodayKey();
            var stored = localStorage.getItem('usage_date');
            if (stored !== key) {
                localStorage.setItem('usage_date', key);
                setUsage(0, 0);
                if (typeof refreshQuotaUI === 'function') refreshQuotaUI();
            }
        }
        function migrateLegacyToSubscriptions() {
            var list = getSubscriptions();
            if (list.length > 0) return;
            var tier = (localStorage.getItem(STORAGE_KEY_TIER) || 'free').toLowerCase();
            var exp = Number(localStorage.getItem('membership_expire_at') || 0);
            if (tier !== 'free' && tier_config[tier] && exp > Date.now()) {
                var now = Date.now();
                list.push({ user_id: 'local_user', tier: tier, start_at: exp - SUBSCRIPTION_DAYS * 86400000, end_at: exp, status: 'active', order_id: 'legacy_1', created_at: now });
                saveSubscriptions(list);
            }
        }
        function getCurrentTier() {
            if (getAccountType() === 'anon') {
                var debugTier = (localStorage.getItem('debug_tier') || '').toLowerCase();
                if (tier_config[debugTier]) return debugTier;
            }
            if (USE_BACKEND_ENTITLEMENT) {
                if (window._cachedEntitlement) {
                    var t = window._cachedEntitlement.effective_tier;
                    return tier_config[t] ? t : 'free';
                }
                return 'free'; // 后端不可用时不回退本地，不污染会员状态，避免两套真相打架
            }
            migrateLegacyToSubscriptions();
            var list = getSubscriptions();
            if (list.length === 0) {
                var t = (localStorage.getItem(STORAGE_KEY_TIER) || 'free').toLowerCase();
                return tier_config[t] ? t : 'free';
            }
            var ent = computeEntitlement();
            return tier_config[ent.effective_tier] ? ent.effective_tier : 'free';
        }
        function getMembership() {
            if (getAccountType() === 'anon') {
                return { tier: getCurrentTier(), exp: 0, paused: [] };
            }
            if (USE_BACKEND_ENTITLEMENT) {
                if (window._cachedEntitlement) {
                    var e = window._cachedEntitlement;
                    return { tier: e.effective_tier || 'free', exp: e.effective_end_at || 0, paused: e.paused_list || [] };
                }
                return { tier: 'free', exp: 0, paused: [] }; // 后端不可用时不回退本地
            }
            migrateLegacyToSubscriptions();
            var list = getSubscriptions();
            if (list.length === 0) {
                var tier = localStorage.getItem(STORAGE_KEY_TIER) || 'free';
                var exp = Number(localStorage.getItem('membership_expire_at') || 0);
                if (tier !== 'free' && exp && Date.now() > exp) {
                    localStorage.setItem(STORAGE_KEY_TIER, 'free');
                    localStorage.setItem('membership_expire_at', '0');
                    return { tier: 'free', exp: 0, paused: [] };
                }
                return { tier: tier, exp: exp, paused: [] };
            }
            var ent = computeEntitlement();
            localStorage.setItem(STORAGE_KEY_TIER, ent.effective_tier);
            localStorage.setItem('membership_expire_at', String(ent.effective_end_at));
            return { tier: ent.effective_tier, exp: ent.effective_end_at, paused: ent.paused_list };
        }
        function formatDate(ts) {
            if (!ts) return '';
            var d = new Date(ts);
            var y = d.getFullYear();
            var m = String(d.getMonth() + 1).padStart(2, '0');
            var da = String(d.getDate()).padStart(2, '0');
            return y + '-' + m + '-' + da;
        }
        function daysLeft(ts) {
            if (!ts) return 0;
            return Math.max(0, Math.ceil((ts - Date.now()) / 86400000));
        }
        // 幂等：同一 order_id 只允许写一次订阅变更
        function hasOrderId(orderId) {
            var list = getSubscriptions();
            for (var i = 0; i < list.length; i++) if (list[i].order_id === orderId) return true;
            return false;
        }
        function applyPurchase(orderId, tier) {
            if (!tier_config[tier] || tier === 'free') return;
            if (hasOrderId(orderId)) return;
            var list = getSubscriptions();
            var now = Date.now();
            var effectiveTier = (computeEntitlement()).effective_tier;
            var effectiveLevel = getTierLevel(effectiveTier);
            var reqLevel = getTierLevel(tier);
            if (reqLevel < effectiveLevel) return;
            if (reqLevel === effectiveLevel) {
                for (var i = 0; i < list.length; i++) {
                    if (list[i].status === 'active' && list[i].tier === tier && list[i].end_at > now) {
                        list[i].end_at += SUBSCRIPTION_DAYS * 86400000;
                        saveSubscriptions(list);
                        computeEntitlement();
                        if (typeof updateDrawerFromTierAndUsage === 'function') updateDrawerFromTierAndUsage();
                        if (typeof updateMembershipUI === 'function') updateMembershipUI();
                        return;
                    }
                }
            }
            var newSub = { user_id: 'local_user', tier: tier, start_at: now, end_at: now + SUBSCRIPTION_DAYS * 86400000, status: 'active', order_id: orderId, created_at: now };
            list.push(newSub);
            saveSubscriptions(list);
            var ent = computeEntitlement();
            localStorage.setItem(STORAGE_KEY_TIER, ent.effective_tier);
            localStorage.setItem('membership_expire_at', String(ent.effective_end_at));
            if (typeof updateDrawerFromTierAndUsage === 'function') updateDrawerFromTierAndUsage();
            if (typeof updateMembershipUI === 'function') updateMembershipUI();
        }
        function setCurrentTier(tier) {
            if (!tier_config[tier]) return;
            if (getAccountType() === 'anon') {
                localStorage.setItem('debug_tier', tier);
                if (typeof updateDrawerFromTierAndUsage === 'function') updateDrawerFromTierAndUsage();
                if (typeof updateMembershipUI === 'function') updateMembershipUI();
                return;
            }
            if (tier === 'free') {
                localStorage.setItem(STORAGE_KEY_TIER, 'free');
                localStorage.setItem('membership_expire_at', '0');
                if (typeof updateDrawerFromTierAndUsage === 'function') updateDrawerFromTierAndUsage();
                if (typeof updateMembershipUI === 'function') updateMembershipUI();
                return;
            }
            var orderId = 'local_' + Date.now();
            applyPurchase(orderId, tier);
        }
        function getQuota() {
            var c = tier_config[getCurrentTier()];
            return c ? { chat: c.chatPerDay, img: c.imgPerDay } : { chat: 10, img: 1 };
        }
        function checkQuotaBeforeSend(chatNeed, imgNeed) {
            resetUsageIfNewDay();
            var usage = getUsage();
            var quota = getQuota();
            var chatOk = (usage.chat + chatNeed) <= quota.chat;
            var imgOk = (usage.img + imgNeed) <= quota.img;
            return { allowed: chatOk && imgOk, chatOk: chatOk, imgOk: imgOk };
        }
        function incrementUsage(chatDelta, imgDelta) {
            resetUsageIfNewDay();
            var u = getUsage();
            setUsage(u.chat + (chatDelta || 0), u.img + (imgDelta || 0));
            updateDrawerFromTierAndUsage();
        }
        function getTierLabel(tier) {
            var map = { free: '免费版', plus: 'Plus', pro: 'Pro', expert: '专家模式' };
            return map[tier] || tier;
        }
        function getTierDrawerLabel(tier) {
            var map = { free: '免费', plus: 'Plus', pro: 'Pro', expert: '专家模式' };
            return map[tier] || getTierLabel(tier);
        }
        function updateTierUIEverywhere() {
            var tier = getCurrentTier();
            var usage = getUsage();
            var quota = getQuota();
            var chatLeft = Math.max(0, quota.chat - usage.chat);
            var imgLeft = Math.max(0, quota.img - usage.img);
            var fullText = '当前生效档位：' + getTierLabel(tier) + ' · 查看套餐与额度';
            var labelOnly = '当前：' + getTierDrawerLabel(tier);
            var drawerTierText = document.getElementById('drawerTierText');
            if (drawerTierText) drawerTierText.textContent = labelOnly;
        }
        function updateDrawerFromTierAndUsage() {
            resetUsageIfNewDay();
            updateTierUIEverywhere();
            updateDrawerLoginState();
        }
        // ==================== UI 层：只负责渲染/动画/灰块/置灰/Toast，不直接改订阅、不直接改 A/B ====================
        function setDisabled(selector, disabled) {
            var el = document.querySelector(selector);
            if (!el) return;
            el.classList.toggle('disabled', disabled);
            el.setAttribute('aria-disabled', disabled ? 'true' : 'false');
        }
        function refreshQuotaUI() {
            resetUsageIfNewDay();
            var tier = getCurrentTier();
            var usage = getUsage();
            var quota = getQuota();
            var chatLeft = quota.chat - usage.chat;
            var imgLeft = quota.img - usage.img;
            var canChat = chatLeft > 0;
            var canImg = imgLeft > 0;
            setDisabled('#btnSend', !canChat);
            setDisabled('#btnMicOrKeyboard', !canChat);
            setDisabled('#plusSheetGallery', !canImg);
            setDisabled('#plusSheetCamera', !canImg);
            if (typeof updateDrawerFromTierAndUsage === 'function') updateDrawerFromTierAndUsage();
        }
        function showToastOncePerDay(key, msg) {
            var day = getTodayKey();
            var k = 'toast_once_' + day + '_' + key;
            if (localStorage.getItem(k) === '1') return;
            localStorage.setItem(k, '1');
            showToast(msg);
        }
        function updateMembershipUI() {
            var m = getMembership();
            var tier = m.tier;
            var exp = m.exp;
            var currentLevel = getTierLevel(tier);
            var sub = document.getElementById('membershipSub');
            if (sub) {
                var parts = [];
                if (tier === 'free') {
                    parts.push('当前生效档位：免费版');
                } else {
                    parts.push('当前生效档位：' + getTierLabel(tier) + '（以最高档位计） · 到期：' + formatDate(exp) + '（剩余 ' + daysLeft(exp) + ' 天）');
                }
                var paused = (m.paused && m.paused.length) ? m.paused : [];
                for (var i = 0; i < paused.length; i++) {
                    parts.push('已冻结：' + getTierLabel(paused[i].tier) + '（剩余' + (paused[i].remaining_days || 0) + '天）');
                }
                sub.innerHTML = parts.join('<br>');
            }
            document.querySelectorAll('#membership-modal .membership-card').forEach(function(card) {
                var t = card.getAttribute('data-tier');
                var btn = card.querySelector('.card-btn');
                var hint = card.querySelector('.card-higher-hint');
                if (!btn) return;
                var cardLevel = getTierLevel(t);
                var isCurrent = (t === tier);
                var isHigherAlready = (currentLevel > cardLevel);
                btn.classList.remove('btn-current', 'btn-higher-disabled');
                if (hint) hint.style.display = 'none';
                if (isHigherAlready) {
                    btn.textContent = '已开通更高档位';
                    btn.disabled = false;
                    btn.classList.add('btn-higher-disabled');
                    if (!hint) {
                        hint = document.createElement('div');
                        hint.className = 'card-higher-hint';
                        card.appendChild(hint);
                    }
                    hint.textContent = '当前权益已包含';
                    hint.style.display = 'block';
                } else if (isCurrent && tier !== 'free') {
                    btn.textContent = '当前已开通';
                    btn.disabled = true;
                    btn.classList.add('btn-current');
                } else {
                    btn.disabled = false;
                    if (t === 'plus') btn.textContent = '开通 Plus';
                    else if (t === 'pro') btn.textContent = '开通 Pro';
                    else if (t === 'expert') btn.textContent = '开通 专家模式';
                }
            });
        }
        function openMembershipModal(highlightRecommended) {
            var cards = document.querySelectorAll('#membership-modal .membership-card');
            cards.forEach(function(el) {
                if (el.getAttribute('data-tier') === 'pro') el.classList.toggle('recommended-highlight', !!highlightRecommended);
                else el.classList.remove('recommended-highlight');
            });
            updateMembershipUI();
            membershipBackdrop.classList.add('open');
            membershipBackdrop.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }
        function closeMembershipModal() {
            membershipBackdrop.classList.remove('open');
            membershipBackdrop.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }
        function showToast(msg) {
            toastEl.textContent = msg != null ? msg : '功能开发中';
            toastEl.classList.add('show');
            setTimeout(function() {
                toastEl.classList.remove('show');
            }, 2000);
        }
        function getPlainTextFromMessage(msg) {
            if (!msg) return '';
            var content = msg.querySelector && msg.querySelector('.message-content');
            if (content && content.dataset.rawText !== undefined && content.dataset.rawText !== '') return content.dataset.rawText;
            if (msg.dataset && msg.dataset.rawText !== undefined && msg.dataset.rawText !== '') return msg.dataset.rawText;
            return content ? content.innerText : msg.innerText || '';
        }
        function copyText(text) {
            var t = (text != null ? text + '' : '').trim();
            if (!t) return;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(t).catch(function() {
                    if (typeof AndroidInterface !== 'undefined' && AndroidInterface.copyText) AndroidInterface.copyText(t);
                    else fallbackCopy(t);
                });
                return;
            }
            if (typeof AndroidInterface !== 'undefined' && AndroidInterface.copyText) { AndroidInterface.copyText(t); return; }
            fallbackCopy(t);
        }
        function fallbackCopy(text) {
            var ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed'; ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); } catch (e) {}
            document.body.removeChild(ta);
        }
        var copyPopoverCurrentMsg = null;
        var copyLongPressState = { timerId: null, startX: 0, startY: 0 };
        var COPY_LONG_PRESS_MS = 380;
        var COPY_MOVE_THRESHOLD = 8;
        function showCopyPopover(x, y, msgEl) {
            if (!copyPopover || !msgEl) return;
            copyPopoverCurrentMsg = msgEl;
            copyPopover.style.display = 'block';
            copyPopover.setAttribute('aria-hidden', 'false');
            var w = copyPopover.offsetWidth || 80;
            var h = copyPopover.offsetHeight || 44;
            var vw = window.innerWidth;
            var vh = window.innerHeight;
            var left = Math.max(8, Math.min(x - w / 2, vw - w - 8));
            var top = Math.max(8, Math.min(y - h - 12, vh - h - 8));
            copyPopover.style.left = left + 'px';
            copyPopover.style.top = top + 'px';
        }
        function hideCopyPopover() {
            if (copyPopover) {
                copyPopover.style.display = 'none';
                copyPopover.setAttribute('aria-hidden', 'true');
            }
            copyPopoverCurrentMsg = null;
        }
        function forceCloseCopyUI() {
            hideCopyPopover();
            closeCopySheet();
            clearCopyLongPress();
        }
        var copySheetCurrentMsg = null;
        var copySheetOpenedAt = 0;
        var copyUiScrollY = 0;
        function getRenderedHtmlFromMessage(msg) {
            if (!msg) return '';
            var content = msg.querySelector && msg.querySelector('.message-content');
            if (!content) return '';
            if (!content.classList || !content.classList.contains('md-rendered')) return '';
            return content.innerHTML || '';
        }
        function openCopySheet(msg) {
            if (!copySheet || !copySheetMask || !copySheetBody) return;
            copySheetOpenedAt = Date.now();
            document.body.classList.add('copy-ui-open');
            copyUiScrollY = window.scrollY || document.documentElement.scrollTop || 0;
            document.body.style.position = 'fixed';
            document.body.style.top = (-copyUiScrollY) + 'px';
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';
            var renderedHtml = getRenderedHtmlFromMessage(msg);
            if (renderedHtml) {
                copySheetBody.innerHTML =
                    '<div class="message-content md-rendered copy-sheet-rendered">' + renderedHtml + '</div>';
            } else {
                var text = getPlainTextFromMessage(msg);
                copySheetBody.textContent = text != null ? text : '';
            }
            copySheetCurrentMsg = msg || null;
            copySheetMask.classList.add('open');
            copySheet.classList.add('open');
            copySheetMask.setAttribute('aria-hidden', 'false');
            copySheet.setAttribute('aria-hidden', 'false');
        }
        function closeCopySheet() {
            if (!copySheet || !copySheetMask || !copySheetBody) return;
            copySheet.classList.remove('open');
            copySheetMask.classList.remove('open');
            copySheet.setAttribute('aria-hidden', 'true');
            copySheetMask.setAttribute('aria-hidden', 'true');
            copySheetBody.innerHTML = '';
            copySheetCurrentMsg = null;
            document.body.classList.remove('copy-ui-open');
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.right = '';
            document.body.style.width = '';
            window.scrollTo(0, copyUiScrollY || 0);
            copyUiScrollY = 0;
            clearCopyLongPress();
            copySheetOpenedAt = 0;
        }
        function clearCopyLongPress() {
            if (copyLongPressState.timerId) {
                clearTimeout(copyLongPressState.timerId);
                copyLongPressState.timerId = null;
            }
        }
        function onCopyLongPressStart(e) {
            if (e && e.target && e.target.closest && e.target.closest('#copySheet')) return;
            var content = e.target.closest && e.target.closest('.message-content');
            if (!content || !messagesContainer || !messagesContainer.contains(content)) return;
            var msg = content.closest('.message');
            if (!msg) return;
            var x = e.touches ? e.touches[0].clientX : e.clientX;
            var y = e.touches ? e.touches[0].clientY : e.clientY;
            clearCopyLongPress();
            copyLongPressState.startX = x;
            copyLongPressState.startY = y;
            copyLongPressState.timerId = setTimeout(function() {
                copyLongPressState.timerId = null;
                openCopySheet(msg);
            }, COPY_LONG_PRESS_MS);
        }
        function onCopyLongPressMove(e) {
            if (!copyLongPressState.timerId) return;
            var x = e.touches ? e.touches[0].clientX : e.clientX;
            var y = e.touches ? e.touches[0].clientY : e.clientY;
            var dx = x - copyLongPressState.startX;
            var dy = y - copyLongPressState.startY;
            if (Math.sqrt(dx * dx + dy * dy) > COPY_MOVE_THRESHOLD) clearCopyLongPress();
        }
        function onCopyLongPressEnd() { clearCopyLongPress(); }
        if (messagesContainer) {
            messagesContainer.addEventListener('touchstart', onCopyLongPressStart, { passive: true });
            messagesContainer.addEventListener('mousedown', onCopyLongPressStart);
        }
        document.addEventListener('touchmove', onCopyLongPressMove, { passive: true });
        document.addEventListener('mousemove', onCopyLongPressMove);
        document.addEventListener('touchend', onCopyLongPressEnd);
        document.addEventListener('mouseup', onCopyLongPressEnd);
        document.addEventListener('scroll', function() {
            if (copySheet && copySheet.classList.contains('open')) return;
            forceCloseCopyUI();
        }, true);
        if (copySheetMask) copySheetMask.addEventListener('click', closeCopySheet);
        if (copySheetCloseBtn) copySheetCloseBtn.addEventListener('click', closeCopySheet);
        function shouldIgnoreCloseByRecentlyOpened() {
            return copySheetOpenedAt && (Date.now() - copySheetOpenedAt < 250);
        }
        function isInsideCopyUI(t) {
            if (!t || !t.closest) return false;
            return !!(t.closest('#copySheet') || t.closest('#copySheetMask') || t.closest('#copyPopover'));
        }
        if (copySheetCopyBtn) {
            copySheetCopyBtn.addEventListener('click', function() {
                var txt = (copySheetBody && copySheetBody.textContent) ? copySheetBody.textContent : '';
                if (!txt && copySheetCurrentMsg) txt = getPlainTextFromMessage(copySheetCurrentMsg) || '';
                copyText(txt);
                showToast('已复制');
                closeCopySheet();
            });
        }
        document.addEventListener('touchstart', function(e) {
            var t = e && e.target;
            if (shouldIgnoreCloseByRecentlyOpened()) return;
            if (!isInsideCopyUI(t)) forceCloseCopyUI();
        }, true);
        document.addEventListener('click', function(e) {
            var t = e && e.target;
            if (shouldIgnoreCloseByRecentlyOpened()) return;
            if (!isInsideCopyUI(t)) forceCloseCopyUI();
        }, true);
        document.addEventListener('keydown', function(e) {
            if (e && (e.key === 'Escape' || e.keyCode === 27)) forceCloseCopyUI();
        }, true);
        if (copyBtn) {
            copyBtn.addEventListener('click', function() {
                var text = getPlainTextFromMessage(copyPopoverCurrentMsg);
                copyText(text);
                showToast('已复制');
                forceCloseCopyUI();
            });
        }
        if (membershipCloseBtn) {
            membershipCloseBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                closeMembershipModal();
            });
        }
        if (membershipModal) {
            membershipModal.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        if (membershipBackdrop) {
            membershipBackdrop.addEventListener('click', function(e) {
                if (e.target === membershipBackdrop) closeMembershipModal();
            });
        }
        document.querySelectorAll('#membership-modal .card-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var tier = this.getAttribute('data-tier');
                if (!tier || !tier_config[tier]) {
                    showToast('功能开发中');
                    return;
                }
                if (getAccountType() === 'anon') {
                    setCurrentTier(tier);
                    closeMembershipModal();
                    showToast('已切换档位');
                    return;
                }
                var current = getCurrentTier();
                var currentLevel = getTierLevel(current);
                var cardLevel = getTierLevel(tier);
                if (cardLevel <= currentLevel && tier !== current) {
                    showToastOncePerDay('no_downgrade', '已开通更高档位，无需重复购买');
                    return;
                }
                if (cardLevel <= currentLevel) return;
                setCurrentTier(tier);
                closeMembershipModal();
                showToast('已开通，立即生效');
            });
        });

        document.querySelectorAll('#drawer .menu-card').forEach(function(el) {
            el.addEventListener('click', function() {
                var key = this.getAttribute('data-menu') || 'unknown';
                if (key === 'membership') {
                    openMembershipModal(false);
                } else if (key === 'account-manage') {
                    openLocalPage('account.html');
                } else if (key === 'help') {
                    openLocalPage(HELP_FEEDBACK_URL);
                } else if (key === 'privacy') {
                    openLocalPage('privacy.html');
                } else if (key === 'terms') {
                    openLocalPage('terms.html');
                } else if (key === 'about') {
                    openLocalPage('about.html');
                } else if (key === 'logout') {
                    openLogoutConfirm();
                } else {
                    if (typeof DEBUG !== 'undefined' && DEBUG) console.log(key);
                }
            });
        });
        resetUsageIfNewDay();
        getMembership();
        updateDrawerFromTierAndUsage();
        refreshQuotaUI();
        if (USE_BACKEND_ENTITLEMENT && window.AndroidInterface && typeof window.AndroidInterface.getEntitlement === 'function') {
            getEntitlementFromBackend(function(ent) {
                if (ent && (typeof updateDrawerFromTierAndUsage === 'function')) updateDrawerFromTierAndUsage();
                if (ent && (typeof updateMembershipUI === 'function')) updateMembershipUI();
            });
        }

        document.addEventListener('click', function(e) {
            var sendBtn = document.getElementById('btnSend');
            var micBtn = document.getElementById('btnMicOrKeyboard');
            if (sendBtn && (e.target === sendBtn || sendBtn.contains(e.target))) {
                if (sendBtn.classList.contains('disabled') || sendBtn.getAttribute('aria-disabled') === 'true') {
                    e.preventDefault();
                    e.stopPropagation();
                    showToastOncePerDay('chat', '今日额度已用完');
                    return;
                }
                if (imageState.size > 0 && !textInput.value.trim()) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
            }
            if (micBtn && (e.target === micBtn || micBtn.contains(e.target))) {
                if (micBtn.classList.contains('disabled') || micBtn.getAttribute('aria-disabled') === 'true') {
                    e.preventDefault();
                    e.stopPropagation();
                    showToastOncePerDay('chat', '今日额度已用完');
                    return;
                }
            }
            var up = e.target.closest && e.target.closest('[data-action="upload"], [data-action="camera"]');
            if (up && (up.classList.contains('disabled') || up.getAttribute('aria-disabled') === 'true')) {
                e.preventDefault();
                e.stopPropagation();
                showToastOncePerDay('img', '今日额度已用完');
            }
        }, true);

        let isGenerating = false;
        let stickToBottom = true;
        const BOTTOM_THRESHOLD_PX = 120;
        function distanceToBottom(container) { return container.scrollHeight - (container.scrollTop + container.clientHeight); }
        function atBottom(container) { return distanceToBottom(container) <= BOTTOM_THRESHOLD_PX; }
        /** C. 4 态：idle | typing | generating | voicePanel */
        let inputMode = 'idle';
        let voiceRecording = false;
        let voiceCancelArmed = false;
        let voiceTouchStartY = 0;
        const VOICE_CANCEL_THRESHOLD_PX = 60;
        let waveformAnimId = null;
        let voicePendingTimeout = null;

        // 长聊不卡顿：窗口化 + 前端假流式（打字机）
        // 【两条线分离】RENDER_WINDOW 为纯展示裁剪，不参与 A/B 推导；A/B 只来自后端拉取或 onComplete/updateB 写入
        const RENDER_WINDOW = 80;      // 仅渲染最近 N 条
        const LOAD_MORE_BATCH = 20;    // 每次「加载更多」展开条数
        const TYPEWRITER_MS = 50;     // 打字机每片间隔（ms），避免 DOM 频繁重排
        const TYPEWRITER_CHARS = 2;   // 每片追加字符数
        const TYPEWRITER_MAX_MS = 60000; // 打字机最大时长兜底（ms），超时直接补全剩余
        const MAX_WAIT_MS = 65000;       // 全局 Watchdog：该 streamId 未在 65s 内收到 onComplete/onInterrupted 则强制中断收尾
        const chunkBufferByStream = {};
        // streamId -> 该 stream 当前累计的 buffer 全文（与 chunkBufferByStream 同步），供 onComplete 时 buffer 为空降级直出；语义是「最后一次可见的全文」非「最后一个 chunk」
        const lastFullBufferByStream = {};
        const watchdogTimerByStream = {}; // streamId -> setTimeout id，onComplete/onInterrupted 时 clear
        const terminatedStreamIds = {};   // 护栏：watchdog 触发后加入，onChunk/onComplete/onInterrupted 入口若已存在则直接 return
        const pendingDeduct = {};          // client_msg_id -> imgUploadCount(0|1)，onComplete 扣后 delete
        const pendingRequest = {};         // streamId -> { text, imageUrls, clientMsgId }，重试复用同一 client_msg_id
        const clientMsgIdByStream = {};    // streamId -> client_msg_id，UI stream 与业务幂等键解耦
        const assistantMsgByStream = {};   // streamId -> assistant message element，减少高频 DOM 查询
        const deducted = {};               // client_msg_id -> true，同一 client_msg_id 只扣一次；24h 后清理
        const previewTimerByStream = {};   // streamId -> setInterval id (preview fake stream)
        const DEDUCTED_TTL_MS = 24 * 60 * 60 * 1000;
        const PENDING_MAX_AGE_MS = 15 * 60 * 1000;  // P2b：pending 悬挂超 15 分钟自动清

        // 前端假流式：收到完整 response 后打字机分片追加；停止仅停定时器
        let typewriterState = { timerId: null, streamId: null, fullText: '', index: 0 };
        // 统一失败提示（弱提示、无指令感）；除 canceled/resumable 外均用 default
        var reasonToCopy = {
            canceled: '已停止',
            resumable: '已中断 · 点击继续',
            default: '连接中断 · 点击重试'
        };
        
        // 图片状态管理（Map 保持插入顺序，发送时 URL 顺序与用户选择一致）
        const imageState = new Map(); // imageId -> {file, base64, status, url, element, currentRequestId}

        // Android 接口对象（由 WebView 注入）；未注入时 no-op，DEBUG 时打日志
        var DEBUG = false;
        const hasNativeAndroidSend = !!(window.AndroidInterface && typeof window.AndroidInterface.sendMessage === 'function');
        const AndroidInterface = window.AndroidInterface || {
            uploadImages: function(imageDataListJson) { if (DEBUG) console.log('uploadImages', imageDataListJson); },
            retryImage: function(imageId, requestId) { if (DEBUG) console.log('retryImage', imageId, requestId); },
            sendMessage: function(text, imageUrlsJson, streamId, model, clientMsgId, searchResult) { if (DEBUG) console.log('sendMessage', text, streamId, clientMsgId); },
            webSearch: function(streamId, query, freshness, countStr) { if (DEBUG) console.log('webSearch', streamId, query); },
            stopGeneration: function() { if (DEBUG) console.log('stopGeneration'); },
            requestResume: function(streamId) { if (DEBUG) console.log('requestResume', streamId); }
        };
        function generateClientMsgId() {
            return 'cmsg_' + Date.now() + '_' + Math.random().toString(36).slice(2, 12);
        }
        const SEND_DEBOUNCE_MS = 300;
        let lastSendTriggeredAt = 0;
        let wasTextTooLong = false;

        function checkTextTooLongAndToastOnEdge() {
            const tooLong = (textInput.value || '').length > MAX_TEXT_LEN;
            if (tooLong && !wasTextTooLong) {
                showToastOncePerDay('text_too_long', '字数超限（最多6000字）');
            }
            wasTextTooLong = tooLong;
            return tooLong;
        }

        // 自动调整文本域高度（最多 5 行视觉）
        textInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 110) + 'px';
            checkTextTooLongAndToastOnEdge();
            updateInputMode();
        });

        /** C. 4 态状态机：更新右侧按钮 Mic / Send / Stop 显示与禁用；图片=必须配文字，有图无字时 placeholder 提示 */
        function updateInputMode() {
            const hasText = textInput.value.trim().length > 0;
            const isTextTooLong = (textInput.value || '').length > MAX_TEXT_LEN;
            const voiceOpen = voicePanel.classList.contains('open');
            const inVoiceMode = inputContainer.classList.contains('voice-mode');
            const hasImages = imageState.size > 0;
            var hasAnyImageUploadingOrFailed = false;
            for (var _s of imageState.values()) {
                if (_s.status === 'uploading' || _s.status === 'fail') {
                    hasAnyImageUploadingOrFailed = true;
                    break;
                }
            }

            if (voiceOpen || inVoiceMode) {
                inputMode = inVoiceMode ? 'voiceMode' : 'voicePanel';
                btnMicOrKeyboard.classList.remove('btn-hidden');
                btnMicOrKeyboard.classList.add('voice-mode');
                btnSend.classList.add('btn-hidden');
                btnStop.classList.add('btn-hidden');
                textInput.placeholder = '';
            } else if (isGenerating) {
                inputMode = 'generating';
                btnMicOrKeyboard.classList.add('btn-hidden');
                btnSend.classList.add('btn-hidden');
                btnStop.classList.remove('btn-hidden');
                textInput.placeholder = '';
            } else if (hasImages && !hasText) {
                inputMode = 'typing';
                btnMicOrKeyboard.classList.add('btn-hidden');
                btnSend.classList.remove('btn-hidden');
                btnSend.disabled = true;
                btnStop.classList.add('btn-hidden');
                textInput.placeholder = '请补充图片描述后再发送';
            } else if (hasText) {
                inputMode = 'typing';
                btnMicOrKeyboard.classList.add('btn-hidden');
                btnSend.classList.remove('btn-hidden');
                btnStop.classList.add('btn-hidden');
                textInput.placeholder = '';
                var sendDisabled = hasAnyImageUploadingOrFailed;
                if (hasImages && !sendDisabled) {
                    for (var _s of imageState.values()) {
                        if (_s.status === 'uploading' || _s.status === 'fail') {
                            sendDisabled = true;
                            break;
                        }
                    }
                }
                if (isTextTooLong) sendDisabled = true;
                btnSend.disabled = sendDisabled;
            } else {
                inputMode = 'idle';
                btnMicOrKeyboard.classList.remove('btn-hidden');
                btnMicOrKeyboard.classList.remove('voice-mode');
                btnSend.classList.add('btn-hidden');
                btnStop.classList.add('btn-hidden');
                textInput.placeholder = (hasImages && !hasText) ? '请补充图片描述后再发送' : '描述作物/地区/问题，我来帮你分析';
            }

            if (hasAnyImageUploadingOrFailed && !btnSend.classList.contains('btn-hidden')) btnSend.disabled = true;
            if (isTextTooLong && !btnSend.classList.contains('btn-hidden')) btnSend.disabled = true;
            if (textPlaceholder) {
                textPlaceholder.textContent = textInput.placeholder || '';
                textPlaceholder.style.display = (!hasText && !!textInput.placeholder) ? 'block' : 'none';
            }
            addButton.disabled = imageState.size >= 4;
            addButton.style.opacity = imageState.size >= 4 ? '0.5' : '1';
            if (inputMode === 'generating') document.body.classList.add('generating');
            else document.body.classList.remove('generating');
        }

        // E. + 面板：点击 + 打开 BottomSheet
        addButton.addEventListener('click', () => {
            if (imageState.size >= 4) {
                // 显示最多4张图片提示
                const tip = document.createElement('div');
                tip.className = 'image-limit-tip';
                tip.textContent = '最多可上传4张图片';
                tip.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 4px; font-size: 14px; z-index: 1000;';
                document.body.appendChild(tip);
                setTimeout(() => {
                    tip.remove();
                }, 1000);
                return;
            }
            refreshQuotaUI();
            updatePlusSheetTier();
            plusSheet.classList.add('open');
            plusSheetBackdrop.classList.add('open');
        });
        function closePlusSheet() {
            plusSheet.classList.remove('open');
            plusSheetBackdrop.classList.remove('open');
        }
        function getTierLocal() {
            if (typeof getCurrentTier === 'function') return getCurrentTier();
            return localStorage.getItem('membership_tier') || 'free';
        }
        function tierLabel(tier) {
            return ({ free: '免费版', plus: 'Plus', pro: 'Pro', expert: '专家模式' })[tier] || '免费版';
        }
        function updatePlusSheetTier() {
            var tierEl = document.getElementById('tier-tier');
            if (!tierEl) return;
            tierEl.textContent = getTierLabel(getTierLocal());
        }
        plusSheetBackdrop.addEventListener('click', closePlusSheet);
        plusSheetGallery.addEventListener('click', () => {
            closePlusSheet();
            fileInput.click();
        });
        plusSheetCamera.addEventListener('click', () => {
            closePlusSheet();
            cameraInput.click();
        });
        var tierEntry = document.getElementById('tier-card');
        if (tierEntry) {
            tierEntry.addEventListener('click', function() {
                closePlusSheet();
                openMembershipModal(false);
            });
        }

        function handleFileSelect(fileList) {
            const imageFiles = Array.from(fileList || []).filter(file => file.type.startsWith('image/'));
            const currentImageCount = imageState.size;
            const remainingSlots = Math.max(0, 4 - currentImageCount);
            const toAdd = imageFiles.slice(0, remainingSlots);
            toAdd.forEach((file) => {
                const imageId = 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                addImagePreview(imageId, file);
            });
            fileInput.value = '';
            cameraInput.value = '';
            updateInputMode();
        }
        fileInput.addEventListener('change', function() { handleFileSelect(this.files); });
        cameraInput.addEventListener('change', function() { handleFileSelect(this.files); });
        
        // 添加图片预览（缩略图用 objectURL 减少内存，base64 仅用于发给 Android）
        function addImagePreview(imageId, file) {
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.dataset.imageId = imageId;
            
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            
            const statusOverlay = document.createElement('div');
            statusOverlay.className = 'image-status-overlay';
            const statusIcon = document.createElement('div');
            statusIcon.className = 'image-status-uploading';
            statusOverlay.appendChild(statusIcon);
            
            const actions = document.createElement('div');
            actions.className = 'image-actions';
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'image-action-btn delete';
            deleteBtn.textContent = '删除';
            deleteBtn.onclick = () => removeImage(imageId);
            actions.appendChild(deleteBtn);
            
            previewItem.appendChild(img);
            previewItem.appendChild(statusOverlay);
            previewItem.appendChild(actions);
            
            imagePreviewContainer.appendChild(previewItem);
            imagePreviewContainer.style.display = 'flex';
            
            const requestId = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            // 立即写入 state，便于删除时能清理；base64 稍后填入
            imageState.set(imageId, {
                file: file,
                base64: null,
                status: 'uploading',
                url: null,
                element: previewItem,
                currentRequestId: requestId
            });
            
            // base64 仅用于首次发给 Android 上传，发完即丢，不长期保存（重试走 Android 缓存）
            const reader = new FileReader();
            reader.onload = function(e) {
                const state = imageState.get(imageId);
                if (!state) return; // 用户已删除，不再上传
                const base64 = e.target.result.split(',')[1];
                if (!base64 || base64.length < 10) return;
                uploadImage(imageId, base64, requestId);
                state.base64 = null; // 发完立刻丢，不占内存
            };
            reader.readAsDataURL(file);
        }
        
        // 上传图片（带 requestId；base64 仅首次使用）
        function uploadImage(imageId, base64, requestId) {
            const imageData = {
                imageId: imageId,
                base64: base64,
                requestId: requestId
            };
            const imageDataList = [imageData];
            AndroidInterface.uploadImages(JSON.stringify(imageDataList));
        }
        
        // 更新图片状态（仅当 imageId 仍存在且 requestId 匹配时生效；errorMessage 仅 fail 时卡片展示）
        function updateImageStatus(imageId, status, url, requestId, errorMessage) {
            const state = imageState.get(imageId);
            if (!state) return; // 已删除，忽略回调
            if (requestId != null && state.currentRequestId !== requestId) return; // 非本次尝试，忽略
            
            state.status = status;
            if (url) {
                state.url = url;
            }
            
            const statusOverlay = state.element.querySelector('.image-status-overlay');
            statusOverlay.innerHTML = '';
            
            if (status === 'uploading') {
                const spinner = document.createElement('div');
                spinner.className = 'image-status-uploading';
                statusOverlay.appendChild(spinner);
            } else if (status === 'success') {
                const checkmark = document.createElement('div');
                checkmark.className = 'image-status-success';
                checkmark.textContent = '✓';
                statusOverlay.appendChild(checkmark);
                
                const retryBtn = state.element.querySelector('.retry');
                if (retryBtn) retryBtn.remove();
                const hint = state.element.querySelector('.image-fail-hint');
                if (hint) hint.remove();
            } else if (status === 'fail') {
                const failIcon = document.createElement('div');
                failIcon.className = 'image-status-fail';
                failIcon.textContent = '✗';
                statusOverlay.appendChild(failIcon);
                
                const actions = state.element.querySelector('.image-actions');
                if (!actions.querySelector('.retry')) {
                    const retryBtn = document.createElement('button');
                    retryBtn.className = 'image-action-btn retry';
                    retryBtn.textContent = '重试';
                    retryBtn.onclick = () => retryImage(imageId);
                    actions.insertBefore(retryBtn, actions.firstChild);
                }
                if (errorMessage) {
                    let hint = state.element.querySelector('.image-fail-hint');
                    if (!hint) {
                        hint = document.createElement('div');
                        hint.className = 'image-fail-hint';
                        state.element.appendChild(hint);
                    }
                    hint.textContent = errorMessage;
                }
            }
            
            updateInputMode();
        }
        
        // 重试：只发 imageId + requestId，不传 base64；Android 用缓存 bytes 重传
        function retryImage(imageId) {
            const state = imageState.get(imageId);
            if (!state) return;
            
            const requestId = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            state.currentRequestId = requestId;
            updateImageStatus(imageId, 'uploading', null, requestId, null);
            AndroidInterface.retryImage(imageId, requestId);
        }
        
        // 删除图片：UI 立即移除，已删除图不参与发送，后续该图回调忽略
        function removeImage(imageId) {
            const state = imageState.get(imageId);
            if (state && state.element) {
                if (state.element.querySelector('img') && state.element.querySelector('img').src) {
                    URL.revokeObjectURL(state.element.querySelector('img').src);
                }
                state.element.remove();
            }
            imageState.delete(imageId);
            
            if (imageState.size === 0) {
                imagePreviewContainer.style.display = 'none';
            }
            
            updateInputMode();
        }
        
        // 接收 Android 上传状态回调（requestId 去重；errorMessage 仅 fail 时在卡片上展示）
        window.onImageUploadStatus = function(imageId, status, url, requestId, errorMessage) {
            updateImageStatus(imageId, status, url || null, requestId || null, errorMessage || null);
        };

        // 消息窗口化：仅渲染最近 RENDER_WINDOW 条，更老折叠为「加载更多」
        function applyMessageWindow() {
            const messages = messagesContainer.querySelectorAll('.message');
            const total = messages.length;
            const oldScrollTop = messagesWrapper.scrollTop;
            const oldScrollHeight = messagesWrapper.scrollHeight;
            let loadMoreEl = messagesContainer.querySelector('.load-more-placeholder');
            if (total <= RENDER_WINDOW) {
                messages.forEach(el => el.classList.remove('message-folded'));
                if (loadMoreEl) loadMoreEl.remove();
                requestAnimationFrame(function() {
                    const distFromBottom = oldScrollHeight - oldScrollTop;
                    if (distFromBottom <= 120) {
                        messagesWrapper.scrollTop = Math.max(0, messagesWrapper.scrollHeight - distFromBottom);
                    } else {
                        messagesWrapper.scrollTop = Math.min(oldScrollTop, Math.max(0, messagesWrapper.scrollHeight - messagesWrapper.clientHeight));
                    }
                });
                return;
            }
            const toFold = total - RENDER_WINDOW;
            for (let i = 0; i < toFold; i++) messages[i].classList.add('message-folded');
            for (let i = toFold; i < total; i++) messages[i].classList.remove('message-folded');
            if (!loadMoreEl) {
                loadMoreEl = document.createElement('div');
                loadMoreEl.className = 'load-more-placeholder';
                loadMoreEl.textContent = '加载更多（' + toFold + ' 条）';
                loadMoreEl.onclick = function() {
                    const oldScrollHeight = messagesWrapper.scrollHeight;
                    const oldScrollTop = messagesWrapper.scrollTop;
                    const folded = messagesContainer.querySelectorAll('.message-folded');
                    const n = Math.min(LOAD_MORE_BATCH, folded.length);
                    for (let i = 0; i < n; i++) folded[i].classList.remove('message-folded');
                    requestAnimationFrame(function() {
                        requestAnimationFrame(function() {
                            messagesWrapper.scrollTop = oldScrollTop + (messagesWrapper.scrollHeight - oldScrollHeight);
                        });
                    });
                    const remaining = messagesContainer.querySelectorAll('.message-folded').length;
                    if (remaining === 0) loadMoreEl.remove();
                    else loadMoreEl.textContent = '加载更多（' + remaining + ' 条）';
                };
                messagesContainer.insertBefore(loadMoreEl, messagesContainer.firstChild);
            }
            const remaining = messagesContainer.querySelectorAll('.message-folded').length;
            if (remaining === 0) loadMoreEl.remove();
            else loadMoreEl.textContent = '加载更多（' + remaining + ' 条）';
            requestAnimationFrame(function() {
                const distFromBottom = oldScrollHeight - oldScrollTop;
                if (distFromBottom <= 120) {
                    messagesWrapper.scrollTop = Math.max(0, messagesWrapper.scrollHeight - distFromBottom);
                } else {
                    messagesWrapper.scrollTop = Math.min(oldScrollTop, Math.max(0, messagesWrapper.scrollHeight - messagesWrapper.clientHeight));
                }
            });
        }

        // 发送消息（P0：数量≤4、有图必须有文字，双层拦截）
        function sendMessage() {
            if (btnSend.disabled) return;
            if (isGenerating) return;
            if (checkTextTooLongAndToastOnEdge()) return;
            var now = Date.now();
            if ((now - lastSendTriggeredAt) < SEND_DEBOUNCE_MS) return;
            lastSendTriggeredAt = now;

            const text = textInput.value.trim();
            const hasImages = imageState.size > 0;
            if (!text) {
                if (hasImages) showToastOncePerDay('img_no_text', '请补充图片描述后再发送');
                return;
            }

            if (hasImages) {
                var allSuccess = true;
                for (const [imageId, state] of imageState) {
                    if (state.status !== 'success') {
                        allSuccess = false;
                        break;
                    }
                }
                if (!allSuccess) return;
            }

            const imageUrls = [];
            for (const [imageId, state] of imageState) {
                if (state.status === 'success' && state.url) imageUrls.push(state.url);
            }
            if (imageUrls.length > 4) {
                showToast('最多4张图片');
                return;
            }

            var imgNeed = imageUrls.length > 0 ? 1 : 0;
            var quotaCheck = checkQuotaBeforeSend(1, imgNeed);
            if (!quotaCheck.allowed) return;

            // 添加用户消息（右对齐，立即显示）
            const userMessage = createMessage({ 
                role: "user", 
                text: text, 
                files: null, 
                imageUrls: imageUrls,
                stream: false 
            });
            messagesContainer.appendChild(userMessage);
            hardTrimMessages();
            refreshEmptyState();
            scrollToBottom();
            applyMessageWindow();

            // 创建AI回复占位并生成 streamId（取消时旧气泡按 streamId 落终态）
            const streamId = 'stream_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const clientMsgId = generateClientMsgId();
            startAutoFollowForGeneration();
            isGenerating = true;
            updateInputMode();
            updateScrollToBottomBtn();
            const assistantMessage = createMessage({ role: "assistant", text: "", stream: true });
            assistantMessage.dataset.streamId = streamId;
            bindAssistantMessage(streamId, assistantMessage);
            messagesContainer.appendChild(assistantMessage);
            hardTrimMessages();
            scrollToBottom();
            applyMessageWindow();

            lastSent = { text: text, imageUrls: imageUrls.slice(), streamId: streamId, clientMsgId: clientMsgId };
            pendingRequest[streamId] = { text: text, imageUrls: imageUrls.slice(), clientMsgId: clientMsgId, ts: Date.now() };
            clientMsgIdByStream[streamId] = clientMsgId;
            pendingDeduct[clientMsgId] = (imageUrls.length > 0 ? 1 : 0);

            // 直接发送，由模型自行决策是否需要联网搜索
            // hasNativeAndroidSend=false 代表浏览器/无桥环境，自动走本地 mock；否则走 Android 原生发送
            if (!hasNativeAndroidSend) {
                startPreviewMockResponse(streamId, text);
            } else {
                sendToAndroid(text, imageUrls, streamId, clientMsgId);
                startWatchdog(streamId);
            }

            // 清空输入和图片预览
            textInput.value = '';
            textInput.style.height = 'auto';
            imageState.clear();
            imagePreviewContainer.innerHTML = '';
            imagePreviewContainer.style.display = 'none';
            updateInputMode();
        }

        // 发送到Android后端（streamId 写对应气泡；模型路由：专家=expert，其余=flash）
        function sendToAndroid(text, imageUrls, streamId, clientMsgId) {
            var imageUrlsJson = imageUrls && imageUrls.length > 0 ? JSON.stringify(imageUrls) : 'null';
            var tier = getCurrentTier();
            var model = tier === 'expert' ? 'expert' : 'flash';
            if (typeof AndroidInterface.sendMessage === 'function') {
                AndroidInterface.sendMessage(text || '', imageUrlsJson, streamId || '', model, clientMsgId || '');
            }
        }

        function buildPreviewMockReply(userText) {
            var clean = (userText || '').replace(/\s+/g, ' ').trim();
            var topic = clean ? ('你提到“' + clean.slice(0, 28) + '”') : '你当前关心的问题';
            return [
                '### 本地预览回复（动画联调）',
                topic + '，下面这段是本地假流式文本，用于测试打字动画、段落间距、长文滚动、连续阅读和回到底部的稳定表现。',
                '先给一个简化判断：当前最重要的是把目标拆成可验证的小步骤，再按固定节奏推进。不要一次改太多变量，否则很难判断到底是哪一处动作带来了效果，也难以在后续复盘时复用。',
                '可以用“三段式观察法”。第一段做基线记录，至少留三项指标：响应时延、可读性主观评分、操作完成率；第二段只改一到两个关键变量，观察 24 到 48 小时变化；第三段只保留已验证有效动作，未验证动作暂缓，避免把系统带入不可解释状态。',
                '在内容组织上，建议固定同一结构：先结论、再依据、后行动边界。结论要短，依据要可核验，边界要写清楚“什么情况下不适用”。这样不仅能提高用户阅读效率，也能降低长消息造成的理解偏差，尤其适合移动端场景。',
                '在交互体验上，重点盯四件事：第一，长段落是否保持稳定行高与换行；第二，连续流式输出时是否出现跳动和闪烁；第三，滚动到中段后继续输出是否打断阅读；第四，消息很长时输入区与发送区是否仍保持可预期对齐。',
                '如果你要做压力预演，可以连续发送多轮不同长度文本：200 字、800 字、1500 字各两轮，记录页面滚动、渲染速度、按钮状态切换是否一致；再混合一次“带图片 + 文字”输入，检查布局是否维持统一节奏。',
                '另外建议在验证期间固定一个最小记录模板：问题场景、触发动作、期望表现、实际表现、截图编号、复现概率。模板简短但持续执行，后续接入真实模型和服务端时，能直接复用并快速定位回归问题。',
                '当前这条消息仅用于 UI 效果联调，不代表正式业务回复。它包含标题、较长段落、换行、术语混排与连续阅读场景，目的是让你一次性观察字体渲染、段落密度、动效节奏和视觉稳定性。后续你接入真实模型后，这里会自动切换为正式回答。'
            ].join('\n\n');
        }
        function startPreviewMockResponse(streamId, userText) {
            if (!streamId) return;
            if (previewTimerByStream[streamId]) {
                clearInterval(previewTimerByStream[streamId]);
                delete previewTimerByStream[streamId];
            }
            var full = buildPreviewMockReply(userText);
            var index = 0;
            previewTimerByStream[streamId] = setInterval(function() {
                if (terminatedStreamIds[streamId] || !isGenerating) {
                    clearInterval(previewTimerByStream[streamId]);
                    delete previewTimerByStream[streamId];
                    return;
                }
                var step = Math.max(3, Math.floor(Math.random() * 10));
                var chunk = full.slice(index, index + step);
                if (chunk) window.onChunkReceived && window.onChunkReceived(streamId, chunk);
                index += step;
                if (index >= full.length) {
                    clearInterval(previewTimerByStream[streamId]);
                    delete previewTimerByStream[streamId];
                    window.onCompleteReceived && window.onCompleteReceived(streamId, '');
                }
            }, 28);
        }

        // 全局 Watchdog：65s 内该 streamId 未收到 onComplete/onInterrupted 则强制中断收尾（永不无限转圈）
        function startWatchdog(streamId) {
            if (!streamId) return;
            if (watchdogTimerByStream[streamId]) {
                clearTimeout(watchdogTimerByStream[streamId]);
                delete watchdogTimerByStream[streamId];
            }
            watchdogTimerByStream[streamId] = setTimeout(function() {
                if (watchdogTimerByStream[streamId]) {
                    clearTimeout(watchdogTimerByStream[streamId]);
                    delete watchdogTimerByStream[streamId];
                }
                terminatedStreamIds[streamId] = true;
                AndroidInterface.stopGeneration && AndroidInterface.stopGeneration();
                stopTypewriter();
                isGenerating = false;
                updateInputMode();
                updateScrollToBottomBtn();
                delete chunkBufferByStream[streamId];
                delete lastFullBufferByStream[streamId];
                var timeoutClientMsgId = clientMsgIdByStream[streamId];
                delete pendingRequest[streamId];
                delete clientMsgIdByStream[streamId];
                unbindAssistantMessage(streamId);
                if (timeoutClientMsgId) delete pendingDeduct[timeoutClientMsgId];
                // 前端 watchdog 仅做 UI 中断与本地 pending 清理，不推导/修改后端扣费结果；扣费以服务端 onComplete 规则为准。
                applyInterruptedUI(streamId, 'timeout');
                setTimeout(function() { delete terminatedStreamIds[streamId]; }, 2 * 60 * 1000);
            }, MAX_WAIT_MS);
        }

        function clearWatchdog(streamId) {
            if (!streamId) return;
            if (watchdogTimerByStream[streamId]) {
                clearTimeout(watchdogTimerByStream[streamId]);
                delete watchdogTimerByStream[streamId];
            }
        }

        function cleanupStalePending() {
            var now = Date.now();
            Object.keys(pendingRequest).forEach(function(sid) {
                var req = pendingRequest[sid];
                if (req && req.ts != null && (now - req.ts) > PENDING_MAX_AGE_MS) {
                    var staleClientMsgId = req.clientMsgId || clientMsgIdByStream[sid];
                    delete pendingRequest[sid];
                    delete clientMsgIdByStream[sid];
                    if (staleClientMsgId) delete pendingDeduct[staleClientMsgId];
                }
            });
        }
        setInterval(cleanupStalePending, 5 * 60 * 1000);
        function findAssistantMessageByStreamId(streamId) {
            if (!streamId || !messagesContainer) return null;
            var cached = assistantMsgByStream[streamId];
            if (cached && cached.isConnected && cached.dataset && cached.dataset.streamId === streamId) return cached;
            var found = messagesContainer.querySelector('.message.assistant[data-stream-id="' + streamId + '"]');
            if (found) assistantMsgByStream[streamId] = found;
            return found;
        }
        function bindAssistantMessage(streamId, el) {
            if (!streamId || !el) return;
            assistantMsgByStream[streamId] = el;
        }
        function unbindAssistantMessage(streamId) {
            if (!streamId) return;
            delete assistantMsgByStream[streamId];
        }

        // 统一中断 UI：该条消息底部一行灰字 +「重试」按钮（ChatGPT 风格，不弹窗）
        function applyInterruptedUI(streamId, reason) {
            if (!streamId) return;
            var msg = findAssistantMessageByStreamId(streamId);
            if (!msg) return;
            var contentDiv = msg.querySelector('.message-content');
            if (!contentDiv || contentDiv.querySelector('.interrupted-badge')) return;
            var hasContent = contentDiv.textContent && contentDiv.textContent.trim().length > 0;
            if (!hasContent) return;
            msg.classList.remove('streaming');
            msg.classList.add('message-interrupted');
            var text = reason === 'canceled' ? reasonToCopy.canceled : reason === 'resumable' ? reasonToCopy.resumable : reasonToCopy.default;
            if (!text) return;
            var badge = document.createElement('span');
            badge.className = 'interrupted-badge';
            badge.textContent = text;
            if (reason === 'resumable') {
                badge.style.cursor = 'pointer';
                badge.onclick = function() { AndroidInterface.requestResume && AndroidInterface.requestResume(streamId); };
            }
            contentDiv.appendChild(badge);
            if (reason !== 'resumable' && pendingRequest[streamId]) {
                var retryBtn = document.createElement('button');
                retryBtn.className = 'retry-stream-btn';
                retryBtn.textContent = '重试';
                var retrying = false;
                retryBtn.onclick = function() {
                    if (retrying || isGenerating) return;
                    retrying = true;
                    retryBtn.disabled = true;
                    var data = pendingRequest[streamId];
                    if (!data) { retrying = false; retryBtn.disabled = false; return; }
                    AndroidInterface.stopGeneration && AndroidInterface.stopGeneration();
                    delete chunkBufferByStream[streamId];
                    delete lastFullBufferByStream[streamId];
                    var oldClientMsgId = clientMsgIdByStream[streamId];
                    delete pendingRequest[streamId];
                    delete clientMsgIdByStream[streamId];
                    unbindAssistantMessage(streamId);
                    contentDiv.innerHTML = '';
                    var newStreamId = 'stream_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    msg.dataset.streamId = newStreamId;
                    bindAssistantMessage(newStreamId, msg);
                    msg.classList.remove('message-interrupted');
                    var urls = data.imageUrls && data.imageUrls.slice ? data.imageUrls.slice() : (data.imageUrls || []);
                    var retryClientMsgId = data.clientMsgId || oldClientMsgId || generateClientMsgId();
                    pendingRequest[newStreamId] = { text: data.text, imageUrls: urls, clientMsgId: retryClientMsgId, ts: Date.now() };
                    clientMsgIdByStream[newStreamId] = retryClientMsgId;
                    pendingDeduct[retryClientMsgId] = (urls.length > 0 ? 1 : 0);
                    lastSent = { text: data.text, imageUrls: urls, streamId: newStreamId, clientMsgId: retryClientMsgId };
                    startAutoFollowForGeneration();
                    isGenerating = true;
                    updateInputMode();
                    sendToAndroid(data.text, urls, newStreamId, retryClientMsgId);
                    startWatchdog(newStreamId);
                };
                contentDiv.appendChild(retryBtn);
            }
        }

        // 停止打字机（用户点「停止」时）：仅停定时器，可选一次性补全剩余文字
        function stopTypewriter() {
            if (typewriterState.timerId) {
                clearInterval(typewriterState.timerId);
                typewriterState.timerId = null;
            }
            if (typewriterState.streamId && typewriterState.fullText && typewriterState.index < typewriterState.fullText.length) {
                const msg = findAssistantMessageByStreamId(typewriterState.streamId);
                if (msg) {
                    const contentDiv = msg.querySelector('.message-content');
                    if (contentDiv) contentDiv.textContent += typewriterState.fullText.slice(typewriterState.index); // 仅追加剩余部分，避免重复
                    msg.classList.remove('streaming');
                }
            }
            typewriterState = { timerId: null, streamId: null, fullText: '', index: 0 };
        }

        // 前端假流式：用定时器分片追加 fullText；先停旧打字机（防旧写到新消息）；超时兜底直接补全
        function runTypewriter(streamId, fullText) {
            stopTypewriter();
            if (!streamId || !fullText) return;
            const msg = findAssistantMessageByStreamId(streamId);
            if (!msg) return;
            const contentDiv = msg.querySelector('.message-content');
            if (!contentDiv) return;
            msg.classList.remove('streaming');
            var typewriterStartMs = Date.now();
            var dynamicChars = TYPEWRITER_CHARS;
            if (fullText.length > 1200) dynamicChars = 6;
            else if (fullText.length > 700) dynamicChars = 4;
            var typewriterTick = 0;
            typewriterState = { timerId: null, streamId: streamId, fullText: fullText, index: 0 };
            typewriterState.timerId = setInterval(function() {
                if ((Date.now() - typewriterStartMs) >= TYPEWRITER_MAX_MS) {
                    clearInterval(typewriterState.timerId);
                    typewriterState.timerId = null;
                    if (typewriterState.index < fullText.length) {
                        contentDiv.textContent += fullText.slice(typewriterState.index); // 仅追加剩余部分，避免重复
                    }
                    msg.classList.remove('streaming');
                    typewriterState = { timerId: null, streamId: null, fullText: '', index: 0 };
                    isGenerating = false;
                    applyMarkdownToElement(contentDiv, fullText);
                    fileInput.value = '';
                    updateInputMode();
                    refreshEmptyState();
                    updateScrollToBottomBtn();
                    hardTrimMessages();
                    scrollToBottom();
                    return;
                }
                var n = Math.min(dynamicChars, fullText.length - typewriterState.index);
                if (n <= 0) {
                    clearInterval(typewriterState.timerId);
                    typewriterState.timerId = null;
                    msg.classList.remove('streaming');
                    typewriterState = { timerId: null, streamId: null, fullText: '', index: 0 };
                    isGenerating = false;
                    applyMarkdownToElement(contentDiv, fullText);
                    fileInput.value = '';
                    updateInputMode();
                    refreshEmptyState();
                    updateScrollToBottomBtn();
                    hardTrimMessages();
                    scrollToBottom();
                    return;
                }
                contentDiv.textContent += fullText.slice(typewriterState.index, typewriterState.index + n);
                typewriterState.index += n;
                typewriterTick++;
                if (typewriterTick % 3 === 0 || typewriterState.index >= fullText.length) scrollToBottom();
            }, TYPEWRITER_MS);
        }

        // 接收后端一次性返回的完整内容（仅累积到 buffer，不直接写 DOM）
        window.onChunkReceived = function(streamId, chunk) {
            if (!streamId || !chunk) return;
            if (terminatedStreamIds[streamId]) return;
            chunkBufferByStream[streamId] = (chunkBufferByStream[streamId] || '') + chunk;
            lastFullBufferByStream[streamId] = chunkBufferByStream[streamId];
        };

        // 收到完成通知后：同一 streamId 只扣一次（deducted 防重）；再取 buffer 全文、打字机/直出、清理 pending、clear Watchdog
        window.onCompleteReceived = function(streamId, clientMsgId) {
            if (!streamId) return;
            if (terminatedStreamIds[streamId]) return;
            var dedupeKey = ((clientMsgId == null ? '' : String(clientMsgId))).trim();
            clearWatchdog(streamId);
            var shouldDeduct = !!dedupeKey && !deducted[dedupeKey];
            var imgUploadCount = (dedupeKey && pendingDeduct[dedupeKey] != null ? pendingDeduct[dedupeKey] : 0);
            var mappedClientMsgId = clientMsgIdByStream[streamId];
            delete pendingRequest[streamId];
            delete clientMsgIdByStream[streamId];
            if (!dedupeKey && mappedClientMsgId) {
                delete pendingDeduct[mappedClientMsgId];
            }
            if (shouldDeduct) {
                delete pendingDeduct[dedupeKey];
                incrementUsage(1, imgUploadCount);
                deducted[dedupeKey] = true;
                setTimeout(function() { delete deducted[dedupeKey]; }, DEDUCTED_TTL_MS);
                refreshQuotaUI();
            }
            var hadBuffer = !!(chunkBufferByStream[streamId]);
            var fullText = (chunkBufferByStream[streamId] || '');
            if (!fullText) fullText = (lastFullBufferByStream[streamId] || '');
            delete chunkBufferByStream[streamId];
            delete lastFullBufferByStream[streamId];
            if (!fullText) {
                var msg = findAssistantMessageByStreamId(streamId);
                if (msg) msg.classList.remove('streaming');
                isGenerating = false;
                fileInput.value = '';
                updateInputMode();
                updateScrollToBottomBtn();
                hardTrimMessages();
                unbindAssistantMessage(streamId);
                delete terminatedStreamIds[streamId];
                return;
            }
            var msg = findAssistantMessageByStreamId(streamId);
            if (msg && !msg.classList.contains('streaming')) {
                var contentDiv = msg.querySelector('.message-content');
                if (contentDiv) applyMarkdownToElement(contentDiv, fullText);
                msg.classList.remove('streaming');
                scrollToBottom();
                isGenerating = false;
                fileInput.value = '';
                updateInputMode();
                updateScrollToBottomBtn();
                hardTrimMessages();
                refreshEmptyState();
                unbindAssistantMessage(streamId);
                delete terminatedStreamIds[streamId];
                return;
            }
            if (hadBuffer) {
                runTypewriter(streamId, fullText);
            } else {
                var msg = findAssistantMessageByStreamId(streamId);
                if (msg) {
                    var contentDiv = msg.querySelector('.message-content');
                    if (contentDiv) applyMarkdownToElement(contentDiv, fullText);
                    msg.classList.remove('streaming');
                }
                scrollToBottom();
                isGenerating = false;
                fileInput.value = '';
                updateInputMode();
                updateScrollToBottomBtn();
                hardTrimMessages();
                unbindAssistantMessage(streamId);
            }
            delete terminatedStreamIds[streamId];
        };

        function escapeHtml(s) {
            if (s == null) return '';
            var t = (s + '');
            return t.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }
        function renderMarkdownSafe(text) {
            if (text == null) text = '';
            var raw = (text + '');
            var codeBlocks = [];
            var linkPlaceholders = [];
            var idx = 0;
            raw = raw.replace(/```[\s\S]*?```/g, function(m) {
                var inner = m.slice(3, -3).replace(/^[\w-]*\n?/, '');
                codeBlocks.push(inner);
                return '\n@@CODEBLOCK_' + (idx++) + '@@\n';
            });
            var lines = raw.split(/\r?\n/);
            var out = [];
            var i = 0;
            function parseInline(str) {
                str = (str + '').replace(/\[([^\]]*)\]\((https?:\/\/[^)\s]+)\)/g, function(_, t, url) {
                    var idx = linkPlaceholders.length;
                    linkPlaceholders.push({ text: t ? t : url, url: url });
                    return '@@LINK_' + idx + '@@';
                });
                str = escapeHtml(str);
                str = str.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                str = str.replace(/`([^`]+)`/g, function(_, c) { return '<code>' + escapeHtml(c) + '</code>'; });
                str = str.replace(/@@LINK_(\d+)@@/g, function(_, n) {
                    var L = linkPlaceholders[parseInt(n, 10)];
                    return L ? '<a href="' + escapeHtml(L.url) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(L.text) + '</a>' : '';
                });
                return str;
            }
            while (i < lines.length) {
                var line = lines[i];
                var trimmed = line.trim();
                if (trimmed === '' || trimmed === '---' || trimmed === '***') {
                    if (trimmed === '---' || trimmed === '***') out.push('<hr>');
                    i++;
                    continue;
                }
                var head = /^(#{1,4})\s+(.*)$/.exec(trimmed);
                if (head) {
                    var l = head[1].length;
                    out.push('<h' + l + '>' + parseInline(head[2].trim()) + '</h' + l + '>');
                    i++;
                    continue;
                }
                if (/^[-*]\s+/.test(trimmed) || /^\d+\.\s+/.test(trimmed)) {
                    var tag = /^\d+\.\s+/.test(trimmed) ? 'ol' : 'ul';
                    var items = [];
                    while (i < lines.length && (/^[-*]\s+/.test(lines[i].trim()) || /^\d+\.\s+/.test(lines[i].trim()))) {
                        var it = lines[i].trim().replace(/^[-*]\s+/, '').replace(/^\d+\.\s+/, '');
                        items.push('<li>' + parseInline(it) + '</li>');
                        i++;
                    }
                    out.push('<' + tag + '>' + items.join('') + '</' + tag + '>');
                    continue;
                }
                if (/^>\s*/.test(trimmed)) {
                    var q = [];
                    while (i < lines.length && /^>\s*/.test(lines[i].trim())) {
                        q.push(parseInline(lines[i].trim().replace(/^>\s*/, '')));
                        i++;
                    }
                    out.push('<blockquote>' + q.join('<br>') + '</blockquote>');
                    continue;
                }
                var para = [];
                while (i < lines.length && lines[i].trim() !== '' && !/^#{1,4}\s+/.test(lines[i].trim()) && !/^[-*]\s+/.test(lines[i].trim()) && !/^\d+\.\s+/.test(lines[i].trim()) && !/^>\s*/.test(lines[i].trim()) && lines[i].trim() !== '---' && lines[i].trim() !== '***') {
                    para.push(lines[i]);
                    i++;
                }
                if (para.length) {
                    var pText = para.join('\n').trim();
                    var tokenRepl = function(_, n) {
                        var code = codeBlocks[parseInt(n, 10)];
                        return (code != null) ? '<pre><code>' + escapeHtml(code) + '</code></pre>' : '';
                    };
                    if (/^@@CODEBLOCK_\d+@@$/.test(pText)) {
                        out.push(pText.replace(/@@CODEBLOCK_(\d+)@@/g, tokenRepl));
                    } else if (pText.indexOf('@@CODEBLOCK_') >= 0) {
                        out.push('<p>' + pText.replace(/@@CODEBLOCK_(\d+)@@/g, tokenRepl) + '</p>');
                    } else {
                        out.push('<p>' + parseInline(pText) + '</p>');
                    }
                }
            }
            var html = out.join('\n');
            html = html.replace(/@@CODEBLOCK_(\d+)@@/g, function(_, n) {
                var code = codeBlocks[parseInt(n, 10)];
                return (code != null) ? '<pre><code>' + escapeHtml(code) + '</code></pre>' : '';
            });
            return html;
        }
        function applyMarkdownToElement(el, rawText) {
            if (!el || rawText == null) return;
            el.classList.remove('md-rendered');
            el.innerHTML = renderMarkdownSafe(rawText);
            el.classList.add('md-rendered');
        }

        // 灰块内 URL 可点击：将文本中的 http(s) URL 转为 <a target="_blank">，其余转义防 XSS
        function linkifyToolResultText(text) {
            var s = (text != null ? (text + '') : '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return s.replace(/(https?:\/\/[^\s\n&lt;&amp;]+)/g, function(m) {
                var href = m.replace(/"/g, '&quot;');
                return '<a href="' + href + '" target="_blank" rel="noopener noreferrer">' + m + '</a>';
            });
        }
        // 统一渲染工具结果块：同 streamId + toolName 只保留一块，重复回调则覆盖更新；灰块内 URL 可点击
        function renderToolResult(streamId, toolName, text) {
            if (!streamId || toolName == null) return;
            var msg = messagesContainer.querySelector('.message.assistant[data-stream-id="' + streamId + '"]');
            if (!msg) return;
            var contentDiv = msg.querySelector('.message-content');
            if (!contentDiv) return;
            var normalized = (text != null ? (text + '') : '').replace(/\\n/g, '\n');
            var html = linkifyToolResultText(normalized);
            var existing = contentDiv.querySelector('.tool-result[data-tool="' + toolName + '"]');
            if (existing) {
                existing.innerHTML = html;
            } else {
                var block = document.createElement('div');
                block.className = 'tool-result';
                block.setAttribute('data-tool', toolName);
                block.innerHTML = html;
                contentDiv.appendChild(block);
            }
            scrollToBottom();
        }



        // 安卓本地时间：供锚点/业务按需调用
        window.getLocalDateTimeFromAndroid = function() {
            if (typeof AndroidInterface !== 'undefined' && typeof AndroidInterface.getLocalDateTime === 'function') {
                return AndroidInterface.getLocalDateTime();
            }
            return '';
        };

        // 终态仅 badge/灰字 + 重试；开头 clear Watchdog、清理 buffer，再统一 applyInterruptedUI
        window.onStreamInterrupted = function(streamId, reason) {
            if (!streamId) return;
            if (terminatedStreamIds[streamId]) return;
            clearWatchdog(streamId);
            var interruptedClientMsgId = clientMsgIdByStream[streamId];
            delete pendingRequest[streamId];
            delete clientMsgIdByStream[streamId];
            unbindAssistantMessage(streamId);
            if (interruptedClientMsgId) delete pendingDeduct[interruptedClientMsgId];
            if (typewriterState.streamId === streamId) stopTypewriter();
            isGenerating = false;
            updateInputMode();
            updateScrollToBottomBtn();
            delete chunkBufferByStream[streamId];
            delete lastFullBufferByStream[streamId];
            applyInterruptedUI(streamId, reason);
            delete terminatedStreamIds[streamId];
        };

        // 统一消息渲染函数（用户/AI共用）
        function createMessage({ role, text, files, imageUrls, stream }) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (role === 'assistant') {
                const row = document.createElement('div');
                row.className = 'message-row';
                const avatarSlot = document.createElement('div');
                avatarSlot.className = 'avatar-slot';
                const dot = document.createElement('span');
                dot.className = 'streaming-dot';
                avatarSlot.appendChild(dot);
                row.appendChild(avatarSlot);
                row.appendChild(contentDiv);
                messageDiv.appendChild(row);
                if (stream) {
                    if (messagesContainer) messagesContainer.querySelectorAll('.message.assistant.streaming').forEach(function(m) { m.classList.remove('streaming'); });
                    messageDiv.classList.add('streaming');
                }
            } else {
                messageDiv.appendChild(contentDiv);
            }

            // 添加图片（仅用户消息支持）
            if (imageUrls && imageUrls.length > 0 && role === 'user') {
                for (let url of imageUrls) {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = 'message-image';
                    contentDiv.appendChild(img);
                }
            } else if (files && files.length > 0 && role === 'user') {
                // 兼容旧逻辑（如果传入files）
                for (let file of files) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'message-image';
                            contentDiv.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }

            // 添加文本
            if (text && role === 'user') {
                // 用户消息：立即完整显示（同步）
                const textNode = document.createTextNode(text);
                contentDiv.appendChild(textNode);
            } else if (role === 'assistant') {
                // AI消息：初始为空，等待流式渲染
                contentDiv.textContent = '';
            }

            if (role !== 'assistant') {
                messageDiv.appendChild(contentDiv);
            }
            return messageDiv;
        }

        // 两条线分离：Android 拉取 snapshot 后注入最近 N 轮仅做 UI 展示，不参与 A/B 存储
        function setInitialHistory(rounds) {
            if (!messagesContainer || !Array.isArray(rounds) || rounds.length === 0) return;
            for (var i = 0; i < rounds.length; i++) {
                var r = rounds[i];
                var userMsg = createMessage({ role: 'user', text: (r && r.user) || '', files: null, imageUrls: null, stream: false });
                messagesContainer.appendChild(userMsg);
                var astMsg = createMessage({ role: 'assistant', text: '', stream: false });
                var contentDiv = astMsg.querySelector('.message-content');
                if (contentDiv) contentDiv.textContent = (r && r.assistant) || '';
                messagesContainer.appendChild(astMsg);
            }
            refreshEmptyState();
            if (typeof applyMessageWindow === 'function') applyMessageWindow();
            scrollToBottom();
        }
        window.setInitialHistory = setInitialHistory;

        // 滚动到底部：仅当 stickToBottom 时自动跟；force=true 时一键回底并恢复跟随
        var scrollToBottomRaf = null;
        function scheduleScrollToBottom() {
            if (scrollToBottomRaf) return;
            scrollToBottomRaf = requestAnimationFrame(function() {
                scrollToBottomRaf = null;
                if (stickToBottom && messagesWrapper) messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
            });
        }
        function scrollToBottom(force) {
            if (force) {
                stickToBottom = true;
                if (messagesWrapper) messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
                updateScrollToBottomBtn();
            } else {
                if (stickToBottom) scheduleScrollToBottom();
            }
        }
        function startAutoFollowForGeneration() {
            stickToBottom = true;
            scrollToBottom(true);
            requestAnimationFrame(function() { scrollToBottom(true); });
        }
        function updateScrollToBottomBtn() {
            var btn = document.getElementById('scrollToBottomBtn');
            if (!btn) return;
            var hasMessages = !!(messagesContainer && messagesContainer.querySelector('.message'));
            if (hasMessages && !stickToBottom) btn.style.display = '';
            else btn.style.display = 'none';
        }
        messagesWrapper.addEventListener('scroll', function() {
            stickToBottom = atBottom(messagesWrapper);
            updateScrollToBottomBtn();
        });
        (function() {
            var btn = document.getElementById('scrollToBottomBtn');
            if (btn) btn.addEventListener('click', function() { scrollToBottom(true); });
        })();

        // 纯展示裁剪：删除超出 MAX_MESSAGES 的 DOM，不得用裁剪结果更新或推导 A/B
        function hardTrimMessages() {
            if (!messagesContainer) return;
            var nodes = Array.from(messagesContainer.querySelectorAll('.message'));
            if (nodes.length <= MAX_MESSAGES) return;
            var removeCount = nodes.length - MAX_MESSAGES;
            for (var i = 0; i < removeCount; i++) {
                nodes[i].remove();
            }
        }
        function refreshEmptyState() {
            const hasMessages = !!(messagesContainer && messagesContainer.querySelector('.message'));
            emptyState.classList.toggle('hidden', hasMessages);
        }

        // 同一位置切换：语音键/键盘键（麦克风键只做切换，不打开面板；录音由按住输入框触发）
        btnMicOrKeyboard.addEventListener('click', function() {
            if (voicePanel.classList.contains('open')) {
                stopVoice();
                textInput.focus();
                return;
            }
            if (inputContainer.classList.contains('voice-mode')) {
                inputContainer.classList.remove('voice-mode');
                updateInputMode();
                textInput.focus();
            } else {
                inputContainer.classList.add('voice-mode');
                updateInputMode();
            }
        });

        // C. Stop：只停前端（stopTypewriter + 状态）；stopGeneration 保留调用但不依赖其中断后端
        btnStop.addEventListener('click', function() {
            stopTypewriter();
            Object.keys(previewTimerByStream).forEach(function(sid) {
                clearInterval(previewTimerByStream[sid]);
                delete previewTimerByStream[sid];
                terminatedStreamIds[sid] = true;
            });
            // 确保结束流式态：移除所有 assistant 的 .streaming，dot 只在「正在流式的那一条」显示
            if (messagesContainer) {
                messagesContainer.querySelectorAll('.message.assistant.streaming').forEach(function(m) { m.classList.remove('streaming'); });
            }
            isGenerating = false;
            updateInputMode();
            updateScrollToBottomBtn();
            if (typeof AndroidInterface.stopGeneration === 'function') {
                AndroidInterface.stopGeneration();
            }
        });

        /** P0-6: 幂等复位，任一退出事件调用 */
        function stopVoice() {
            if (!voicePanel.classList.contains('open') && !voiceRecording) return;
            voiceRecording = false;
            voiceCancelArmed = false;
            if (voicePendingTimeout) { clearTimeout(voicePendingTimeout); voicePendingTimeout = null; }
            voicePanel.classList.remove('open');
            document.body.classList.remove('voice-panel-open');
            inputContainer.classList.remove('voice-mode');
            voicePanel.classList.remove('cancel-armed');
            voiceHint.textContent = '按住说话';
            stopWaveform();
            removeVoiceRecordingListeners();
            removeVoiceExitListeners();
            updateInputMode();
        }
        function addVoiceExitListeners() {
            document.addEventListener('pointerup', _onVoiceExit);
            document.addEventListener('pointercancel', _onVoiceExit);
            window.addEventListener('blur', _onVoiceExit);
            document.addEventListener('visibilitychange', _onVoiceExitHidden);
        }
        function removeVoiceExitListeners() {
            document.removeEventListener('pointerup', _onVoiceExit);
            document.removeEventListener('pointercancel', _onVoiceExit);
            window.removeEventListener('blur', _onVoiceExit);
            document.removeEventListener('visibilitychange', _onVoiceExitHidden);
        }
        function _onVoiceExit(e) {
            if (!voicePanel.classList.contains('open')) return;
            if (e && (e.target === voiceMicBtn || voiceMicBtn.contains(e.target))) return;
            if (e && voiceHoldOverlay && (e.target === voiceHoldOverlay || voiceHoldOverlay.contains(e.target))) return;
            stopVoice();
        }
        function _onVoiceExitHidden() { if (document.hidden) stopVoice(); }

        // D. VoicePanel：按住输入框才录音，弹出面板显示蓝态/红态提示（松手发送上滑取消 / 松手取消）
        function getTouchY(e) {
            if (e.touches && e.touches.length) return e.touches[0].clientY;
            return e.clientY;
        }
        function addVoiceRecordingListeners() {
            document.addEventListener('touchmove', onVoiceMove, { passive: false });
            document.addEventListener('mousemove', onVoiceMove);
            document.addEventListener('touchend', onVoiceEnd);
            document.addEventListener('mouseup', onVoiceEnd);
        }
        function removeVoiceRecordingListeners() {
            document.removeEventListener('touchmove', onVoiceMove);
            document.removeEventListener('mousemove', onVoiceMove);
            document.removeEventListener('touchend', onVoiceEnd);
            document.removeEventListener('mouseup', onVoiceEnd);
        }
        function onVoiceMove(e) {
            if (voiceRecording && e && e.cancelable) e.preventDefault();
            if (!voiceRecording) return;
            const y = getTouchY(e);
            const delta = voiceTouchStartY - y;
            if (delta > VOICE_CANCEL_THRESHOLD_PX && !voiceCancelArmed) {
                voiceCancelArmed = true;
                voicePanel.classList.add('cancel-armed');
                voiceHint.textContent = '松手取消';
                startWaveform(true, true);
            }
        }

        function onVoiceStart(e) {
            if (e && e.cancelable) e.preventDefault();
            if (e.type === 'touchstart') voiceTouchStartY = e.touches[0].clientY;
            else voiceTouchStartY = e.clientY;
            if (typeof removeVoiceRecordingListeners === 'function') removeVoiceRecordingListeners();
            voiceRecording = true;
            voiceCancelArmed = false;
            voicePanel.classList.remove('cancel-armed');
            voiceHint.textContent = '松手发送，上滑取消';
            voicePanel.classList.add('open');
            document.body.classList.add('voice-panel-open');
            addVoiceExitListeners();
            if (typeof addVoiceRecordingListeners === 'function') addVoiceRecordingListeners();
            startWaveform(true, false);
        }

        function onVoiceEnd(e) {
            if (!voiceRecording) return;
            if (e && e.cancelable) e.preventDefault();
            voiceRecording = false;
            removeVoiceRecordingListeners();
            voicePanel.classList.remove('cancel-armed');
            voiceHint.textContent = '按住说话';
            stopWaveform();
            if (voiceCancelArmed) {
                voicePanel.classList.remove('open');
                document.body.classList.remove('voice-panel-open');
                removeVoiceExitListeners();
                updateInputMode();
                return;
            }
            if (voicePendingTimeout) clearTimeout(voicePendingTimeout);
            voicePendingTimeout = setTimeout(function() {
                voicePendingTimeout = null;
                finishVoiceSend('语音输入的消息');
            }, 600);
            if (typeof window.onVoiceRecognized === 'function') {
                var t = window.onVoiceRecognized();
                if (t != null && t !== undefined) {
                    if (voicePendingTimeout) { clearTimeout(voicePendingTimeout); voicePendingTimeout = null; }
                    finishVoiceSend(t);
                    return;
                }
            }
        }
        if (voiceHoldOverlay) {
            voiceHoldOverlay.addEventListener('mousedown', onVoiceStart);
            voiceHoldOverlay.addEventListener('touchstart', onVoiceStart, { passive: false });
        }
        window.onVoiceResult = function(text) {
            if (voicePendingTimeout) { clearTimeout(voicePendingTimeout); voicePendingTimeout = null; }
            finishVoiceSend(text);
        };

        function finishVoiceSend(text) {
            removeVoiceExitListeners();
            voicePanel.classList.remove('open');
            document.body.classList.remove('voice-panel-open');
            inputContainer.classList.remove('voice-mode');
            updateInputMode();
            if (!text || !String(text).trim()) {
                showToastOncePerDay('voice_empty', '未识别到内容');
                voiceHint.textContent = '按住说话';
                return;
            }
            var t = String(text).trim();
            textInput.value = t;
            updateInputMode();
            sendMessage();
        }

        // D4. 波形 Canvas（细条、轻微浮动，不抢注意力）
        const WAVE_BARS = 32;
        let waveBarsHeights = Array(WAVE_BARS).fill(0.35);
        let wavePhase = 0;

        function startWaveform(recording, cancelArmed) {
            stopWaveform();
            const ctx = voiceWaveform.getContext('2d');
            const w = voiceWaveform.width;
            const h = voiceWaveform.height;
            const barW = Math.max(2, (w / WAVE_BARS) * 0.32);
            const gap = w / WAVE_BARS - barW;
            const color = cancelArmed ? '#E14B4B' : (recording ? '#000000' : '#D9D9D9');
            const amp = cancelArmed ? 0.2 : (recording ? 0.28 : 0.15);

            function draw() {
                wavePhase += recording ? 0.08 : 0.03;
                ctx.clearRect(0, 0, w, h);
                for (let i = 0; i < WAVE_BARS; i++) {
                    const t = Math.sin(wavePhase + i * 0.35) * 0.5 + 0.5;
                    waveBarsHeights[i] = waveBarsHeights[i] * 0.88 + t * amp * 0.12;
                    const barH = Math.max(2, h * waveBarsHeights[i] * 0.5);
                    const x = i * (barW + gap) + gap * 0.5;
                    ctx.fillStyle = color;
                    ctx.fillRect(x, (h - barH) / 2, barW, barH);
                }
                waveformAnimId = requestAnimationFrame(draw);
            }
            draw();
        }

        function stopWaveform() {
            if (waveformAnimId) {
                cancelAnimationFrame(waveformAnimId);
                waveformAnimId = null;
            }
        }

        inputContainer.classList.remove('voice-mode');
        btnMicOrKeyboard.classList.remove('voice-mode');
        updateDrawerLoginState();
        updateInputMode();
        refreshEmptyState();
        btnSend.addEventListener('click', sendMessage);

        textInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
