<!-- UI_VERSION: phone-shell-20250128 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
    <title>鍐滄妧鍗冮棶</title>
    <style>
        /* B. 棰滆壊涓庡昂瀵革紙纭€硷級 */
        :root {
            --debug-shell: 0;
            --green: #169C5C;
            --green-accent: #1FAE6A;
            --bg: #FFFFFF;
            --border: #EDEDED;
            --text: #111111;
            --text-secondary: #8C8C8C;
            --text-disabled: #BDBDBD;
            --danger: #E14B4B;
            --stop-bg: #F4F4F4;
            --divider: #F2F2F2;
            --placeholder: #9B9B9B;
            --tool-result-text: #6B6B6B;
            --input-radius: 22px;
            --btn-circle-size: 40px;
            --input-min-height: 56px;
            --transition-fast: 180ms ease;
            --transition-sheet: 240ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 16px;
            line-height: 1.4;
            background-color: #F6F6F6;
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        .app-shell {
            width: min(100vw, 430px);
            max-width: 430px;
            height: 100vh;
            margin: 0 auto;
            background: #F6F6F6;
            display: flex;
            flex-direction: column;
            position: relative;
            outline: calc(var(--debug-shell) * 1px) solid red;
        }
        .app-shell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.025), transparent);
            pointer-events: none;
            z-index: 0;
        }
        .app-shell::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 96px;
            background: linear-gradient(to top, rgba(0,0,0,0.03), transparent);
            pointer-events: none;
            z-index: 0;
        }

        @media (orientation: landscape) {
            .app-shell {
                max-width: 520px;
                width: min(100vw, 520px);
            }
        }

        /* A. 椤堕儴 AppBar锛堣儗鏅€忔槑锛屾部鐢?app-shell 搴曡壊锛?*/
        .app-bar {
            position: relative;
            z-index: 1;
            flex-shrink: 0;
            height: 56px;
            padding: env(safe-area-inset-top) 12px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: none;
            box-shadow: none;
            background: transparent;
        }
        .app-bar-left {
            width: var(--btn-circle-size);
            height: var(--btn-circle-size);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            color: var(--text);
            border-radius: 50%;
            background: #FFFFFF;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.06);
        }
        .app-bar-left:hover {
            background: #F8F8F8;
        }
        .app-bar-title-wrap {
            position: relative;
            margin-left: auto;
            margin-right: 16px;
            pointer-events: none;
            max-width: calc(100% - var(--btn-circle-size) - 32px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #FFFFFF;
            border-radius: 999px;
            padding: 6px 14px 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.06);
        }
        .app-bar-title {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.3px;
            color: var(--text);
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .app-bar svg {
            width: 22px;
            height: 22px;
            stroke: var(--text);
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        /* 宸︿晶鎶藉眽锛?40px 鏈€澶?360px锛岀Щ鍔ㄧ 80% 鏈€澶?360px锛涘乏婊戝叆 220ms锛涚姝㈢珫鎺?鏃嬭浆鏂囧瓧 */
        #drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: 340px;
            max-width: 360px;
            height: 100%;
            background: #F5F5F5;
            box-shadow: 2px 0 12px rgba(0,0,0,0.12);
            z-index: 301;
            transform: translateX(-100%);
            transition: transform 220ms cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex;
            flex-direction: column;
            writing-mode: horizontal-tb;
        }
        #drawer .drawer-content {
            writing-mode: horizontal-tb;
            transform: none;
            text-orientation: mixed;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #drawer .drawer-content::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        #drawer .menu-card {
            writing-mode: horizontal-tb;
            transform: none;
            text-orientation: mixed;
        }
        #drawer .menu-card:active {
            transform: scale(0.98);
        }
        @media (max-width: 600px) {
            #drawer { width: 80%; max-width: 360px; }
        }
        #drawer.open {
            transform: translateX(0);
        }
        .drawer-content {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 16px;
        }
        .menu-card {
            display: flex;
            align-items: center;
            gap: 12px;
            min-height: 60px;
            padding: 16px;
            margin-bottom: 12px;
            background: #F6F6F6;
            border-radius: 12px;
            font-size: 15px;
            color: var(--text);
            cursor: pointer;
            transition: background 0.2s ease, transform 0.15s ease;
        }
        .menu-card:hover {
            background: #EEEEEE;
        }
        .menu-card:active {
            background: #E0E0E0;
        }
        .menu-card > span:first-of-type {
            flex: 1;
            min-width: 0;
        }
        .menu-card .menu-card-right {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .menu-card .menu-arrow {
            flex-shrink: 0;
            opacity: 0.5;
        }
        .menu-card .menu-arrow svg {
            width: 18px;
            height: 18px;
        }
        .drawer-footer {
            flex-shrink: 0;
            padding: 8px 16px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
            background: transparent;
            border-top: 0;
        }
        .drawer-footer .menu-card {
            margin-bottom: 2px;
            min-height: auto;
            padding: 0;
            border: 0;
            border-radius: 0;
            background: transparent;
            box-shadow: none;
            justify-content: center;
        }
        .drawer-footer .menu-card:hover,
        .drawer-footer .menu-card:active {
            background: transparent;
            border-color: transparent;
            transform: none;
        }
        .drawer-logout {
            color: #C2362B;
            font-size: 14px;
            font-weight: 600;
        }
        .menu-card.menu-card-danger {
            color: #C2362B;
            border-color: transparent;
            background: transparent;
        }
        .menu-card.is-hidden {
            display: none;
        }
        .drawer-version {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 12px;
        }
        /* 閬僵锛歳gba(0,0,0,0.35)锛岀偣鍑诲叧闂娊灞?*/
        #drawer-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.35);
            cursor: pointer;
            z-index: 300;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        #drawer-mask.show {
            pointer-events: auto;
            opacity: 1;
        }

        /* ========== 浼氬憳涓績锛氫竴灞忓彲瑙侊紙榛樿鏃犲唴閮ㄦ粴鍔ㄦ潯锛?========== */
        #membership-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.35);
            z-index: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            opacity: 0;
            visibility: hidden;
            transition: opacity .22s ease, visibility .22s ease;
            writing-mode: horizontal-tb;
        }
        #membership-modal-backdrop.open {
            opacity: 1;
            visibility: visible;
        }
        #membership-modal {
            width: min(560px, calc(100vw - 24px));
            height: min(720px, calc(100vh - 24px));
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 10px 40px rgba(0,0,0,.18);
            padding: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1000;
            writing-mode: horizontal-tb;
            transform: none;
            text-orientation: mixed;
        }
        .membership-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 4px 10px;
            border-bottom: 1px solid rgba(0,0,0,.06);
        }
        .membership-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--text);
        }
        .membership-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,.10);
            background: #fff;
            cursor: pointer;
            pointer-events: auto;
            z-index: 1100;
        }
        .membership-close:active {
            transform: scale(.98);
        }
        .membership-sub {
            font-size: 13px;
            color: var(--text-secondary);
            padding: 8px 4px 12px;
            line-height: 1.4;
        }
        .membership-cards {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-top: 12px;
        }
        .membership-card {
            flex: 1;
            min-height: 0;
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,.08);
            background: #fff;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            writing-mode: horizontal-tb;
            transform: none;
            text-orientation: mixed;
        }
        .membership-card[data-tier="pro"] {
            border-color: rgba(0,0,0,.18);
            box-shadow: 0 6px 18px rgba(0,0,0,.06);
        }
        .membership-card.recommended-highlight {
            border-color: rgba(0,0,0,.35);
            box-shadow: 0 8px 24px rgba(0,0,0,.12);
        }
        .card-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding-right: 96px;
            /* 鍏滃簳锛氱郴缁熷瓧浣撴斁澶т篃涓嶆尋 */
        }
        .card-name {
            font-size: 16px;
            font-weight: 900;
            color: var(--text);
        }
        .card-price {
            font-size: 16px;
            font-weight: 900;
            color: var(--text);
            white-space: nowrap;
        }
        .card-badge {
            position: absolute;
            top: 10px;
            right: 12px;
            font-size: 11px;
            line-height: 1.2;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid rgba(0,0,0,.14);
            background: #fff;
            color: rgba(0,0,0,.72);
            /* 闃叉闀挎枃妗堥《鍒颁环鏍硷細badge 鑷繁鏀舵暃 */
            max-width: 88px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dot {
            font-weight: 900;
            color: rgba(0,0,0,.70);
            padding: 0 2px;
        }
        .card-desc {
            font-size: 13px;
            font-weight: 400;
            color: var(--text-secondary);
            line-height: 1.45;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            padding-left: 12px;
            padding-right: 96px;
            min-width: 0;
            width: 100%;
            box-sizing: border-box;
        }
        .card-desc .dot {
            font-weight: 900;
        }
        .card-btn {
            margin-top: auto;
            width: 100%;
            height: 44px;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,.12);
            background: #111;
            color: #fff;
            font-size: 14px;
            font-weight: 900;
            cursor: pointer;
            writing-mode: horizontal-tb;
            transform: none;
        }
        .card-btn:active {
            transform: scale(.99);
        }
        .card-btn.btn-current, .card-btn:disabled {
            opacity: .45;
        }
        .card-btn.btn-higher-disabled {
            cursor: not-allowed;
            opacity: .5;
        }
        .card-higher-hint {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
            cursor: not-allowed;
        }
        .membership-footnote {
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        @media (max-height: 680px) {
            #membership-modal {
                height: calc(100vh - 24px);
                overflow: auto;
                scrollbar-width: none;
            }
            #membership-modal::-webkit-scrollbar {
                width: 0;
                height: 0;
            }
        }
        #toast {
            position: fixed;
            left: 50%;
            bottom: 80px;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0,0,0,0.75);
            color: #fff;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 500;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.25s, transform 0.25s, visibility 0.25s;
        }
        #toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        /* ===== ChatGPT-ish neutral theme锛堣鐩?drawer + modal 涓洪粦鐧界伆鏋佺畝锛?===== */
        :root {
            --bg: #f7f7f8;
            --surface: #ffffff;
            --text: #111111;
            --muted: rgba(17,17,17,.65);
            --border: rgba(0,0,0,.08);
            --shadow: 0 8px 30px rgba(0,0,0,.12);
            --radius: 16px;
        }
        #drawer {
            background: var(--surface);
            box-shadow: 8px 0 30px rgba(0,0,0,.10);
            border-right: 1px solid var(--border);
        }
        .menu-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            margin-bottom: 10px;
            min-height: 56px;
            padding: 14px;
            box-shadow: 0 1px 0 rgba(0,0,0,.02);
            transition: background .15s ease, border-color .15s ease;
        }
        .menu-card:hover {
            background: #fbfbfc;
            border-color: rgba(0,0,0,.12);
        }
        .menu-card:active {
            transform: none;
            background: #f3f3f5;
        }
        .menu-card .menu-card-right {
            color: var(--muted);
        }
        .menu-card .menu-arrow {
            opacity: .35;
        }
        #drawer-mask {
            background: rgba(0,0,0,.28);
        }

        .main {
            position: relative;
            z-index: 1;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .messages-wrapper {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        .messages-container {
            display: flex;
            flex-direction: column;
            padding: 16px;
            padding-bottom: calc(88px + env(safe-area-inset-bottom, 0px));
            min-height: 100%;
        }

        /* G. 绌烘€侊紙P0-2锛氭棤澶х悆锛屾枃瀛楀乏瀵归綈锛?*/
        .empty-state {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            padding: 40px 24px 24px;
            pointer-events: none;
        }
        .empty-state.hidden {
            display: none;
        }
        .empty-state .logo {
            display: block;
        }
        .empty-state .empty-state-hint {
            font-size: 16px;
            color: var(--text);
            font-weight: 500;
            margin-top: 12px;
            line-height: 1.55;
            max-width: 340px;
            letter-spacing: 0.2px;
        }
        /* 鍏ㄥ璇濇棤姘旀场锛欸PT 绾噣鏂囨湰鍧?*/
        .message {
            margin-bottom: 20px;
            max-width: 85%;
            background: transparent;
            border: none;
            box-shadow: none;
            border-radius: 0;
        }

        .message:last-child {
            margin-bottom: 0;
        }

        .message.user {
            align-self: flex-end;
            margin-left: auto;
        }

        .message.assistant {
            align-self: flex-start;
        }

        /* P0-1: 宸︿晶鐢熸垚涓烦鍔ㄧ豢鐞?*/
        .message.assistant .message-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .message.assistant .avatar-slot {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 14px;
        }
        /* ChatGPT 椋庢牸锛氱敓鎴愪腑浠呮樉绀哄皬灏哄榛戠櫧涓夌偣 loading锛屾棤褰╄壊 */
        .message.assistant .streaming-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--green);
            opacity: 0;
            pointer-events: none;
        }
        .message.assistant.streaming .streaming-dot {
            opacity: 1;
            animation: dot-breathe 1.25s ease-in-out infinite;
        }
        @keyframes dot-breathe {
            0%, 100% { transform: scale(1); opacity: 0.78; }
            50% { transform: scale(1.12); opacity: 0.95; }
        }

        .message-content {
            line-height: 1.62;
            font-size: 16px;
            font-weight: 400;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
            /* 鏂鍒お纰庯紙anywhere 浼氭妸涓枃/URL 鏂緱寰堟€級 */
            overflow-wrap: break-word;
            letter-spacing: 0.1px;
            max-width: 100%;
            color: var(--text);
            padding: 4px 12px;
            background: transparent;
            border: none;
            box-shadow: none;
            border-radius: 12px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .message-content p { margin: 0 0 10px; }
        .message-content p:last-child { margin-bottom: 0; }
        .message-content ul, .message-content ol { margin: 6px 0 10px 22px; padding: 0; }
        .message-content li { margin: 4px 0; }
        .message-content li > p { margin: 0; }
        .message-content blockquote {
            margin: 8px 0 10px;
            padding: 6px 10px;
            border-left: 3px solid rgba(0,0,0,0.12);
            color: var(--text-secondary);
        }
        .message-content code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            font-size: 0.95em;
            background: rgba(0,0,0,0.05);
            border-radius: 6px;
            padding: 1px 6px;
        }
        .message-content pre {
            margin: 8px 0 10px;
            padding: 10px 12px;
            background: rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 12px;
            overflow: auto;
            /* WebView 閲屼唬鐮佸潡鏇寸ǔ銆佹洿鍍?GPT */
            white-space: pre;
            tab-size: 4;
        }
        .message-content pre code {
            background: transparent;
            padding: 0;
            border-radius: 0;
            display: block;
            white-space: pre;
        }
        .message-content h1 { font-size: 18px; margin: 10px 0 8px; }
        .message-content h2 { font-size: 17px; margin: 10px 0 8px; }
        .message-content h3 { font-size: 16px; margin: 10px 0 6px; }
        .message-content h4 { font-size: 16px; margin: 8px 0 6px; font-weight: 600; }
        .message-content a { color: inherit; text-decoration: underline; text-underline-offset: 2px; }
        .message-content hr { border: 0; border-top: 1px solid rgba(0,0,0,0.08); margin: 10px 0; }
        .message-content.md-rendered { white-space: normal; }
        /* ===== 杩藉姞瑕嗙洊锛氭敹鍙ｆ垚 GPT 瑙傛劅锛堜笉鍒犳棫瑙勫垯锛屼粎鍚庡啓瑕嗙洊锛?===== */
        /* 1) 鍐呭瀹藉害涓庤创杈癸細assistant 闈犲乏銆乽ser 闈犲彸锛屼絾閮藉埆閾烘弧 */
        .message-content { max-width: 680px; width: 100%; box-sizing: border-box; margin-right: auto; margin-left: 0; }
        .message.user .message-content { margin-left: auto; margin-right: 0; max-width: 680px; }

        /* 2) 鑺傚鏇村儚 GPT锛氭钀?鍒楄〃闂磋窛鐣ユ敹绱?*/
        .message-content p { margin: 0 0 8px; }
        .message-content p:last-child { margin-bottom: 0; }
        .message-content ul, .message-content ol { margin: 6px 0 8px 22px; }
        .message-content li { margin: 3px 0; }

        /* 3) 寮曠敤鍧楋細娣″簳 + 鍦嗚锛岄伩鍏嶁€滅‖妗嗏€?*/
        .message-content blockquote { padding: 8px 10px; background: rgba(0,0,0,0.02); border-left-color: rgba(0,0,0,0.12); border-radius: 10px; }

        /* 4) 浠ｇ爜鍧楋細鏇撮『婊戞嫋鍔ㄣ€佹洿绋崇殑瀛楀彿涓庤楂?*/
        .message-content pre { line-height: 1.55; font-size: 14px; padding: 12px 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; background: rgba(0,0,0,0.035); border-color: rgba(0,0,0,0.07); border-radius: 14px; }
        .message-content code { background: rgba(0,0,0,0.045); }

        /* 5) 閾炬帴锛氬埆澶€滅‖鈥濓紝涓嬪垝绾挎贰涓€鐐?*/
        .message-content a { text-decoration-thickness: 1px; text-decoration-color: rgba(0,0,0,0.35); }

        /* 6) 鐢ㄦ埛娑堟伅锛氬鍣ㄩ潬鍙筹紝鍧楃骇涓庢钀藉乏瀵归綈鍙 */
        .message.user .message-content ul,
        .message.user .message-content ol,
        .message.user .message-content blockquote,
        .message.user .message-content pre,
        .message.user .message-content h1,
        .message.user .message-content h2,
        .message.user .message-content h3,
        .message.user .message-content h4 { text-align: left; }
        .message.user .message-content p,
        .message.user .message-content li,
        .message.user .message-content blockquote,
        .message.user .message-content pre { text-align: left; }

        .message.user .message-content {
            text-align: right;
            color: var(--text);
            margin-left: auto;
            margin-right: 0;
            max-width: 680px;
        }

        .message.assistant .message-content {
            text-align: left;
            color: var(--text);
        }

        /* ===== GPT-ish message spacing (override only) ===== */
        /* 1) 姣忔潯娑堟伅鐨勫瀭鐩撮棿璺濓細鍒尋銆佸埆澶暎 */
        .message { margin: 10px 0; }
        /* 2) 娑堟伅琛屽唴閮細澶村儚涓庢鏂囩殑璺濈銆佸榻愭洿绋?*/
        .message-row { gap: 10px; align-items: flex-start; }
        /* 3) 鍐呭鍧楀唴杈硅窛锛欸PT 鏇粹€滅焊寮犳劅鈥濓紝浣嗗埆鍙樻垚姘旀场 */
        .message-content { padding: 6px 12px; }
        /* 4) 鐢ㄦ埛娑堟伅鍧楋細鍙充晶闈犺竟浣嗗埆璐存锛堜笉鏀逛綘鐜版湁鍙冲榻愮瓥鐣ワ級 */
        .message.user .message-content { padding: 6px 12px; }
        /* 5) 濡傛灉浣犳湁 message-wrapper/ container 鐨?padding锛岀‘淇濅笂涓嬬暀鐧?*/
        .messages-container { padding-top: 6px; padding-bottom: calc(96px + env(safe-area-inset-bottom, 0px)); }

        /* ===== 瀹屾垚鎬?GPT 瑙傛劅鏈€灏忛闄╂敹鍙ｏ紙浠呰拷鍔犺鐩栵級 ===== */
        .message-content.md-rendered { overflow-wrap: break-word; word-break: break-word; }
        .message-content.md-rendered a { word-break: break-all; }
        .message-content { line-height: 1.62; }
        .message-content p { margin: 0 0 8px; }
        .message-content p:last-child { margin-bottom: 0; }
        .message-content ul, .message-content ol { margin: 6px 0 8px 22px; }
        .message-content li { margin: 3px 0; }
        .message-content { -webkit-user-select: text; user-select: text; }
        .copy-popover {
            position: fixed;
            z-index: 9999;
            background: rgba(255,255,255,0.98);
            border: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 6px 18px rgba(0,0,0,0.10);
            border-radius: 12px;
            padding: 6px;
            display: none;
        }
        .copy-popover button {
            border: 0;
            background: transparent;
            padding: 8px 10px;
            font-size: 14px;
            color: var(--text);
            cursor: pointer;
            border-radius: 10px;
        }
        .copy-popover button:active { background: rgba(0,0,0,0.06); }

        .copy-sheet-mask {
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 9998;
            background: rgba(0,0,0,0.08);
            display: none;
        }
        .copy-sheet-mask.open { display: block; }
        .copy-sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            max-height: 55vh;
            background: #fff;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -4px 24px rgba(0,0,0,0.12);
            transform: translateY(110%);
            transition: transform 0.25s ease;
            display: block;
        }
        .copy-sheet.open { transform: translateY(0); }
        .copy-sheet-handle {
            height: 4px;
            width: 36px;
            margin: 8px auto;
            background: rgba(0,0,0,0.12);
            border-radius: 2px;
        }
        .copy-sheet-actions {
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }
        .copy-sheet-actions button {
            border: 0;
            background: transparent;
            padding: 8px 12px;
            font-size: 14px;
            color: var(--text);
            cursor: pointer;
            border-radius: 8px;
        }
        .copy-sheet-actions button:active { background: rgba(0,0,0,0.06); }
        .copy-sheet-body {
            padding: 12px;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            user-select: text;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.5;
            max-height: calc(55vh - 120px);
        }
        body.copy-ui-open { overflow: hidden; }
        .copy-sheet-body { -webkit-user-select: text; user-select: text; }
        .copy-sheet-body * { -webkit-user-select: text; user-select: text; }
        .copy-sheet-body a { pointer-events: none; }

        /* 宸ュ叿缁撴灉鍧楋細ChatGPT 椋庢牸鐏板瓧灏忓彿锛岀粦瀹氬湪 assistant 娑堟伅涓嬫柟 */
        .tool-result {
            font-size: 12px;
            line-height: 1.5;
            color: var(--tool-result-text);
            margin-top: 8px;
            white-space: pre-wrap;
            word-break: break-word;
            padding-left: 12px;
            border-left: 1px solid rgba(0, 0, 0, 0.08);
        }
        .message-image {
            max-width: 100%;
            margin: 12px 0;
            display: block;
            border-radius: 4px;
        }

        .image-preview-container {
            padding: 8px 12px;
            background-color: #f9f9f9;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 120px;
            overflow-y: auto;
        }

        .image-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #e0e0e0;
            flex-shrink: 0;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-status-overlay {
            position: absolute;
            top: 0;
            right: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 0 0 0 8px;
        }

        .image-status-uploading {
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .image-status-success {
            color: #4caf50;
            font-size: 16px;
            font-weight: bold;
        }

        .image-status-fail {
            color: #f44336;
            font-size: 16px;
            font-weight: bold;
        }

        .image-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 4px;
            padding: 4px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
        }

        .image-action-btn {
            flex: 1;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.9);
            color: #111;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }

        .image-action-btn:hover {
            background-color: rgba(255, 255, 255, 1);
        }

        .image-action-btn.delete {
            background-color: rgba(244, 67, 54, 0.9);
            color: white;
        }

        .image-action-btn.delete:hover {
            background-color: rgba(244, 67, 54, 1);
        }

        .image-fail-hint {
            position: absolute;
            bottom: 28px;
            left: 4px;
            right: 4px;
            font-size: 10px;
            color: #f44336;
            text-align: center;
            background: rgba(0,0,0,0.6);
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* F. 搴曢儴杈撳叆鍖猴紙鑳屾櫙閫忔槑锛屾部鐢?app-shell 鏁撮〉娓愬彉锛?*/
        .input-container {
            flex-shrink: 0;
            min-height: calc(var(--input-min-height) - 2px);
            background: transparent;
            border-top: none;
            padding: 8px 14px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
            display: flex;
            flex-direction: column;
            gap: 0;
            transition: min-height var(--transition-sheet);
            position: relative;
            z-index: 100;
        }
        .input-container.voice-mode {
            min-height: calc(var(--input-min-height) + 8px);
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 44px;
        }

        .file-input, .camera-input {
            display: none;
        }

        .add-button, .btn-mic-or-keyboard, .btn-send, .btn-stop {
            width: var(--btn-circle-size);
            height: var(--btn-circle-size);
            min-width: var(--btn-circle-size);
            min-height: var(--btn-circle-size);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform var(--transition-fast), background-color var(--transition-fast);
        }
        .add-button:active, .btn-mic-or-keyboard:active, .btn-send:active, .btn-stop:active {
            transform: scale(0.98);
        }

        /* 鍔犲彿鎸夐挳锛氬渾鐞冪櫧鑹诧紝搴曟爮娴呯伆锛岀櫧鐞冨湪鐏板簳涓婃樉鐪硷紱鍗佸瓧鏋舵祬鐏?*/
        .add-button {
            border: 1px solid rgba(0,0,0,0.06);
            align-self: center;
            min-width: 44px;
            min-height: 44px;
            width: 44px;
            height: 44px;
            background: #FFFFFF;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            color: #666666;
            font-size: 48px;
            font-weight: 300;
            line-height: 1;
        }
        .add-button:hover {
            background: #F8F8F8;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: #666666;
        }
        .add-button:active {
            transform: scale(0.96);
            box-shadow: 0 0 0 rgba(0,0,0,0.04);
        }
        .btn-mic-or-keyboard {
            background: none;
            color: var(--text);
            position: relative;
            margin-top: -2px;
        }
        .btn-mic-or-keyboard .icon-keyboard {
            display: none;
        }
        .btn-mic-or-keyboard .icon-mic {
            display: flex;
        }
        .btn-mic-or-keyboard.voice-mode .icon-keyboard {
            display: flex;
        }
        .btn-mic-or-keyboard.voice-mode .icon-mic {
            display: none;
        }
        .btn-mic-or-keyboard svg {
            width: 28px;
            height: 28px;
        }
        .btn-mic-or-keyboard .icon-mic svg,
        .btn-mic-or-keyboard .icon-keyboard svg {
            stroke: var(--text);
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        .btn-mic-or-keyboard:hover {
            background: rgba(0,0,0,0.05);
        }

        .btn-send {
            background: rgba(0,0,0,0.92);
            color: #fff;
        }
        .btn-send:hover {
            background: rgba(0,0,0,0.84);
        }
        .btn-send:active {
            background: rgba(0,0,0,0.78);
        }
        .btn-send svg {
            width: 24px;
            height: 24px;
            stroke: #fff;
            stroke-width: 2.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        /* P0-7: 榛戝渾+缁挎柟 */
        .btn-stop {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            background: #111;
            color: var(--text);
            border-radius: 999px;
        }
        .btn-stop:hover {
            background: #222;
        }
        .btn-stop:active {
            transform: scale(0.92);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .btn-stop svg {
            width: 21px;
            height: 21px;
        }
        .btn-stop svg rect {
            fill: #fff;
        }

        .input-area-with-hint .btn-mic-or-keyboard,
        .input-area-with-hint .btn-send,
        .input-area-with-hint .btn-stop {
            transition: opacity var(--transition-fast);
        }
        .input-area-with-hint .btn-hidden {
            display: none !important;
        }

        .text-input {
            flex: 1;
            width: 100%;
            min-width: 0;
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 10px 4px 6px;
            color: var(--text);
            font-size: 16px;
            font-weight: 400;
            line-height: 22px;
            resize: none;
            min-height: 40px;
            max-height: 110px;
            outline: none;
            -webkit-font-smoothing: antialiased;
            text-align: left;
        }
        .text-input::placeholder {
            color: transparent;
            text-align: left;
        }
        .text-input:focus {
            border-color: var(--green);
        }
        .text-input::-webkit-resizer {
            display: none;
        }
        .text-input::-webkit-scrollbar {
            width: 4px;
        }
        .text-input::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 2px;
        }

        .typing-indicator {
            display: inline-block;
            color: #666;
        }

        /* ChatGPT 椋庢牸锛氬け璐?涓柇浠呰鏉″簳閮ㄤ竴琛岀伆瀛楋紝涓嶅脊绐?*/
        .interrupted-badge {
            color: #666;
            font-size: 13px;
            margin-left: 0;
        }
        .retry-stream-btn {
            margin-left: 8px;
            padding: 2px 10px;
            font-size: 13px;
            border: 1px solid #999;
            border-radius: 4px;
            background: transparent;
            color: #333;
            cursor: pointer;
        }
        .retry-stream-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .message-folded {
            display: none;
        }

        .load-more-placeholder {
            padding: 12px;
            text-align: center;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .messages-container::-webkit-scrollbar {
            width: 4px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
        }

        /* GPT 椋庢牸锛氬洖鍒板簳閮ㄥ眳涓渾褰㈢澶达紙鐢熸垚涓笖鐢ㄦ埛绂诲紑搴曢儴鏃舵樉绀猴級 */
        .scroll-to-bottom-btn {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 88px;
            width: 44px;
            height: 44px;
            min-width: 44px;
            min-height: 44px;
            border-radius: 999px;
            background: #fff;
            border: 1px solid #e5e5e5;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            color: #111;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 80;
            cursor: pointer;
        }
        .scroll-to-bottom-btn svg {
            width: 24px;
            height: 24px;
        }

        /* D. VoicePanel锛堣创搴曠洊浣忓姞鍙?楹﹀厠椋庯紱闆捐挋钂欐瘺鐜荤拑 + 绮捐嚧鎰燂紱鏈墦寮€鏃跺畬鍏ㄤ笉鍙锛?*/
        .voice-panel {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ffffff !important;
            -webkit-backdrop-filter: none;
            backdrop-filter: none;
            border-radius: 20px 20px 0 0;
            border-top: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.06);
            padding: 16px 16px 20px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
            transition: none !important;
            z-index: 9999 !important;
            min-height: 200px;
            max-height: 320px;
        }
        .voice-panel.open {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
            touch-action: none;
        }
        .voice-panel.cancel-armed {
            background: #ffffff !important;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.06);
        }
        .voice-drag-bar {
            visibility: hidden;
            width: 36px;
            height: 4px;
            margin: 0 auto 16px;
        }
        .voice-hint {
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            min-height: 40px;
        }
        .input-area-with-hint {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 3px 8px 3px 14px;
            background: #FFFFFF;
            border: 1px solid var(--border);
            border-radius: var(--input-radius);
            transition: border-color var(--transition-fast);
        }
        .input-area-with-hint:focus-within {
            border-color: var(--border);
        }
        .input-area-inner {
            flex: 1;
            min-width: 0;
            position: relative;
        }
        .text-placeholder {
            position: absolute;
            left: 4px;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            color: var(--placeholder);
            font-size: 16px;
            font-weight: 400;
            line-height: 22px;
            text-align: left;
            pointer-events: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: none;
        }
        .voice-input-hint {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: #333333;
            letter-spacing: 0.2em;
            pointer-events: none;
            display: none;
        }
        .input-container.voice-mode .voice-input-hint {
            display: block;
        }
        /* 璇煶闈㈡澘鎵撳紑鏃讹細绂佹椤甸潰婊氬姩锛屼繚璇佷笂婊戝彇娑堟墜鍔跨ǔ瀹?*/
        body.voice-panel-open {
            overflow-y: hidden;
        }
        body.voice-panel-open .voice-input-hint {
            display: none !important;
        }
        /* 璇煶妯″紡涓嬶紝杈撳叆妗嗗唴鎸変綇鍖哄煙锛堢偣/鎸変綇姝ゅ鎵嶅綍闊筹紝楹﹀厠椋庨敭鍙仛鍒囨崲锛?*/
        .voice-hold-overlay {
            display: none;
            position: absolute;
            inset: 0;
            z-index: 2;
            cursor: pointer;
            touch-action: none;
        }
        .input-container.voice-mode .voice-hold-overlay {
            display: block;
        }
        .voice-waveform-wrap {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 56px;
            height: 56px;
            margin-bottom: 16px;
        }
        .voice-waveform {
            display: block;
            width: 100%;
            max-width: 280px;
            height: 48px;
            background: transparent;
        }
        /* 褰曢煶鐢辨寜浣忚緭鍏ユ瑙﹀彂锛岄潰鏉垮唴涓嶅啀鏄剧ず楹﹀厠椋庢寜閽紙楹﹀厠椋庨敭浠呬綔璇煶/閿洏鍒囨崲锛?*/
        .voice-panel .voice-mic-btn {
            display: none;
        }
        .voice-mic-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid var(--green);
            background: var(--bg);
            color: var(--green);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            cursor: pointer;
            transition: background var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast);
            -webkit-user-select: none;
            user-select: none;
        }
        .voice-mic-btn.recording {
            background: var(--green);
            color: #fff;
            border-color: var(--green);
        }
        .voice-mic-btn.cancel-armed {
            background: var(--danger);
            color: #fff;
            border-color: var(--danger);
        }
        .voice-mic-btn svg {
            width: 36px;
            height: 36px;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        /* E. + 闈㈡澘 BottomSheet锛坺-index 楂樹簬 input-container:100锛岀‘淇濆脊鍑哄湪杈撳叆鏍忎笂鏂癸級 */
        .plus-sheet-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-sheet), visibility var(--transition-sheet);
            z-index: 101;
        }
        .plus-sheet-backdrop.open {
            opacity: 1;
            visibility: visible;
        }
        /* 鏈墦寮€鏃跺畬鍏ㄤ笉鍙銆佷笉鍗犺绾匡紝閬垮厤鍒锋柊鍚庡簳閮ㄤ竴鐩寸湅鍒版柟妗?*/
        .plus-sheet {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            min-height: 280px;
            background: var(--bg);
            border-radius: 18px 18px 0 0;
            padding: 8px 20px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
            transition: transform var(--transition-sheet), opacity var(--transition-sheet);
            z-index: 102;
        }
        .plus-sheet.open {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        .plus-sheet-status {
            padding: 12px 14px 10px;
            font-size: 13px;
            color: rgba(0,0,0,.65);
            border-bottom: 1px solid rgba(0,0,0,.06);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .plus-sheet-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px 88px;
        }
        .plus-sheet-item {
            height: 76px;
            min-height: 48px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 6px;
            padding: 10px 12px;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.06);
            background: rgba(255,255,255,0.86);
            border-radius: 16px;
            box-shadow: none;
            font-size: 16px;
            color: var(--text);
            text-align: center;
            transition: background var(--transition-fast);
        }
        .plus-sheet-item:hover {
            background: rgba(255,255,255,0.96);
        }
        .plus-sheet-item:active {
            background: rgba(255,255,255,0.82);
        }
        .plus-sheet-item svg {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            stroke: var(--text);
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        /* + 闈㈡澘锛氬綋鍓嶄細鍛樻。浣嶆潯锛堥粦鐧藉共鍑€锛?*/
        .plus-sheet-tier {
            margin-top: 14px;
            padding: 13px 14px;
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,0.06);
            background: rgba(255,255,255,0.86);
            box-shadow: none;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            cursor: pointer;
            user-select: none;
        }
        .plus-sheet-tier:active {
            background: rgba(255,255,255,0.82);
        }
        .plus-sheet-tier:hover {
            background: rgba(255,255,255,0.96);
        }
        .plus-sheet-tier .tier-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }
        .plus-sheet-tier .tier-name {
            font-size: 16px;
            font-weight: 600;
            color: rgba(0,0,0,0.88);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .plus-sheet-tier .tier-sub {
            font-size: 13px;
            color: rgba(0,0,0,0.58);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .plus-sheet-tier .tier-right { display: none; }
        /* ===== + 闈㈡澘锛欸PT 椋庢牸瀹氱増 ===== */
        #plusSheet {
            will-change: transform, opacity;
            opacity: 0;
            transform: translateY(18px);
            transition: transform .18s ease-out, opacity .18s ease-out;
        }
        #plusSheet.open {
            opacity: 1;
            transform: translateY(0);
        }
        .plus-sheet-content {
            padding: 14px 14px 18px;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
        }
        .plus-sheet-content {
            padding-top: 12px;
        }
        .plus-sheet-status {
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(0,0,0,.03);
            color: rgba(0,0,0,.68);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 12px;
        }
        #plusSheetStatus.plus-sheet-status {
            margin-top: 10px;
            padding: 8px 12px;
            font-size: 12px;
            color: rgba(0,0,0,.55);
            background: rgba(0,0,0,.03);
            border-radius: 12px;
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0;
        }
        .plus-sheet-grid {
            margin-top: 0 !important;
            margin-bottom: 0;
        }
        .plus-sheet-content {
            padding-top: 6px !important;
        }
        .plus-sheet-item {
            height: 76px;
            border-radius: 16px;
            font-weight: 700;
            font-size: 14px;
        }
        .plus-sheet-tier {
            margin-top: 0;
        }
        /* + 闈㈡澘锛氫細鍛樹腑蹇冨崱鐗囷紙鐪熷疄 DOM锛屼袱琛屾枃妗堬級 */
        #tier-card { margin-top: 42px; }
        #tier-card .tier-left {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        #tier-card .tier-title {
            font-size: 16px;
            font-weight: 600;
            color: rgba(0,0,0,0.88);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #tier-card .tier-tierline {
            font-size: 13px;
            color: rgba(0,0,0,0.58);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #tier-card .tier-tiername {
            font-weight: 700;
            color: inherit;
        }
        #tier-card .tier-row-sub {
            margin-top: 4px;
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
            font-size: 13px;
            color: rgba(0,0,0,0.58);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* 棰濆害鐢ㄥ敖锛氱伆鎸夐挳锛堝彲鐐瑰嚮浠ユ彁绀轰竴娆★級 */
        .disabled, button:disabled {
            opacity: .38;
            cursor: not-allowed;
            pointer-events: auto;
        }

        /* ===== 浼氬憳涓績锛氭敹绱х┖鐧?+ 鍙栨秷 flex 鍧囧垎鎾戦珮锛堟渶缁堢増瑕嗙洊锛?===== */
        #membership-modal-backdrop {
            overflow: hidden !important;
        }
        #membership-modal {
            height: auto !important;
            max-height: min(720px, calc(100vh - 24px)) !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            padding: 14px !important;
        }
        #membership-modal::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        #membership-modal .membership-cards,
        #membership-modal .cards-list,
        #membership-modal .modal-body {
            flex: 0 0 auto !important;
            overflow: visible !important;
            height: auto !important;
            max-height: none !important;
        }
        #membership-modal .membership-cards {
            flex: 0 0 auto !important;
            min-height: auto !important;
            padding-top: 8px !important;
            gap: 10px !important;
        }
        #membership-modal .membership-card {
            flex: 0 0 auto !important;
            min-height: auto !important;
            padding: 12px !important;
            gap: 6px !important;
            margin-bottom: 10px !important;
        }
        #membership-modal .membership-header {
            padding: 2px 2px 8px !important;
        }
        #membership-modal .membership-sub {
            padding: 6px 2px 8px !important;
            font-size: 12.5px !important;
            line-height: 1.35 !important;
        }
        #membership-modal .card-desc {
            line-height: 1.35 !important;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        #membership-modal .card-btn {
            height: 42px !important;
            margin-top: 8px !important;
            border-radius: 12px !important;
        }

        /* P0锛氫細鍛樹腑蹇冪┖鐧藉啀鏀剁揣涓€鐐癸紙鍙姩闂磋窛/鍐呰竟璺濓紝涓嶆敼缁撴瀯锛?*/
        #membership-modal {
            padding: 12px !important;
            height: min(680px, calc(100vh - 32px)) !important;
            max-height: calc(100vh - 24px) !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        #membership-modal .membership-header {
            padding: 0 2px 6px !important;
        }
        #membership-modal .membership-sub {
            margin: 4px 0 6px !important;
            padding: 0 2px !important;
        }
        #membership-modal .membership-cards {
            padding-top: 6px !important;
            gap: 8px !important;
        }
        #membership-modal .membership-card {
            padding: 10px !important;
            gap: 4px !important;
            margin-bottom: 8px !important;
        }
        #membership-modal .card-btn {
            height: 40px !important;
            margin-top: 6px !important;
        }

    </style>
</head>
<body>
    <div class="app-shell" id="app">
    <header class="app-bar">
        <button type="button" class="app-bar-left" id="appBarLeft" aria-label="鑿滃崟">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="14" y2="15"/></svg>
        </button>
        <span class="app-bar-title-wrap"><span class="app-bar-title">鍐滄妧鍗冮棶</span></span>
    </header>

    <!-- 鏍囧噯渚ц竟鎶藉眽锛氫富鍐呭浠嶅湪锛屾娊灞?#drawer + 閬僵 #drawer-mask -->
    <div id="drawer-mask" aria-hidden="true"></div>
    <div id="drawer" aria-hidden="true">
        <div class="drawer-content">
            <div class="menu-card" data-menu="account-manage"><span>璐﹀彿绠＄悊</span><span class="menu-card-right" id="drawerAccountText">鏈櫥褰?/span><span class="menu-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></span></div>
            <div class="menu-card" data-menu="membership"><span>浼氬憳涓績</span><span class="menu-card-right" id="drawerTierText">褰撳墠锛?</span><span class="menu-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></span></div>
            <div class="menu-card" data-menu="help"><span>甯姪涓庡弽棣?/span><span class="menu-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></span></div>
            <div class="menu-card" data-menu="privacy"><span>闅愮鏀跨瓥</span><span class="menu-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></span></div>
            <div class="menu-card" data-menu="terms"><span>鐢ㄦ埛鍗忚</span><span class="menu-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></span></div>
            <div class="menu-card" data-menu="about"><span>鍏充簬</span><span class="menu-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></span></div>
        </div>
        <div class="drawer-footer">
            <div class="menu-card menu-card-danger drawer-logout" id="drawerLogoutBtn" data-menu="logout"><span>鐧诲綍</span></div>
            <div class="drawer-version">v1.0.0</div>
        </div>
    </div>

    <!-- 浼氬憳涓績锛氫竴灞忓彲瑙侊紙榛樿鏃犲唴閮ㄦ粴鍔ㄦ潯锛?-->
    <div id="membership-modal-backdrop" aria-hidden="true">
        <div id="membership-modal" onclick="event.stopPropagation()">
            <div class="membership-header">
                <div class="membership-title">浼氬憳涓績</div>
                <button class="membership-close" type="button" data-close-membership aria-label="鍏抽棴">鉁?/button>
            </div>
            <div class="membership-sub" id="membershipSub"></div>
            <div class="membership-cards">
                <div class="membership-card" data-tier="plus">
                    <div class="card-top">
                        <div class="card-name">Plus</div>
                        <div class="card-price">楼19.9/鏈?/div>
                    </div>
                    <div class="card-desc">30 娆″璇?澶?<span class="dot">鈥?/span> 5 娆″浘鐗囦笂浼?澶╋紙Flash锛?/div>
                    <div class="card-desc">閫傚悎锛氭棩甯搁棶绛斻€佽交閲忓挩璇€侀殢鎵嬫媿鍥捐瘑鍒?/div>
                    <button type="button" class="card-btn" data-tier="plus">寮€閫?Plus</button>
                </div>
                <div class="membership-card" data-tier="pro">
                    <div class="card-badge">鎺ㄨ崘</div>
                    <div class="card-top">
                        <div class="card-name">Pro</div>
                        <div class="card-price">楼29.9/鏈?/div>
                    </div>
                    <div class="card-desc">60 娆″璇?澶?<span class="dot">鈥?/span> 10 娆″浘鐗囦笂浼?澶╋紙Flash锛?/div>
                    <div class="card-desc">閫傚悎锛氶珮棰戜娇鐢ㄣ€侀搴︽洿绋炽€佹洿澶氬浘鐗囪瘖鏂?/div>
                    <button type="button" class="card-btn" data-tier="pro">寮€閫?Pro</button>
                </div>
                <div class="membership-card" data-tier="expert">
                    <div class="card-badge">鎺ㄧ悊/鍥剧墖鏇村己</div>
                    <div class="card-top">
                        <div class="card-name">涓撳妯″紡</div>
                        <div class="card-price">楼99/鏈?/div>
                    </div>
                    <div class="card-desc">80 娆″璇?澶?<span class="dot">鈥?/span> 20 娆″浘鐗囦笂浼?澶╋紙MAX锛?/div>
                    <div class="card-desc">閫傚悎锛氬鏉傞棶棰樸€佸鍥剧患鍚堝垽鏂€佹帹鐞嗘洿寮?/div>
                    <button type="button" class="card-btn" data-tier="expert">寮€閫?涓撳妯″紡</button>
                </div>
            </div>
            <div class="membership-footnote">娉細1 娆″浘鐗囦笂浼犳渶澶?4 寮犲浘锛堢郴缁熼粯璁や腑绛夊帇缂╋紝涓嶉檺鍒剁敤鎴锋枃浠跺ぇ灏忥級銆?/div>
        </div>
    </div>
    <div id="toast">鍔熻兘寮€鍙戜腑</div>

    <main class="main">
        <div class="messages-wrapper" id="messagesWrapper">
            <div class="empty-state" id="emptyState">
                <div class="logo"></div>
                <p class="empty-state-hint">
                    娆㈣繋鍜ㄨ绉嶆銆佺梾铏闃叉不銆佹柦鑲ョ瓑闂銆?br>
                    鎻忚堪浣滅墿/鍦板尯/鐜拌薄锛屽繀瑕佹椂鍙笂浼犵収鐗囥€?
                </p>
            </div>
            <div class="messages-container" id="messagesContainer"></div>
        </div>

        <div class="input-container" id="inputContainer">
            <div id="imagePreviewContainer" class="image-preview-container" style="display: none;"></div>
            <div class="input-wrapper">
                <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                <input type="file" id="cameraInput" class="camera-input" accept="image/*" capture="environment">
                <button type="button" class="add-button" id="addButton" title="鍥剧墖鎴栨媿鐓?>+</button>
                <div class="input-area-with-hint">
                    <div class="input-area-inner">
                        <div class="voice-input-hint" id="voiceInputHint">鎸変綇璇磋瘽</div>
                        <div class="text-placeholder" id="textPlaceholder"></div>
                        <textarea id="textInput" class="text-input" placeholder="" rows="1" maxlength="2000"></textarea>
                        <div class="voice-hold-overlay" id="voiceHoldOverlay" aria-label="鎸変綇璇磋瘽"></div>
                    </div>
                    <button type="button" class="btn-mic-or-keyboard" id="btnMicOrKeyboard" title="璇煶/閿洏">
                        <span class="icon-mic"><svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 1 3 3v8a3 3 0 0 1-6 0V4a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></span>
                        <span class="icon-keyboard" style="margin-top: -3px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.7" stroke-linecap="butt" stroke-linejoin="miter"><rect x="1.5" y="6" width="21" height="15" rx="1.2"/><rect x="5.62" y="8.62" width="0.85" height="0.85" rx="0" ry="0" fill="currentColor"/><rect x="11.62" y="8.62" width="0.85" height="0.85" rx="0" ry="0" fill="currentColor"/><rect x="17.62" y="8.62" width="0.85" height="0.85" rx="0" ry="0" fill="currentColor"/><rect x="5.62" y="12.62" width="0.85" height="0.85" rx="0" ry="0" fill="currentColor"/><rect x="11.62" y="12.62" width="0.85" height="0.85" rx="0" ry="0" fill="currentColor"/><rect x="17.62" y="12.62" width="0.85" height="0.85" rx="0" ry="0" fill="currentColor"/><rect x="5" y="16.25" width="14" height="1.5" rx="0" ry="0" fill="currentColor" stroke="none"/></svg></span>
                    </button>
                    <button type="button" class="btn-send btn-hidden" id="btnSend" title="鍙戦€?>
                        <svg viewBox="0 0 24 24"><path d="M12 20V3.2 M6.0 10.8L12 3.2 18.0 10.8"/></svg>
                    </button>
                    <button type="button" class="btn-stop btn-hidden" id="btnStop" title="鍋滄" aria-label="鍋滄">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                            <rect x="4" y="4" width="16" height="16" rx="0"></rect>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </main>
    <button type="button" id="scrollToBottomBtn" class="scroll-to-bottom-btn" aria-label="鍥炲埌搴曢儴" style="display: none;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M19 12l-7 7-7-7"/></svg></button>

    <div class="voice-panel" id="voicePanel">
        <div class="voice-drag-bar"></div>
        <p class="voice-hint" id="voiceHint">鎸変綇璇磋瘽</p>
        <div class="voice-waveform-wrap"><canvas class="voice-waveform" id="voiceWaveform" width="280" height="48"></canvas></div>
        <button type="button" class="voice-mic-btn" id="voiceMicBtn">
            <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 1 3 3v8a3 3 0 0 1-6 0V4a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
        </button>
    </div>

    <div class="plus-sheet-backdrop" id="plusSheetBackdrop"></div>
    <div class="plus-sheet" id="plusSheet">
        <div class="plus-sheet-content">
            <div class="plus-sheet-grid">
                <button type="button" class="plus-sheet-item" id="plusSheetGallery" data-action="upload">
                    <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                    鍥剧墖涓婁紶
                </button>
                <button type="button" class="plus-sheet-item" id="plusSheetCamera" data-action="camera">
                    <svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                    鎷嶇収
                </button>
            </div>
            <div class="plus-sheet-tier" id="tier-card" role="button" tabindex="0">
                <div class="tier-left">
                    <div class="tier-title" id="tier-name">浼氬憳涓績</div>
                    <div class="tier-tierline">褰撳墠鐢熸晥锛?strong class="tier-tiername" id="tier-tier">-</strong> 锝?鏌ョ湅濂楅涓庨搴?/div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div id="copyPopover" class="copy-popover" aria-hidden="true">
        <button id="copyBtn" type="button">澶嶅埗</button>
    </div>

    <div id="copySheetMask" class="copy-sheet-mask" aria-hidden="true"></div>
    <div id="copySheet" class="copy-sheet" aria-hidden="true">
        <div class="copy-sheet-handle"></div>
        <div class="copy-sheet-actions">
            <button id="copySheetCopyBtn" type="button">澶嶅埗鍏ㄦ枃</button>
            <button id="copySheetCloseBtn" type="button">鍏抽棴</button>
        </div>
        <div id="copySheetBody" class="copy-sheet-body"></div>
    </div>

    <script>
        const MAX_ROUNDS = 30;
        const MAX_MESSAGES = MAX_ROUNDS * 2;
        const messagesWrapper = document.getElementById('messagesWrapper');
        const messagesContainer = document.getElementById('messagesContainer');
        const emptyState = document.getElementById('emptyState');
        const textInput = document.getElementById('textInput');
        const textPlaceholder = document.getElementById('textPlaceholder');
        const addButton = document.getElementById('addButton');
        const fileInput = document.getElementById('fileInput');
        const cameraInput = document.getElementById('cameraInput');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const btnMicOrKeyboard = document.getElementById('btnMicOrKeyboard');
        const btnSend = document.getElementById('btnSend');
        const btnStop = document.getElementById('btnStop');
        const voicePanel = document.getElementById('voicePanel');
        const voiceHint = document.getElementById('voiceHint');
        const voiceMicBtn = document.getElementById('voiceMicBtn');
        const voiceWaveform = document.getElementById('voiceWaveform');
        const voiceHoldOverlay = document.getElementById('voiceHoldOverlay');
        const inputContainer = document.getElementById('inputContainer');
        const plusSheet = document.getElementById('plusSheet');
        const plusSheetBackdrop = document.getElementById('plusSheetBackdrop');
        const plusSheetGallery = document.getElementById('plusSheetGallery');
        const plusSheetCamera = document.getElementById('plusSheetCamera');
        const drawer = document.getElementById('drawer');
        const drawerMask = document.getElementById('drawer-mask');
        const appBarLeft = document.getElementById('appBarLeft');
        const copyPopover = document.getElementById('copyPopover');
        const copyBtn = document.getElementById('copyBtn');
        const copySheetMask = document.getElementById('copySheetMask');
        const copySheet = document.getElementById('copySheet');
        const copySheetBody = document.getElementById('copySheetBody');
        const copySheetCopyBtn = document.getElementById('copySheetCopyBtn');
        const copySheetCloseBtn = document.getElementById('copySheetCloseBtn');

        function closeDrawer() {
            drawer.classList.remove('open');
            drawerMask.classList.remove('show');
            drawer.setAttribute('aria-hidden', 'true');
            drawerMask.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }
        function openDrawer() {
            updateTierUIEverywhere();
            drawer.classList.add('open');
            drawerMask.classList.add('show');
            drawer.setAttribute('aria-hidden', 'false');
            drawerMask.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
            updateDrawerLoginState();
        }
        function toggleDrawer() {
            const open = drawer.classList.contains('open');
            open ? closeDrawer() : openDrawer();
        }
        closeDrawer();
        appBarLeft.addEventListener('click', toggleDrawer);
        drawerMask.addEventListener('click', closeDrawer);
        window.addEventListener('focus', function() { updateDrawerLoginState(); });
        window.addEventListener('pageshow', function() { updateDrawerLoginState(); });
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) updateDrawerLoginState();
        });

        var membershipBackdrop = document.getElementById('membership-modal-backdrop');
        var membershipModal = document.getElementById('membership-modal');
        var membershipCloseBtn = document.querySelector('[data-close-membership]');
        var toastEl = document.getElementById('toast');
        var HELP_FEEDBACK_URL = 'https://t0zamvo8k09.feishu.cn/share/base/form/shrcn9AWNObwhAUnHxVzldd9mwh';
        function openLocalPage(path) {
            if (/^https?:\/\//i.test(path)) {
                try {
                    if (window.AndroidInterface && typeof window.AndroidInterface.openUrl === 'function') {
                        window.AndroidInterface.openUrl(path);
                        return;
                    }
                } catch (e) {}
                try {
                    var popup = window.open(path, '_blank');
                    if (popup) return;
                } catch (e2) {}
                window.location.href = path;
                return;
            }
            window.location.href = path;
        }
        var ENABLE_ANON_LOGIN = true;
        try { localStorage.setItem('enable_anon_login', ENABLE_ANON_LOGIN ? '1' : '0'); } catch (e) {}
        function createAnonAccountId() {
            if (window.crypto && typeof window.crypto.randomUUID === 'function') {
                return 'anon_' + window.crypto.randomUUID();
            }
            return 'anon_' + Date.now() + '_' + Math.random().toString(36).slice(2, 10);
        }
        function getAccountId() {
            var val = localStorage.getItem('account_id');
            if (val && String(val).trim()) return String(val).trim();
            if (window.account_id && String(window.account_id).trim()) return String(window.account_id).trim();
            return '';
        }
        function getAccountType() {
            var t = localStorage.getItem('account_type');
            if (t && String(t).trim()) return String(t).trim();
            if (window.account_type && String(window.account_type).trim()) return String(window.account_type).trim();
            var accountId = getAccountId();
            if (!accountId) return '';
            return accountId.indexOf('anon_') === 0 ? 'anon' : 'phone';
        }
        function ensureAnonLogin() {
            if (!ENABLE_ANON_LOGIN) return false;
            if (getAccountId()) return false;
            var anonId = createAnonAccountId();
            localStorage.setItem('account_id', anonId);
            localStorage.setItem('account_type', 'anon');
            window.account_id = anonId;
            window.account_type = 'anon';
            return true;
        }
        function performDrawerLogin() {
            if (isLoggedIn()) return;
            if (!ENABLE_ANON_LOGIN) return;
            ensureAnonLogin();
            showToast('\u767b\u5f55\u6210\u529f');
            updateDrawerLoginState();
            updateDrawerFromTierAndUsage();
        }
        function setPhoneLoginIdentity(phoneAccountId) {
            var nextId = (phoneAccountId == null ? '' : String(phoneAccountId).trim());
            if (!nextId) return false;
            var prevId = getAccountId();
            if (getAccountType() === 'anon' && prevId) {
                localStorage.setItem('merge_from_anon', prevId);
            }
            localStorage.setItem('account_id', nextId);
            localStorage.setItem('account_type', 'phone');
            window.account_id = nextId;
            window.account_type = 'phone';
            updateDrawerLoginState();
            return true;
        }
        function getIdentityReservedParams() {
            return {
                account_id: getAccountId() || '',
                account_type: getAccountType() || '',
                merge_from_anon: localStorage.getItem('merge_from_anon') || ''
            };
        }
        function getMaskedAccountText() {
            if (getAccountType() === 'anon') return '\u533f\u540d';
            var account = getAccountId();
            var digits = account.replace(/\D/g, '');
            if (digits.length >= 7) return digits.slice(0, 3) + '****' + digits.slice(-2);
            return '\u5df2\u767b\u5f55';
        }
        function isLoggedIn() {
            return !!getAccountId();
        }
        function performDrawerLogout() {
            if (!isLoggedIn()) return;
            var now = Date.now();
            if (!window.__logoutConfirmUntil || now > window.__logoutConfirmUntil) {
                window.__logoutConfirmUntil = now + 2000;
                showToast('\u518d\u70b9\u4e00\u6b21\u786e\u8ba4');
                return;
            }
            window.__logoutConfirmUntil = 0;
            localStorage.removeItem('account_id');
            localStorage.removeItem('account_type');
            localStorage.removeItem('debug_tier');
            window.account_id = '';
            window.account_type = '';
            showToast('\u5df2\u9000\u51fa\u767b\u5f55');
            updateDrawerLoginState();
            updateDrawerFromTierAndUsage();
        }
        function updateDrawerLoginState() {
            var loggedIn = isLoggedIn();
            var accountText = document.getElementById('drawerAccountText');
            if (accountText) accountText.textContent = loggedIn ? getMaskedAccountText() : '\u672a\u767b\u5f55';
            var logoutBtn = document.getElementById('drawerLogoutBtn');
            if (logoutBtn) logoutBtn.classList.remove('is-hidden');
            if (logoutBtn) {
                var textEl = logoutBtn.querySelector('span');
                if (textEl) textEl.textContent = loggedIn ? '\u9000\u51fa\u767b\u5f55' : '\u767b\u5f55';
            }
        }
        window.__drawerLogin = performDrawerLogin;
        window.__drawerLogout = performDrawerLogout;
        window.__refreshDrawerLoginState = updateDrawerLoginState;
        window.__ensureAnonLogin = ensureAnonLogin;
        window.__setPhoneLoginIdentity = setPhoneLoginIdentity;
        window.__getIdentityReservedParams = getIdentityReservedParams;

        // ==================== 寮€鍏筹細浠呭垏鎹?Data 灞傛潵婧愶紝UI 涓嶆敼 ====================
        var USE_BACKEND_AB = false;           // 瀹為檯鐢熸晥鍦?Android BuildConfig.USE_BACKEND_AB锛涙澶勪粎鏂囨。
        var USE_BACKEND_ENTITLEMENT = false; // true 鏃堕搴?灞曠ず鍙鍚庣 GET /api/entitlement

        // ==================== Data 灞傦細瀛樺偍 + 鍚庣 HTTP锛堜笉鐩存帴缁?UI锛岀粡 Domain锛?====================
        var STORAGE_KEY_TIER = 'membership_tier';
        var STORAGE_KEY_SUBSCRIPTIONS = 'membership_subscriptions';
        var SUBSCRIPTION_DAYS = 30;
        function getSubscriptions() {
            try {
                var raw = localStorage.getItem(STORAGE_KEY_SUBSCRIPTIONS);
                if (raw) {
                    var arr = JSON.parse(raw);
                    return Array.isArray(arr) ? arr : [];
                }
            } catch (e) {}
            return [];
        }
        function saveSubscriptions(arr) {
            localStorage.setItem(STORAGE_KEY_SUBSCRIPTIONS, JSON.stringify(arr));
        }
        function getEntitlementFromBackend(cb) {
            if (!USE_BACKEND_ENTITLEMENT || typeof cb !== 'function') return;
            if (!window.AndroidInterface || typeof window.AndroidInterface.getEntitlement !== 'function') { cb(null); return; }
            window._entitlementCallback = window._entitlementCallback || {};
            var id = 'ent_' + Date.now();
            window._entitlementCallback[id] = function(ent) {
                if (ent) window._cachedEntitlement = ent;
                cb(ent);
            };
            window.AndroidInterface.getEntitlement(id);
        }
        function getTodayKey() {
            var d = new Date();
            return 'usage_' + d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        }
        function getUsage() {
            var key = getTodayKey();
            try {
                var raw = localStorage.getItem(key);
                if (raw) {
                    var o = JSON.parse(raw);
                    return { chat: (o.chat || 0) | 0, img: (o.img || 0) | 0 };
                }
            } catch (e) {}
            return { chat: 0, img: 0 };
        }
        function setUsage(chat, img) {
            var key = getTodayKey();
            localStorage.setItem(key, JSON.stringify({ chat: chat, img: img }));
        }

        // ==================== Domain 灞傦細浼氬憳瑁佸喅銆佹墸鍑忓彛寰勩€佽緭鍏ヨ鍒欙紙鍙皟 Data锛屼笉鐩存帴鏀?DOM锛?====================
        var TIER_ORDER = { free: 0, plus: 1, pro: 2, expert: 3 };
        var tier_config = {
            free:   { label: '鍏嶈垂鐗?, chatPerDay: 10, imgPerDay: 1,  model: 'flash' },
            plus:   { label: 'Plus',   chatPerDay: 30, imgPerDay: 5,  model: 'flash' },
            pro:    { label: 'Pro',    chatPerDay: 60, imgPerDay: 10, model: 'flash' },
            expert: { label: '涓撳妯″紡', chatPerDay: 80, imgPerDay: 20, model: 'plus' }
        };
        var COPY_REFRESH_FAIL = '鏉冪泭鐘舵€佹殏鏈洿鏂帮紝璇风◢鍚庨噸璇?;
        function getTierLevel(tier) { return TIER_ORDER[tier] != null ? TIER_ORDER[tier] : -1; }
        // 鐘舵€佹満 (a)(b)(c)锛涗粎璇?Data 灞?getSubscriptions/saveSubscriptions
        function computeEntitlement() {
            var now = Date.now();
            var list = getSubscriptions();
            for (var i = 0; i < list.length; i++) {
                var s = list[i];
                if (s.status !== 'active' && s.status !== 'paused') continue;
                var endMs = s.end_at || 0;
                if (s.status === 'active' && endMs <= now) {
                    s.status = 'expired';
                    var pausedSubs = list.filter(function(x) { return x.status === 'paused' && (x.remaining_seconds > 0 || (x.end_at && x.end_at > now)); });
                    var best = null;
                    for (var j = 0; j < pausedSubs.length; j++) {
                        if (!best || getTierLevel(pausedSubs[j].tier) > getTierLevel(best.tier)) best = pausedSubs[j];
                    }
                    if (best) {
                        best.status = 'active';
                        best.resume_at = now;
                        best.end_at = now + (best.remaining_seconds || 0) * 1000;
                        best.remaining_seconds = 0;
                    }
                }
            }
            var activeList = list.filter(function(s) { return s.status === 'active' && s.end_at > now; });
            var effective = null;
            for (var i = 0; i < activeList.length; i++) {
                if (!effective || getTierLevel(activeList[i].tier) > getTierLevel(effective.tier)) effective = activeList[i];
            }
            for (var i = 0; i < list.length; i++) {
                var s = list[i];
                if (s.status !== 'active' && s.status !== 'paused') continue;
                if (effective && getTierLevel(s.tier) < getTierLevel(effective.tier)) {
                    if (s.status !== 'paused') {
                        s.status = 'paused';
                        s.pause_at = now;
                        s.remaining_seconds = Math.max(0, Math.floor((s.end_at - now) / 1000));
                    }
                }
            }
            var pausedList = list.filter(function(s) { return s.status === 'paused'; });
            var effectiveTier = effective ? effective.tier : 'free';
            var effectiveEndAt = effective ? effective.end_at : 0;
            var pausedForShow = pausedList.map(function(p) {
                var sec = p.remaining_seconds != null ? p.remaining_seconds : Math.max(0, Math.floor((p.end_at - now) / 1000));
                return { tier: p.tier, remaining_days: Math.ceil(sec / 86400) };
            });
            saveSubscriptions(list);
            var out = { effective_tier: effectiveTier, effective_end_at: effectiveEndAt, paused_list: pausedForShow };
            if (typeof console !== 'undefined' && console.log) console.log('[ENT] entitlement:', JSON.stringify(out));
            return out;
        }
        function resetUsageIfNewDay() {
            var key = getTodayKey();
            var stored = localStorage.getItem('usage_date');
            if (stored !== key) {
                localStorage.setItem('usage_date', key);
                setUsage(0, 0);
                if (typeof refreshQuotaUI === 'function') refreshQuotaUI();
            }
        }
        function migrateLegacyToSubscriptions() {
            var list = getSubscriptions();
            if (list.length > 0) return;
            var tier = (localStorage.getItem(STORAGE_KEY_TIER) || 'free').toLowerCase();
            var exp = Number(localStorage.getItem('membership_expire_at') || 0);
            if (tier !== 'free' && tier_config[tier] && exp > Date.now()) {
                var now = Date.now();
                list.push({ user_id: 'local_user', tier: tier, start_at: exp - SUBSCRIPTION_DAYS * 86400000, end_at: exp, status: 'active', order_id: 'legacy_1', created_at: now });
                saveSubscriptions(list);
            }
        }
        function getCurrentTier() {
            if (getAccountType() === 'anon') {
                var debugTier = (localStorage.getItem('debug_tier') || '').toLowerCase();
                if (tier_config[debugTier]) return debugTier;
            }
            if (USE_BACKEND_ENTITLEMENT) {
                if (window._cachedEntitlement) {
                    var t = window._cachedEntitlement.effective_tier;
                    return tier_config[t] ? t : 'free';
                }
                return 'free'; // 鍚庣涓嶅彲鐢ㄦ椂涓嶅洖閫€鏈湴锛屼笉姹℃煋浼氬憳鐘舵€侊紝閬垮厤涓ゅ鐪熺浉鎵撴灦
            }
            migrateLegacyToSubscriptions();
            var list = getSubscriptions();
            if (list.length === 0) {
                var t = (localStorage.getItem(STORAGE_KEY_TIER) || 'free').toLowerCase();
                return tier_config[t] ? t : 'free';
            }
            var ent = computeEntitlement();
            return tier_config[ent.effective_tier] ? ent.effective_tier : 'free';
        }
        function getMembership() {
            if (getAccountType() === 'anon') {
                var debugTier = (localStorage.getItem('debug_tier') || '').toLowerCase();
                var tier = tier_config[debugTier] ? debugTier : 'free';
                return { tier: tier, exp: 0, paused: [] };
            }
            if (USE_BACKEND_ENTITLEMENT) {
                if (window._cachedEntitlement) {
                    var e = window._cachedEntitlement;
                    return { tier: e.effective_tier || 'free', exp: e.effective_end_at || 0, paused: e.paused_list || [] };
                }
                return { tier: 'free', exp: 0, paused: [] }; // 鍚庣涓嶅彲鐢ㄦ椂涓嶅洖閫€鏈湴
            }
            migrateLegacyToSubscriptions();
            var list = getSubscriptions();
            if (list.length === 0) {
                var tier = localStorage.getItem(STORAGE_KEY_TIER) || 'free';
                var exp = Number(localStorage.getItem('membership_expire_at') || 0);
                if (tier !== 'free' && exp && Date.now() > exp) {
                    localStorage.setItem(STORAGE_KEY_TIER, 'free');
                    localStorage.setItem('membership_expire_at', '0');
                    return { tier: 'free', exp: 0, paused: [] };
                }
                return { tier: tier, exp: exp, paused: [] };
            }
            var ent = computeEntitlement();
            localStorage.setItem(STORAGE_KEY_TIER, ent.effective_tier);
            localStorage.setItem('membership_expire_at', String(ent.effective_end_at));
            return { tier: ent.effective_tier, exp: ent.effective_end_at, paused: ent.paused_list };
        }
        function formatDate(ts) {
            if (!ts) return '';
            var d = new Date(ts);
            var y = d.getFullYear();
            var m = String(d.getMonth() + 1).padStart(2, '0');
            var da = String(d.getDate()).padStart(2, '0');
            return y + '-' + m + '-' + da;
        }
        function daysLeft(ts) {
            if (!ts) return 0;
            return Math.max(0, Math.ceil((ts - Date.now()) / 86400000));
        }
        // 骞傜瓑锛氬悓涓€ order_id 鍙厑璁稿啓涓€娆¤闃呭彉鏇?
        function hasOrderId(orderId) {
            var list = getSubscriptions();
            for (var i = 0; i < list.length; i++) if (list[i].order_id === orderId) return true;
            return false;
        }
        function applyPurchase(orderId, tier) {
            if (!tier_config[tier] || tier === 'free') return;
            if (hasOrderId(orderId)) return;
            var list = getSubscriptions();
            var now = Date.now();
            var effectiveTier = (computeEntitlement()).effective_tier;
            var effectiveLevel = getTierLevel(effectiveTier);
            var reqLevel = getTierLevel(tier);
            if (reqLevel < effectiveLevel) return;
            if (reqLevel === effectiveLevel) {
                for (var i = 0; i < list.length; i++) {
                    if (list[i].status === 'active' && list[i].tier === tier && list[i].end_at > now) {
                        list[i].end_at += SUBSCRIPTION_DAYS * 86400000;
                        saveSubscriptions(list);
                        computeEntitlement();
                        if (typeof updateDrawerFromTierAndUsage === 'function') updateDrawerFromTierAndUsage();
                        if (typeof updateMembershipUI === 'function') updateMembershipUI();
                        return;
                    }
                }
            }
            var newSub = { user_id: 'local_user', tier: tier, start_at: now, end_at: now + SUBSCRIPTION_DAYS * 86400000, status: 'active', order_id: orderId, created_at: now };
            list.push(newSub);
            saveSubscriptions(list);
            var ent = computeEntitlement();
            localStorage.setItem(STORAGE_KEY_TIER, ent.effective_tier);
            localStorage.setItem('membership_expire_at', String(ent.effective_end_at));
            if (typeof updateDrawerFromTierAndUsage === 'function') updateDrawerFromTierAndUsage();
            if (typeof updateMembershipUI === 'function') updateMembershipUI();
        }
        function setCurrentTier(tier) {
            if (!tier_config[tier]) return;
            if (getAccountType() === 'anon') {
                localStorage.setItem('debug_tier', tier);
                if (typeof updateDrawerFromTierAndUsage === 'function') updateDrawerFromTierAndUsage();
                if (typeof updateMembershipUI === 'function') updateMembershipUI();
                return;
            }
            if (tier === 'free') {
                localStorage.setItem(STORAGE_KEY_TIER, 'free');
                localStorage.setItem('membership_expire_at', '0');
                if (typeof updateDrawerFromTierAndUsage === 'function') updateDrawerFromTierAndUsage();
                if (typeof updateMembershipUI === 'function') updateMembershipUI();
                return;
            }
            var orderId = 'local_' + Date.now();
            applyPurchase(orderId, tier);
        }
        function getQuota() {
            var c = tier_config[getCurrentTier()];
            return c ? { chat: c.chatPerDay, img: c.imgPerDay } : { chat: 10, img: 1 };
        }
        function checkQuotaBeforeSend(chatNeed, imgNeed) {
            resetUsageIfNewDay();
            var usage = getUsage();
            var quota = getQuota();
            var chatOk = (usage.chat + chatNeed) <= quota.chat;
            var imgOk = (usage.img + imgNeed) <= quota.img;
            return { allowed: chatOk && imgOk, chatOk: chatOk, imgOk: imgOk };
        }
        function incrementUsage(chatDelta, imgDelta) {
            resetUsageIfNewDay();
            var u = getUsage();
            setUsage(u.chat + (chatDelta || 0), u.img + (imgDelta || 0));
            updateDrawerFromTierAndUsage();
        }
        function getTierLabel(tier) {
            var map = { free: '鍏嶈垂鐗?, plus: 'Plus', pro: 'Pro', expert: '涓撳妯″紡' };
            return map[tier] || tier;
        }
        function getTierDrawerLabel(tier) {
            var map = { free: '鍏嶈垂', plus: 'Plus', pro: 'Pro', expert: '涓撳妯″紡' };
            return map[tier] || getTierLabel(tier);
        }
        function updateTierUIEverywhere() {
            var tier = getCurrentTier();
            var usage = getUsage();
            var quota = getQuota();
            var chatLeft = Math.max(0, quota.chat - usage.chat);
            var imgLeft = Math.max(0, quota.img - usage.img);
            var fullText = '褰撳墠鐢熸晥妗ｄ綅锛? + getTierLabel(tier) + ' 路 鏌ョ湅濂楅涓庨搴?;
            var labelOnly = '褰撳墠锛? + getTierDrawerLabel(tier);
            var drawerTierText = document.getElementById('drawerTierText');
            if (drawerTierText) drawerTierText.textContent = labelOnly;
        }
        function updateDrawerFromTierAndUsage() {
            resetUsageIfNewDay();
            updateTierUIEverywhere();
            updateDrawerLoginState();
        }
        // ==================== UI 灞傦細鍙礋璐ｆ覆鏌?鍔ㄧ敾/鐏板潡/缃伆/Toast锛屼笉鐩存帴鏀硅闃呫€佷笉鐩存帴鏀?A/B ====================
        function setDisabled(selector, disabled) {
            var el = document.querySelector(selector);
            if (!el) return;
            el.classList.toggle('disabled', disabled);
            el.setAttribute('aria-disabled', disabled ? 'true' : 'false');
        }
        function refreshQuotaUI() {
            resetUsageIfNewDay();
            var tier = getCurrentTier();
            var usage = getUsage();
            var quota = getQuota();
            var chatLeft = quota.chat - usage.chat;
            var imgLeft = quota.img - usage.img;
            var canChat = chatLeft > 0;
            var canImg = imgLeft > 0;
            setDisabled('#btnSend', !canChat);
            setDisabled('#btnMicOrKeyboard', !canChat);
            setDisabled('#plusSheetGallery', !canImg);
            setDisabled('#plusSheetCamera', !canImg);
            if (typeof updateDrawerFromTierAndUsage === 'function') updateDrawerFromTierAndUsage();
        }
        function showToastOncePerDay(key, msg) {
            var day = getTodayKey();
            var k = 'toast_once_' + day + '_' + key;
            if (localStorage.getItem(k) === '1') return;
            localStorage.setItem(k, '1');
            showToast(msg);
        }
        function updateMembershipUI() {
            var m = getMembership();
            var tier = m.tier;
            var exp = m.exp;
            var currentLevel = getTierLevel(tier);
            var sub = document.getElementById('membershipSub');
            if (sub) {
                var parts = [];
                if (tier === 'free') {
                    parts.push('褰撳墠鐢熸晥妗ｄ綅锛氬厤璐圭増');
                } else {
                    parts.push('褰撳墠鐢熸晥妗ｄ綅锛? + getTierLabel(tier) + '锛堜互鏈€楂樻。浣嶈锛?路 鍒版湡锛? + formatDate(exp) + '锛堝墿浣?' + daysLeft(exp) + ' 澶╋級');
                }
                var paused = (m.paused && m.paused.length) ? m.paused : [];
                for (var i = 0; i < paused.length; i++) {
                    parts.push('宸插喕缁擄細' + getTierLabel(paused[i].tier) + '锛堝墿浣? + (paused[i].remaining_days || 0) + '澶╋級');
                }
                sub.innerHTML = parts.join('<br>');
            }
            document.querySelectorAll('#membership-modal .membership-card').forEach(function(card) {
                var t = card.getAttribute('data-tier');
                var btn = card.querySelector('.card-btn');
                var hint = card.querySelector('.card-higher-hint');
                if (!btn) return;
                var cardLevel = getTierLevel(t);
                var isCurrent = (t === tier);
                var isHigherAlready = (currentLevel > cardLevel);
                btn.classList.remove('btn-current', 'btn-higher-disabled');
                if (hint) hint.style.display = 'none';
                if (isHigherAlready) {
                    btn.textContent = '宸插紑閫氭洿楂樻。浣?;
                    btn.disabled = false;
                    btn.classList.add('btn-higher-disabled');
                    if (!hint) {
                        hint = document.createElement('div');
                        hint.className = 'card-higher-hint';
                        card.appendChild(hint);
                    }
                    hint.textContent = '褰撳墠鏉冪泭宸插寘鍚?;
                    hint.style.display = 'block';
                } else if (isCurrent && tier !== 'free') {
                    btn.textContent = '褰撳墠宸插紑閫?;
                    btn.disabled = true;
                    btn.classList.add('btn-current');
                } else {
                    btn.disabled = false;
                    if (t === 'plus') btn.textContent = '寮€閫?Plus';
                    else if (t === 'pro') btn.textContent = '寮€閫?Pro';
                    else if (t === 'expert') btn.textContent = '寮€閫?涓撳妯″紡';
                }
            });
        }
        function openMembershipModal(highlightRecommended) {
            var cards = document.querySelectorAll('#membership-modal .membership-card');
            cards.forEach(function(el) {
                if (el.getAttribute('data-tier') === 'pro') el.classList.toggle('recommended-highlight', !!highlightRecommended);
                else el.classList.remove('recommended-highlight');
            });
            updateMembershipUI();
            membershipBackdrop.classList.add('open');
            membershipBackdrop.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }
        function closeMembershipModal() {
            membershipBackdrop.classList.remove('open');
            membershipBackdrop.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }
        function showToast(msg) {
            toastEl.textContent = msg != null ? msg : '鍔熻兘寮€鍙戜腑';
            toastEl.classList.add('show');
            setTimeout(function() {
                toastEl.classList.remove('show');
            }, 2000);
        }
        function getPlainTextFromMessage(msg) {
            if (!msg) return '';
            var content = msg.querySelector && msg.querySelector('.message-content');
            if (content && content.dataset.rawText !== undefined && content.dataset.rawText !== '') return content.dataset.rawText;
            if (msg.dataset && msg.dataset.rawText !== undefined && msg.dataset.rawText !== '') return msg.dataset.rawText;
            return content ? content.innerText : msg.innerText || '';
        }
        function copyText(text) {
            var t = (text != null ? text + '' : '').trim();
            if (!t) return;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(t).catch(function() {
                    if (typeof AndroidInterface !== 'undefined' && AndroidInterface.copyText) AndroidInterface.copyText(t);
                    else fallbackCopy(t);
                });
                return;
            }
            if (typeof AndroidInterface !== 'undefined' && AndroidInterface.copyText) { AndroidInterface.copyText(t); return; }
            fallbackCopy(t);
        }
        function fallbackCopy(text) {
            var ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed'; ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); } catch (e) {}
            document.body.removeChild(ta);
        }
        var copyPopoverCurrentMsg = null;
        var copyLongPressState = { timerId: null, startX: 0, startY: 0 };
        var COPY_LONG_PRESS_MS = 380;
        var COPY_MOVE_THRESHOLD = 8;
        function showCopyPopover(x, y, msgEl) {
            if (!copyPopover || !msgEl) return;
            copyPopoverCurrentMsg = msgEl;
            copyPopover.style.display = 'block';
            copyPopover.setAttribute('aria-hidden', 'false');
            var w = copyPopover.offsetWidth || 80;
            var h = copyPopover.offsetHeight || 44;
            var vw = window.innerWidth;
            var vh = window.innerHeight;
            var left = Math.max(8, Math.min(x - w / 2, vw - w - 8));
            var top = Math.max(8, Math.min(y - h - 12, vh - h - 8));
            copyPopover.style.left = left + 'px';
            copyPopover.style.top = top + 'px';
        }
        function hideCopyPopover() {
            if (copyPopover) {
                copyPopover.style.display = 'none';
                copyPopover.setAttribute('aria-hidden', 'true');
            }
            copyPopoverCurrentMsg = null;
        }
        function forceCloseCopyUI() {
            hideCopyPopover();
            closeCopySheet();
            clearCopyLongPress();
        }
        var copySheetCurrentMsg = null;
        var copySheetOpenedAt = 0;
        var copyUiScrollY = 0;
        function getRenderedHtmlFromMessage(msg) {
            if (!msg) return '';
            var content = msg.querySelector && msg.querySelector('.message-content');
            if (!content) return '';
            if (!content.classList || !content.classList.contains('md-rendered')) return '';
            return content.innerHTML || '';
        }
        function openCopySheet(msg) {
            if (!copySheet || !copySheetMask || !copySheetBody) return;
            copySheetOpenedAt = Date.now();
            document.body.classList.add('copy-ui-open');
            copyUiScrollY = window.scrollY || document.documentElement.scrollTop || 0;
            document.body.style.position = 'fixed';
            document.body.style.top = (-copyUiScrollY) + 'px';
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';
            var renderedHtml = getRenderedHtmlFromMessage(msg);
            if (renderedHtml) {
                copySheetBody.innerHTML =
                    '<div class="message-content md-rendered copy-sheet-rendered">' + renderedHtml + '</div>';
            } else {
                var text = getPlainTextFromMessage(msg);
                copySheetBody.textContent = text != null ? text : '';
            }
            copySheetCurrentMsg = msg || null;
            copySheetMask.classList.add('open');
            copySheet.classList.add('open');
            copySheetMask.setAttribute('aria-hidden', 'false');
            copySheet.setAttribute('aria-hidden', 'false');
        }
        function closeCopySheet() {
            if (!copySheet || !copySheetMask || !copySheetBody) return;
            copySheet.classList.remove('open');
            copySheetMask.classList.remove('open');
            copySheet.setAttribute('aria-hidden', 'true');
            copySheetMask.setAttribute('aria-hidden', 'true');
            copySheetBody.innerHTML = '';
            copySheetCurrentMsg = null;
            document.body.classList.remove('copy-ui-open');
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.right = '';
            document.body.style.width = '';
            window.scrollTo(0, copyUiScrollY || 0);
            copyUiScrollY = 0;
            clearCopyLongPress();
            copySheetOpenedAt = 0;
        }
        function clearCopyLongPress() {
            if (copyLongPressState.timerId) {
                clearTimeout(copyLongPressState.timerId);
                copyLongPressState.timerId = null;
            }
        }
        function onCopyLongPressStart(e) {
            if (e && e.target && e.target.closest && e.target.closest('#copySheet')) return;
            var content = e.target.closest && e.target.closest('.message-content');
            if (!content || !messagesContainer || !messagesContainer.contains(content)) return;
            var msg = content.closest('.message');
            if (!msg) return;
            var x = e.touches ? e.touches[0].clientX : e.clientX;
            var y = e.touches ? e.touches[0].clientY : e.clientY;
            clearCopyLongPress();
            copyLongPressState.startX = x;
            copyLongPressState.startY = y;
            copyLongPressState.timerId = setTimeout(function() {
                copyLongPressState.timerId = null;
                openCopySheet(msg);
            }, COPY_LONG_PRESS_MS);
        }
        function onCopyLongPressMove(e) {
            if (!copyLongPressState.timerId) return;
            var x = e.touches ? e.touches[0].clientX : e.clientX;
            var y = e.touches ? e.touches[0].clientY : e.clientY;
            var dx = x - copyLongPressState.startX;
            var dy = y - copyLongPressState.startY;
            if (Math.sqrt(dx * dx + dy * dy) > COPY_MOVE_THRESHOLD) clearCopyLongPress();
        }
        function onCopyLongPressEnd() { clearCopyLongPress(); }
        if (messagesContainer) {
            messagesContainer.addEventListener('touchstart', onCopyLongPressStart, { passive: true });
            messagesContainer.addEventListener('mousedown', onCopyLongPressStart);
        }
        document.addEventListener('touchmove', onCopyLongPressMove, { passive: true });
        document.addEventListener('mousemove', onCopyLongPressMove);
        document.addEventListener('touchend', onCopyLongPressEnd);
        document.addEventListener('mouseup', onCopyLongPressEnd);
        document.addEventListener('scroll', function() {
            if (copySheet && copySheet.classList.contains('open')) return;
            forceCloseCopyUI();
        }, true);
        if (copySheetMask) copySheetMask.addEventListener('click', closeCopySheet);
        if (copySheetCloseBtn) copySheetCloseBtn.addEventListener('click', closeCopySheet);
        function shouldIgnoreCloseByRecentlyOpened() {
            return copySheetOpenedAt && (Date.now() - copySheetOpenedAt < 250);
        }
        function isInsideCopyUI(t) {
            if (!t || !t.closest) return false;
            return !!(t.closest('#copySheet') || t.closest('#copySheetMask') || t.closest('#copyPopover'));
        }
        if (copySheetCopyBtn) {
            copySheetCopyBtn.addEventListener('click', function() {
                var txt = (copySheetBody && copySheetBody.textContent) ? copySheetBody.textContent : '';
                if (!txt && copySheetCurrentMsg) txt = getPlainTextFromMessage(copySheetCurrentMsg) || '';
                copyText(txt);
                showToast('宸插鍒?);
                closeCopySheet();
            });
        }
        document.addEventListener('touchstart', function(e) {
            var t = e && e.target;
            if (shouldIgnoreCloseByRecentlyOpened()) return;
            if (!isInsideCopyUI(t)) forceCloseCopyUI();
        }, true);
        document.addEventListener('click', function(e) {
            var t = e && e.target;
            if (shouldIgnoreCloseByRecentlyOpened()) return;
            if (!isInsideCopyUI(t)) forceCloseCopyUI();
        }, true);
        document.addEventListener('keydown', function(e) {
            if (e && (e.key === 'Escape' || e.keyCode === 27)) forceCloseCopyUI();
        }, true);
        if (copyBtn) {
            copyBtn.addEventListener('click', function() {
                var text = getPlainTextFromMessage(copyPopoverCurrentMsg);
                copyText(text);
                showToast('宸插鍒?);
                forceCloseCopyUI();
            });
        }
        if (membershipCloseBtn) {
            membershipCloseBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                closeMembershipModal();
            });
        }
        if (membershipModal) {
            membershipModal.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        if (membershipBackdrop) {
            membershipBackdrop.addEventListener('click', function(e) {
                if (e.target === membershipBackdrop) closeMembershipModal();
            });
        }
        document.querySelectorAll('#membership-modal .card-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var tier = this.getAttribute('data-tier');
                if (getAccountType() === 'anon') {
                    if (tier_config[tier]) {
                        setCurrentTier(tier);
                        closeMembershipModal();
                        showToast('\u5df2\u5207\u6362\u6863\u4f4d');
                    }
                    return;
                }
                if (!tier || !tier_config[tier]) {
                    showToast('鍔熻兘寮€鍙戜腑');
                    return;
                }
                var current = getCurrentTier();
                var currentLevel = getTierLevel(current);
                var cardLevel = getTierLevel(tier);
                if (cardLevel <= currentLevel && tier !== current) {
                    showToastOncePerDay('no_downgrade', '宸插紑閫氭洿楂樻。浣嶏紝鏃犻渶閲嶅璐拱');
                    return;
                }
                if (cardLevel <= currentLevel) return;
                setCurrentTier(tier);
                closeMembershipModal();
                showToast('宸插紑閫氾紝绔嬪嵆鐢熸晥');
            });
        });

        document.querySelectorAll('#drawer .menu-card').forEach(function(el) {
            el.addEventListener('click', function() {
                var key = this.getAttribute('data-menu') || 'unknown';
                if (key === 'membership') {
                    openMembershipModal(false);
                } else if (key === 'account-manage') {
                    // 账号管理二级入口预留；当前登录入口在抽屉底部主按钮
                } else if (key === 'help') {
                    openLocalPage(HELP_FEEDBACK_URL);
                } else if (key === 'privacy') {
                    openLocalPage('privacy.html');
                } else if (key === 'terms') {
                    openLocalPage('terms.html');
                } else if (key === 'about') {
                    openLocalPage('about.html');
                } else if (key === 'logout') {
                    if (isLoggedIn()) performDrawerLogout();
                    else performDrawerLogin();
                } else {
                    if (typeof DEBUG !== 'undefined' && DEBUG) console.log(key);
                }
            });
        });
        resetUsageIfNewDay();
        getMembership();
        updateDrawerFromTierAndUsage();
        refreshQuotaUI();
        if (USE_BACKEND_ENTITLEMENT && window.AndroidInterface && typeof window.AndroidInterface.getEntitlement === 'function') {
            getEntitlementFromBackend(function(ent) {
                if (ent && (typeof updateDrawerFromTierAndUsage === 'function')) updateDrawerFromTierAndUsage();
                if (ent && (typeof updateMembershipUI === 'function')) updateMembershipUI();
            });
        }

        document.addEventListener('click', function(e) {
            var sendBtn = document.getElementById('btnSend');
            var micBtn = document.getElementById('btnMicOrKeyboard');
            if (sendBtn && (e.target === sendBtn || sendBtn.contains(e.target))) {
                if (sendBtn.classList.contains('disabled') || sendBtn.getAttribute('aria-disabled') === 'true') {
                    e.preventDefault();
                    e.stopPropagation();
                    showToastOncePerDay('chat', '浠婃棩棰濆害宸茬敤瀹?);
                    return;
                }
                if (imageState.size > 0 && !textInput.value.trim()) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
            }
            if (micBtn && (e.target === micBtn || micBtn.contains(e.target))) {
                if (micBtn.classList.contains('disabled') || micBtn.getAttribute('aria-disabled') === 'true') {
                    e.preventDefault();
                    e.stopPropagation();
                    showToastOncePerDay('chat', '浠婃棩棰濆害宸茬敤瀹?);
                    return;
                }
            }
            var up = e.target.closest && e.target.closest('[data-action="upload"], [data-action="camera"]');
            if (up && (up.classList.contains('disabled') || up.getAttribute('aria-disabled') === 'true')) {
                e.preventDefault();
                e.stopPropagation();
                showToastOncePerDay('img', '浠婃棩棰濆害宸茬敤瀹?);
            }
        }, true);

        let isGenerating = false;
        let stickToBottom = true;
        const BOTTOM_THRESHOLD_PX = 120;
        function distanceToBottom(container) { return container.scrollHeight - (container.scrollTop + container.clientHeight); }
        function atBottom(container) { return distanceToBottom(container) <= BOTTOM_THRESHOLD_PX; }
        /** C. 4 鎬侊細idle | typing | generating | voicePanel */
        let inputMode = 'idle';
        let voiceRecording = false;
        let voiceCancelArmed = false;
        let voiceTouchStartY = 0;
        const VOICE_CANCEL_THRESHOLD_PX = 60;
        let waveformAnimId = null;
        let voicePendingTimeout = null;

        // 闀胯亰涓嶅崱椤匡細绐楀彛鍖?+ 鍓嶇鍋囨祦寮忥紙鎵撳瓧鏈猴級
        // 銆愪袱鏉＄嚎鍒嗙銆慠ENDER_WINDOW 涓虹函灞曠ず瑁佸壀锛屼笉鍙備笌 A/B 鎺ㄥ锛汚/B 鍙潵鑷悗绔媺鍙栨垨 onComplete/updateB 鍐欏叆
        const RENDER_WINDOW = 80;      // 浠呮覆鏌撴渶杩?N 鏉?
        const LOAD_MORE_BATCH = 20;    // 姣忔銆屽姞杞芥洿澶氥€嶅睍寮€鏉℃暟
        const TYPEWRITER_MS = 50;     // 鎵撳瓧鏈烘瘡鐗囬棿闅旓紙ms锛夛紝閬垮厤 DOM 棰戠箒閲嶆帓
        const TYPEWRITER_CHARS = 2;   // 姣忕墖杩藉姞瀛楃鏁?
        const TYPEWRITER_MAX_MS = 60000; // 鎵撳瓧鏈烘渶澶ф椂闀垮厹搴曪紙ms锛夛紝瓒呮椂鐩存帴琛ュ叏鍓╀綑
        const MAX_WAIT_MS = 65000;       // 鍏ㄥ眬 Watchdog锛氳 streamId 鏈湪 65s 鍐呮敹鍒?onComplete/onInterrupted 鍒欏己鍒朵腑鏂敹灏?
        const chunkBufferByStream = {};
        // streamId -> 璇?stream 褰撳墠绱鐨?buffer 鍏ㄦ枃锛堜笌 chunkBufferByStream 鍚屾锛夛紝渚?onComplete 鏃?buffer 涓虹┖闄嶇骇鐩村嚭锛涜涔夋槸銆屾渶鍚庝竴娆″彲瑙佺殑鍏ㄦ枃銆嶉潪銆屾渶鍚庝竴涓?chunk銆?
        const lastFullBufferByStream = {};
        const watchdogTimerByStream = {}; // streamId -> setTimeout id锛宱nComplete/onInterrupted 鏃?clear
        const terminatedStreamIds = {};   // 鎶ゆ爮锛歸atchdog 瑙﹀彂鍚庡姞鍏ワ紝onChunk/onComplete/onInterrupted 鍏ュ彛鑻ュ凡瀛樺湪鍒欑洿鎺?return
        const pendingDeduct = {};          // client_msg_id -> imgUploadCount(0|1)锛宱nComplete 鎵ｅ悗 delete
        const pendingRequest = {};         // streamId -> { text, imageUrls, clientMsgId }锛岄噸璇曞鐢ㄥ悓涓€ client_msg_id
        const clientMsgIdByStream = {};    // streamId -> client_msg_id锛孶I stream 涓庝笟鍔″箓绛夐敭瑙ｈ€?
        const assistantMsgByStream = {};   // streamId -> assistant message element锛屽噺灏戦珮棰?DOM 鏌ヨ
        const deducted = {};               // client_msg_id -> true锛屽悓涓€ client_msg_id 鍙墸涓€娆★紱24h 鍚庢竻鐞?
        const DEDUCTED_TTL_MS = 24 * 60 * 60 * 1000;
        const PENDING_MAX_AGE_MS = 15 * 60 * 1000;  // P2b锛歱ending 鎮寕瓒?15 鍒嗛挓鑷姩娓?

        // 鍓嶇鍋囨祦寮忥細鏀跺埌瀹屾暣 response 鍚庢墦瀛楁満鍒嗙墖杩藉姞锛涘仠姝粎鍋滃畾鏃跺櫒
        let typewriterState = { timerId: null, streamId: null, fullText: '', index: 0 };
        // 缁熶竴澶辫触鎻愮ず锛堝急鎻愮ず銆佹棤鎸囦护鎰燂級锛涢櫎 canceled/resumable 澶栧潎鐢?default
        var reasonToCopy = {
            canceled: '宸插仠姝?,
            resumable: '宸蹭腑鏂?路 鐐瑰嚮缁х画',
            default: '杩炴帴涓柇 路 鐐瑰嚮閲嶈瘯'
        };
        
        // 鍥剧墖鐘舵€佺鐞嗭紙Map 淇濇寔鎻掑叆椤哄簭锛屽彂閫佹椂 URL 椤哄簭涓庣敤鎴烽€夋嫨涓€鑷达級
        const imageState = new Map(); // imageId -> {file, base64, status, url, element, currentRequestId}

        // Android 鎺ュ彛瀵硅薄锛堢敱 WebView 娉ㄥ叆锛夛紱鏈敞鍏ユ椂 no-op锛孌EBUG 鏃舵墦鏃ュ織
        var DEBUG = false;
        const hasNativeAndroidSend = !!(window.AndroidInterface && typeof window.AndroidInterface.sendMessage === 'function');
        const AndroidInterface = window.AndroidInterface || {
            uploadImages: function(imageDataListJson) { if (DEBUG) console.log('uploadImages', imageDataListJson); },
            retryImage: function(imageId, requestId) { if (DEBUG) console.log('retryImage', imageId, requestId); },
            sendMessage: function(text, imageUrlsJson, streamId, model, clientMsgId, searchResult) { if (DEBUG) console.log('sendMessage', text, streamId, clientMsgId); },
            webSearch: function(streamId, query, freshness, countStr) { if (DEBUG) console.log('webSearch', streamId, query); },
            stopGeneration: function() { if (DEBUG) console.log('stopGeneration'); },
            requestResume: function(streamId) { if (DEBUG) console.log('requestResume', streamId); }
        };
        function generateClientMsgId() {
            return 'cmsg_' + Date.now() + '_' + Math.random().toString(36).slice(2, 12);
        }
        const SEND_DEBOUNCE_MS = 300;
        let lastSendTriggeredAt = 0;

        // 鑷姩璋冩暣鏂囨湰鍩熼珮搴︼紙鏈€澶?5 琛岃瑙夛級
        textInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 110) + 'px';
            updateInputMode();
        });

        /** C. 4 鎬佺姸鎬佹満锛氭洿鏂板彸渚ф寜閽?Mic / Send / Stop 鏄剧ず涓庣鐢紱鍥剧墖=蹇呴』閰嶆枃瀛楋紝鏈夊浘鏃犲瓧鏃?placeholder 鎻愮ず */
        function updateInputMode() {
            const hasText = textInput.value.trim().length > 0;
            const voiceOpen = voicePanel.classList.contains('open');
            const inVoiceMode = inputContainer.classList.contains('voice-mode');
            const hasImages = imageState.size > 0;
            var hasAnyImageUploadingOrFailed = false;
            for (var _s of imageState.values()) {
                if (_s.status === 'uploading' || _s.status === 'fail') {
                    hasAnyImageUploadingOrFailed = true;
                    break;
                }
            }

            if (voiceOpen || inVoiceMode) {
                inputMode = inVoiceMode ? 'voiceMode' : 'voicePanel';
                btnMicOrKeyboard.classList.remove('btn-hidden');
                btnMicOrKeyboard.classList.add('voice-mode');
                btnSend.classList.add('btn-hidden');
                btnStop.classList.add('btn-hidden');
                textInput.placeholder = '';
            } else if (isGenerating) {
                inputMode = 'generating';
                btnMicOrKeyboard.classList.add('btn-hidden');
                btnSend.classList.add('btn-hidden');
                btnStop.classList.remove('btn-hidden');
                textInput.placeholder = '';
            } else if (hasImages && !hasText) {
                inputMode = 'typing';
                btnMicOrKeyboard.classList.add('btn-hidden');
                btnSend.classList.remove('btn-hidden');
                btnSend.disabled = true;
                btnStop.classList.add('btn-hidden');
                textInput.placeholder = '璇疯ˉ鍏呭浘鐗囨弿杩板悗鍐嶅彂閫?;
            } else if (hasText) {
                inputMode = 'typing';
                btnMicOrKeyboard.classList.add('btn-hidden');
                btnSend.classList.remove('btn-hidden');
                btnStop.classList.add('btn-hidden');
                textInput.placeholder = '';
                var sendDisabled = hasAnyImageUploadingOrFailed;
                if (hasImages && !sendDisabled) {
                    for (var _s of imageState.values()) {
                        if (_s.status === 'uploading' || _s.status === 'fail') {
                            sendDisabled = true;
                            break;
                        }
                    }
                }
                btnSend.disabled = sendDisabled;
            } else {
                inputMode = 'idle';
                btnMicOrKeyboard.classList.remove('btn-hidden');
                btnMicOrKeyboard.classList.remove('voice-mode');
                btnSend.classList.add('btn-hidden');
                btnStop.classList.add('btn-hidden');
                textInput.placeholder = (hasImages && !hasText) ? '璇疯ˉ鍏呭浘鐗囨弿杩板悗鍐嶅彂閫? : '鎻忚堪浣滅墿/鍦板尯/闂锛屾垜鏉ュ府浣犲垎鏋?;
            }

            if (hasAnyImageUploadingOrFailed && !btnSend.classList.contains('btn-hidden')) btnSend.disabled = true;
            if (textPlaceholder) {
                textPlaceholder.textContent = textInput.placeholder || '';
                textPlaceholder.style.display = (!hasText && !!textInput.placeholder) ? 'block' : 'none';
            }
            addButton.disabled = imageState.size >= 4;
            addButton.style.opacity = imageState.size >= 4 ? '0.5' : '1';
            if (inputMode === 'generating') document.body.classList.add('generating');
            else document.body.classList.remove('generating');
        }

        // E. + 闈㈡澘锛氱偣鍑?+ 鎵撳紑 BottomSheet
        addButton.addEventListener('click', () => {
            if (imageState.size >= 4) {
                // 鏄剧ず鏈€澶?寮犲浘鐗囨彁绀?
                const tip = document.createElement('div');
                tip.className = 'image-limit-tip';
                tip.textContent = '鏈€澶氬彲涓婁紶4寮犲浘鐗?;
                tip.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 4px; font-size: 14px; z-index: 1000;';
                document.body.appendChild(tip);
                setTimeout(() => {
                    tip.remove();
                }, 1000);
                return;
            }
            refreshQuotaUI();
            updatePlusSheetTier();
            plusSheet.classList.add('open');
            plusSheetBackdrop.classList.add('open');
        });
        function closePlusSheet() {
            plusSheet.classList.remove('open');
            plusSheetBackdrop.classList.remove('open');
        }
        function getTierLocal() {
            if (typeof getCurrentTier === 'function') return getCurrentTier();
            return localStorage.getItem('membership_tier') || 'free';
        }
        function tierLabel(tier) {
            return ({ free: '鍏嶈垂鐗?, plus: 'Plus', pro: 'Pro', expert: '涓撳妯″紡' })[tier] || '鍏嶈垂鐗?;
        }
        function updatePlusSheetTier() {
            var tierEl = document.getElementById('tier-tier');
            if (!tierEl) return;
            tierEl.textContent = getTierLabel(getTierLocal());
        }
        plusSheetBackdrop.addEventListener('click', closePlusSheet);
        plusSheetGallery.addEventListener('click', () => {
            closePlusSheet();
            fileInput.click();
        });
        plusSheetCamera.addEventListener('click', () => {
            closePlusSheet();
            cameraInput.click();
        });
        var tierEntry = document.getElementById('tier-card');
        if (tierEntry) {
            tierEntry.addEventListener('click', function() {
                closePlusSheet();
                openMembershipModal(false);
            });
        }

        function handleFileSelect(fileList) {
            const imageFiles = Array.from(fileList || []).filter(file => file.type.startsWith('image/'));
            const currentImageCount = imageState.size;
            const remainingSlots = Math.max(0, 4 - currentImageCount);
            const toAdd = imageFiles.slice(0, remainingSlots);
            toAdd.forEach((file) => {
                const imageId = 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                addImagePreview(imageId, file);
            });
            fileInput.value = '';
            cameraInput.value = '';
            updateInputMode();
        }
        fileInput.addEventListener('change', function() { handleFileSelect(this.files); });
        cameraInput.addEventListener('change', function() { handleFileSelect(this.files); });
        
        // 娣诲姞鍥剧墖棰勮锛堢缉鐣ュ浘鐢?objectURL 鍑忓皯鍐呭瓨锛宐ase64 浠呯敤浜庡彂缁?Android锛?
        function addImagePreview(imageId, file) {
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.dataset.imageId = imageId;
            
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            
            const statusOverlay = document.createElement('div');
            statusOverlay.className = 'image-status-overlay';
            const statusIcon = document.createElement('div');
            statusIcon.className = 'image-status-uploading';
            statusOverlay.appendChild(statusIcon);
            
            const actions = document.createElement('div');
            actions.className = 'image-actions';
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'image-action-btn delete';
            deleteBtn.textContent = '鍒犻櫎';
            deleteBtn.onclick = () => removeImage(imageId);
            actions.appendChild(deleteBtn);
            
            previewItem.appendChild(img);
            previewItem.appendChild(statusOverlay);
            previewItem.appendChild(actions);
            
            imagePreviewContainer.appendChild(previewItem);
            imagePreviewContainer.style.display = 'flex';
            
            const requestId = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            // 绔嬪嵆鍐欏叆 state锛屼究浜庡垹闄ゆ椂鑳芥竻鐞嗭紱base64 绋嶅悗濉叆
            imageState.set(imageId, {
                file: file,
                base64: null,
                status: 'uploading',
                url: null,
                element: previewItem,
                currentRequestId: requestId
            });
            
            // base64 浠呯敤浜庨娆″彂缁?Android 涓婁紶锛屽彂瀹屽嵆涓紝涓嶉暱鏈熶繚瀛橈紙閲嶈瘯璧?Android 缂撳瓨锛?
            const reader = new FileReader();
            reader.onload = function(e) {
                const state = imageState.get(imageId);
                if (!state) return; // 鐢ㄦ埛宸插垹闄わ紝涓嶅啀涓婁紶
                const base64 = e.target.result.split(',')[1];
                if (!base64 || base64.length < 10) return;
                uploadImage(imageId, base64, requestId);
                state.base64 = null; // 鍙戝畬绔嬪埢涓紝涓嶅崰鍐呭瓨
            };
            reader.readAsDataURL(file);
        }
        
        // 涓婁紶鍥剧墖锛堝甫 requestId锛沚ase64 浠呴娆′娇鐢級
        function uploadImage(imageId, base64, requestId) {
            const imageData = {
                imageId: imageId,
                base64: base64,
                requestId: requestId
            };
            const imageDataList = [imageData];
            AndroidInterface.uploadImages(JSON.stringify(imageDataList));
        }
        
        // 鏇存柊鍥剧墖鐘舵€侊紙浠呭綋 imageId 浠嶅瓨鍦ㄤ笖 requestId 鍖归厤鏃剁敓鏁堬紱errorMessage 浠?fail 鏃跺崱鐗囧睍绀猴級
        function updateImageStatus(imageId, status, url, requestId, errorMessage) {
            const state = imageState.get(imageId);
            if (!state) return; // 宸插垹闄わ紝蹇界暐鍥炶皟
            if (requestId != null && state.currentRequestId !== requestId) return; // 闈炴湰娆″皾璇曪紝蹇界暐
            
            state.status = status;
            if (url) {
                state.url = url;
            }
            
            const statusOverlay = state.element.querySelector('.image-status-overlay');
            statusOverlay.innerHTML = '';
            
            if (status === 'uploading') {
                const spinner = document.createElement('div');
                spinner.className = 'image-status-uploading';
                statusOverlay.appendChild(spinner);
            } else if (status === 'success') {
                const checkmark = document.createElement('div');
                checkmark.className = 'image-status-success';
                checkmark.textContent = '鉁?;
                statusOverlay.appendChild(checkmark);
                
                const retryBtn = state.element.querySelector('.retry');
                if (retryBtn) retryBtn.remove();
                const hint = state.element.querySelector('.image-fail-hint');
                if (hint) hint.remove();
            } else if (status === 'fail') {
                const failIcon = document.createElement('div');
                failIcon.className = 'image-status-fail';
                failIcon.textContent = '鉁?;
                statusOverlay.appendChild(failIcon);
                
                const actions = state.element.querySelector('.image-actions');
                if (!actions.querySelector('.retry')) {
                    const retryBtn = document.createElement('button');
                    retryBtn.className = 'image-action-btn retry';
                    retryBtn.textContent = '閲嶈瘯';
                    retryBtn.onclick = () => retryImage(imageId);
                    actions.insertBefore(retryBtn, actions.firstChild);
                }
                if (errorMessage) {
                    let hint = state.element.querySelector('.image-fail-hint');
                    if (!hint) {
                        hint = document.createElement('div');
                        hint.className = 'image-fail-hint';
                        state.element.appendChild(hint);
                    }
                    hint.textContent = errorMessage;
                }
            }
            
            updateInputMode();
        }
        
        // 閲嶈瘯锛氬彧鍙?imageId + requestId锛屼笉浼?base64锛汚ndroid 鐢ㄧ紦瀛?bytes 閲嶄紶
        function retryImage(imageId) {
            const state = imageState.get(imageId);
            if (!state) return;
            
            const requestId = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            state.currentRequestId = requestId;
            updateImageStatus(imageId, 'uploading', null, requestId, null);
            AndroidInterface.retryImage(imageId, requestId);
        }
        
        // 鍒犻櫎鍥剧墖锛歎I 绔嬪嵆绉婚櫎锛屽凡鍒犻櫎鍥句笉鍙備笌鍙戦€侊紝鍚庣画璇ュ浘鍥炶皟蹇界暐
        function removeImage(imageId) {
            const state = imageState.get(imageId);
            if (state && state.element) {
                if (state.element.querySelector('img') && state.element.querySelector('img').src) {
                    URL.revokeObjectURL(state.element.querySelector('img').src);
                }
                state.element.remove();
            }
            imageState.delete(imageId);
            
            if (imageState.size === 0) {
                imagePreviewContainer.style.display = 'none';
            }
            
            updateInputMode();
        }
        
        // 鎺ユ敹 Android 涓婁紶鐘舵€佸洖璋冿紙requestId 鍘婚噸锛沞rrorMessage 浠?fail 鏃跺湪鍗＄墖涓婂睍绀猴級
        window.onImageUploadStatus = function(imageId, status, url, requestId, errorMessage) {
            updateImageStatus(imageId, status, url || null, requestId || null, errorMessage || null);
        };

        // 娑堟伅绐楀彛鍖栵細浠呮覆鏌撴渶杩?RENDER_WINDOW 鏉★紝鏇磋€佹姌鍙犱负銆屽姞杞芥洿澶氥€?
        function applyMessageWindow() {
            const messages = messagesContainer.querySelectorAll('.message');
            const total = messages.length;
            const oldScrollTop = messagesWrapper.scrollTop;
            const oldScrollHeight = messagesWrapper.scrollHeight;
            let loadMoreEl = messagesContainer.querySelector('.load-more-placeholder');
            if (total <= RENDER_WINDOW) {
                messages.forEach(el => el.classList.remove('message-folded'));
                if (loadMoreEl) loadMoreEl.remove();
                requestAnimationFrame(function() {
                    const distFromBottom = oldScrollHeight - oldScrollTop;
                    if (distFromBottom <= 120) {
                        messagesWrapper.scrollTop = Math.max(0, messagesWrapper.scrollHeight - distFromBottom);
                    } else {
                        messagesWrapper.scrollTop = Math.min(oldScrollTop, Math.max(0, messagesWrapper.scrollHeight - messagesWrapper.clientHeight));
                    }
                });
                return;
            }
            const toFold = total - RENDER_WINDOW;
            for (let i = 0; i < toFold; i++) messages[i].classList.add('message-folded');
            for (let i = toFold; i < total; i++) messages[i].classList.remove('message-folded');
            if (!loadMoreEl) {
                loadMoreEl = document.createElement('div');
                loadMoreEl.className = 'load-more-placeholder';
                loadMoreEl.textContent = '鍔犺浇鏇村锛? + toFold + ' 鏉★級';
                loadMoreEl.onclick = function() {
                    const oldScrollHeight = messagesWrapper.scrollHeight;
                    const oldScrollTop = messagesWrapper.scrollTop;
                    const folded = messagesContainer.querySelectorAll('.message-folded');
                    const n = Math.min(LOAD_MORE_BATCH, folded.length);
                    for (let i = 0; i < n; i++) folded[i].classList.remove('message-folded');
                    requestAnimationFrame(function() {
                        requestAnimationFrame(function() {
                            messagesWrapper.scrollTop = oldScrollTop + (messagesWrapper.scrollHeight - oldScrollHeight);
                        });
                    });
                    const remaining = messagesContainer.querySelectorAll('.message-folded').length;
                    if (remaining === 0) loadMoreEl.remove();
                    else loadMoreEl.textContent = '鍔犺浇鏇村锛? + remaining + ' 鏉★級';
                };
                messagesContainer.insertBefore(loadMoreEl, messagesContainer.firstChild);
            }
            const remaining = messagesContainer.querySelectorAll('.message-folded').length;
            if (remaining === 0) loadMoreEl.remove();
            else loadMoreEl.textContent = '鍔犺浇鏇村锛? + remaining + ' 鏉★級';
            requestAnimationFrame(function() {
                const distFromBottom = oldScrollHeight - oldScrollTop;
                if (distFromBottom <= 120) {
                    messagesWrapper.scrollTop = Math.max(0, messagesWrapper.scrollHeight - distFromBottom);
                } else {
                    messagesWrapper.scrollTop = Math.min(oldScrollTop, Math.max(0, messagesWrapper.scrollHeight - messagesWrapper.clientHeight));
                }
            });
        }

        // 鍙戦€佹秷鎭紙P0锛氭暟閲忊墹4銆佹湁鍥惧繀椤绘湁鏂囧瓧锛屽弻灞傛嫤鎴級
        function sendMessage() {
            if (btnSend.disabled) return;
            if (isGenerating) return;
            var now = Date.now();
            if ((now - lastSendTriggeredAt) < SEND_DEBOUNCE_MS) return;
            lastSendTriggeredAt = now;
            if (!hasNativeAndroidSend) {
                showToastOncePerDay('preview_send', '棰勮妯″紡鏃犳硶鍙戦€?);
                return;
            }

            const text = textInput.value.trim();
            const hasImages = imageState.size > 0;
            if (!text) {
                if (hasImages) showToastOncePerDay('img_no_text', '璇疯ˉ鍏呭浘鐗囨弿杩板悗鍐嶅彂閫?);
                return;
            }

            if (hasImages) {
                var allSuccess = true;
                for (const [imageId, state] of imageState) {
                    if (state.status !== 'success') {
                        allSuccess = false;
                        break;
                    }
                }
                if (!allSuccess) return;
            }

            const imageUrls = [];
            for (const [imageId, state] of imageState) {
                if (state.status === 'success' && state.url) imageUrls.push(state.url);
            }
            if (imageUrls.length > 4) {
                showToast('鏈€澶?寮犲浘鐗?);
                return;
            }

            var imgNeed = imageUrls.length > 0 ? 1 : 0;
            var quotaCheck = checkQuotaBeforeSend(1, imgNeed);
            if (!quotaCheck.allowed) return;

            // 娣诲姞鐢ㄦ埛娑堟伅锛堝彸瀵归綈锛岀珛鍗虫樉绀猴級
            const userMessage = createMessage({ 
                role: "user", 
                text: text, 
                files: null, 
                imageUrls: imageUrls,
                stream: false 
            });
            messagesContainer.appendChild(userMessage);
            hardTrimMessages();
            refreshEmptyState();
            scrollToBottom();
            applyMessageWindow();

            // 鍒涘缓AI鍥炲鍗犱綅骞剁敓鎴?streamId锛堝彇娑堟椂鏃ф皵娉℃寜 streamId 钀界粓鎬侊級
            const streamId = 'stream_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const clientMsgId = generateClientMsgId();
            isGenerating = true;
            updateInputMode();
            updateScrollToBottomBtn();
            const assistantMessage = createMessage({ role: "assistant", text: "", stream: true });
            assistantMessage.dataset.streamId = streamId;
            bindAssistantMessage(streamId, assistantMessage);
            messagesContainer.appendChild(assistantMessage);
            hardTrimMessages();
            scrollToBottom();
            applyMessageWindow();

            lastSent = { text: text, imageUrls: imageUrls.slice(), streamId: streamId, clientMsgId: clientMsgId };
            pendingRequest[streamId] = { text: text, imageUrls: imageUrls.slice(), clientMsgId: clientMsgId, ts: Date.now() };
            clientMsgIdByStream[streamId] = clientMsgId;
            pendingDeduct[clientMsgId] = (imageUrls.length > 0 ? 1 : 0);

            // 鐩存帴鍙戦€侊紝鐢辨ā鍨嬭嚜琛屽喅绛栨槸鍚﹂渶瑕佽仈缃戞悳绱?
            sendToAndroid(text, imageUrls, streamId, clientMsgId);
            startWatchdog(streamId);

            // 娓呯┖杈撳叆鍜屽浘鐗囬瑙?
            textInput.value = '';
            textInput.style.height = 'auto';
            imageState.clear();
            imagePreviewContainer.innerHTML = '';
            imagePreviewContainer.style.display = 'none';
            updateInputMode();
        }

        // 鍙戦€佸埌Android鍚庣锛坰treamId 鍐欏搴旀皵娉★紱妯″瀷璺敱锛氫笓瀹?plus锛屽叾浣?flash锛?
        function sendToAndroid(text, imageUrls, streamId, clientMsgId) {
            var imageUrlsJson = imageUrls && imageUrls.length > 0 ? JSON.stringify(imageUrls) : 'null';
            var tier = getCurrentTier();
            var model = tier === 'expert' ? 'plus' : 'flash';
            if (typeof AndroidInterface.sendMessage === 'function') {
                AndroidInterface.sendMessage(text || '', imageUrlsJson, streamId || '', model, clientMsgId || '');
            }
        }

        // 鍏ㄥ眬 Watchdog锛?5s 鍐呰 streamId 鏈敹鍒?onComplete/onInterrupted 鍒欏己鍒朵腑鏂敹灏撅紙姘镐笉鏃犻檺杞湀锛?
        function startWatchdog(streamId) {
            if (!streamId) return;
            if (watchdogTimerByStream[streamId]) {
                clearTimeout(watchdogTimerByStream[streamId]);
                delete watchdogTimerByStream[streamId];
            }
            watchdogTimerByStream[streamId] = setTimeout(function() {
                if (watchdogTimerByStream[streamId]) {
                    clearTimeout(watchdogTimerByStream[streamId]);
                    delete watchdogTimerByStream[streamId];
                }
                terminatedStreamIds[streamId] = true;
                AndroidInterface.stopGeneration && AndroidInterface.stopGeneration();
                stopTypewriter();
                isGenerating = false;
                updateInputMode();
                updateScrollToBottomBtn();
                delete chunkBufferByStream[streamId];
                delete lastFullBufferByStream[streamId];
                var timeoutClientMsgId = clientMsgIdByStream[streamId];
                delete pendingRequest[streamId];
                delete clientMsgIdByStream[streamId];
                unbindAssistantMessage(streamId);
                if (timeoutClientMsgId) delete pendingDeduct[timeoutClientMsgId];
                // 鍓嶇 watchdog 浠呭仛 UI 涓柇涓庢湰鍦?pending 娓呯悊锛屼笉鎺ㄥ/淇敼鍚庣鎵ｈ垂缁撴灉锛涙墸璐逛互鏈嶅姟绔?onComplete 瑙勫垯涓哄噯銆?
                applyInterruptedUI(streamId, 'timeout');
                setTimeout(function() { delete terminatedStreamIds[streamId]; }, 2 * 60 * 1000);
            }, MAX_WAIT_MS);
        }

        function clearWatchdog(streamId) {
            if (!streamId) return;
            if (watchdogTimerByStream[streamId]) {
                clearTimeout(watchdogTimerByStream[streamId]);
                delete watchdogTimerByStream[streamId];
            }
        }

        function cleanupStalePending() {
            var now = Date.now();
            Object.keys(pendingRequest).forEach(function(sid) {
                var req = pendingRequest[sid];
                if (req && req.ts != null && (now - req.ts) > PENDING_MAX_AGE_MS) {
                    var staleClientMsgId = req.clientMsgId || clientMsgIdByStream[sid];
                    delete pendingRequest[sid];
                    delete clientMsgIdByStream[sid];
                    if (staleClientMsgId) delete pendingDeduct[staleClientMsgId];
                }
            });
        }
        setInterval(cleanupStalePending, 5 * 60 * 1000);
        function findAssistantMessageByStreamId(streamId) {
            if (!streamId || !messagesContainer) return null;
            var cached = assistantMsgByStream[streamId];
            if (cached && cached.isConnected && cached.dataset && cached.dataset.streamId === streamId) return cached;
            var found = messagesContainer.querySelector('.message.assistant[data-stream-id="' + streamId + '"]');
            if (found) assistantMsgByStream[streamId] = found;
            return found;
        }
        function bindAssistantMessage(streamId, el) {
            if (!streamId || !el) return;
            assistantMsgByStream[streamId] = el;
        }
        function unbindAssistantMessage(streamId) {
            if (!streamId) return;
            delete assistantMsgByStream[streamId];
        }

        // 缁熶竴涓柇 UI锛氳鏉℃秷鎭簳閮ㄤ竴琛岀伆瀛?+銆岄噸璇曘€嶆寜閽紙ChatGPT 椋庢牸锛屼笉寮圭獥锛?
        function applyInterruptedUI(streamId, reason) {
            if (!streamId) return;
            var msg = findAssistantMessageByStreamId(streamId);
            if (!msg) return;
            var contentDiv = msg.querySelector('.message-content');
            if (!contentDiv || contentDiv.querySelector('.interrupted-badge')) return;
            var hasContent = contentDiv.textContent && contentDiv.textContent.trim().length > 0;
            if (!hasContent) return;
            msg.classList.remove('streaming');
            msg.classList.add('message-interrupted');
            var text = reason === 'canceled' ? reasonToCopy.canceled : reason === 'resumable' ? reasonToCopy.resumable : reasonToCopy.default;
            if (!text) return;
            var badge = document.createElement('span');
            badge.className = 'interrupted-badge';
            badge.textContent = text;
            if (reason === 'resumable') {
                badge.style.cursor = 'pointer';
                badge.onclick = function() { AndroidInterface.requestResume && AndroidInterface.requestResume(streamId); };
            }
            contentDiv.appendChild(badge);
            if (reason !== 'resumable' && pendingRequest[streamId]) {
                var retryBtn = document.createElement('button');
                retryBtn.className = 'retry-stream-btn';
                retryBtn.textContent = '閲嶈瘯';
                var retrying = false;
                retryBtn.onclick = function() {
                    if (retrying || isGenerating) return;
                    retrying = true;
                    retryBtn.disabled = true;
                    var data = pendingRequest[streamId];
                    if (!data) { retrying = false; retryBtn.disabled = false; return; }
                    AndroidInterface.stopGeneration && AndroidInterface.stopGeneration();
                    delete chunkBufferByStream[streamId];
                    delete lastFullBufferByStream[streamId];
                    var oldClientMsgId = clientMsgIdByStream[streamId];
                    delete pendingRequest[streamId];
                    delete clientMsgIdByStream[streamId];
                    unbindAssistantMessage(streamId);
                    contentDiv.innerHTML = '';
                    var newStreamId = 'stream_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    msg.dataset.streamId = newStreamId;
                    bindAssistantMessage(newStreamId, msg);
                    msg.classList.remove('message-interrupted');
                    var urls = data.imageUrls && data.imageUrls.slice ? data.imageUrls.slice() : (data.imageUrls || []);
                    var retryClientMsgId = data.clientMsgId || oldClientMsgId || generateClientMsgId();
                    pendingRequest[newStreamId] = { text: data.text, imageUrls: urls, clientMsgId: retryClientMsgId, ts: Date.now() };
                    clientMsgIdByStream[newStreamId] = retryClientMsgId;
                    pendingDeduct[retryClientMsgId] = (urls.length > 0 ? 1 : 0);
                    lastSent = { text: data.text, imageUrls: urls, streamId: newStreamId, clientMsgId: retryClientMsgId };
                    isGenerating = true;
                    updateInputMode();
                    sendToAndroid(data.text, urls, newStreamId, retryClientMsgId);
                    startWatchdog(newStreamId);
                };
                contentDiv.appendChild(retryBtn);
            }
        }

        // 鍋滄鎵撳瓧鏈猴紙鐢ㄦ埛鐐广€屽仠姝€嶆椂锛夛細浠呭仠瀹氭椂鍣紝鍙€変竴娆℃€цˉ鍏ㄥ墿浣欐枃瀛?
        function stopTypewriter() {
            if (typewriterState.timerId) {
                clearInterval(typewriterState.timerId);
                typewriterState.timerId = null;
            }
            if (typewriterState.streamId && typewriterState.fullText && typewriterState.index < typewriterState.fullText.length) {
                const msg = findAssistantMessageByStreamId(typewriterState.streamId);
                if (msg) {
                    const contentDiv = msg.querySelector('.message-content');
                    if (contentDiv) contentDiv.textContent += typewriterState.fullText.slice(typewriterState.index); // 浠呰拷鍔犲墿浣欓儴鍒嗭紝閬垮厤閲嶅
                    msg.classList.remove('streaming');
                }
            }
            typewriterState = { timerId: null, streamId: null, fullText: '', index: 0 };
        }

        // 鍓嶇鍋囨祦寮忥細鐢ㄥ畾鏃跺櫒鍒嗙墖杩藉姞 fullText锛涘厛鍋滄棫鎵撳瓧鏈猴紙闃叉棫鍐欏埌鏂版秷鎭級锛涜秴鏃跺厹搴曠洿鎺ヨˉ鍏?
        function runTypewriter(streamId, fullText) {
            stopTypewriter();
            if (!streamId || !fullText) return;
            const msg = findAssistantMessageByStreamId(streamId);
            if (!msg) return;
            const contentDiv = msg.querySelector('.message-content');
            if (!contentDiv) return;
            var typewriterStartMs = Date.now();
            var dynamicChars = TYPEWRITER_CHARS;
            if (fullText.length > 1200) dynamicChars = 6;
            else if (fullText.length > 700) dynamicChars = 4;
            var typewriterTick = 0;
            typewriterState = { timerId: null, streamId: streamId, fullText: fullText, index: 0 };
            typewriterState.timerId = setInterval(function() {
                if ((Date.now() - typewriterStartMs) >= TYPEWRITER_MAX_MS) {
                    clearInterval(typewriterState.timerId);
                    typewriterState.timerId = null;
                    if (typewriterState.index < fullText.length) {
                        contentDiv.textContent += fullText.slice(typewriterState.index); // 浠呰拷鍔犲墿浣欓儴鍒嗭紝閬垮厤閲嶅
                    }
                    msg.classList.remove('streaming');
                    typewriterState = { timerId: null, streamId: null, fullText: '', index: 0 };
                    isGenerating = false;
                    applyMarkdownToElement(contentDiv, fullText);
                    fileInput.value = '';
                    updateInputMode();
                    refreshEmptyState();
                    updateScrollToBottomBtn();
                    hardTrimMessages();
                    scrollToBottom();
                    return;
                }
                var n = Math.min(dynamicChars, fullText.length - typewriterState.index);
                if (n <= 0) {
                    clearInterval(typewriterState.timerId);
                    typewriterState.timerId = null;
                    msg.classList.remove('streaming');
                    typewriterState = { timerId: null, streamId: null, fullText: '', index: 0 };
                    isGenerating = false;
                    applyMarkdownToElement(contentDiv, fullText);
                    fileInput.value = '';
                    updateInputMode();
                    refreshEmptyState();
                    updateScrollToBottomBtn();
                    hardTrimMessages();
                    scrollToBottom();
                    return;
                }
                contentDiv.textContent += fullText.slice(typewriterState.index, typewriterState.index + n);
                typewriterState.index += n;
                typewriterTick++;
                if (typewriterTick % 3 === 0 || typewriterState.index >= fullText.length) scrollToBottom();
            }, TYPEWRITER_MS);
        }

        // 鎺ユ敹鍚庣涓€娆℃€ц繑鍥炵殑瀹屾暣鍐呭锛堜粎绱Н鍒?buffer锛屼笉鐩存帴鍐?DOM锛?
        window.onChunkReceived = function(streamId, chunk) {
            if (!streamId || !chunk) return;
            if (terminatedStreamIds[streamId]) return;
            chunkBufferByStream[streamId] = (chunkBufferByStream[streamId] || '') + chunk;
            lastFullBufferByStream[streamId] = chunkBufferByStream[streamId];
        };

        // 鏀跺埌瀹屾垚閫氱煡鍚庯細鍚屼竴 streamId 鍙墸涓€娆★紙deducted 闃查噸锛夛紱鍐嶅彇 buffer 鍏ㄦ枃銆佹墦瀛楁満/鐩村嚭銆佹竻鐞?pending銆乧lear Watchdog
        window.onCompleteReceived = function(streamId, clientMsgId) {
            if (!streamId) return;
            if (terminatedStreamIds[streamId]) return;
            var dedupeKey = clientMsgId || clientMsgIdByStream[streamId];
            clearWatchdog(streamId);
            var shouldDeduct = !!dedupeKey && !deducted[dedupeKey];
            var imgUploadCount = (dedupeKey && pendingDeduct[dedupeKey] != null ? pendingDeduct[dedupeKey] : 0);
            delete pendingRequest[streamId];
            delete clientMsgIdByStream[streamId];
            if (shouldDeduct) {
                delete pendingDeduct[dedupeKey];
                incrementUsage(1, imgUploadCount);
                deducted[dedupeKey] = true;
                setTimeout(function() { delete deducted[dedupeKey]; }, DEDUCTED_TTL_MS);
                refreshQuotaUI();
            }
            var hadBuffer = !!(chunkBufferByStream[streamId]);
            var fullText = (chunkBufferByStream[streamId] || '');
            if (!fullText) fullText = (lastFullBufferByStream[streamId] || '');
            delete chunkBufferByStream[streamId];
            delete lastFullBufferByStream[streamId];
            if (!fullText) {
                var msg = findAssistantMessageByStreamId(streamId);
                if (msg) msg.classList.remove('streaming');
                isGenerating = false;
                fileInput.value = '';
                updateInputMode();
                updateScrollToBottomBtn();
                hardTrimMessages();
                unbindAssistantMessage(streamId);
                delete terminatedStreamIds[streamId];
                return;
            }
            var msg = findAssistantMessageByStreamId(streamId);
            if (msg && !msg.classList.contains('streaming')) {
                var contentDiv = msg.querySelector('.message-content');
                if (contentDiv) applyMarkdownToElement(contentDiv, fullText);
                msg.classList.remove('streaming');
                scrollToBottom();
                isGenerating = false;
                fileInput.value = '';
                updateInputMode();
                updateScrollToBottomBtn();
                hardTrimMessages();
                refreshEmptyState();
                unbindAssistantMessage(streamId);
                delete terminatedStreamIds[streamId];
                return;
            }
            if (hadBuffer) {
                runTypewriter(streamId, fullText);
            } else {
                var msg = findAssistantMessageByStreamId(streamId);
                if (msg) {
                    var contentDiv = msg.querySelector('.message-content');
                    if (contentDiv) applyMarkdownToElement(contentDiv, fullText);
                    msg.classList.remove('streaming');
                }
                scrollToBottom();
                isGenerating = false;
                fileInput.value = '';
                updateInputMode();
                updateScrollToBottomBtn();
                hardTrimMessages();
                unbindAssistantMessage(streamId);
            }
            delete terminatedStreamIds[streamId];
        };

        function escapeHtml(s) {
            if (s == null) return '';
            var t = (s + '');
            return t.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }
        function renderMarkdownSafe(text) {
            if (text == null) text = '';
            var raw = (text + '');
            var codeBlocks = [];
            var linkPlaceholders = [];
            var idx = 0;
            raw = raw.replace(/```[\s\S]*?```/g, function(m) {
                var inner = m.slice(3, -3).replace(/^[\w-]*\n?/, '');
                codeBlocks.push(inner);
                return '\n@@CODEBLOCK_' + (idx++) + '@@\n';
            });
            var lines = raw.split(/\r?\n/);
            var out = [];
            var i = 0;
            function parseInline(str) {
                str = (str + '').replace(/\[([^\]]*)\]\((https?:\/\/[^)\s]+)\)/g, function(_, t, url) {
                    var idx = linkPlaceholders.length;
                    linkPlaceholders.push({ text: t ? t : url, url: url });
                    return '@@LINK_' + idx + '@@';
                });
                str = escapeHtml(str);
                str = str.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                str = str.replace(/`([^`]+)`/g, function(_, c) { return '<code>' + escapeHtml(c) + '</code>'; });
                str = str.replace(/@@LINK_(\d+)@@/g, function(_, n) {
                    var L = linkPlaceholders[parseInt(n, 10)];
                    return L ? '<a href="' + escapeHtml(L.url) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(L.text) + '</a>' : '';
                });
                return str;
            }
            while (i < lines.length) {
                var line = lines[i];
                var trimmed = line.trim();
                if (trimmed === '' || trimmed === '---' || trimmed === '***') {
                    if (trimmed === '---' || trimmed === '***') out.push('<hr>');
                    i++;
                    continue;
                }
                var head = /^(#{1,4})\s+(.*)$/.exec(trimmed);
                if (head) {
                    var l = head[1].length;
                    out.push('<h' + l + '>' + parseInline(head[2].trim()) + '</h' + l + '>');
                    i++;
                    continue;
                }
                if (/^[-*]\s+/.test(trimmed) || /^\d+\.\s+/.test(trimmed)) {
                    var tag = /^\d+\.\s+/.test(trimmed) ? 'ol' : 'ul';
                    var items = [];
                    while (i < lines.length && (/^[-*]\s+/.test(lines[i].trim()) || /^\d+\.\s+/.test(lines[i].trim()))) {
                        var it = lines[i].trim().replace(/^[-*]\s+/, '').replace(/^\d+\.\s+/, '');
                        items.push('<li>' + parseInline(it) + '</li>');
                        i++;
                    }
                    out.push('<' + tag + '>' + items.join('') + '</' + tag + '>');
                    continue;
                }
                if (/^>\s*/.test(trimmed)) {
                    var q = [];
                    while (i < lines.length && /^>\s*/.test(lines[i].trim())) {
                        q.push(parseInline(lines[i].trim().replace(/^>\s*/, '')));
                        i++;
                    }
                    out.push('<blockquote>' + q.join('<br>') + '</blockquote>');
                    continue;
                }
                var para = [];
                while (i < lines.length && lines[i].trim() !== '' && !/^#{1,4}\s+/.test(lines[i].trim()) && !/^[-*]\s+/.test(lines[i].trim()) && !/^\d+\.\s+/.test(lines[i].trim()) && !/^>\s*/.test(lines[i].trim()) && lines[i].trim() !== '---' && lines[i].trim() !== '***') {
                    para.push(lines[i]);
                    i++;
                }
                if (para.length) {
                    var pText = para.join('\n').trim();
                    var tokenRepl = function(_, n) {
                        var code = codeBlocks[parseInt(n, 10)];
                        return (code != null) ? '<pre><code>' + escapeHtml(code) + '</code></pre>' : '';
                    };
                    if (/^@@CODEBLOCK_\d+@@$/.test(pText)) {
                        out.push(pText.replace(/@@CODEBLOCK_(\d+)@@/g, tokenRepl));
                    } else if (pText.indexOf('@@CODEBLOCK_') >= 0) {
                        out.push('<p>' + pText.replace(/@@CODEBLOCK_(\d+)@@/g, tokenRepl) + '</p>');
                    } else {
                        out.push('<p>' + parseInline(pText) + '</p>');
                    }
                }
            }
            var html = out.join('\n');
            html = html.replace(/@@CODEBLOCK_(\d+)@@/g, function(_, n) {
                var code = codeBlocks[parseInt(n, 10)];
                return (code != null) ? '<pre><code>' + escapeHtml(code) + '</code></pre>' : '';
            });
            return html;
        }
        function applyMarkdownToElement(el, rawText) {
            if (!el || rawText == null) return;
            el.classList.remove('md-rendered');
            el.innerHTML = renderMarkdownSafe(rawText);
            el.classList.add('md-rendered');
        }

        // 鐏板潡鍐?URL 鍙偣鍑伙細灏嗘枃鏈腑鐨?http(s) URL 杞负 <a target="_blank">锛屽叾浣欒浆涔夐槻 XSS
        function linkifyToolResultText(text) {
            var s = (text != null ? (text + '') : '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return s.replace(/(https?:\/\/[^\s\n&lt;&amp;]+)/g, function(m) {
                var href = m.replace(/"/g, '&quot;');
                return '<a href="' + href + '" target="_blank" rel="noopener noreferrer">' + m + '</a>';
            });
        }
        // 缁熶竴娓叉煋宸ュ叿缁撴灉鍧楋細鍚?streamId + toolName 鍙繚鐣欎竴鍧楋紝閲嶅鍥炶皟鍒欒鐩栨洿鏂帮紱鐏板潡鍐?URL 鍙偣鍑?
        function renderToolResult(streamId, toolName, text) {
            if (!streamId || toolName == null) return;
            var msg = messagesContainer.querySelector('.message.assistant[data-stream-id="' + streamId + '"]');
            if (!msg) return;
            var contentDiv = msg.querySelector('.message-content');
            if (!contentDiv) return;
            var normalized = (text != null ? (text + '') : '').replace(/\\n/g, '\n');
            var html = linkifyToolResultText(normalized);
            var existing = contentDiv.querySelector('.tool-result[data-tool="' + toolName + '"]');
            if (existing) {
                existing.innerHTML = html;
            } else {
                var block = document.createElement('div');
                block.className = 'tool-result';
                block.setAttribute('data-tool', toolName);
                block.innerHTML = html;
                contentDiv.appendChild(block);
            }
            scrollToBottom();
        }



        // 瀹夊崜鏈湴鏃堕棿锛氫緵閿氱偣/涓氬姟鎸夐渶璋冪敤
        window.getLocalDateTimeFromAndroid = function() {
            if (typeof AndroidInterface !== 'undefined' && typeof AndroidInterface.getLocalDateTime === 'function') {
                return AndroidInterface.getLocalDateTime();
            }
            return '';
        };

        // 缁堟€佷粎 badge/鐏板瓧 + 閲嶈瘯锛涘紑澶?clear Watchdog銆佹竻鐞?buffer锛屽啀缁熶竴 applyInterruptedUI
        window.onStreamInterrupted = function(streamId, reason) {
            if (!streamId) return;
            if (terminatedStreamIds[streamId]) return;
            clearWatchdog(streamId);
            var interruptedClientMsgId = clientMsgIdByStream[streamId];
            delete pendingRequest[streamId];
            delete clientMsgIdByStream[streamId];
            unbindAssistantMessage(streamId);
            if (interruptedClientMsgId) delete pendingDeduct[interruptedClientMsgId];
            if (typewriterState.streamId === streamId) stopTypewriter();
            isGenerating = false;
            updateInputMode();
            updateScrollToBottomBtn();
            delete chunkBufferByStream[streamId];
            delete lastFullBufferByStream[streamId];
            applyInterruptedUI(streamId, reason);
            delete terminatedStreamIds[streamId];
        };

        // 缁熶竴娑堟伅娓叉煋鍑芥暟锛堢敤鎴?AI鍏辩敤锛?
        function createMessage({ role, text, files, imageUrls, stream }) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (role === 'assistant') {
                const row = document.createElement('div');
                row.className = 'message-row';
                const avatarSlot = document.createElement('div');
                avatarSlot.className = 'avatar-slot';
                const dot = document.createElement('span');
                dot.className = 'streaming-dot';
                avatarSlot.appendChild(dot);
                row.appendChild(avatarSlot);
                row.appendChild(contentDiv);
                messageDiv.appendChild(row);
                if (stream) {
                    if (messagesContainer) messagesContainer.querySelectorAll('.message.assistant.streaming').forEach(function(m) { m.classList.remove('streaming'); });
                    messageDiv.classList.add('streaming');
                }
            } else {
                messageDiv.appendChild(contentDiv);
            }

            // 娣诲姞鍥剧墖锛堜粎鐢ㄦ埛娑堟伅鏀寔锛?
            if (imageUrls && imageUrls.length > 0 && role === 'user') {
                for (let url of imageUrls) {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = 'message-image';
                    contentDiv.appendChild(img);
                }
            } else if (files && files.length > 0 && role === 'user') {
                // 鍏煎鏃ч€昏緫锛堝鏋滀紶鍏iles锛?
                for (let file of files) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'message-image';
                            contentDiv.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }

            // 娣诲姞鏂囨湰
            if (text && role === 'user') {
                // 鐢ㄦ埛娑堟伅锛氱珛鍗冲畬鏁存樉绀猴紙鍚屾锛?
                const textNode = document.createTextNode(text);
                contentDiv.appendChild(textNode);
            } else if (role === 'assistant') {
                // AI娑堟伅锛氬垵濮嬩负绌猴紝绛夊緟娴佸紡娓叉煋
                contentDiv.textContent = '';
            }

            if (role !== 'assistant') {
                messageDiv.appendChild(contentDiv);
            }
            return messageDiv;
        }

        // 涓ゆ潯绾垮垎绂伙細Android 鎷夊彇 snapshot 鍚庢敞鍏ユ渶杩?N 杞粎鍋?UI 灞曠ず锛屼笉鍙備笌 A/B 瀛樺偍
        function setInitialHistory(rounds) {
            if (!messagesContainer || !Array.isArray(rounds) || rounds.length === 0) return;
            for (var i = 0; i < rounds.length; i++) {
                var r = rounds[i];
                var userMsg = createMessage({ role: 'user', text: (r && r.user) || '', files: null, imageUrls: null, stream: false });
                messagesContainer.appendChild(userMsg);
                var astMsg = createMessage({ role: 'assistant', text: '', stream: false });
                var contentDiv = astMsg.querySelector('.message-content');
                if (contentDiv) contentDiv.textContent = (r && r.assistant) || '';
                messagesContainer.appendChild(astMsg);
            }
            refreshEmptyState();
            if (typeof applyMessageWindow === 'function') applyMessageWindow();
            scrollToBottom();
        }
        window.setInitialHistory = setInitialHistory;

        // 婊氬姩鍒板簳閮細浠呭綋 stickToBottom 鏃惰嚜鍔ㄨ窡锛沠orce=true 鏃朵竴閿洖搴曞苟鎭㈠璺熼殢
        var scrollToBottomRaf = null;
        function scheduleScrollToBottom() {
            if (scrollToBottomRaf) return;
            scrollToBottomRaf = requestAnimationFrame(function() {
                scrollToBottomRaf = null;
                if (stickToBottom && messagesWrapper) messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
            });
        }
        function scrollToBottom(force) {
            if (force) {
                stickToBottom = true;
                if (messagesWrapper) messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
                updateScrollToBottomBtn();
            } else {
                if (stickToBottom) scheduleScrollToBottom();
            }
        }
        function updateScrollToBottomBtn() {
            var btn = document.getElementById('scrollToBottomBtn');
            if (!btn) return;
            if (isGenerating && !stickToBottom) btn.style.display = ''; else btn.style.display = 'none';
        }
        messagesWrapper.addEventListener('scroll', function() {
            stickToBottom = atBottom(messagesWrapper);
            updateScrollToBottomBtn();
        });
        (function() {
            var btn = document.getElementById('scrollToBottomBtn');
            if (btn) btn.addEventListener('click', function() { scrollToBottom(true); });
        })();

        // 绾睍绀鸿鍓細鍒犻櫎瓒呭嚭 MAX_MESSAGES 鐨?DOM锛屼笉寰楃敤瑁佸壀缁撴灉鏇存柊鎴栨帹瀵?A/B
        function hardTrimMessages() {
            if (!messagesContainer) return;
            var nodes = Array.from(messagesContainer.querySelectorAll('.message'));
            if (nodes.length <= MAX_MESSAGES) return;
            var removeCount = nodes.length - MAX_MESSAGES;
            for (var i = 0; i < removeCount; i++) {
                nodes[i].remove();
            }
        }
        function refreshEmptyState() {
            const hasMessages = !!(messagesContainer && messagesContainer.querySelector('.message'));
            emptyState.classList.toggle('hidden', hasMessages);
        }

        // 鍚屼竴浣嶇疆鍒囨崲锛氳闊抽敭/閿洏閿紙楹﹀厠椋庨敭鍙仛鍒囨崲锛屼笉鎵撳紑闈㈡澘锛涘綍闊崇敱鎸変綇杈撳叆妗嗚Е鍙戯級
        btnMicOrKeyboard.addEventListener('click', function() {
            if (voicePanel.classList.contains('open')) {
                stopVoice();
                textInput.focus();
                return;
            }
            if (inputContainer.classList.contains('voice-mode')) {
                inputContainer.classList.remove('voice-mode');
                updateInputMode();
                textInput.focus();
            } else {
                inputContainer.classList.add('voice-mode');
                updateInputMode();
            }
        });

        // C. Stop锛氬彧鍋滃墠绔紙stopTypewriter + 鐘舵€侊級锛泂topGeneration 淇濈暀璋冪敤浣嗕笉渚濊禆鍏朵腑鏂悗绔?
        btnStop.addEventListener('click', function() {
            stopTypewriter();
            // 纭繚缁撴潫娴佸紡鎬侊細绉婚櫎鎵€鏈?assistant 鐨?.streaming锛宒ot 鍙湪銆屾鍦ㄦ祦寮忕殑閭ｄ竴鏉°€嶆樉绀?
            if (messagesContainer) {
                messagesContainer.querySelectorAll('.message.assistant.streaming').forEach(function(m) { m.classList.remove('streaming'); });
            }
            isGenerating = false;
            updateInputMode();
            updateScrollToBottomBtn();
            if (typeof AndroidInterface.stopGeneration === 'function') {
                AndroidInterface.stopGeneration();
            }
        });

        /** P0-6: 骞傜瓑澶嶄綅锛屼换涓€閫€鍑轰簨浠惰皟鐢?*/
        function stopVoice() {
            if (!voicePanel.classList.contains('open') && !voiceRecording) return;
            voiceRecording = false;
            voiceCancelArmed = false;
            if (voicePendingTimeout) { clearTimeout(voicePendingTimeout); voicePendingTimeout = null; }
            voicePanel.classList.remove('open');
            document.body.classList.remove('voice-panel-open');
            inputContainer.classList.remove('voice-mode');
            voicePanel.classList.remove('cancel-armed');
            voiceHint.textContent = '鎸変綇璇磋瘽';
            stopWaveform();
            removeVoiceRecordingListeners();
            removeVoiceExitListeners();
            updateInputMode();
        }
        function addVoiceExitListeners() {
            document.addEventListener('pointerup', _onVoiceExit);
            document.addEventListener('pointercancel', _onVoiceExit);
            window.addEventListener('blur', _onVoiceExit);
            document.addEventListener('visibilitychange', _onVoiceExitHidden);
        }
        function removeVoiceExitListeners() {
            document.removeEventListener('pointerup', _onVoiceExit);
            document.removeEventListener('pointercancel', _onVoiceExit);
            window.removeEventListener('blur', _onVoiceExit);
            document.removeEventListener('visibilitychange', _onVoiceExitHidden);
        }
        function _onVoiceExit(e) {
            if (!voicePanel.classList.contains('open')) return;
            if (e && (e.target === voiceMicBtn || voiceMicBtn.contains(e.target))) return;
            if (e && voiceHoldOverlay && (e.target === voiceHoldOverlay || voiceHoldOverlay.contains(e.target))) return;
            stopVoice();
        }
        function _onVoiceExitHidden() { if (document.hidden) stopVoice(); }

        // D. VoicePanel锛氭寜浣忚緭鍏ユ鎵嶅綍闊筹紝寮瑰嚭闈㈡澘鏄剧ず钃濇€?绾㈡€佹彁绀猴紙鏉炬墜鍙戦€佷笂婊戝彇娑?/ 鏉炬墜鍙栨秷锛?
        function getTouchY(e) {
            if (e.touches && e.touches.length) return e.touches[0].clientY;
            return e.clientY;
        }
        function addVoiceRecordingListeners() {
            document.addEventListener('touchmove', onVoiceMove, { passive: false });
            document.addEventListener('mousemove', onVoiceMove);
            document.addEventListener('touchend', onVoiceEnd);
            document.addEventListener('mouseup', onVoiceEnd);
        }
        function removeVoiceRecordingListeners() {
            document.removeEventListener('touchmove', onVoiceMove);
            document.removeEventListener('mousemove', onVoiceMove);
            document.removeEventListener('touchend', onVoiceEnd);
            document.removeEventListener('mouseup', onVoiceEnd);
        }
        function onVoiceMove(e) {
            if (voiceRecording && e && e.cancelable) e.preventDefault();
            if (!voiceRecording) return;
            const y = getTouchY(e);
            const delta = voiceTouchStartY - y;
            if (delta > VOICE_CANCEL_THRESHOLD_PX && !voiceCancelArmed) {
                voiceCancelArmed = true;
                voicePanel.classList.add('cancel-armed');
                voiceHint.textContent = '鏉炬墜鍙栨秷';
                startWaveform(true, true);
            }
        }

        function onVoiceStart(e) {
            if (e && e.cancelable) e.preventDefault();
            if (e.type === 'touchstart') voiceTouchStartY = e.touches[0].clientY;
            else voiceTouchStartY = e.clientY;
            if (typeof removeVoiceRecordingListeners === 'function') removeVoiceRecordingListeners();
            voiceRecording = true;
            voiceCancelArmed = false;
            voicePanel.classList.remove('cancel-armed');
            voiceHint.textContent = '鏉炬墜鍙戦€侊紝涓婃粦鍙栨秷';
            voicePanel.classList.add('open');
            document.body.classList.add('voice-panel-open');
            addVoiceExitListeners();
            if (typeof addVoiceRecordingListeners === 'function') addVoiceRecordingListeners();
            startWaveform(true, false);
        }

        function onVoiceEnd(e) {
            if (!voiceRecording) return;
            if (e && e.cancelable) e.preventDefault();
            voiceRecording = false;
            removeVoiceRecordingListeners();
            voicePanel.classList.remove('cancel-armed');
            voiceHint.textContent = '鎸変綇璇磋瘽';
            stopWaveform();
            if (voiceCancelArmed) {
                voicePanel.classList.remove('open');
                document.body.classList.remove('voice-panel-open');
                removeVoiceExitListeners();
                updateInputMode();
                return;
            }
            if (voicePendingTimeout) clearTimeout(voicePendingTimeout);
            voicePendingTimeout = setTimeout(function() {
                voicePendingTimeout = null;
                finishVoiceSend('璇煶杈撳叆鐨勬秷鎭?);
            }, 600);
            if (typeof window.onVoiceRecognized === 'function') {
                var t = window.onVoiceRecognized();
                if (t != null && t !== undefined) {
                    if (voicePendingTimeout) { clearTimeout(voicePendingTimeout); voicePendingTimeout = null; }
                    finishVoiceSend(t);
                    return;
                }
            }
        }
        if (voiceHoldOverlay) {
            voiceHoldOverlay.addEventListener('mousedown', onVoiceStart);
            voiceHoldOverlay.addEventListener('touchstart', onVoiceStart, { passive: false });
        }
        window.onVoiceResult = function(text) {
            if (voicePendingTimeout) { clearTimeout(voicePendingTimeout); voicePendingTimeout = null; }
            finishVoiceSend(text);
        };

        function finishVoiceSend(text) {
            removeVoiceExitListeners();
            voicePanel.classList.remove('open');
            document.body.classList.remove('voice-panel-open');
            inputContainer.classList.remove('voice-mode');
            updateInputMode();
            if (!text || !String(text).trim()) {
                showToastOncePerDay('voice_empty', '鏈瘑鍒埌鍐呭');
                voiceHint.textContent = '鎸変綇璇磋瘽';
                return;
            }
            var t = String(text).trim();
            textInput.value = t;
            updateInputMode();
            sendMessage();
        }

        // D4. 娉㈠舰 Canvas锛堢粏鏉°€佽交寰诞鍔紝涓嶆姠娉ㄦ剰鍔涳級
        const WAVE_BARS = 32;
        let waveBarsHeights = Array(WAVE_BARS).fill(0.35);
        let wavePhase = 0;

        function startWaveform(recording, cancelArmed) {
            stopWaveform();
            const ctx = voiceWaveform.getContext('2d');
            const w = voiceWaveform.width;
            const h = voiceWaveform.height;
            const barW = Math.max(2, (w / WAVE_BARS) * 0.32);
            const gap = w / WAVE_BARS - barW;
            const color = cancelArmed ? '#E14B4B' : (recording ? '#000000' : '#D9D9D9');
            const amp = cancelArmed ? 0.2 : (recording ? 0.28 : 0.15);

            function draw() {
                wavePhase += recording ? 0.08 : 0.03;
                ctx.clearRect(0, 0, w, h);
                for (let i = 0; i < WAVE_BARS; i++) {
                    const t = Math.sin(wavePhase + i * 0.35) * 0.5 + 0.5;
                    waveBarsHeights[i] = waveBarsHeights[i] * 0.88 + t * amp * 0.12;
                    const barH = Math.max(2, h * waveBarsHeights[i] * 0.5);
                    const x = i * (barW + gap) + gap * 0.5;
                    ctx.fillStyle = color;
                    ctx.fillRect(x, (h - barH) / 2, barW, barH);
                }
                waveformAnimId = requestAnimationFrame(draw);
            }
            draw();
        }

        function stopWaveform() {
            if (waveformAnimId) {
                cancelAnimationFrame(waveformAnimId);
                waveformAnimId = null;
            }
        }

        inputContainer.classList.remove('voice-mode');
        btnMicOrKeyboard.classList.remove('voice-mode');
        updateDrawerLoginState();
        updateInputMode();
        refreshEmptyState();
        btnSend.addEventListener('click', sendMessage);

        textInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>

