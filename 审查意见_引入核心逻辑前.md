# 全面审查意见（引入核心逻辑前）

**状态**：先不修改，仅列意见，供引入核心逻辑前决策。

---

## 一、严重漏洞

### 1. stopGeneration 未实现

**现象**：HTML 点击 Stop 按钮调用 `AndroidInterface.stopGeneration()`，但 MainActivity.kt 的 `AndroidJSInterface` 未实现该方法。

**影响**：用户点「停止」无效，请求继续跑，无法取消。

**证据**：gpt-demo.html 第 784-788 行有 fallback `stopGeneration: function() { console.log('stopGeneration'); }`，实际 WebView 注入的接口无此方法时会走 fallback。

**建议**：在 AndroidJSInterface 中增加 `stopGeneration()`，内部调用 `ModelService.cancelCurrentRequest()` 或 `QwenClient.cancelCurrentRequest()`，并在 MainActivity 中同步清 `isRequesting` / `currentStreamId`。

---

### 2. isRequesting 在 cancel 时未清空

**现象**：`isRequesting` 只在 `dispatchComplete` 中清空；用户 cancel 时走 `dispatchInterrupted("canceled")`，不会触发 `dispatchComplete`。

**影响**：cancel 后 `isRequesting` 仍为 true，UI 可能认为还在请求中，发送键、状态机异常。

**建议**：在 `dispatchInterrupted` 中，当 `streamId == currentStreamId` 时，同时清空 `isRequesting` 和 `currentStreamId`。

---

### 3. API_KEY 明文泄露风险

**现象**：gradle.properties 中 `API_KEY=sk-e6865ea00577486eacfdd7b98bb1ed03` 明文，且 gradle.properties 未加入 .gitignore，提交即泄露。

**影响**：密钥泄露，可能被滥用、产生费用。

**建议**：
- 将 API_KEY 从 gradle.properties 移到 local.properties（已进 .gitignore），或
- 强制使用环境变量 `BAILIAN_API_KEY`，未配置则构建失败，或
- 至少将 gradle.properties 中 API_KEY 行改为占位符，README 说明需本地配置。

---

## 二、设计与文档不一致

### 4. 切后台行为 vs 文档

**文档**（FEATURE_AND_API 第 101 行）：onPause/onStop 时 `QwenClient.cancelCurrentRequest()`。

**实际**：MainActivity.onStop 注释「不在此 cancel：仅新请求或用户点停止时 cancel，切后台不断网」，未在 onStop 中 cancel。

**建议**：若设计已改为「切后台不断网」，应同步更新 FEATURE_AND_API，避免误导；若仍希望切后台 cancel，则需在 onPause/onStop 中补上 cancel。

---

### 5. readTimeout 数值不一致

**文档**：readTimeout 15s。

**实际**：QwenClient.kt 中 `READ_TIMEOUT_SEC = 30L`。

**建议**：统一为 15s 或 30s，并更新文档与代码一致。

---

### 6. 配置项命名混用

**文档**（APP设定对齐.md）：写的是 `DASHSCOPE_API_KEY`。

**实际**：build.gradle.kts 读取的是 `BAILIAN_API_KEY`（环境变量）或 `API_KEY`（gradle.properties）。

**建议**：文档改为实际使用的 `BAILIAN_API_KEY` / `API_KEY`。

---

## 三、设定不合理

### 7. release 未混淆

**现象**：`isMinifyEnabled = false`，release APK 可被反编译。

**影响**：若 API_KEY 被打进 APK（当前通过 BuildConfig 打入），反编译可获取密钥。

**建议**：引入核心逻辑前考虑开启 ProGuard/R8 混淆；更根本的是不在 APK 内硬编码 API_KEY，改为服务端代理或运行时从安全存储读取。

---

### 8. onBackPressed 已废弃

**现象**：MainActivity 使用 `override fun onBackPressed()`，Android API 33+ 已标记为 deprecated。

**建议**：迁移到 `OnBackPressedDispatcher`，避免未来兼容性问题。

---

### 9. WebView 安全设置

**现象**：`allowFileAccess = true`、`allowContentAccess = true`，未显式限制 file 协议范围。

**影响**：在单页、仅加载 `file:///android_asset/` 的前提下风险可控，但若后续加载外部 URL，需收紧。

**建议**：若后续引入联网/外部页面，需评估并限制 file 访问、混合内容等策略。

---

## 四、引入核心逻辑前需明确的问题

### 10. 核心逻辑注入点

**现状**：payload 仅由 `userMessage` + `imageUrlList` 拼装，AB 占位、规则层均未接入。

**需明确**：
- 核心逻辑（规则、摘要、锚点等）以何种形式注入：服务端中间层 / 客户端 prompt 拼接 / 其他？
- 若在客户端拼接，注入点在 `QwenClient.callApi` 之前的 `ModelService` 层，还是更上层？
- 当前 `ABContextPlaceholder` 全库无引用，引入时是否沿用该结构？

---

### 11. 用户/会话标识

**现状**：`install_id`、`session_id` 仅用于 header/日志，未写入 prompt。

**需明确**：核心逻辑是否需要 `user_id`、`session_id`、设备信息等？若需要，如何注入、脱敏策略如何？

---

### 12. 错误与降级策略

**现状**：请求失败时仅 `onInterrupted(reason)`，UI 显示 badge，无重试、无分级提示。

**需明确**：核心逻辑接入后，对 403/429/5xx/超时 是否有差异化处理？是否允许自动重试、限流、降级到简化 prompt？

---

## 五、其他建议

- **build_apk.bat**：末尾 `pause` 在 CI 中会阻塞，建议改为可选或移除。
- **日志脱敏**：当前部分 Log 已脱敏，引入核心逻辑后需确保 prompt、用户输入、规则内容不完整输出到 Logcat。
- **单元测试**：当前无单测，核心逻辑接入后建议对关键拼接、转换逻辑加测。

---

**结论**：引入核心逻辑前，建议至少修复 1、2、3；同步 4、5、6；并根据业务决策处理 7–12。
