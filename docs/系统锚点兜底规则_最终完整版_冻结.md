# 【系统锚点兜底规则｜最终完整版（冻结·可直接落地）】

**一句话总原则：**  
system 只允许 1 条、只允许覆盖、不允许拼接；注入失败先用完整锚点，完整锚点不可用才降级短锚点；永不累加、永不膨胀。

---

## 一、目标（硬约束，不得变更）

1) 任意请求 messages[0] 必须是 system role。  
2) system role 全局只允许 1 条：多条 → 去重；没有 → 补齐。  
3) system content 只允许「覆盖式写入」，禁止任何字符串累加。  
4) 注入失败必须可恢复、可观测，但不刷屏。  
5) 任何情况下都不允许 system 失控或隐性膨胀。

---

## 二、什么叫「注入失败」（命中任一即触发兜底）

**A）结构失败**  
- messages 中不存在 system role  
- system role 不在 index 0  
- messages 中存在 ≥2 条 system role（必须去重）

**B）内容失败**  
- system content 为 null / 空 / trim 后为空  
- system content 过短（trim 后长度 < 200）  
  ※ 例外：若当前 system content 已等于 FALLBACK_ANCHOR（trim 后一致），不再因 too_short 触发兜底，防止死循环

**C）运行时异常**  
- 构造 messages、读取锚点、序列化等阶段抛异常，导致 system 未正确写入

---

## 三、两级兜底策略（必须严格按顺序）

**Level-1：优先重注入【完整锚点 system_anchor.txt】**  
- 触发：检测到任意「注入失败」  
- 行为：从 assets 读取 system_anchor.txt（UTF-8）；校验 trim 非空且长度 ≥ 200；system 去重（仅保留第一条，其余删除）；覆盖式写入；强制 system 位于 index 0。

**Level-2：降级注入【短锚点 FALLBACK_ANCHOR】**  
- 触发：Level-1 读取/校验失败  
- 行为：同 Level-1 的去重 + 覆盖 + system 置顶，content 使用 FALLBACK_ANCHOR。

---

## 四、关键禁止项（必须写进代码注释）

- 禁止任何 oldSystem + newText 的字符串拼接  
- 禁止每次请求 append 新 system  
- 禁止 system 条数 >1  
- 禁止在锚点兜底逻辑中处理 A/B/联网内容  
- 锚点兜底只负责 system_anchor 本体，不参与上下文拼接  

---

## 五、短锚点 FALLBACK_ANCHOR（全文｜一字不改）

【系统兜底短锚点】  
你是「农技千问」，资深农业技术顾问。仅提供农业技术建议与可行方案，不替用户做最终决策。  
当前轮输入优先；历史仅用于语义承接。输出控制在约800字以内；用自然段与要点列表表达；禁止表情符号。  
信息不足时先追问1–2条关键参数（作物/地区/生育期/症状或图片/近期操作），不得用臆测代替信息。  
涉及不可逆或高风险操作（如清园、拔除、重度用药、停产处理等）不得武断结论；需说明不确定性，并给更低风险验证/替代方案。  
联网：默认不联网；仅强时效（天气/价格/政策/预警等）、强客观核对（法规标准/官方名单/登记备案入口与路径/厂家主体等）、或用户明确要求权威出处引用时才可联网；能不联网继续推进就不联；同一轮最多一次；未命中须说明不确定，不得伪造「已查到」。  
用户询问会员档位/配额/剩余次数/扣减原因：只提示「请在会员中心查看当前档位与剩余次数」；不解释系统内部机制与原因；不提训练数据/模型来源等。

（说明：该短锚点长度 ≥200，用于完整锚点不可用的极端情况；一旦进入 fallback，不再因 too_short 反复兜底。）

---

## 六、缓存与读取策略（稳定优先）

- Fast path：App 启动 init 时读取一次完整锚点并缓存（线程安全）  
- Slow path：仅当检测到「注入失败」时，强制重新读取 assets 尝试恢复完整锚点  
- 平时不反复 I/O；出问题才重读  

---

## 七、并发与线程安全（Android 必须）

- 缓存变量使用 @Volatile  
- init 使用 synchronized，保证只初始化一次  
- slow path 重读 assets 同样加锁，避免并发覆盖  

---

## 八、日志与可观测性（必须节流）

- 仅触发兜底时打 warn  
- 同一 reason 60 秒内只打一条  
- 日志必须包含：reason（missing_system / multi_system / not_at_zero / empty / too_short / exception）、strategy（L1_full / L2_fallback）  

---

## 九、验收用例（必须全部通过）

1) 正常：system_anchor 可读 → system[0] 为完整锚点，system 仅 1 条  
2) 无 system → 自动插入完整锚点  
3) system 为空 → 覆盖完整锚点  
4) system 过短 → 覆盖完整锚点（除非已是 fallback）  
5) assets 读取失败 → 自动使用 fallbackAnchor  
6) 多 system → 去重后仅 1 条  
7) 连续 100 轮构造请求 → system 始终 1 条，内容长度不增长  

---

*不要聪明，不要重构，不要「顺手优化」。严格按本规则实现即可。*
