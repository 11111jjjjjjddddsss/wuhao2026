# 两条线分离（A/B）· 可跑闭环与验收

## 最小闭环（必须跑通）

1. **启动/换设备**：GET `/api/session/snapshot`（参数 `user_id`, `session_id`）→ 返回 `b_summary`、`a_rounds_full`、`a_rounds_for_ui`。Android 在 `USE_BACKEND_AB` 且 baseUrl 非空时调用，成功则 `ABLayerManager.loadSnapshot(snapshot)`，仅将 `a_rounds_for_ui`（最近 24 轮）注入 UI；**B 提取只用 `a_rounds_full`（全量 N 轮，不限 24）**。

2. **仅 done=true 才 POST append-a**：`ABLayerManager.onRoundComplete` 仅在轮次完整完成时调用；中断/stop/timeout 不调用，不写 A。后端 `POST /api/session/append-a` 写入当前轮 user/assistant。

3. **A≥24 触发 B 提取，B 成功后 POST update-b，且仅 update-b 成功才清 A**：`onRoundComplete` 内先 `SessionApi.appendA`，成功则加入 `serverARoundsCache`，若 `size >= 24` 则调用 `tryExtractAndUpdateBBackend`；B 摘要提取成功后 `SessionApi.updateB`，**仅当 updateB 回调 ok 时**清空 `serverARoundsCache`。B 失败/超时/未调用 update-b 则不清 A。

4. **UI 只展示 for_ui 最近 24 轮**：注入通过 `setInitialHistory(a_rounds_for_ui)`，不参与 A/B 存储；B 提取输入为 `a_rounds_full`（全量）。

## 真实调用日志示例（验收用）

**后端（Node）**：
```
[SESSION] GET snapshot user_xxx sess_yyy b_len=120 a_rounds_full=26 a_rounds_for_ui=24
[SESSION] POST append-a user_xxx sess_yyy a_rounds=27
[SESSION] POST update-b user_xxx sess_yyy b_len=200 a_cleared
```

**Android Logcat（DEBUG）**：
```
D/MainActivity: snapshot loaded a_rounds_full=26 injected for_ui=24
D/ABLayerManager: appendA ok session=sess_yyy a_rounds=27
D/ABLayerManager: updateB ok session=sess_yyy b_len=200 a_cleared
```

## 数据源与降级

- A/B 真相仅来自后端 GET snapshot / append-a / update-b；**不从 DOM 回读拼上下文**。
- snapshot 失败（503/timeout）时：不注入、不回退本地，toast「会话同步失败，请稍后重试」。见 `docs/后端开关与降级策略.md`。
