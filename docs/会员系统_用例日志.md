# 会员系统 — 4 条用例日志（entitlement 结果）

以下为 4 条用例在**切换时刻**打印的 entitlement 结果，用于对账与验收。

## 1) Free → Plus

**操作**：无订阅时购买 Plus。

**前端**（console）：
```
[ENT] entitlement: {"effective_tier":"plus","effective_end_at":<now+30天>,"paused_list":[]}
```

**后端**（POST /api/subscription/apply 后）：
```
[ENT] apply local_user local_<ts> plus -> {"effective_tier":"plus","effective_end_at":<ts>,"paused_list":[]}
```

---

## 2) Plus 剩 10 天 → 升 Pro（Plus 冻结 10 天）

**操作**：已有 Plus(active, 剩10天) 时购买 Pro。

**前端**：
```
[ENT] entitlement: {"effective_tier":"pro","effective_end_at":<now+30天>,"paused_list":[{"tier":"plus","remaining_days":10}]}
```

**后端**：
```
[ENT] apply ... pro -> {"effective_tier":"pro","effective_end_at":...,"paused_list":[{"tier":"plus","remaining_days":10}]}
```

---

## 3) Pro 到期 → 自动恢复 Plus 剩 10 天

**操作**：Pro 的 end_at 已过，下一次 getMembership/getCurrentTier 或 GET /api/entitlement。

**前端**：
```
[ENT] entitlement: {"effective_tier":"plus","effective_end_at":<now+10天>,"paused_list":[]}
```

---

## 4) 严禁双档扣/发（同一请求只按 effective_tier）

**验证**：扣减/发额接口仅依据本次查询的 effective_tier 做单档处理；同一 request_id 只出现一条扣减记录。

**示例**：
```
request_id=xxx effective_tier=pro deduct_chat=1 deduct_img=0
（无第二条 deduct，且无 plus 的 deduct）
```

---

说明：前端每次 `computeEntitlement()` 会打印 `[ENT] entitlement: {...}`；后端 POST apply 会打印 `[ENT] apply ... -> {...}`。冒烟验证见《会员多订阅_数据结构与状态机.md》第十三节。
