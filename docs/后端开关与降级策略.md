# 后端为唯一真相 · 开关与降级策略

## 开关

- **USE_BACKEND_AB**（Android BuildConfig）：为 true 时，A/B 真相来自后端 GET snapshot、POST append-a、POST update-b；为 false 时使用本地存储。
- **USE_BACKEND_ENTITLEMENT**（gpt-demo.html 内变量）：为 true 时，额度/展示只读后端 GET /api/entitlement；为 false 时使用前端本地订阅与 computeEntitlement。

## 降级策略（固定、避免两套真相打架）

### USE_BACKEND_AB

- **后端可用**：正常 GET snapshot → 注入 a_rounds_for_ui（最近 24 轮）；仅 done=true 时 POST append-a；A≥24 触发 B 提取，仅 update-b 成功才清 A；B 提取用 a_rounds_full 全量。
- **后端不可用**（503/timeout/网络失败）：
  - getSnapshot 失败 → onResult(null)。**不回退到本地 A/B**，不从 DOM 回读拼上下文。
  - 本次不注入历史；toast 提示「会话同步失败，请稍后重试」。
  - appendA 失败 → 不写入 serverARoundsCache，本轮不记入 A。
  - updateB 失败 → 不清 A，下次仍用当前全量 A 重试 B 提取。

### USE_BACKEND_ENTITLEMENT

- **后端可用**：getEntitlement 返回有效 JSON → _cachedEntitlement 写入；getCurrentTier / getMembership 只读该缓存。
- **后端不可用**（503/timeout/未配置）：getEntitlement 回调 null → **不回退到本地会员状态**。getCurrentTier 返回 `'free'`，getMembership 返回 `{ tier:'free', exp:0, paused:[] }`，不读写 localStorage 订阅，不污染会员状态。可选：首次加载失败时 toast「权益加载失败，请稍后重试」（由产品决定是否加）。

## 会员 4 条用例日志（后端已打，前端可按 response 打）

后端（upload-server/server.js）在以下情况已打日志，便于验收：

| 用例 | 后端日志（示例） |
|------|------------------|
| 升档冻结 | `[ENT] apply upgrade_freeze` user_id order_id tier `new_sub lower_tiers_paused` |
| 到期解冻 | `[ENT] expiry_thaw` tier `paused->active` `remaining_seconds->end_at`（在 computeEntitlement 内） |
| 降档拒绝 | `[ENT] apply no_downgrade` user_id order_id tier `effective=...` |
| 同档续费 + 幂等 | `[ENT] apply same_tier_renew` 或 `[ENT] apply idempotent` |

前端/Android：在调用 POST /api/subscription/apply 或 GET /api/entitlement 后，可根据 response（如 `error=no_downgrade`、`idempotent: true`）打对应一条日志，与后端成对验收。

## 禁止

- 任何降级不得从 DOM 回读拼 A/B 或会员上下文。
- 不得在「后端为真相」模式下把后端失败时的临时状态写回本地 A/B 或本地订阅。
