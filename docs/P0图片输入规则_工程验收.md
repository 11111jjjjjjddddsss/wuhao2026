# P0 图片输入规则 · 工程验收材料

## 一、改动文件清单

| 文件 | 说明 |
|------|------|
| `app/src/main/kotlin/com/nongjiqianwen/ImageUploader.kt` | 1536px/≤1MB、质量85→80、EXIF兜底、解码失败返回 null、固定文案常量 |
| `app/src/main/kotlin/com/nongjiqianwen/MainActivity.kt` | 解码失败用 DECODE_FAIL_MESSAGE；发送前校验：有图须有文、图片≤4 张，拦截时 toast |
| `app/src/main/assets/gpt-demo.html` | 发送前：无文字时 toast「请补充文字描述后再发送」；imageUrls.length>4 时 toast「最多4张图片」并 return |

调用链：`gpt-demo.html` → `AndroidInterface.uploadImages` / `sendMessage` → `MainActivity` → `ImageUploader.compressImage` / `uploadImage`；`QwenClient` 请求前亦有 imgCount>4、有图无文 校验。

## 二、验收方式（3 条）

1. **大图 → 1536 / ≤1MB / JPEG**  
   上传一张 3–6MB 手机原图，查看 Logcat 过滤 `ImageUploader` 或 `MainActivity`：  
   - 应出现 `P0验收: 长边=1536px(≤1536) size=xxxxxbytes(≤1048576) format=JPEG`（或长边≤1536、size≤1048576）。  
   - 输出为 JPEG，肉眼清晰。

2. **HEIC → 转 JPEG 成功**  
   在支持 HEIC 解码的设备上选择 HEIC 照片：应正常压缩为 JPEG 并上传成功（无“格式暂不支持”提示）。

3. **异常格式 → 提示 + 未发送**  
   使用无法解码的图片或异常格式：应弹固定提示「该图片格式暂不支持，请转为JPG/PNG后重试」，该图状态为 fail，不调用模型、不扣费、不计轮次。

## 三、Commit 信息

```
feat(image): 1536px ≤1MB JPEG85→80 + format fallback + decode fail guard
```
