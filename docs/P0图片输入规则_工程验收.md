# P0 图片输入规则 · 工程验收材料

## 0. 可验收证据（3 段关键代码 + 1 条端到端日志）

### a) compressImage 循环：maxIterations + 最小边长硬退出（防死循环/卡死）

```kotlin
// ImageUploader.kt
private const val MAX_ITERATIONS = 25
private const val MIN_EDGE_PX = 48

var iterations = 0
while (compressedBytes.size > MAX_SIZE_BYTES && iterations < MAX_ITERATIONS) {
    val minEdge = minOf(resultBitmap.width, resultBitmap.height)
    if (minEdge < MIN_EDGE_PX) {
        Log.w(TAG, "体积循环硬退出: 最短边=${minEdge}px < ${MIN_EDGE_PX}")
        break
    }
    iterations++
    scaleFactor *= 0.85f
    val w = (resultBitmap.width * scaleFactor).toInt().coerceAtLeast(MIN_EDGE_PX)...
    // ... 缩放后 compressToJpeg(JPEG_QUALITY_LOW)
}
```

### b) 解码失败路径：return 前不触发 sendToModel、不扣费不计轮

```kotlin
// MainActivity.kt uploadSingleImage
val compressResult = ImageUploader.compressImage(imageBytes)
if (compressResult == null) {
    Log.e("MainActivity", "图片[$imageId] 解码失败，不调用模型/不扣费/不计轮次")
    runOnUiThread {
        webView.evaluateJavascript("window.onImageUploadStatus('$escapedImageId', 'fail', null, ... '$escapedErr');", null)
    }
    return@Thread  // 不调用 uploadSingleImageWithBytes，不进入 sendMessage 链路
}
```

前端：sendMessage 仅当 `state.status === 'success'` 才把 URL 加入 imageUrls；有任一张 fail 则 allSuccess=false，直接 return，不写入 pendingSendByStreamId、不调用 sendToAndroid。

### c) 上传成功→发送模型链路：失败时必须短路

```kotlin
// gpt-demo.html sendMessage()
if (hasImages) {
    var allSuccess = true;
    for (const [imageId, state] of imageState) {
        if (state.status !== 'success') { allSuccess = false; break; }
    }
    if (!allSuccess) return;  // 任一张未 success 则不发送
}
// ... 仅 success 的 state.url 进入 imageUrls，再 sendToAndroid
```

上传失败时 onImageUploadStatus(..., 'fail', ...)，该图不会进入 imageUrls，故不会触发 sendToModel。

### 验收日志示例（Logcat 可见）

```
D/ImageUploader: P0验收: 长边=1536px(≤1536) size=524288bytes(≤1048576) format=JPEG quality=85
D/MainActivity: === 图片[img_xxx] 处理完成 ===
D/MainActivity: 压缩后尺寸: 1536x1024 524288 bytes
```

或质量 80 时：`quality=80`。长边≤1536、size≤1048576、format=JPEG、quality 为 85 或 80，四者均在日志中可验。

---

## 一、改动文件清单

| 文件 | 说明 |
|------|------|
| `app/src/main/kotlin/com/nongjiqianwen/ImageUploader.kt` | 1536px/≤1MB、质量85→80、EXIF兜底、解码失败返回 null、固定文案常量 |
| `app/src/main/kotlin/com/nongjiqianwen/MainActivity.kt` | 解码失败用 DECODE_FAIL_MESSAGE；发送前校验：有图须有文、图片≤4 张，拦截时 toast |
| `app/src/main/assets/gpt-demo.html` | 发送前：无文字时 toast「请补充文字描述后再发送」；imageUrls.length>4 时 toast「最多4张图片」并 return |

调用链：`gpt-demo.html` → `AndroidInterface.uploadImages` / `sendMessage` → `MainActivity` → `ImageUploader.compressImage` / `uploadImage`；`QwenClient` 请求前亦有 imgCount>4、有图无文 校验。

## 二、验收方式（3 条）

1. **大图 → 1536 / ≤1MB / JPEG**  
   上传一张 3–6MB 手机原图，查看 Logcat 过滤 `ImageUploader` 或 `MainActivity`：  
   - 应出现 `P0验收: 长边=...px(≤1536) size=...bytes(≤1048576) format=JPEG quality=85` 或 `quality=80`。  
   - 输出为 JPEG，肉眼清晰。

2. **HEIC → 转 JPEG 成功**  
   在支持 HEIC 解码的设备上选择 HEIC 照片：应正常压缩为 JPEG 并上传成功（无“格式暂不支持”提示）。

3. **异常格式 → 提示 + 未发送**  
   使用无法解码的图片或异常格式：应弹固定提示「该图片格式暂不支持，请转为JPG/PNG后重试」，该图状态为 fail，不调用模型、不扣费、不计轮次。

## 三、Commit 信息

```
feat(image): 1536px ≤1MB JPEG85→80 + format fallback + decode fail guard
```
