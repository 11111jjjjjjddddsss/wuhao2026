# 会员体系规则（最终版·冻结｜可直接转发给工程）

目标：**任意时刻只允许一个档位生效；升档立刻生效；低档冻结不扣天数；严禁叠加折算；严禁双档同时扣减/同时给额度。**

---

## 一、购买入口与下单限制（必须做）

### 1) 禁止“降档购买”
- 若用户当前已存在有效的高档位（例如 Pro/专家），则：
  - **不允许再购买任何更低档位**（Free/Plus/Pro 的下级）
  - 前端入口**直接置灰** + 单句提示：**已开通更高档位，无需重复购买**

### 2) 允许“升档购买”
- 仅允许购买当前档位的**上级**（例如 Plus→Pro，Pro→专家）

---

## 二、升档行为（低档→高档）

### 1) 高档立即生效
- 下单成功后：**effective_tier = 新高档**
- 模型路由/额度/展示均以新高档为准（**立即生效**）

### 2) 低档自动冻结（paused）
- 低档位在高档位生效期间**必须进入 paused**
- **冻结期间不扣天数**：
  - 推荐做法：记录 `remaining_seconds` 并冻结；或记录 `pause_at` 并在解冻时顺延 `end_at`
- 冻结期间不提供额度、不参与扣减、不参与路由

### 3) 高档结束后自动解冻低档
- 高档到期/取消/失效后：
  - 自动寻找仍有效的下一高档位；若不存在，则**解冻原低档位继续使用剩余时长**
- **严禁**将低档剩余时间折算/叠加到高档到期日

---

## 三、严禁项（投诉高发点，硬约束）

- **严禁双档同时扣减**（一次请求只能记在 effective_tier 上）
- **严禁双档同时发放额度**
- **严禁把低档剩余天数折算进高档**（不可“合并到期日”）

---

## 四、数据结构与判定（实现口径）

**订阅记录**：`{ user_id, tier, start_at, end_at, status(active|paused|expired|canceled), created_at, remaining_seconds(可选) }`

**effective_tier 计算**：
1. 取所有 `status ∈ { active, paused }` 且 `end_at > now` 的记录
2. 选 **tier 最大**的一条作为 effective
3. 其余更低 tier **全部设置为 paused**（若不在 paused）
4. 若 effective 到期/取消：置 expired/canceled → 重新计算并解冻下一条

---

## 五、聊天记录“展示层 vs 记忆层”分离（必须遵守）

### 1) UI 展示层（仅性能策略）
- UI/DOM 仅展示最近 24 轮（或你定义的窗口），用于不卡顿
- UI 裁剪/清空/退出**只影响展示**，不得影响 A/B 存储

### 2) 记忆/上下文层（后端真相）
- **A 层**：可累计到 A≥24 触发 B；触发前可超过 24；仅在 B 写入成功后才清 A（失败不清）
- **B 层**：累计摘要（按 session 隔离）
- 换手机/重装：通过 user_id + session_id 从后端拉取 B + 最近 A，保证不断层

### 3) 严禁从 DOM 回读拼上下文（后端为唯一真相）

---

# 会员体系｜前端提示文案（极简·冻结）

原则：**不弹窗轰炸、不长解释、单句可操作，符合黑白极简风格。**

---

## 一、购买入口提示

| 场景 | 文案 |
|------|------|
| 1) 已有更高档位，低档入口置灰 | **已开通更高档位**；副文案（灰字，可选）：当前权益已包含 |
| 2) 升档购买成功（低→高） | 顶部轻提示（toast，一次）：**已升级，立即生效** |
| 3) 禁止降档购买时点击提示 | toast，当天一次：**已开通更高档位，无需重复购买** |

---

## 二、档位切换提示

| 场景 | 文案 |
|------|------|
| 4) 低档被冻结（后台自动，不强提示） | 会员中心小字：**低档位已暂停，待高档到期后继续** |
| 5) 高档到期，低档自动恢复 | 轻提示（toast，一次）：**已恢复原档位** |

---

## 三、扣减相关（只在必要时出现）

| 场景 | 文案 |
|------|------|
| 6) 当前请求使用的档位说明（会员中心内） | **当前生效档位：Pro**（以最高档位计） |
| 7) 额度用尽 | **今日额度已用完**；入口置灰，当天仅提示一次 |

---

## 四、异常兜底（极少出现）

| 场景 | 文案 |
|------|------|
| 8) 权益状态刷新失败（网络/服务异常） | **权益状态暂未更新，请稍后重试**；不暴露原因，不提示“计费/系统错误” |

---

## 五、统一约束（工程）

- 所有提示**优先 toast / 灰字**
- **不使用确认弹窗**
- **同类提示同日仅出现一次**
