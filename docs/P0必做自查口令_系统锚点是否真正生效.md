# ã€P0 å¿…åšè‡ªæŸ¥å£ä»¤ï½œç³»ç»Ÿé”šç‚¹æ˜¯å¦çœŸæ­£ç”Ÿæ•ˆã€‘

ç›®çš„ï¼šé˜²æ­¢å‡ºç°â€œensureSystemRole æ³¨å…¥äº†é”šç‚¹ï¼Œä½†åç»­åˆè¢«è¦†ç›–æ‰â€çš„éšæ€§è‡´å‘½é—®é¢˜ã€‚

---

## ä¸€ã€å¿…é¡»åšçš„è‡ªæŸ¥ï¼ˆä¸æ”¹é€»è¾‘ï¼ŒåªåŠ éªŒè¯ï¼‰

è¯·åœ¨ QwenClient.callApi() ä¸­ï¼ŒHTTP è¯·æ±‚å‘å‡ºå‰ï¼Œåšå¦‚ä¸‹ 3 æ¡è‡ªæŸ¥ï¼ˆDebug ä¸‹å³å¯ï¼‰ï¼š

### 1ï¸âƒ£ system æ•°é‡æ ¡éªŒ

```kotlin
// Debug only
val systemCount = messagesArray.count { it["role"].asString == "system" }
check(systemCount == 1) { "FATAL: system role count != 1, count=$systemCount" }
```

### 2ï¸âƒ£ system å¿…é¡»åœ¨ index 0

```kotlin
check(messagesArray[0]["role"].asString == "system") { "FATAL: system not at index 0" }
```

### 3ï¸âƒ£ system å†…å®¹å¿…é¡»åŒ…å«é”šç‚¹å…³é”®å¥ï¼ˆç¡¬æ ¡éªŒï¼‰

é€‰ç”¨ **ä¸ä¼šå˜åŒ–** çš„ä¸€å¥ï¼Œä¾‹å¦‚ï¼š`ä½ æ˜¯"å†œæŠ€åƒé—®"`

```kotlin
val systemContent = messagesArray[0]["content"].asString
check(systemContent.contains("ä½ æ˜¯"å†œæŠ€åƒé—®"")) { "FATAL: system anchor missing or overwritten" }
```

âš ï¸ **è¯´æ˜ï¼š**
- è¿™ä¸æ˜¯æ—¥å¿—ï¼Œæ˜¯**æ–­è¨€**
- Debug ä¸‹ä¸é€šè¿‡ç›´æ¥ **crash**
- åªè¦è·‘ä¸€è½®å¯¹è¯å°±èƒ½ 100% è¯æ˜ï¼šğŸ‘‰ é”šç‚¹æ˜¯å¦çœŸæ­£å­˜åœ¨ã€æ˜¯å¦è¢«è¦†ç›–

---

## äºŒã€å¼ºåˆ¶ç¡®è®¤è°ƒç”¨é¡ºåºï¼ˆå¿…é¡»äººå·¥æ ¸å¯¹ï¼‰

è¯·äººå·¥ç¡®è®¤ **é¡ºåºä¸¥æ ¼å¦‚ä¸‹**ï¼ˆä¸å…è®¸å˜ï¼‰ï¼š

1. æ„å»º messagesï¼ˆuser / assistantï¼‰
2. è°ƒç”¨ **SystemAnchor.ensureSystemRole(messagesArray)**
3. **å†**æ„å»º system çš„ A/B å†…å®¹  
   âš ï¸ **base å¿…é¡»å– messagesArray[0].content**ï¼Œä¸èƒ½ç”¨ç©ºä¸²ã€å¸¸é‡æˆ–æ—§å˜é‡
4. **è¦†ç›–å†™å›** messagesArray[0].content
5. å‘é€ HTTP è¯·æ±‚

å¦‚æœçœ‹åˆ°ä»¥ä¸‹ä»»ä¸€æƒ…å†µï¼Œ**ç«‹å³ä¿®æ­£**ï¼š
- buildSystemContentWithLayers() ä½¿ç”¨çš„ base **ä¸æ˜¯** messagesArray[0].content
- åœ¨ ensureSystemRole ä¹‹åï¼Œåˆ **new äº†ä¸€ä¸ª** system message
- ç”¨å­—ç¬¦ä¸²æ‹¼æ¥**é‡æ–°ç”Ÿæˆ** system è€Œä¸æ˜¯**è¦†ç›– index 0**

---

## ä¸‰ã€rg å†éªŒä¸€æ¬¡ï¼ˆé˜²æ¼ç½‘ï¼‰

åœ¨é¡¹ç›®æ ¹æ‰§è¡Œï¼š

```bash
rg -n "role\s*[:=]\s*\"system\"" app
```

**è¦æ±‚ï¼š**
- é™¤ **SystemAnchor.kt** å’Œ **QwenClient.callApi()** å¤–
- ä¸å…è®¸å‡ºç°ä»»ä½•æ‰‹å†™ system çš„åœ°æ–¹

ï¼ˆæ³¨ï¼šQwenClient.extractBSummary ä¸­æœ‰ä¸€å¤„ä¸º B å±‚æ‘˜è¦è¯·æ±‚æ„é€  systemï¼Œå±å¦ä¸€æ¡çº¿ï¼Œå¯ä¸ä¸»å¯¹è¯é”šç‚¹åŒºåˆ†è¯„ä¼°ã€‚ï¼‰

---

## å››ã€éªŒæ”¶æ ‡å‡†ï¼ˆå¿…é¡»åŒæ—¶æ»¡è¶³ï¼‰

1. Debug ä¸‹è·‘ä¸€è½®å¯¹è¯ **ä¸ crash**
2. æ–­è¨€ 3 æ¡**å…¨éƒ¨é€šè¿‡**
3. rg åªå‰© 1 ä¸ª system **æ³¨å…¥å…¥å£**ï¼ˆensureSystemRoleï¼‰
4. å®é™…è¿”å›å†…å®¹é£æ ¼ã€é•¿åº¦ã€è”ç½‘çº¦æŸç¬¦åˆé”šç‚¹é¢„æœŸ

---

## äº”ã€ä¸€å¥è¯çº¢çº¿ï¼ˆå¿…é¡»éµå®ˆï¼‰

**å¦‚æœ ensureSystemRole() æ³¨å…¥åçš„ system content è¿˜èƒ½è¢«è¦†ç›–æ‰ï¼Œç­‰åŒäºé”šç‚¹å¤±æ•ˆï¼Œå¿…é¡»è§†ä¸º P0 bugã€‚**

---

## å…­ã€æœ¬ä»“åº“è½å®è¯´æ˜ï¼ˆä¾›æ ¸å¯¹ï¼‰

- **3 æ¡æ–­è¨€**ï¼šå·²åœ¨ `QwenClient.callApi()` ä¸­ã€HTTP è¯·æ±‚å‰ã€`if (BuildConfig.DEBUG)` å†…å®ç°ï¼›å¯¹ `requestBody.getAsJsonArray("messages")` åš system æ•°é‡ã€index 0ã€å†…å®¹å« `ä½ æ˜¯"å†œæŠ€åƒé—®"` çš„ checkã€‚
- **è°ƒç”¨é¡ºåº**ï¼šå·²æ ¸å¯¹ã€‚é¡ºåºä¸ºï¼šæ„å»º messagesï¼ˆsystem å ä½ + userï¼‰â†’ ensureSystemRole(messagesArray) â†’ base = messagesArray[0].content å¹¶ strip A/B æ ‡è®° â†’ first.addProperty("content", buildSystemContentWithLayers(base, aText, bSum)) è¦†ç›– index 0 â†’ add("messages", ...) â†’ æ–­è¨€ â†’ å‘é€ HTTP è¯·æ±‚ã€‚base æ¥è‡ª messagesArray[0].contentï¼Œæœª new æ–° systemï¼Œä»…è¦†ç›– index 0ã€‚
- **rg**ï¼š`role` + `"system"` å‘½ä¸­ SystemAnchor.ktã€QwenClient.callApi() å†…å ä½ä¸ first.get("role")ã€ä»¥åŠ QwenClient.extractBSummaryï¼ˆB å±‚æ‘˜è¦ç”¨ï¼‰ï¼›ä¸»å¯¹è¯é”šç‚¹æ³¨å…¥å…¥å£ä»… ensureSystemRole ä¸€å¤„ã€‚
