# P0 锚点剔旧收敛 + 不误伤 B 层｜封板验收

## 目标（一句话红线）
主对话锚点必须「唯一入口、覆盖式、system 仅 1 条」；B 提取必须「system=b_extraction_prompt」。两者都满足才算 P0 完成。

---

## 1) 范围（写死）

- **锚点剔旧只约束「主对话请求」**：主对话里任何读取/拼接/append system_anchor.txt 的旧逻辑全部删除或强制失效。
- **B 层提取不在剔旧范围**：extractBSummary 请求中必须有 role="system" 且 content=b_extraction_prompt.txt，禁止为过 rg 把 system 合并进 user。

---

## 2) 代码必须满足

**主对话**：SystemAnchor.getText() 禁止外部调用（已 private）；callApi 内构建 messages 后只调用一次 ensureSystemRole(messages)；system 仅 1 条、在 index0、覆盖式写入。

**B 层提取**：extractBSummary 必须 system=BExtractionPrompt.getText()（assets/b_extraction_prompt.txt），user=[历史摘要(可选)]+[对话A全量]。

---

## 3) 静态验收（项目根执行，贴原始输出）

### A. 主对话旧入口必须 0 命中

```bash
rg -n "systemAnchorText|SystemAnchor\.getText\(" app
```

**验收：必须无输出（0 命中）。**

**本次结果：**
```
（无输出）
```

---

### B. 主对话 ensureSystemRole 只能 1 个生产调用点

```bash
rg -n "ensureSystemRole\(" app/src/main/kotlin
```

**验收：只允许两处 — SystemAnchor.kt 内函数定义（1 处）+ QwenClient.callApi() 内唯一调用（1 处）。**

**本次结果：**
```
app\src\main\kotlin\com\nongjiqianwen\QwenClient.kt:72:     * 锚点注入：仅在此方法内通过 SystemAnchor.ensureSystemRole(messagesArray) 统一注入，不接收外部锚点参数。
app\src\main\kotlin\com\nongjiqianwen\QwenClient.kt:157:                    com.nongjiqianwen.SystemAnchor.ensureSystemRole(messagesArray)
app\src\main\kotlin\com\nongjiqianwen\SystemAnchor.kt:101:    fun ensureSystemRole(messagesArray: com.google.gson.JsonArray) {
```
（定义 1 处 + 调用 1 处，符合。）

---

### C. B 层提取必须命中 system=b_extraction_prompt

```bash
rg -n "extractBSummary|BExtractionPrompt|b_extraction_prompt" app/src/main/kotlin
```

**验收：必须看到 extractBSummary 构造 role=system 且 content 来源 b_extraction_prompt。**

**本次结果：**
```
app\src\main\kotlin\com\nongjiqianwen\QwenClient.kt:360:    fun extractBSummary(oldB: String, dialogueText: String, systemPrompt: String): String {
app\src\main\kotlin\com\nongjiqianwen\QwenClient.kt:367:            // B 层提取必须保留 system role：system = b_extraction_prompt.txt；锚点剔旧仅作用于主对话，不约束此处
...（addProperty("role", "system") + content=systemPrompt）
app\src\main\kotlin\com\nongjiqianwen\ABLayerManager.kt:110:                val prompt = BExtractionPrompt.getText()
app\src\main\kotlin\com\nongjiqianwen\ABLayerManager.kt:112:                val newSummary = QwenClient.extractBSummary(oldB, dialogueText, prompt)
```
（extractBSummary 的 systemPrompt 由 ABLayerManager 传入 prompt=BExtractionPrompt.getText()，即 b_extraction_prompt.txt；请求体 role=system、content=systemPrompt，符合。）

---

## 4) 最小冒烟（Logcat 关键行）

**跑一轮主对话**：正常回复；Logcat 过滤 `QwenClient` 或 `P0_SMOKE`，应出现：
```
P0_SMOKE: main dialogue ensureSystemRole done, system@index0
```

**触发一次 B 提取**（A≥24 后 done 触发）：请求体含 system=b_extraction_prompt；Logcat 应出现：
```
P0_SMOKE: B extract system=b_extraction_prompt
```

任何崩溃/空回复/锚点缺失，按口径回滚修复。

---

## 5) 交付

- **提交**：1 次，message：`chore(anchor): main dialogue single ensureSystemRole; B extraction keeps system prompt; self-check rg + smoke`
- **封板证据**：PR/群贴 3 段 rg 输出 + 2 条冒烟日志截图。
