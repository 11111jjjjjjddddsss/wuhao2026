# 锚点剔旧·清单与处理结果

## 目标
运行时只允许 1 个锚点注入入口：`SystemAnchor.ensureSystemRole(...)`。  
任何其他「注入 system / 修复 system / 读 system_anchor.txt / fallback anchor」的旧逻辑：删除或强制失效。

---

## 1) 全项目扫旧逻辑·清单

扫描命令（在项目根执行）：
```bash
rg -n "system_anchor|SystemAnchor|ensureSystem|ensureSystemRole|FALLBACK_ANCHOR|anchor|锚点|注入.*system|system role" .
rg -n "insert\(0,.*system|add\(0,.*system|append.*system|role\s*=\s*\"system\"" app upload-server .
```

### 命中清单（文件 / 行号 / 用途 → 处理方式）

| 文件 | 行号 | 函数/位置 | 用途 | 处理 |
|------|------|-----------|------|------|
| `app/.../SystemAnchor.kt` | 21-22 | object SystemAnchor | 唯一实现 | **保留** |
| `app/.../SystemAnchor.kt` | 23 | ASSET_PATH | 读 system_anchor.txt 路径 | 内部常量，**保留** |
| `app/.../SystemAnchor.kt` | 38 | FALLBACK_ANCHOR | 兜底短锚点 | 内部常量，**保留** |
| `app/.../SystemAnchor.kt` | 70 | getText() | 旧入口：外部取锚点再注入 | **A. 改为 private**，仅 ensureSystemRole 内部使用 |
| `app/.../SystemAnchor.kt` | 73 | getFallbackAnchor() | 短锚点，仅内部使用 | **保留** |
| `app/.../SystemAnchor.kt` | 101 | ensureSystemRole(...) | 唯一注入入口 | **保留** |
| `app/.../QwenClient.kt` | 76 | callApi(..., systemAnchorText, ...) | 旧路径：接收 getText() 再构建 system | **A. 删除参数**，内部只通过 ensureSystemRole 注入 |
| `app/.../QwenClient.kt` | 111-126 | systemContent = systemAnchorText + A + B | 用传入锚点拼 system | **A. 删除**，改为先空 system，再 ensureSystemRole 后拼 A/B |
| `app/.../QwenClient.kt` | 166 | ensureSystemRole(messagesArray) | 唯一调用点 | **保留** |
| `app/.../ModelService.kt` | 30 | SystemAnchor.getText() | 旧路径：取锚点传 callApi | **A. 删除**，不再传锚点，由 callApi 内 ensureSystemRole 统一注入 |
| `app/.../MainActivity.kt` | 63 | SystemAnchor.init(...) | 启动时缓存锚点 | 非注入路径，**保留** |
| `app/.../gpt-demo.html` | 2948 | 注释 | 「锚点/业务」注释 | 文档/注释，**保留** |
| `app/.../ApiConfig.kt` | 21 | 注释 | AB 层/锚点占位说明 | 文档，**保留** |
| `app/.../BExtractionPrompt.kt` | 37 | getText() | B 层提取 prompt，非 system 锚点 | **保留**（非主对话锚点） |
| `docs/系统锚点兜底规则_最终完整版_冻结.md` | — | 旧锚点兜底规则 | 文档 | **已删除**（兜底以 P0 三段式为准，见第 8 节） |
| `docs/输入规则_P0_工程落地自查.md` 等 | 多处 | 文档引用 | 文档 | **保留** |
| `README.md` / `清理交付_已删与保留清单.md` | 引用 | 说明 | 文档 | **保留** |

---

## 2) 旧逻辑处理结果（逐条）

- **SystemAnchor.getText()**：改为 `private`，仅 `ensureSystemRole` 内部使用；外部调用已删除（ModelService）。
- **QwenClient.callApi(systemAnchorText)**：删除参数 `systemAnchorText`；构建 messages 时先添加空 system 占位 + user，再调用 `ensureSystemRole(messagesArray)`，再按现有逻辑 `buildSystemContentWithLayers(base, aText, bSum)`。
- **ModelService.getReply()**：删除 `val systemAnchor = SystemAnchor.getText()` 及向 `callApi` 传递锚点；改为 `QwenClient.callApi(..., userMessage, ...)` 不传 systemAnchor。

---

## 3) 唯一入口 + 唯一调用点

- **唯一入口**：`SystemAnchor.ensureSystemRole(messagesArray)`（仅一份实现，位于 `SystemAnchor.kt`）。
- **唯一生产调用点**：`QwenClient.callApi()` 内、构建好 `messagesArray` 后、HTTP 请求前（当前约 166 行），仅此一处。

验收命令（项目根执行）：
```bash
rg -n "ensureSystemRole\(" app
```
**要求**：只允许出现 1 个生产调用点（测试/脚手架若有须单独注明）。

---

## 4) 提交与验收

- **提交信息**：`chore(anchor): remove legacy system injection paths, keep single ensureSystemRole entrypoint`
- **提交内容**：仅剔旧相关改动 + 本清单文档。

验收：
1. `rg` 结果证明：旧入口/旧注入点已消失（无外部 getText()、无 callApi(systemAnchorText)）；`ensureSystemRole(` 仅 1 处调用。
2. 实机跑一轮对话：能正常出回复（未误删关键路径）。

---

## 5) rg 验收输出（剔旧后）

执行：
```bash
rg -n "ensureSystemRole\(" app
```
预期仅 1 处（生产调用点）：
```
app\src\main\kotlin\com\nongjiqianwen\QwenClient.kt:157:                    com.nongjiqianwen.SystemAnchor.ensureSystemRole(messagesArray)
```
（另：SystemAnchor.kt 内为唯一实现定义，非调用点。）

执行：
```bash
rg -n "SystemAnchor\.getText\(\)|systemAnchorText" app
```
预期：无命中（getText 已改为 private，仅 SystemAnchor 内部使用；systemAnchorText 参数已删除）。

---

## 6) 剔旧后 rg 结果（粘贴证明）

**ensureSystemRole 仅 1 处生产调用：**
```
app\src\main\kotlin\com\nongjiqianwen\QwenClient.kt:157:                    com.nongjiqianwen.SystemAnchor.ensureSystemRole(messagesArray)
app\src\main\kotlin\com\nongjiqianwen\SystemAnchor.kt:101:    fun ensureSystemRole(messagesArray: com.google.gson.JsonArray) {
```
（定义 1 处 + 调用 1 处，符合要求。）

**旧入口已消失：**
```
rg -n "SystemAnchor\.getText\(\)|systemAnchorText" app  → 无命中
```

---

## 7) 纠偏：锚点剔旧范围仅限主对话

**范围**：锚点剔旧只作用于「主对话请求」。主对话里 system 只能由 `SystemAnchor.ensureSystemRole(messages)` 注入，禁止任何其它路径读/拼/append system_anchor。

**B 层提取**：必须保留 system role。`extractBSummary` 请求中 `system = b_extraction_prompt.txt` 这一条必须保留；禁止为通过 rg 把 system prompt 合并进 user。

**验收 rg（改口径）**：
- **主对话验收**：`rg -n "systemAnchorText|SystemAnchor\.getText\(" app` **必须无命中**；`ensureSystemRole(` 主对话只能 **1 个调用点**。
- **不再用** `role=\"system\"` 做全项目清零验收（B 提取合法需要 system）。

---

## 8) P0 锚点兜底（三段式·宽松·必须成功）

**目标**：不管任何异常，主对话请求里 system 必须成功注入锚点；允许多试，不允许失败。

**兜底顺序**（一次请求只走一次 ensureSystemRole）：
1. **Step 1**：第一次尝试【完整锚点】— 用缓存 getText()，trim 非空即成功 → system 1 条、index 0、覆盖式写入，结束。
2. **Step 2**：仅 Step 1 失败时 — 再次从 assets 读取 system_anchor.txt，trim 非空即成功 → 同上，结束。
3. **Step 3**：仅 Step 1、Step 2 都失败时 — 使用代码内 FALLBACK_ANCHOR（一字不改）→ 同上，必须结束，禁止循环。

**强制禁止**：oldSystem+anchor 拼接、append system、system>1、ensureSystemRole 后再覆盖 system、用「过短/too_short/阈值」否定锚点（**非空即有效**）。
