# 锚点剔旧·清单与处理结果

## 目标
运行时只允许 1 个锚点注入入口：`SystemAnchor.ensureSystemRole(...)`。  
任何其他「注入 system / 修复 system / 读 system_anchor.txt / fallback anchor」的旧逻辑：删除或强制失效。

---

## 1) 全项目扫旧逻辑·清单

扫描命令（在项目根执行）：
```bash
rg -n "system_anchor|SystemAnchor|ensureSystem|ensureSystemRole|FALLBACK_ANCHOR|anchor|锚点|注入.*system|system role" .
rg -n "insert\(0,.*system|add\(0,.*system|append.*system|role\s*=\s*\"system\"" app upload-server .
```

### 命中清单（文件 / 行号 / 用途 → 处理方式）

| 文件 | 行号 | 函数/位置 | 用途 | 处理 |
|------|------|-----------|------|------|
| `app/.../SystemAnchor.kt` | 21-22 | object SystemAnchor | 唯一实现 | **保留** |
| `app/.../SystemAnchor.kt` | 23 | ASSET_PATH | 读 system_anchor.txt 路径 | 内部常量，**保留** |
| `app/.../SystemAnchor.kt` | 38 | FALLBACK_ANCHOR | 兜底短锚点 | 内部常量，**保留** |
| `app/.../SystemAnchor.kt` | 70 | getText() | 旧入口：外部取锚点再注入 | **A. 改为 private**，仅 ensureSystemRole 内部使用 |
| `app/.../SystemAnchor.kt` | 73 | getFallbackAnchor() | 短锚点，仅内部使用 | **保留** |
| `app/.../SystemAnchor.kt` | 101 | ensureSystemRole(...) | 唯一注入入口 | **保留** |
| `app/.../QwenClient.kt` | 76 | callApi(..., systemAnchorText, ...) | 旧路径：接收 getText() 再构建 system | **A. 删除参数**，内部只通过 ensureSystemRole 注入 |
| `app/.../QwenClient.kt` | 111-126 | systemContent = systemAnchorText + A + B | 用传入锚点拼 system | **A. 删除**，改为先空 system，再 ensureSystemRole 后拼 A/B |
| `app/.../QwenClient.kt` | 166 | ensureSystemRole(messagesArray) | 唯一调用点 | **保留** |
| `app/.../ModelService.kt` | 30 | SystemAnchor.getText() | 旧路径：取锚点传 callApi | **A. 删除**，不再传锚点，由 callApi 内 ensureSystemRole 统一注入 |
| `app/.../MainActivity.kt` | 63 | SystemAnchor.init(...) | 启动时缓存锚点 | 非注入路径，**保留** |
| `app/.../gpt-demo.html` | 2948 | 注释 | 「锚点/业务」注释 | 文档/注释，**保留** |
| `app/.../ApiConfig.kt` | 21 | 注释 | AB 层/锚点占位说明 | 文档，**保留** |
| `app/.../BExtractionPrompt.kt` | 37 | getText() | B 层提取 prompt，非 system 锚点 | **保留**（非主对话锚点） |
| `docs/系统锚点兜底规则_最终完整版_冻结.md` | 多处 | 规则说明 | 文档 | **保留** |
| `docs/输入规则_P0_工程落地自查.md` 等 | 多处 | 文档引用 | 文档 | **保留** |
| `README.md` / `清理交付_已删与保留清单.md` | 引用 | 说明 | 文档 | **保留** |

---

## 2) 旧逻辑处理结果（逐条）

- **SystemAnchor.getText()**：改为 `private`，仅 `ensureSystemRole` 内部使用；外部调用已删除（ModelService）。
- **QwenClient.callApi(systemAnchorText)**：删除参数 `systemAnchorText`；构建 messages 时先添加空 system 占位 + user，再调用 `ensureSystemRole(messagesArray)`，再按现有逻辑 `buildSystemContentWithLayers(base, aText, bSum)`。
- **ModelService.getReply()**：删除 `val systemAnchor = SystemAnchor.getText()` 及向 `callApi` 传递锚点；改为 `QwenClient.callApi(..., userMessage, ...)` 不传 systemAnchor。

---

## 3) 唯一入口 + 唯一调用点

- **唯一入口**：`SystemAnchor.ensureSystemRole(messagesArray)`（仅一份实现，位于 `SystemAnchor.kt`）。
- **唯一生产调用点**：`QwenClient.callApi()` 内、构建好 `messagesArray` 后、HTTP 请求前（当前约 166 行），仅此一处。

验收命令（项目根执行）：
```bash
rg -n "ensureSystemRole\(" app
```
**要求**：只允许出现 1 个生产调用点（测试/脚手架若有须单独注明）。

---

## 4) 提交与验收

- **提交信息**：`chore(anchor): remove legacy system injection paths, keep single ensureSystemRole entrypoint`
- **提交内容**：仅剔旧相关改动 + 本清单文档。

验收：
1. `rg` 结果证明：旧入口/旧注入点已消失（无外部 getText()、无 callApi(systemAnchorText)）；`ensureSystemRole(` 仅 1 处调用。
2. 实机跑一轮对话：能正常出回复（未误删关键路径）。

---

## 5) rg 验收输出（剔旧后）

执行：
```bash
rg -n "ensureSystemRole\(" app
```
预期仅 1 处（生产调用点）：
```
app\src\main\kotlin\com\nongjiqianwen\QwenClient.kt:157:                    com.nongjiqianwen.SystemAnchor.ensureSystemRole(messagesArray)
```
（另：SystemAnchor.kt 内为唯一实现定义，非调用点。）

执行：
```bash
rg -n "SystemAnchor\.getText\(\)|systemAnchorText" app
```
预期：无命中（getText 已改为 private，仅 SystemAnchor 内部使用；systemAnchorText 参数已删除）。

---

## 6) 剔旧后 rg 结果（粘贴证明）

**ensureSystemRole 仅 1 处生产调用：**
```
app\src\main\kotlin\com\nongjiqianwen\QwenClient.kt:157:                    com.nongjiqianwen.SystemAnchor.ensureSystemRole(messagesArray)
app\src\main\kotlin\com\nongjiqianwen\SystemAnchor.kt:101:    fun ensureSystemRole(messagesArray: com.google.gson.JsonArray) {
```
（定义 1 处 + 调用 1 处，符合要求。）

**旧入口已消失：**
```
rg -n "SystemAnchor\.getText\(\)|systemAnchorText" app  → 无命中
```
