# 农技千问 · 项目设定总览（详细记录）

**生成目的**：集中记录当前全部项目设定，便于对齐与交接。  
**适用**：助理对齐、新成员上手、验收对照。

---

## 一、产品与定位

| 项 | 设定 |
|----|------|
| 产品名 | 农技千问 |
| 定位 | 农业指导型 AI 应用，非确诊、非权威裁决 |
| 核心能力 | 视觉识别 + 推理建议（参考性建议） |
| 对外称呼 | 助手对外自称「农技千问」 |

---

## 二、工程与构建

### 2.1 项目结构

| 路径 | 说明 |
|------|------|
| `app/src/main/kotlin/com/nongjiqianwen/` | Android 主代码 |
| `app/src/main/assets/` | WebView 加载的 HTML、系统锚点、B 层提取 prompt |
| `upload-server/` | 图片上传服务（Node，可选） |

### 2.2 构建与打包

| 项 | 设定 |
|----|------|
| Android 插件 | com.android.application 8.7.2，Kotlin 1.9.24 |
| compileSdk / targetSdk | 35 |
| minSdk | 24 |
| JVM | 17 |
| 打包脚本 | `build_apk.bat` |
| 输出 | `app/build/outputs/apk/debug/app-debug.apk` |

### 2.3 配置项（禁止提交敏感值）

| 配置项 | 来源顺序 | 说明 |
|--------|----------|------|
| **API_KEY** | 环境变量 `BAILIAN_API_KEY` > `local.properties` 中 `API_KEY=` > `gradle.properties` | DashScope 密钥；空或占位符则构建失败。**禁止在 gradle.properties 填真实 key** |
| **UPLOAD_BASE_URL** | `gradle.properties` 中 `UPLOAD_BASE_URL` | 图片上传后端根地址（不含 `/upload`）；空则不上传，前端统一 fail |

- `local.properties` 已进 .gitignore，可在此写 `API_KEY=sk-xxx`。

---

## 三、模型与接口

### 3.1 当前模型请求

| 项 | 设定 |
|----|------|
| 接口 URL | `https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions` |
| 模型名 | `qwen3-vl-flash`（专家档可路由 `plus`，见前端 tier_config） |
| 流式 | `stream: true`，SSE 解析 `data:`，拼接 `delta.content` |

### 3.2 模型参数（ModelParams.kt，冻结）

| 参数 | 值 |
|------|-----|
| TEMPERATURE | 0.85 |
| TOP_P | 0.9 |
| MAX_TOKENS | 4000 |
| FREQUENCY_PENALTY | 0.0 |
| PRESENCE_PENALTY | 0.0 |

### 3.3 超时与取消

| 项 | 值 | 说明 |
|----|-----|------|
| connectTimeout | 30s | 连接超时 |
| readTimeout | 30s | 读超时（文档曾写 15s，以代码为准） |
| callTimeout | 120s | 单次请求总时长上限 |
| 取消策略 | 仅在新请求开始或用户点「停止」时 cancel 当前请求；**切后台不 cancel**（见 ModelService 注释） |

### 3.4 请求 payload 形态（阶段冻结）

- **仅含**：`model`、`stream`、`messages`（+ temperature/top_p/max_tokens 等参数）。
- **严禁写入**：`a_messages`、`b_summary`、`meta`、`user_id`、`session_id` 等 AB 字段入 messages。
- `requestId`、`userId`、`sessionId` 仅用于日志/请求 header，不入 prompt。
- 代码引用：`QwenClient.kt` 构建 `requestBody`；`ApiConfig` 仅提供 `requestId`（日志用）。

---

## 四、系统锚点（System Anchor）

### 4.1 作用

- 从 `app/src/main/assets/system_anchor.txt` 加载。
- 启动时 `SystemAnchor.init(applicationContext)` 读入并缓存。
- 每次模型请求前，由 `QwenClient.callApi` 注入为 **system role**（与 B 层摘要拼接后写入 messages[0]）。

### 4.2 锚点内容概要（全文见 system_anchor.txt）

- 身份：资深农业技术顾问，对外称呼「农技千问」。
- 问题类型：涉及农业问题 → 以判断思路与可行方案为主，不替用户做最终决策。
- 信息原则：当前轮用户输入优先；历史/B 层摘要/联网信息仅参考，不与当前输入冲突。
- 行为与风格：特殊场景（寒暄、问系统/模型等）不解释规则、不提及数据库/知识库/模型名，一句承接后引导回可判断问题；提炼重点、必要时追问；高风险操作不可单线索定论，需说明不确定性并给替代方案。
- 空态：无 B 层/历史/联网时，直接基于当前输入处理，不提示「信息不足」、不暴露系统状态。
- 输出：自然段落 + 要点列表，约 800 字以内，无固定起手/收尾，无表情符号。
- 商业与联网：立场中立，不推荐商品；联网仅在被要求或关键信息缺失时使用，结果仅作背景补充。
- 证件/登记/备案类：仅提供权威查询路径与关键词模板，不做真伪裁决。

### 4.3 代码引用

- `SystemAnchor.kt`：`init(Context)`、`getText()`。
- `ModelService.getReply` → `SystemAnchor.getText()` → `QwenClient.callApi(..., systemAnchorText, ...)`。

---

## 五、AB 层与 B 层摘要

### 5.1 当前状态

- **AB 层**：骨架占位；`ApiConfig` 仅提供 `requestId`；`ABContextPlaceholder` 全库无引用；payload 不包含 AB 字段。
- **B 层摘要**：`ABLayerManager.getBSummary()` 在 `QwenClient` 构建 messages 时与 system 锚点拼接；若 B 非空，则追加 `[B层累计摘要]\n{bSum}`。

### 5.2 AB 层逻辑（ABLayerManager.kt）

| 项 | 设定 |
|----|------|
| A 层 | 完整轮次 (user, assistant)，内存列表 |
| 触发 B 提取 | A 达到 24 轮后，每轮完成时尝试 B 提取 |
| B 提取 | 异步，用 BExtractionPrompt + 最新 24 轮 + 已有 B 摘要，生成新 B 摘要（≤400/500 字）；成功后原子清空 A 并写入 B |
| 持久化 | B 摘要存 SharedPreferences，key `b_summary`，prefs 名 `ab_layer` |

### 5.3 B 层提取 prompt

- 文件：`app/src/main/assets/b_extraction_prompt.txt`。
- 角色：累计对话背景摘要生成器；将「已有 B 摘要」与「最新 24 轮」融合重写为新的累计判断背景摘要；默认 ≤400 字，复杂场景可 ≤500 字；优先保留：具体问题与关注点、判断复合信息等（详见该文件）。

---

## 六、图片模块

### 6.1 协议（已冻结）

| 项 | 设定 |
|----|------|
| URL | `POST {UPLOAD_BASE_URL}/upload` |
| 请求 | multipart/form-data，字段名 `file` |
| 成功 | HTTP 200 + JSON 根级 `{"url":"https://..."}` |
| 失败 | HTTP ≠200 + JSON 根级 `{"error":"..."}` |
| UPLOAD_BASE_URL 为空 | 不上传，统一 fail，提示「未配置上传服务」，禁止发送（不降级纯文本） |

### 6.2 前端（gpt-demo.html）

- 最多 4 张；有图必有文字；发送前所有图须 success；uploading/fail 时禁发。
- 压缩：EXIF 矫正 → 长边 1600 → JPEG q=75（不裁剪）；禁止静默截断、降级发送、硬大小阈值。

### 6.3 冻结说明（FREEZE_IMAGE.md）

- 验收通过后冻结：上传协议、upload-server 接口、前端图片状态机、发送键规则、QwenClient 图文请求结构。
- 不再修改：上传 URL 约定、multipart 字段名、响应 JSON 结构、图片数量/压缩/EXIF 等。

---

## 七、前端 WebView 与 gpt-demo.html

### 7.1 模板与风格

- 单模板：`app/src/main/assets/gpt-demo.html`。
- 风格：ChatGPT 绿白风格，手机宽度容器，无气泡、透明消息块。

### 7.2 长聊与性能

| 项 | 设定 |
|----|------|
| 消息 DOM 强裁剪 | 最近 30 轮（最多 60 条 .message），超出直接删除旧 DOM（hardTrimMessages） |
| 窗口化（可选） | 仅渲染最近 80 条，更老折叠「加载更多」每次 20 条 |
| SSE 节流 | chunk 每 60ms 合并 append |

### 7.3 会员与额度（前端本地逻辑，gpt-demo.html）

| 项 | 设定 |
|----|------|
| 存储 | `localStorage`：`membership_tier`、`membership_expire_at`、`usage_YYYY-MM-DD`（当日 chat/img 用量） |
| 档位 | free / plus / pro / expert（见下表） |
| 到期 | 开通非 free 时写 `membership_expire_at = Date.now() + 30*86400000`；过期自动回 free |
| 用量 | 按自然日重置；超额拦截：发送/语音/上传/拍照禁用，点击时 toast 一次（今日额度已用尽/今日图片额度已用尽/图片需要配合文字描述） |

**tier_config（gpt-demo.html）：**

| tier | label | chatPerDay | imgPerDay | model |
|------|-------|------------|-----------|--------|
| free | 免费版 | 10 | 1 | flash |
| plus | Plus | 30 | 5 | flash |
| pro | Pro | 60 | 10 | flash |
| expert | 专家模式 | 80 | 20 | plus |

- 模型路由：Android 发送时由前端传入 model（expert → plus，其余 → flash）。

### 7.4 会员中心弹层（CSS 最终版）

- 遮罩：`#membership-modal-backdrop`，`overflow: hidden`，不滚动。
- 白色面板：`#membership-modal`，`height: auto`，`max-height: min(720px, calc(100vh - 24px))`，`overflow-y: auto`（整弹层按需滚动）；内部不设单独滚动区。
- 卡片：`flex: 0 0 auto`，`min-height: auto`，不均分高度；空白收紧（padding/gap 多段覆盖，见样式末尾 P0 收紧块）。

### 7.5 + 面板（Plus Sheet）

- 顺序：`.plus-sheet-grid`（图片上传/拍照）→ `.plus-sheet-tier`（会员中心入口）→ `#plusSheetStatus`（次数提示脚注）。
- 次数提示仅此处展示完整「当前：X · 今日剩余 Y 次对话 / Z 次图片上传」；抽屉等处仅「当前：X」。

---

## 八、服务端与 API 占位（未实现）

| 路径 | 用途 |
|------|------|
| `/chat` | 文本对话 |
| `/chat/stream` | SSE 流式对话 |
| `/usage` | 配额查询 |
| `/auth` | 鉴权占位 |

- 客户端标识占位：`request_id`、`user_id`、`session_id`（当前为 UUID），供后期会员/审计。

---

## 九、阶段冻结与禁止事项

### 9.1 冻结点

- **阶段 0**：模型请求 payload 仅含 model/stream/messages（及既有参数），AB 不参与。
- **阶段 1**：SSE 读超时 30s、切后台不 cancel、正常/中断/快速连发可区分且不串流。
- **阶段 2**：最近 80 条窗口化、「加载更多」仅扩展历史不闪跳、SSE 节流 60ms；**强裁剪 30 轮/60 条 message** 已加。
- **阶段 3**：未配置上传服务时图片统一 fail + 文案「未配置上传服务」+ 发送键 gating，不降级纯文本发送。

### 9.2 禁止事项

- 未讨论的功能、模块、隐性逻辑。
- 动 AB 核心、接口形态、登录/会员（会员前端为本地模拟）、查证（查证已取消）。
- 在 gradle.properties 中填真实 API_KEY。

---

## 十、待办优先级（参考 APP设定对齐 / FEATURE_AND_API）

| 优先级 | 事项 |
|--------|------|
| P0 | 纯文本验收（连续 10 条不崩、断网可恢复） |
| P0 | 图片未配置验收（UPLOAD_BASE_URL 为空时行为符合阶段 3） |
| P1 | 图片闭环（配置后端 + ngrok 后验收，不动主链路） |
| P2 | 服务端常驻 API、会员/鉴权、B 层摘要/锚点真实逻辑（等指挥） |

---

## 十一、关键文件索引

| 文件 | 说明 |
|------|------|
| `APP设定对齐.md` | 产品定位、当前已实现、阶段冻结、配置与构建、待办、禁止事项 |
| `FEATURE_AND_API.md` | 功能清单、待办、接口字段表、阶段验收证据与冻结点 |
| `README.md` | 项目定位、规则来源、修改约束 |
| `ACCEPTANCE_CHECKLIST.md` | 图片闭环验收清单（bat、verify、App/Logcat） |
| `FREEZE_IMAGE.md` | 图片模块冻结范围与后续主线 |
| `审查意见_引入核心逻辑前.md` | 引入核心逻辑前的审查意见（stopGeneration、isRequesting、API_KEY、切后台、readTimeout 等） |
| `工程与接口检查报告.md` | 锚点机制、兜底与风险、下一步优先级 |
| `app/src/main/assets/system_anchor.txt` | 系统前置锚点全文 |
| `app/src/main/assets/b_extraction_prompt.txt` | B 层摘要提取 prompt |
| `app/src/main/assets/gpt-demo.html` | WebView 单页：对话 UI、会员、额度、强裁剪、+ 面板 |
| `SystemAnchor.kt` | 系统锚点加载与缓存 |
| `ApiConfig.kt` | requestId、服务端 API 路径占位 |
| `ModelParams.kt` | 模型参数（冻结） |
| `QwenClient.kt` | 模型请求、SSE、超时、取消 |
| `ModelService.kt` | getReply、注入 SystemAnchor + B 摘要 |
| `ABLayerManager.kt` | A/B 层状态机、B 摘要持久化与注入 |
| `Procfile` | `web: cd upload-server && npm install && npm start`（上传服务） |

---

**文档生成说明**：由项目内现有设定文档与代码汇总而成，仅作记录与对齐用；若与最新规则冲突，以线下确认规则为准。
