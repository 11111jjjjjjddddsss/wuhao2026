# 农技千问 · 项目详细报告

> 本文档为面向外部阅读的项目说明，适合发给同事、朋友或合作方，用于快速了解项目全貌。

---

## 一、项目简介

**农技千问** 是一款面向农业场景的 **AI 对话 + 识图** 应用，运行在 Android 上，通过 WebView 承载对话界面，后端使用阿里云百炼（DashScope）的通义千问多模态模型（qwen3-vl-flash / plus）进行流式对话。

**核心定位**：

- **农业指导型**：提供田间种植管理、病虫害判断、施肥用药等方面的**参考性建议**。
- **非确诊、非权威**：不替代专业机构诊断，不给出具有法律/权威效力的结论；涉及证件、备案、审定类问题时，只提供「权威查询路径」与关键词模板。
- **能力组合**：**视觉识别**（上传作物/病害图片）+ **推理建议**（结合文字描述给出判断思路与可行方案）。

**典型使用场景**：农户或农技员拍照上传作物/叶片/土壤等图片，配合文字描述（如「最近打过什么药」「什么时候开始发黄」），由 AI 给出可能原因、建议排查方向、用药/施肥的常规区间等，并强调不确定性、建议实地验证或送检。

---

## 二、技术架构概览

```
┌─────────────────────────────────────────────────────────────┐
│  Android App (Kotlin)                                        │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────────┐ │
│  │ MainActivity│  │ ModelService │  │ SystemAnchor         │ │
│  │ WebView +   │  │ QwenClient   │  │ ABLayerManager       │ │
│  │ JS 桥接     │  │ 流式 SSE     │  │ ImageUploader        │ │
│  └──────┬──────┘  └──────┬───────┘  └──────────┬──────────┘ │
│         │                 │                      │           │
│         │    gpt-demo.html (对话 UI / 会员 / 额度) │           │
│         └─────────────────┼──────────────────────┘           │
└───────────────────────────┼──────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
   DashScope API      上传服务 (可选)      未来：自建 API
   chat/completions   POST /upload          /chat/stream
   (流式 SSE)         返回图片 URL          /usage /auth
```

- **前端**：单页 HTML（`gpt-demo.html`）在 WebView 中加载，负责输入框、消息列表、图片选择/预览、会员中心、+ 面板、额度展示等；通过 `AndroidInterface` 与原生通信（发消息、上传图片、停止生成、语音结果等）。
- **原生层**：负责网络请求（QwenClient）、模型参数（ModelParams）、系统锚点（SystemAnchor）、AB 层摘要（ABLayerManager）、图片压缩与上传（ImageUploader）、安装/会话 ID（IdManager）等。
- **模型侧**：当前直连阿里云百炼 OpenAI 兼容接口，流式 SSE；后续可切换为自建网关（/chat/stream、/usage、/auth 等占位已留）。

---

## 三、已实现功能（详细）

### 3.1 纯文本与图文流式对话

- **接口**：`POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions`，`stream: true`。
- **模型**：默认 `qwen3-vl-flash`；会员「专家模式」档位可路由到 `plus` 模型（由前端 tier 传入）。
- **请求体**：仅包含 `model`、`stream`、`messages` 及温度/最大 token 等参数；**不**把 AB 层字段（a_messages、b_summary、meta）或 user_id/session_id 写入 messages，仅用于日志与后续鉴权占位。
- **流式**：逐行解析 SSE `data:`，拼接 `delta.content`，通过 JS 桥实时 append 到对应气泡；支持「停止」按钮取消当前请求。
- **超时**：连接 30s、读取 30s、单次请求总时长 120s；不自动重试，用户可手动重发。
- **切后台**：不主动断开连接；若在后台收到 chunk/complete/interrupted，会缓存并在 onResume 时按序补发；缓存有字数/流数/时间上限，超限会标记「缓存超限」类中断。

### 3.2 图片上传与多图输入

- **数量**：最多 4 张；有图时**必须**带文字描述才能发送（前端占位与发送键逻辑已做）。
- **协议**（已冻结）：  
  - `POST {UPLOAD_BASE_URL}/upload`，multipart 字段名 `file`。  
  - 成功：200 + `{"url":"https://..."}`。  
  - 失败：非 200 + `{"error":"..."}`。  
- **配置**：`UPLOAD_BASE_URL` 在 `gradle.properties` 中配置；**为空时**所有图片上传失败，提示「未配置上传服务」，发送键禁用（不降级为纯文本发送）。
- **压缩**：EXIF 矫正 → 长边 1600 → JPEG 质量 75；不在 App 内写 OSS AK/SK，由上传服务写存储并返回公网 URL。
- **状态机**：选图 → 转圈 → 对勾/叉；支持重试、删除；上传中或存在失败时禁止发送。

配套的 **upload-server**（Node）可本地跑或部署到 Railway/Render 等，需设置公网 `BASE_PUBLIC_URL`，返回的 URL 供模型接口拉图使用。

### 3.3 系统锚点（System Anchor）

- **作用**：为每一轮模型请求注入「人设与行为规则」，保证回复风格、边界一致。
- **内容来源**：`app/src/main/assets/system_anchor.txt`，启动时由 `SystemAnchor.init()` 加载并缓存。
- **注入方式**：在 `QwenClient.callApi` 中与 B 层摘要（若有）拼接为一条 system message，放在 `messages` 首位。
- **锚点要点**（节选）：  
  - 身份：资深农业技术顾问，对外称呼「农技千问」。  
  - 农业问题：以判断思路与可行方案为主，不替用户做最终决策。  
  - 当前轮用户输入优先；历史/B 层摘要/联网信息仅作参考。  
  - 寒暄、问系统/模型等：不解释规则、不提及数据库/模型名，一句承接后引导回可判断问题。  
  - 高风险操作（清园、用药等）：不单线索定论，需说明不确定性并给替代方案。  
  - 输出：自然段落 + 要点，约 800 字以内，无固定起手/收尾，无表情。  
  - 商业与联网：中立，不推荐商品；联网仅在被要求或关键信息缺失时使用。  
  - 证件/备案类：只提供权威查询路径与关键词，不做真伪裁决。

### 3.4 A/B 层与 B 层摘要

- **A 层**：内存中维护「完整轮次」（user + assistant）；每轮 onComplete 时调用 `ABLayerManager.onRoundComplete(userMsg, assistantMsg)`，将本轮加入 A。
- **触发 B 提取**：当 A 达到 **24 轮** 后，在 onRoundComplete 内异步触发 B 摘要提取；使用 `b_extraction_prompt.txt` + 已有 B 摘要 + 最新 24 轮对话，调用同一模型生成新 B 摘要（≤400/500 字）。
- **B 层**：新摘要校验通过后，先 `commit()` 写入 SharedPreferences，再原子清空 A 并更新内存 B；供后续请求在 system 中拼接 `[B层累计摘要]\n{bSum}`。
- **防并发**：提取过程用 `extracting` 标志，同一时间只允许一次 B 提取；失败不写 B、不清 A。

### 3.5 会员与额度（前端本地模拟）

- **档位**：免费版 / Plus / Pro / 专家模式；对应每日对话次数、每日图片上传次数及模型路由（见下表）。
- **存储**：`localStorage`：`membership_tier`、`membership_expire_at`（开通非 free 时写 30 天）、`usage_YYYY-MM-DD`（当日 chat/img 用量）。
- **规则**：按自然日重置用量；超额时发送/语音/上传/拍照按钮禁用，点击时 toast 提示（今日额度已用尽 / 今日图片额度已用尽 / 图片需要配合文字描述）；过期自动回退 free。
- **会员中心弹层**：三张卡（Plus/Pro/专家），展示当前档位、到期日、剩余天数；当前已开通档位按钮灰显「当前已开通」；开通按钮点击后写 tier + 到期时间，toast「开通成功」。
- **+ 面板**：图片上传/拍照置顶，会员中心入口卡片，底部次数提示（仅此处展示「今日剩余 X 次对话 / Y 次图片上传」）。

| 档位     | 对话/天 | 图片上传/天 | 模型   |
|----------|---------|-------------|--------|
| 免费版   | 10      | 1           | flash  |
| Plus     | 30      | 5           | flash  |
| Pro      | 60      | 10          | flash  |
| 专家模式 | 80      | 20          | plus   |

### 3.6 长聊与性能

- **消息 DOM 强裁剪**：仅保留最近 **30 轮**（60 条 .message），超出从头部删除，避免长聊卡顿。
- **可选窗口化**：仅渲染最近 80 条，更早折叠为「加载更多（N 条）」点击展开 20 条。
- **SSE 节流**：chunk 每 60ms 合并一次 append，减少重排。

### 3.7 语音输入（前端 + 原生桥接）

- 前端：语音/键盘切换、按住说话、上滑取消；松手后通过 `onVoiceResult(text)` 或 `onVoiceRecognized()` 回传识别文本并调用 `sendMessage()`。
- 若识别为空，toast「未识别到内容」；若带文字则写入输入框并发送（走同一套额度和图片校验）。

### 3.8 其他 UI 行为

- 抽屉：会员中心、帮助与反馈、关于、退出登录；顶部展示「当前：X」；无「搜索当前对话」。
- 会员中心弹层：整弹层按需滚动（不设内部列表滚动）；三张卡高度随内容、不均分；空白已收紧（多段 CSS 覆盖）。
- 错误与中断：超时/断流/403/429/5xx 等给可理解提示；流被取消或中断时显示「已停止」「超时」「网络异常」等 badge，并可重试。

---

## 四、技术栈与版本

| 类别     | 技术 / 版本 |
|----------|-------------|
| 语言     | Kotlin 1.9.24 |
| 构建     | Gradle，Android Gradle Plugin 8.7.2 |
| 最小/目标 SDK | minSdk 24，compileSdk / targetSdk 35 |
| JVM      | 17 |
| 网络     | OkHttp 4.12.0 |
| JSON     | Gson 2.10.1 |
| 图片     | AndroidX ExifInterface 1.3.7 |
| 前端     | 单 HTML + CSS + JS，无框架，WebView 加载 |
| 模型 API | 阿里云百炼 DashScope，OpenAI 兼容 `/compatible-mode/v1/chat/completions` |
| 上传服务 | Node（upload-server），可部署 Railway / Render / 自建 |

---

## 五、项目结构与关键文件

```
d:\wuhao\
├── app/
│   ├── build.gradle.kts          # API_KEY、UPLOAD_BASE_URL 注入
│   └── src/main/
│       ├── AndroidManifest.xml
│       ├── assets/
│       │   ├── gpt-demo.html     # 对话页：UI、会员、额度、强裁剪
│       │   ├── system_anchor.txt # 系统前置锚点全文
│       │   └── b_extraction_prompt.txt  # B 层摘要提取 prompt
│       └── kotlin/com/nongjiqianwen/
│           ├── MainActivity.kt       # WebView、JS 桥、切后台缓存、AB 回调
│           ├── QwenClient.kt        # 模型请求、SSE、超时、取消
│           ├── ModelService.kt      # getReply、注入锚点+B
│           ├── SystemAnchor.kt      # 锚点加载与缓存
│           ├── ABLayerManager.kt    # A/B 层状态机、B 持久化
│           ├── BExtractionPrompt.kt # B 提取 prompt 加载
│           ├── ApiConfig.kt         # requestId、API 路径占位
│           ├── ModelParams.kt       # 温度、max_tokens 等（冻结）
│           ├── ImageUploader.kt    # 压缩、上传、回调
│           └── IdManager.kt         # 安装 ID、会话 ID
├── upload-server/                 # 图片上传服务（Node）
├── build_apk.bat                  # 打包脚本
├── gradle.properties              # UPLOAD_BASE_URL 等（API_KEY 勿写真实值）
├── local.properties               # API_KEY 可放此处（已 gitignore）
├── APP设定对齐.md                 # 产品设定与冻结说明
├── FEATURE_AND_API.md             # 功能清单、接口表、验收证据
├── 项目设定总览.md                # 设定汇总（内部对齐）
└── 项目详细报告.md                # 本报告（对外）
```

---

## 六、配置与运行

### 6.1 必配项

- **API_KEY**（DashScope）：  
  - 环境变量 `BAILIAN_API_KEY`，或  
  - 项目根目录 `local.properties` 中 `API_KEY=sk-xxx`（该文件已 gitignore）。  
  - 未配置或占位符会导致构建失败。

### 6.2 可选项

- **UPLOAD_BASE_URL**：在 `gradle.properties` 中配置图片上传服务根地址（如 `https://xxx.up.railway.app`），**不要**带 `/upload`。  
  - 不配置时：选图即失败，提示「未配置上传服务」，无法带图发送。

### 6.3 本地运行上传服务（可选）

```bash
# 终端 1：ngrok
ngrok http 3000

# 终端 2：上传服务（把 BASE_PUBLIC_URL 换成 ngrok 给的 https 地址）
cd upload-server
npm install
set BASE_PUBLIC_URL=https://xxxx.ngrok-free.app
npm start
```

再将 `UPLOAD_BASE_URL` 设为上述 https 地址，重新打包 App。

### 6.4 打包

- 根目录执行 `build_apk.bat`（或 Gradle 的 assembleDebug）。
- 输出：`app/build/outputs/apk/debug/app-debug.apk`。

---

## 七、设计约束与冻结点

- **模型请求**：payload 仅含 model、stream、messages 及既有参数；AB 相关字段不入 messages。
- **图片**：协议、字段名、响应格式、4 张上限、压缩方式已冻结；未配置上传服务时不降级为纯文本发送。
- **切后台**：不断开连接；用缓存补发；超限打「缓存超限」类标记。
- **禁止**：未讨论的功能与隐性逻辑；擅自改动 AB 核心、接口形态、登录/会员后端（当前会员为前端本地模拟）；在 gradle.properties 中提交真实 API_KEY。

---

## 八、当前状态与后续规划

- **当前**：纯文本与图文流式对话、系统锚点、B 层摘要、会员与额度（前端）、图片上传（协议与实现冻结）、长聊强裁剪与节流、语音输入桥接、会员中心与 + 面板 UI 均已实现并可验收。
- **P0**：纯文本与图片未配置时的行为验收（连续多条不崩、断网可恢复、未配置时图片 fail 且禁发）。
- **P1**：在配置实际上传服务后做图片闭环验收（不改主链路）。
- **P2**：服务端常驻 API（/chat/stream、/usage、/auth）、真实会员/鉴权、B 层与锚点的进一步策略（等产品/后端规划）。

---

## 九、小结

农技千问是一个 **Android + WebView + 百炼模型** 的农业 AI 应用，具备**流式对话、多图上传、系统锚点、A/B 层摘要、前端会员与额度模拟**等完整链路，并在协议与行为上做了多轮冻结以保证稳定。当前适合在真机/模拟器上做功能与体验验收；后续扩展主要集中在服务端 API、真实会员与鉴权，以及 B 层策略的细化。

如需更细的接口字段、验收清单或代码引用位置，可参见仓库内 `FEATURE_AND_API.md` 与 `项目设定总览.md`。
